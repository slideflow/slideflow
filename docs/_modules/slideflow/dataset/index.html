


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>slideflow.dataset &mdash; slideflow 3.0.0 documentation</title>















  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />




  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-Light.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-MediumItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <script defer data-domain="slideflow.dev" src="https://plausible.io/js/script.js"></script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">





    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">





                <div class="version">
                  3.0
                </div>









<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


          </div>







              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_setup/">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets_and_val/">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide_processing/">Slide Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../evaluation/">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../posthoc/">Layer Activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uq/">Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/">Generating Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mil/">Multiple-Instance Learning (MIL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ssl/">Self-Supervised Learning (SSL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stylegan/">Generative Networks (GANs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../saliency/">Saliency Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../segmentation/">Tissue Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cellseg/">Cell Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_loops/">Custom Training Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../studio/">Slideflow Studio: Live Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tfrecords/">TFRecords: Reading and Writing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataloaders/">Dataloaders: Sampling and Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_extractors/">Custom Feature Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tile_labels/">Strong Supervision with Tile Labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins/">Creating a Slideflow Plugin</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../slideflow/">slideflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project/">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataset/">slideflow.Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataset_features/">slideflow.DatasetFeatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heatmap/">slideflow.Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_params/">slideflow.ModelParams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mosaic/">slideflow.Mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slidemap/">slideflow.SlideMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../biscuit/">slideflow.biscuit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slideflow_cellseg/">slideflow.cellseg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io_tensorflow/">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io_torch/">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gan/">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grad/">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mil_module/">slideflow.mil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model/">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_tensorflow/">slideflow.model.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_torch/">slideflow.model.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../norm/">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simclr/">slideflow.simclr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide/">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide_qc/">slideflow.slide.qc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stats/">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../util/">slideflow.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../studio_module/">slideflow.studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial1/">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial2/">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial3/">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial4/">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial5/">Tutorial 5: Creating a mosaic map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial6/">Tutorial 6: Custom slide filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial7/">Tutorial 7: Training with custom augmentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial8/">Tutorial 8: Multiple-Instance Learning</a></li>
</ul>



        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">

      <li>
        <a href="../../../">

            Docs

        </a> &gt;
      </li>


          <li><a href="../../">Module code</a> &gt;</li>

      <li>slideflow.dataset</li>


      <li class="pytorch-breadcrumbs-aside">

      </li>

  </ul>


</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">



          <div class="rst-content">

            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">

  <h1>Source code for slideflow.dataset</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for the ``Dataset`` class and its associated functions.</span>

<span class="sd">The ``Dataset`` class handles management of collections of patients,</span>
<span class="sd">clinical annotations, slides, extracted tiles, and assembly of images</span>
<span class="sd">into torch DataLoader and tensorflow Dataset objects. The high-level</span>
<span class="sd">overview of the structure of ``Dataset`` is as follows:</span>


<span class="sd"> ──────────── Information Methods ───────────────────────────────</span>
<span class="sd">   Annotations      Slides        Settings         TFRecords</span>
<span class="sd">  ┌──────────────┐ ┌─────────┐   ┌──────────────┐ ┌──────────────┐</span>
<span class="sd">  │Patient       │ │Paths to │   │Tile size (px)│ | *.tfrecords  |</span>
<span class="sd">  │Slide         │ │ slides  │   │Tile size (um)│ |  (generated) |</span>
<span class="sd">  │Label(s)      │ └─────────┘   └──────────────┘ └──────────────┘</span>
<span class="sd">  │ - Categorical│  .slides()     .tile_px         .tfrecords()</span>
<span class="sd">  │ - Continuous │  .rois()       .tile_um         .manifest()</span>
<span class="sd">  │ - Time Series│  .slide_paths()                 .num_tiles</span>
<span class="sd">  └──────────────┘  .thumbnails()                  .img_format</span>
<span class="sd">    .patients()</span>
<span class="sd">    .rois()</span>
<span class="sd">    .labels()</span>
<span class="sd">    .harmonize_labels()</span>
<span class="sd">    .is_float()</span>


<span class="sd"> ─────── Filtering and Splitting Methods ──────────────────────</span>
<span class="sd">  ┌────────────────────────────┐</span>
<span class="sd">  │                            │</span>
<span class="sd">  │ ┌─────────┐                │ .filter()</span>
<span class="sd">  │ │Filtered │                │ .remove_filter()</span>
<span class="sd">  │ │ Dataset │                │ .clear_filters()</span>
<span class="sd">  │ └─────────┘                │ .split()</span>
<span class="sd">  │               Full Dataset │</span>
<span class="sd">  └────────────────────────────┘</span>


<span class="sd"> ───────── Summary of Image Data Flow ──────────────────────────</span>
<span class="sd">  ┌──────┐</span>
<span class="sd">  │Slides├─────────────┐</span>
<span class="sd">  └──┬───┘             │</span>
<span class="sd">     │                 │</span>
<span class="sd">     ▼                 │</span>
<span class="sd">  ┌─────────┐          │</span>
<span class="sd">  │TFRecords├──────────┤</span>
<span class="sd">  └──┬──────┘          │</span>
<span class="sd">     │                 │</span>
<span class="sd">     ▼                 ▼</span>
<span class="sd">  ┌────────────────┐ ┌─────────────┐</span>
<span class="sd">  │torch DataLoader│ │Loose images │</span>
<span class="sd">  │ / tf Dataset   │ │ (.png, .jpg)│</span>
<span class="sd">  └────────────────┘ └─────────────┘</span>

<span class="sd"> ──────── Slide Processing Methods ─────────────────────────────</span>
<span class="sd">  ┌──────┐</span>
<span class="sd">  │Slides├───────────────┐</span>
<span class="sd">  └──┬───┘               │</span>
<span class="sd">     │.extract_tiles()   │.extract_tiles(</span>
<span class="sd">     ▼                   │    save_tiles=True</span>
<span class="sd">  ┌─────────┐            │  )</span>
<span class="sd">  │TFRecords├────────────┤</span>
<span class="sd">  └─────────┘            │ .extract_tiles</span>
<span class="sd">                         │  _from_tfrecords()</span>
<span class="sd">                         ▼</span>
<span class="sd">                       ┌─────────────┐</span>
<span class="sd">                       │Loose images │</span>
<span class="sd">                       │ (.png, .jpg)│</span>
<span class="sd">                       └─────────────┘</span>


<span class="sd"> ─────────────── TFRecords Operations ─────────────────────────</span>
<span class="sd">                      ┌─────────┐</span>
<span class="sd">   ┌────────────┬─────┤TFRecords├──────────┐</span>
<span class="sd">   │            │     └─────┬───┘          │</span>
<span class="sd">   │.tfrecord   │.tfrecord  │ .balance()   │.resize_tfrecords()</span>
<span class="sd">   │  _heatmap()│  _report()│ .clip()      │.split_tfrecords</span>
<span class="sd">   │            │           │ .torch()     │  _by_roi()</span>
<span class="sd">   │            │           │ .tensorflow()│</span>
<span class="sd">   ▼            ▼           ▼              ▼</span>
<span class="sd">  ┌───────┐ ┌───────┐ ┌────────────────┐┌─────────┐</span>
<span class="sd">  │Heatmap│ │PDF    │ │torch DataLoader││TFRecords│</span>
<span class="sd">  └───────┘ │ Report│ │ / tf Dataset   │└─────────┘</span>
<span class="sd">            └───────┘ └────────────────┘</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">DPool</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>  <span class="c1"># type: ignore[import]</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span><span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span>
                    <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="k">as</span> <span class="nn">sg</span>
<span class="kn">from</span> <span class="nn">rich.progress</span> <span class="kn">import</span> <span class="n">track</span><span class="p">,</span> <span class="n">Progress</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">slideflow.slide</span> <span class="kn">import</span> <span class="n">WSI</span><span class="p">,</span> <span class="n">ExtractionReport</span><span class="p">,</span> <span class="n">SlideReport</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">Labels</span><span class="p">,</span> <span class="n">_shortname</span><span class="p">,</span> <span class="n">path_to_name</span><span class="p">,</span>
                            <span class="n">tfrecord2idx</span><span class="p">,</span> <span class="n">TileExtractionProgress</span><span class="p">,</span> <span class="n">MultiprocessProgress</span><span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
    <span class="kn">import</span> <span class="nn">cellpose</span>
    <span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">BaseFeatureExtractor</span>
    <span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">ModelParams</span>
    <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
    <span class="kn">from</span> <span class="nn">slideflow.norm</span> <span class="kn">import</span> <span class="n">StainNormalizer</span>

<span class="c1"># -----------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_prepare_slide</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">report_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">wsi_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">qc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">qc_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.WSI&quot;</span><span class="p">]:</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">slide</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">wsi_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qc</span><span class="p">:</span>
            <span class="n">slide</span><span class="o">.</span><span class="n">qc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">qc</span><span class="p">,</span> <span class="o">**</span><span class="n">qc_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slide</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingROIError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Missing ROI for slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">; skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">IncompatibleBackendError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Slide </span><span class="si">{}</span><span class="s1"> has type </span><span class="si">{}</span><span class="s1">, which is incompatible with the active &#39;</span>
                  <span class="s1">&#39;slide reading backend, </span><span class="si">{}</span><span class="s1">. Consider using a different &#39;</span>
                  <span class="s1">&#39;backend, which can be set with the environmental variable &#39;</span>
                  <span class="s1">&#39;SF_SLIDE_BACKEND. See https://slideflow.dev/installation/#cucim-vs-libvips &#39;</span>
                  <span class="s1">&#39;for more information.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span>
                  <span class="p">))</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">. Skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">QCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TileCorruptionError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> corrupt; skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exiting...&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error processing slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">. Skipping&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_handle_slide_errors</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingROIError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Missing ROI for slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">; skipping&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error loading slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">. Skipping&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">QCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TileCorruptionError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> corrupt; skipping&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exiting...&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>


<span class="k">def</span> <span class="nf">_tile_extractor</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tfrecord_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tiles_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">reports</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">qc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">wsi_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">generator_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">qc_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">render_thumb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract tiles. Internal function.</span>

<span class="sd">    Slide processing needs to be process-isolated when num_workers &gt; 1 .</span>

<span class="sd">    Args:</span>
<span class="sd">        tfrecord_dir (str): Path to TFRecord directory.</span>
<span class="sd">        tiles_dir (str): Path to tiles directory (loose format).</span>
<span class="sd">        reports (dict): Multiprocessing-enabled dict.</span>
<span class="sd">        qc (bool): Quality control method.</span>
<span class="sd">        wsi_kwargs (dict): Keyword arguments for sf.WSI.</span>
<span class="sd">        generator_kwargs (dict): Keyword arguments for WSI.extract_tiles()</span>
<span class="sd">        qc_kwargs(dict): Keyword arguments for quality control.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_handle_slide_errors</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting tiles for </span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">slide</span> <span class="o">=</span> <span class="n">_prepare_slide</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">report_dir</span><span class="o">=</span><span class="n">tfrecord_dir</span><span class="p">,</span>
            <span class="n">wsi_kwargs</span><span class="o">=</span><span class="n">wsi_kwargs</span><span class="p">,</span>
            <span class="n">qc</span><span class="o">=</span><span class="n">qc</span><span class="p">,</span>
            <span class="n">qc_kwargs</span><span class="o">=</span><span class="n">qc_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span>
                <span class="n">tfrecord_dir</span><span class="o">=</span><span class="n">tfrecord_dir</span><span class="p">,</span>
                <span class="n">tiles_dir</span><span class="o">=</span><span class="n">tiles_dir</span><span class="p">,</span>
                <span class="o">**</span><span class="n">generator_kwargs</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">render_thumb</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">SlideReport</span><span class="p">):</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">thumb</span>
            <span class="n">reports</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">path</span><span class="p">:</span> <span class="n">report</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">_buffer_slide</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Buffer a slide to a path.&quot;&quot;&quot;</span>
    <span class="n">buffered</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buffered</span><span class="p">)</span>

    <span class="c1"># If this is an MRXS file, copy the associated folder.</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mrxs&#39;</span><span class="p">):</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not find associated MRXS folder for slide buffer&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">buffered</span>


<span class="k">def</span> <span class="nf">_debuffer_slide</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;De-buffer a slide.&quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># If this is an MRXS file, remove the associated folder.</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mrxs&#39;</span><span class="p">):</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not find MRXS folder for slide debuffer&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fill_queue</span><span class="p">(</span>
    <span class="n">slide_list</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
    <span class="n">q_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">buffer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill a queue with slide paths, using an optional buffer.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">:</span>
        <span class="n">warned</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">q_size</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_buffer_slide</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">warned</span><span class="p">:</span>
                            <span class="n">slide</span> <span class="o">=</span> <span class="n">_shortname</span><span class="p">(</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;OSError for </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1">: buffer full?&#39;</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Queue size: </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">warned</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_count_otsu_tiles</span><span class="p">(</span><span class="n">wsi</span><span class="p">):</span>
    <span class="n">wsi</span><span class="o">.</span><span class="n">qc</span><span class="p">(</span><span class="s1">&#39;otsu&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wsi</span><span class="o">.</span><span class="n">estimated_num_tiles</span>


<span class="k">def</span> <span class="nf">_create_index</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
        <span class="n">dirname</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">),</span>
        <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.index&#39;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">,</span> <span class="n">index_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_tile_df</span><span class="p">(</span>
    <span class="n">slide_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">rois</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span>
        <span class="n">slide_path</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">,</span>
        <span class="n">rois</span><span class="o">=</span><span class="n">rois</span><span class="p">,</span>
        <span class="n">stride_div</span><span class="o">=</span><span class="n">stride_div</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping slide </span><span class="si">{}</span><span class="s2">, error raised: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">path_to_name</span><span class="p">(</span><span class="n">slide_path</span><span class="p">),</span> <span class="n">e</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">_df</span> <span class="o">=</span> <span class="n">wsi</span><span class="o">.</span><span class="n">get_tile_dataframe</span><span class="p">()</span>
    <span class="n">_df</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wsi</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">_df</span>

<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">split_patients_preserved_site</span><span class="p">(</span>
    <span class="n">patients_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">balance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split a dictionary of patients into n groups, with site balancing.</span>

<span class="sd">    Splits are balanced according to key &quot;balance&quot;, while preserving site.</span>

<span class="sd">    Args:</span>
<span class="sd">        patients_dict (dict): Nested dictionary mapping patient names to</span>
<span class="sd">            dict of outcomes: labels</span>
<span class="sd">        n (int): Number of splits to generate.</span>
<span class="sd">        balance (str): Annotation header to balance splits across.</span>
<span class="sd">        method (str): Solver method. &#39;auto&#39;, &#39;cplex&#39;, or &#39;bonmin&#39;. If &#39;auto&#39;,</span>
<span class="sd">            will use CPLEX if availabe, otherwise will default to pyomo/bonmin.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of patient splits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patient_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">patients_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">patient_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flatten an array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="c1"># Get patient outcome labels</span>
    <span class="k">if</span> <span class="n">balance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">patient_outcome_labels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">patients_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">balance</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patient_list</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">patient_outcome_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">patient_list</span><span class="p">]</span>
    <span class="c1"># Get unique outcomes</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">patient_outcome_labels</span><span class="p">))</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>
    <span class="c1"># Delayed import in case CPLEX not installed</span>
    <span class="kn">import</span> <span class="nn">slideflow.io.preservedsite.crossfolds</span> <span class="k">as</span> <span class="nn">cv</span>

    <span class="n">site_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">patients_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patient_list</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">patient_list</span><span class="p">,</span> <span class="n">patient_outcome_labels</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient&#39;</span><span class="p">,</span> <span class="s1">&#39;outcome_label&#39;</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="s1">&#39;outcome_label&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">target_column</span><span class="o">=</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
    <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[bold]Train/val split with Preserved-Site Cross-Val&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[bold]Category</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_unique</span><span class="p">)]</span>
    <span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">num_labels_matching</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">CV</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">outcome_label</span> <span class="o">==</span> <span class="n">o</span><span class="p">)]</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">))</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_labels_matching</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;K-fold-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matching</span><span class="p">))</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">CV</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">ni</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;patient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">splits</span>


<span class="k">def</span> <span class="nf">split_patients_balanced</span><span class="p">(</span>
    <span class="n">patients_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">balance</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split a dictionary of patients into n groups, balancing by outcome.</span>

<span class="sd">    Splits are balanced according to key &quot;balance&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        patients_dict (dict): Nested ditionary mapping patient names to</span>
<span class="sd">            dict of outcomes: labels</span>
<span class="sd">        n (int): Number of splits to generate.</span>
<span class="sd">        balance (str): Annotation header to balance splits across.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of patient splits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patient_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">patients_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">patient_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flatten an array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="c1"># Get patient outcome labels</span>
    <span class="n">patient_outcome_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">patients_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">balance</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patient_list</span>
    <span class="p">]</span>
    <span class="c1"># Get unique outcomes</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">patient_outcome_labels</span><span class="p">))</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>

    <span class="c1"># Now, split patient_list according to outcomes</span>
    <span class="n">pt_by_outcome</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patient_list</span> <span class="k">if</span> <span class="n">patients_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">balance</span><span class="p">]</span> <span class="o">==</span> <span class="n">uo</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">uo</span> <span class="ow">in</span> <span class="n">unique_labels</span>
    <span class="p">]</span>
    <span class="c1"># Then, for each sublist, split into n components</span>
    <span class="n">pt_by_outcome_by_n</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">split_list</span><span class="p">(</span><span class="n">sub_l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">sub_l</span> <span class="ow">in</span> <span class="n">pt_by_outcome</span>
    <span class="p">]</span>
    <span class="c1"># Print splitting as a table</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;[bold]Category</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_unique</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">clist</span> <span class="ow">in</span> <span class="n">pt_by_outcome_by_n</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;K-fold-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matching</span><span class="p">))</span>
    <span class="c1"># Join sublists</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">flatten</span><span class="p">([</span>
            <span class="n">item</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pt_by_outcome_by_n</span>
        <span class="p">])</span> <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">splits</span>


<span class="k">def</span> <span class="nf">split_patients</span><span class="p">(</span><span class="n">patients_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split a dictionary of patients into n groups.</span>

<span class="sd">    Args:</span>
<span class="sd">        patients_dict (dict): Nested ditionary mapping patient names to</span>
<span class="sd">            dict of outcomes: labels</span>
<span class="sd">        n (int): Number of splits to generate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of patient splits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patient_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">patients_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">patient_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">split_list</span><span class="p">(</span><span class="n">patient_list</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

<span class="c1"># -----------------------------------------------------------------------------</span>


<div class="viewcode-block" id="Dataset"><a class="viewcode-back" href="../../../dataset/#slideflow.Dataset">[docs]</a><span class="k">class</span> <span class="nc">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Supervises organization and processing of slides, tfrecords, and tiles.</span>

<span class="sd">    Datasets can be comprised of one or more sources, where a source is a</span>
<span class="sd">    combination of slides and any associated regions of interest (ROI) and</span>
<span class="sd">    extracted image tiles (stored as TFRecords or loose images).</span>

<span class="sd">    Datasets can be created in two ways: either by loading one dataset source,</span>
<span class="sd">    or by loading a dataset configuration that contains information about</span>
<span class="sd">    multiple dataset sources.</span>

<span class="sd">    For the first approach, the dataset source configuration is provided via</span>
<span class="sd">    keyword arguments (``tiles``, ``tfrecords``, ``slides``, and ``roi``).</span>
<span class="sd">    Each is a path to a directory containing the respective data.</span>

<span class="sd">    For the second approach, the first argument ``config`` is either a nested</span>
<span class="sd">    dictionary containing the configuration for multiple dataset sources, or</span>
<span class="sd">    a path to a JSON file with this information. The second argument is a list</span>
<span class="sd">    of dataset sources to load (keys from the ``config`` dictionary).</span>

<span class="sd">    With either approach, slide/patient-level annotations are provided through</span>
<span class="sd">    the ``annotations`` keyword argument, which can either be a path to a CSV</span>
<span class="sd">    file, or a pandas DataFrame, which must contain at minimum the column</span>
<span class="sd">    &#39;`patient`&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">tfrecords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">roi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a Dataset to organize processed images.</span>

<span class="sd">        Examples</span>
<span class="sd">            Load a dataset via keyword arguments.</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    dataset = Dataset(</span>
<span class="sd">                        tfrecords=&#39;../path&#39;,</span>
<span class="sd">                        slides=&#39;../path&#39;,</span>
<span class="sd">                        annotations=&#39;../file.csv&#39;</span>
<span class="sd">                    )</span>

<span class="sd">            Load a dataset configuration file and specify dataset source(s).</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    dataset = Dataset(</span>
<span class="sd">                        config=&#39;../path/to/config.json&#39;,</span>
<span class="sd">                        sources=[&#39;Lung_Adeno&#39;, &#39;Lung_Squam&#39;],</span>
<span class="sd">                        annotations=&#39;../file.csv</span>
<span class="sd">                    )</span>

<span class="sd">        Args:</span>
<span class="sd">            config (str, dict): Either a dictionary or a path to a JSON file.</span>
<span class="sd">                If a dictionary, keys should be dataset source names, and</span>
<span class="sd">                values should be dictionaries containing the keys &#39;tiles&#39;,</span>
<span class="sd">                &#39;tfrecords&#39;, &#39;roi&#39;, and/or &#39;slides&#39;, specifying directories for</span>
<span class="sd">                each dataset source. If `config` is a str, it should be a path</span>
<span class="sd">                to a JSON file containing a dictionary with the same</span>
<span class="sd">                formatting. If None, tiles, tfrecords, roi and/or slides should</span>
<span class="sd">                be manually provided via keyword arguments. Defaults to None.</span>
<span class="sd">            sources (List[str]): List of dataset sources to include from</span>
<span class="sd">                configuration. If not provided, will use all sources in the</span>
<span class="sd">                provided configuration. Defaults to None.</span>
<span class="sd">            tile_px (int): Tile size in pixels.</span>
<span class="sd">            tile_um (int or str): Tile size in microns (int) or magnification</span>
<span class="sd">                (str, e.g. &quot;20x&quot;).</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            filters (dict, optional): Dataset filters to use for</span>
<span class="sd">                selecting slides. See :meth:`slideflow.Dataset.filter` for</span>
<span class="sd">                more information. Defaults to None.</span>
<span class="sd">            filter_blank (list(str) or str, optional): Skip slides that have</span>
<span class="sd">                blank values in these patient annotation columns.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Only include slides with this</span>
<span class="sd">                many tiles at minimum. Defaults to 0.</span>
<span class="sd">            annotations (str or pd.DataFrame, optional): Path</span>
<span class="sd">                to annotations file or pandas DataFrame with slide-level</span>
<span class="sd">                annotations. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            errors.SourceNotFoundError: If provided source does not exist</span>
<span class="sd">                in the dataset config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">assert_is_mag</span><span class="p">(</span><span class="n">tile_um</span><span class="p">)</span>
            <span class="n">tile_um</span> <span class="o">=</span> <span class="n">tile_um</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">=</span> <span class="n">tile_px</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="o">=</span> <span class="n">tile_um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">filters</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">filter_blank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_blank</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_blank</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">filter_blank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_tiles</span> <span class="o">=</span> <span class="n">min_tiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, int]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_weights</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Dict]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[pd.DataFrame]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations_file</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tfrecords</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">slides</span><span class="p">))</span>
           <span class="ow">and</span> <span class="p">(</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When initializing a Dataset object via keywords (tiles, &quot;</span>
                <span class="s2">&quot;tfrecords, slides, roi), the arguments &#39;config&#39; and &#39;sources&#39;&quot;</span>
                <span class="s2">&quot; are invalid.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tfrecords</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">slides</span><span class="p">)):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">tfrecords</span><span class="o">=</span><span class="n">tfrecords</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="n">tiles</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">slides</span><span class="o">=</span><span class="n">slides</span>
            <span class="p">))</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
            <span class="n">loaded_config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="s2">&quot;&lt;dict&gt;&quot;</span>
            <span class="n">loaded_config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1"># Read dataset sources from the configuration</span>
        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing argument &#39;sources&#39;&quot;</span><span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">sources</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">loaded_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sources</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">sources_list</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SourceNotFoundError</span><span class="p">(</span><span class="n">sources_list</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">missing_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_sources</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The following sources were not found in the dataset &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;configuration: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Create labels for each source based on tile size</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tile_px</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tile_um</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tile_size_label</span><span class="p">(</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

        <span class="c1"># Load annotations</span>
        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_annotations</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>   <span class="c1"># noqa D105</span>
        <span class="n">_b</span> <span class="o">=</span> <span class="s2">&quot;Dataset(config=</span><span class="si">{!r}</span><span class="s2">, sources=</span><span class="si">{!r}</span><span class="s2">, tile_px=</span><span class="si">{!r}</span><span class="s2">, tile_um=</span><span class="si">{!r}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">_b</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pandas DataFrame of all loaded clinical annotations.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of tiles in tfrecords after filtering/clipping.&quot;&quot;&quot;</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">tfr</span> <span class="ow">in</span> <span class="n">m</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">()</span>
        <span class="n">n_tiles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;clipped&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span> <span class="k">else</span> <span class="n">m</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;clipped&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n_tiles</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the active filters, if any.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_blank</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the active filter_blank filter, if any.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_blank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the active min_tiles filter, if any (defaults to 0).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_tiles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filtered_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pandas DataFrame of clinical annotations, after filtering.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>

            <span class="c1"># Only return slides with annotation values specified in &quot;filters&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">filter_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">filter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_ann</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Filter header </span><span class="si">{</span><span class="n">filter_key</span><span class="si">}</span><span class="s2"> not in annotations.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">filter_vals</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">filter_key</span><span class="p">])</span>
                    <span class="n">f_ann</span> <span class="o">=</span> <span class="n">f_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_ann</span><span class="p">[</span><span class="n">filter_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">filter_vals</span><span class="p">)]</span>

            <span class="c1"># Filter out slides that are blank in a given annotation</span>
            <span class="c1"># column (&quot;filter_blank&quot;)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_blank</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_blank</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_blank</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_ann</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetFilterError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Header </span><span class="si">{</span><span class="n">fb</span><span class="si">}</span><span class="s2"> not found in annotations.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">f_ann</span> <span class="o">=</span> <span class="n">f_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_ann</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
                    <span class="n">f_ann</span> <span class="o">=</span> <span class="n">f_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">f_ann</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">)]</span>

            <span class="c1"># Filter out slides that do not meet minimum number of tiles</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tiles</span><span class="p">:</span>
                <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">man_slides</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">manifest</span>
                              <span class="k">if</span> <span class="n">manifest</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tiles</span><span class="p">]</span>
                <span class="n">f_ann</span> <span class="o">=</span> <span class="n">f_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_ann</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">man_slides</span><span class="p">)]</span>

            <span class="k">return</span> <span class="n">f_ann</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">img_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format of images stored in TFRecords (jpg/png).</span>

<span class="sd">        Verifies all tfrecords share the same image format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Image format of tfrecords (PNG or JPG), or None if no</span>
<span class="sd">            tfrecords have been extracted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_img_format</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_tfrecords_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized dataset source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;tfrecords&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_tiles_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized dataset source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;tiles&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tiles&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_roi_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized dataset source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;roi&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_slides_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized dataset source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;slides&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_assert_size_matches_hp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="s2">&quot;ModelParams&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if dataset tile size (px/um) matches the given parameters.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">hp_px</span> <span class="o">=</span> <span class="n">hp</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">]</span>
            <span class="n">hp_um</span> <span class="o">=</span> <span class="n">hp</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">ModelParams</span><span class="p">):</span>
            <span class="n">hp_px</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span>
            <span class="n">hp_um</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized hyperparameter type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">!=</span> <span class="n">hp_px</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="o">!=</span> <span class="n">hp_um</span><span class="p">:</span>
            <span class="n">d_sz</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="si">}</span><span class="s1">px, tile_um=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="n">m_sz</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">hp_px</span><span class="si">}</span><span class="s1">px, tile_um=</span><span class="si">{</span><span class="n">hp_um</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dataset tile size </span><span class="si">{</span><span class="n">d_sz</span><span class="si">}</span><span class="s2"> does not match model </span><span class="si">{</span><span class="n">m_sz</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotations</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load annotations.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotations (Union[str, pd.DataFrame]): Either path to annotations</span>
<span class="sd">                in CSV format, or a pandas DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            errors.AnnotationsError: If annotations are incorrectly formatted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">annotations</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Unable to find annotations file </span><span class="si">{</span><span class="n">annotations</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ann_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">ann_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="n">ann_df</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations_file</span> <span class="o">=</span> <span class="n">annotations</span>
            <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">EmptyDataError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to load empty annotations </span><span class="si">{</span><span class="n">annotations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="n">annotations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid annotations format; expected path or DataFrame&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Check annotations</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="s2">&quot;Only one annotations column detected (is it in CSV format?)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="s2">&quot;Annotations file has duplicate headers; all must be unique&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;patient&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="s2">&quot;Patient identifier &#39;patient&#39; missing in annotations.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;slide&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                    <span class="s2">&quot;If loading annotations from a pandas DataFrame,&quot;</span>
                    <span class="s2">&quot; must include column &#39;slide&#39; containing slide names.&quot;</span>
                <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Column &#39;slide&#39; missing in annotations.&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to associate patients with slides...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_annotations_with_slidenames</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_annotations</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>

        <span class="c1"># Check for duplicate slides</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">())]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ann</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="n">dup_slide_idx</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span>
            <span class="n">dup_slides</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dup_slide_idx</span><span class="p">]</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Duplicate slides found in annotations: </span><span class="si">{</span><span class="n">dup_slides</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dataset with mini-batch balancing configured.</span>

<span class="sd">        Mini-batch balancing can be configured at tile, slide, patient, or</span>
<span class="sd">        category levels.</span>

<span class="sd">        Balancing information is saved to the attribute ``prob_weights``, which</span>
<span class="sd">        is used by the interleaving dataloaders when sampling from tfrecords</span>
<span class="sd">        to create a batch.</span>

<span class="sd">        Tile level balancing will create prob_weights reflective of the number</span>
<span class="sd">        of tiles per slide, thus causing the batch sampling to mirror random</span>
<span class="sd">        sampling from the entire population of  tiles (rather than randomly</span>
<span class="sd">        sampling from slides).</span>

<span class="sd">        Slide level balancing is the default behavior, where batches are</span>
<span class="sd">        assembled by randomly sampling from each slide/tfrecord with equal</span>
<span class="sd">        probability. This balancing behavior would be the same as no balancing.</span>

<span class="sd">        Patient level balancing is used to randomly sample from individual</span>
<span class="sd">        patients with equal probability. This is distinct from slide level</span>
<span class="sd">        balancing, as some patients may have multiple slides per patient.</span>

<span class="sd">        Category level balancing takes a list of annotation header(s) and</span>
<span class="sd">        generates prob_weights such that each category is sampled equally.</span>
<span class="sd">        This requires categorical outcomes.</span>

<span class="sd">        Args:</span>
<span class="sd">            headers (list of str, optional): List of annotation headers if</span>
<span class="sd">                balancing by category. Defaults to None.</span>
<span class="sd">            strategy (str, optional): &#39;tile&#39;, &#39;slide&#39;, &#39;patient&#39; or &#39;category&#39;.</span>
<span class="sd">                Create prob_weights used to balance dataset batches to evenly</span>
<span class="sd">                distribute slides, patients, or categories in a given batch.</span>
<span class="sd">                Tile-level balancing generates prob_weights reflective of the</span>
<span class="sd">                total number of tiles in a slide. Defaults to &#39;category.&#39;</span>
<span class="sd">            force (bool, optional): If using category-level balancing,</span>
<span class="sd">                interpret all headers as categorical variables, even if the</span>
<span class="sd">                header appears to be a float.</span>

<span class="sd">        Returns:</span>
<span class="sd">            balanced :class:`slideflow.Dataset` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">]</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tfr</span><span class="p">:</span> <span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
                  <span class="k">if</span> <span class="s1">&#39;clipped&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span>
                  <span class="k">else</span> <span class="n">manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;clipped&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tfrecords</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetBalanceError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to balance; no tfrecords found.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">or</span> <span class="n">strategy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;tile&#39;</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">prob_weights</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">totals</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;slide&#39;</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">prob_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">tfr</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tfrecords</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;patient&#39;</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>  <span class="c1"># Maps tfrecords to patients</span>
            <span class="n">r_pts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps patients to list of tfrecords</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">slide</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">pts</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r_pts</span><span class="p">:</span>
                    <span class="n">r_pts</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="n">slide</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r_pts</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="n">slide</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide</span><span class="p">]</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">prob_weights</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_pts</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_pts</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)]]))</span>
                <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;category&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Category balancing requires headers.&#39;</span><span class="p">)</span>
            <span class="c1"># Ensure that header is not type &#39;float&#39;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">is_float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Headers </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span><span class="s2"> appear to be `float`. &quot;</span>
                    <span class="s2">&quot;Categorical outcomes required for balancing. &quot;</span>
                    <span class="s2">&quot;To force balancing with these outcomes, pass &quot;</span>
                    <span class="s2">&quot;`force=True` to Dataset.balance()&quot;</span>
                <span class="p">)</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cats</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Dict]</span>
            <span class="n">cat_prob</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tfr_cats</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
            <span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">:</span>
                <span class="n">slide</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span>
                <span class="n">balance_cat</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                <span class="n">balance_cat_str</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">balance_cat</span><span class="p">))</span>
                <span class="n">tfr_cats</span><span class="p">[</span><span class="n">tfrecord</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance_cat_str</span>
                <span class="n">tiles</span> <span class="o">=</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfrecord</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">balance_cat_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
                    <span class="n">cats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">balance_cat_str</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;num_slides&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;num_tiles&#39;</span><span class="p">:</span> <span class="n">tiles</span>
                    <span class="p">}})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cats</span><span class="p">[</span><span class="n">balance_cat_str</span><span class="p">][</span><span class="s1">&#39;num_slides&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cats</span><span class="p">[</span><span class="n">balance_cat_str</span><span class="p">][</span><span class="s1">&#39;num_tiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles</span>
            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
                <span class="n">min_cat_slides</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span>
                    <span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;num_slides&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cats</span>
                <span class="p">])</span>
                <span class="n">slides_in_cat</span> <span class="o">=</span> <span class="n">cats</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;num_slides&#39;</span><span class="p">]</span>
                <span class="n">cat_prob</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_cat_slides</span> <span class="o">/</span> <span class="n">slides_in_cat</span>
            <span class="n">total_prob</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cat_prob</span><span class="p">[</span><span class="n">tfr_cats</span><span class="p">[</span><span class="n">tfr</span><span class="p">]]</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">])</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">prob_weights</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="n">cat_prob</span><span class="p">[</span><span class="n">tfr_cats</span><span class="p">[</span><span class="n">tfr</span><span class="p">]]</span><span class="o">/</span><span class="n">total_prob</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">build_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build index files for TFRecords.</span>

<span class="sd">        Args:</span>
<span class="sd">            force (bool): Force re-build existing indices.</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            num_workers (int, optional): Number of workers to use for</span>
<span class="sd">                building indices. Defaults to num_cpus, up to maximum of 16.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">index_to_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
            <span class="c1"># Remove existing indices</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">():</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_to_update</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">():</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">:</span>
                    <span class="n">index_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">index_has_locations</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                      <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tfrecord_has_locations</span><span class="p">(</span><span class="n">tfr</span><span class="p">)):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">index_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index_to_update</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Single thread.</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">index_to_update</span><span class="p">,</span>
                             <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Updating index files...&#39;</span><span class="p">,</span>
                             <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">index_to_update</span><span class="p">),</span>
                             <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">_create_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiprocessing.</span>
            <span class="n">index_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_create_index</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(),</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">index_fn</span><span class="p">,</span> <span class="n">index_to_update</span><span class="p">),</span>
                        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Updating index files...&#39;</span><span class="p">,</span>
                        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">index_to_update</span><span class="p">),</span>
                        <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cell_segmentation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">diam_um</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;cellpose.models.Cellpose&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cyto2&#39;</span><span class="p">,</span>
        <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">diam_mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">qc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">qc_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">q_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_centroid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">save_flow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform cell segmentation on slides, saving segmentation masks.</span>

<span class="sd">        Args:</span>
<span class="sd">            diam_um (int, optional): Cell segmentation diameter, in microns.</span>
<span class="sd">            dest (str): Destination in which to save cell segmentation masks.</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            batch_size (int): Batch size for cell segmentation. Defaults to 8.</span>
<span class="sd">            cp_thresh (float): Cell probability threshold. All pixels with</span>
<span class="sd">                value above threshold kept for masks, decrease to find more and</span>
<span class="sd">                larger masks. Defaults to 0.</span>
<span class="sd">            diam_mean (int, optional): Cell diameter to detect, in pixels</span>
<span class="sd">                (without image resizing). If None, uses Cellpose defaults (17</span>
<span class="sd">                for the &#39;nuclei&#39; model, 30 for all others).</span>
<span class="sd">            downscale (float): Factor by which to downscale generated masks</span>
<span class="sd">                after calculation. Defaults to None (keep masks at original</span>
<span class="sd">                size).</span>
<span class="sd">            flow_threshold (float): Flow error threshold (all cells with errors</span>
<span class="sd">                below threshold are kept). Defaults to 0.4.</span>
<span class="sd">            gpus (int, list(int)): GPUs to use for cell segmentation.</span>
<span class="sd">                Defaults to 0 (first GPU).</span>
<span class="sd">            interp (bool): Interpolate during 2D dynamics. Defaults to True.</span>
<span class="sd">            qc (str): Slide-level quality control method to use before</span>
<span class="sd">                performing cell segmentation. Defaults to &quot;Otsu&quot;.</span>
<span class="sd">            model (str, :class:`cellpose.models.Cellpose`): Cellpose model to</span>
<span class="sd">                use for cell segmentation. May be any valid cellpose model.</span>
<span class="sd">                Defaults to &#39;cyto2&#39;.</span>
<span class="sd">            mpp (float): Microns-per-pixel at which cells should be segmented.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            num_workers (int, optional): Number of workers.</span>
<span class="sd">                Defaults to 2 * num_gpus.</span>
<span class="sd">            save_centroid (bool): Save mask centroids. Increases memory</span>
<span class="sd">                utilization slightly. Defaults to True.</span>
<span class="sd">            save_flow (bool): Save flow values for the whole-slide image.</span>
<span class="sd">                Increases memory utilization. Defaults to False.</span>
<span class="sd">            sources (List[str]): List of dataset sources to include from</span>
<span class="sd">                configuration file.</span>
<span class="sd">            tile (bool): Tiles image to decrease GPU/CPU memory usage.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            verbose (bool): Verbose log output at the INFO level.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            window_size (int): Window size at which to segment cells across</span>
<span class="sd">                a whole-slide image. Defaults to 256.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">slideflow.cellseg</span> <span class="kn">import</span> <span class="n">segment_slide</span>

        <span class="k">if</span> <span class="n">qc_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qc_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">slide_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">n_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span>
            <span class="n">slide_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slide_list</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-masks.zip&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">n_skipped</span> <span class="o">=</span> <span class="n">n_all</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_skipped</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping </span><span class="si">{}</span><span class="s2"> slides (masks already generated)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">n_skipped</span>
                <span class="p">))</span>
        <span class="k">if</span> <span class="n">slide_list</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmenting cells for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> slides.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No slides found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">diam_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diam_mean</span> <span class="o">=</span> <span class="mi">30</span> <span class="k">if</span> <span class="n">model</span> <span class="o">!=</span> <span class="s1">&#39;nuclei&#39;</span> <span class="k">else</span> <span class="mi">17</span>
        <span class="n">tile_um</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">diam_um</span> <span class="o">/</span> <span class="n">diam_mean</span><span class="p">))</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">TileExtractionProgress</span><span class="p">()</span>
        <span class="n">speed_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="s2">&quot;Speed: &quot;</span><span class="p">,</span> <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">slide_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="s2">&quot;Slides: &quot;</span><span class="p">,</span> <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;slide_progress&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>  <span class="c1"># type: Queue</span>
        <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">_fill_queue</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">slide_list</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">pb</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cleanup_progress</span><span class="p">(</span><span class="n">pb</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">slide_path</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">slide_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span>
                    <span class="n">slide_path</span><span class="p">,</span>
                    <span class="n">tile_px</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span>
                    <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">qc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wsi</span><span class="o">.</span><span class="n">qc</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="o">**</span><span class="n">qc_kwargs</span><span class="p">)</span>
                <span class="n">segment_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
                    <span class="s2">&quot;Segmenting... &quot;</span><span class="p">,</span>
                    <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;slide_progress&quot;</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">wsi</span><span class="o">.</span><span class="n">estimated_num_tiles</span>
                <span class="p">)</span>
                <span class="c1"># Perform segmentation and save</span>
                <span class="n">segmentation</span> <span class="o">=</span> <span class="n">segment_slide</span><span class="p">(</span>
                    <span class="n">wsi</span><span class="p">,</span>
                    <span class="n">pb</span><span class="o">=</span><span class="n">pb</span><span class="p">,</span>
                    <span class="n">pb_tasks</span><span class="o">=</span><span class="p">[</span><span class="n">speed_task</span><span class="p">,</span> <span class="n">segment_task</span><span class="p">],</span>
                    <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">diam_mean</span><span class="o">=</span><span class="n">diam_mean</span><span class="p">,</span>
                    <span class="n">save_flow</span><span class="o">=</span><span class="n">save_flow</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">mask_dest</span> <span class="o">=</span> <span class="n">dest</span> <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dirname</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span>
                <span class="n">segmentation</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">mask_dest</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wsi</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-masks.zip&#39;</span><span class="p">),</span>
                    <span class="n">flows</span><span class="o">=</span><span class="n">save_flow</span><span class="p">,</span>
                    <span class="n">centroids</span><span class="o">=</span><span class="n">save_centroid</span><span class="p">)</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">slide_task</span><span class="p">)</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">segment_task</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
                    <span class="n">_debuffer_slide</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span>
                <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check_duplicates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">px</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">mse_thresh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for duplicate slides by comparing slide thumbnails.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (`slideflow.Dataset`, optional): Also check for</span>
<span class="sd">                duplicate slides between this dataset and the provided dataset.</span>
<span class="sd">            px (int): Pixel size at which to compare thumbnails.</span>
<span class="sd">                Defaults to 64.</span>
<span class="sd">            mse_thresh (int): MSE threshold below which an image pair is</span>
<span class="sd">                considered duplicate. Defaults to 100.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str], optional: List of path pairs of potential duplicates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">cv2</span>

        <span class="n">thumbs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dups</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">mse</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calulate the mean squared error between two image matrices.&quot;&quot;&quot;</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">B</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">err</span>

        <span class="k">def</span> <span class="nf">img_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Read and resize an image.&quot;&quot;&quot;</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_UNCHANGED</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span>
                              <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">),</span>
                              <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;this_dataset&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thumbnails</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;this_dataset&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;other_dataset&#39;</span><span class="p">))</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">thumbnails</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;other_dataset&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Scanning for duplicates...&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">dataset</span> <span class="ow">and</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;other_dataset&#39;</span><span class="p">:</span>
                        <span class="n">wsi_path</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">find_slide</span><span class="p">(</span><span class="n">slide</span><span class="o">=</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wsi_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_slide</span><span class="p">(</span><span class="n">slide</span><span class="o">=</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">wsi_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">img_from_path</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
                    <span class="n">thumbs</span><span class="p">[</span><span class="n">wsi_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>

                    <span class="c1"># Check if this thumbnail has a duplicate</span>
                    <span class="k">for</span> <span class="n">existing_img</span> <span class="ow">in</span> <span class="n">thumbs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">wsi_path</span> <span class="o">!=</span> <span class="n">existing_img</span><span class="p">:</span>
                            <span class="n">img2</span> <span class="o">=</span> <span class="n">thumbs</span><span class="p">[</span><span class="n">existing_img</span><span class="p">]</span>
                            <span class="n">img_mse</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">img_mse</span> <span class="o">&lt;</span> <span class="n">mse_thresh</span><span class="p">:</span>
                                <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="s1">&#39;Possible duplicates: &#39;</span>
                                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1"> (MSE: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">wsi_path</span><span class="p">,</span>
                                        <span class="n">existing_img</span><span class="p">,</span>
                                        <span class="n">mse</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">dups</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">wsi_path</span><span class="p">,</span> <span class="n">existing_img</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dups</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No duplicates found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dups</span><span class="p">)</span><span class="si">}</span><span class="s2"> possible duplicates found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dups</span>

    <span class="k">def</span> <span class="nf">clear_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dataset with all filters cleared.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`slideflow.Dataset` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_min_tiles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dataset with TFRecords clipped to a max number of tiles.</span>

<span class="sd">        Clip the number of tiles per tfrecord to a given maximum value and/or</span>
<span class="sd">        to the min number of tiles per patient or category.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_tiles (int, optional): Clip the maximum number of tiles per</span>
<span class="sd">                tfrecord to this number. Defaults to 0 (do not perform</span>
<span class="sd">                tfrecord-level clipping).</span>
<span class="sd">            strategy (str, optional): &#39;slide&#39;, &#39;patient&#39;, or &#39;category&#39;.</span>
<span class="sd">                Clip the maximum number of tiles to the minimum tiles seen</span>
<span class="sd">                across slides, patients, or categories. If &#39;category&#39;, headers</span>
<span class="sd">                must be provided. Defaults to None (do not perform group-level</span>
<span class="sd">                clipping).</span>
<span class="sd">            headers (list of str, optional): List of annotation headers to use</span>
<span class="sd">                if clipping by minimum category count (strategy=&#39;category&#39;).</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            clipped :class:`slideflow.Dataset` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;category&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetClipError</span><span class="p">(</span>
                <span class="s2">&quot;headers must be provided if clip strategy is &#39;category&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_tiles</span> <span class="ow">and</span> <span class="n">strategy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unclip</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">]</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">{</span><span class="n">tfr</span><span class="p">:</span> <span class="n">manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tfrecords</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetClipError</span><span class="p">(</span><span class="s2">&quot;No tfrecords found.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;slide&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_tiles</span><span class="p">:</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">totals</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">max_tiles</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">totals</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="p">(</span><span class="n">clip</span> <span class="k">if</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">clip</span> <span class="k">else</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">manifest</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;patient&#39;</span><span class="p">:</span>
            <span class="n">patients</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>  <span class="c1"># Maps slide name to patient</span>
            <span class="n">rev_patients</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Will map patients to list of slide names</span>
            <span class="n">slide_totals</span> <span class="o">=</span> <span class="p">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">):</span> <span class="n">t</span> <span class="k">for</span> <span class="n">tfr</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">totals</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">slide</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">patients</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rev_patients</span><span class="p">:</span>
                    <span class="n">rev_patients</span><span class="p">[</span><span class="n">patients</span><span class="p">[</span><span class="n">slide</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rev_patients</span><span class="p">[</span><span class="n">patients</span><span class="p">[</span><span class="n">slide</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide</span><span class="p">]</span>
            <span class="n">tiles_per_patient</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">pt</span><span class="p">:</span> <span class="nb">sum</span><span class="p">([</span><span class="n">slide_totals</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">slide_list</span> <span class="ow">in</span> <span class="n">rev_patients</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">max_tiles</span><span class="p">:</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tiles_per_patient</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">max_tiles</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tiles_per_patient</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="p">(</span><span class="n">clip</span>
                      <span class="k">if</span> <span class="n">slide_totals</span><span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">clip</span>
                      <span class="k">else</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">manifest</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;category&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Category clipping requires arg `headers`&quot;</span><span class="p">)</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cat_fraction</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tfr_cats</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">:</span>
                <span class="n">slide</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span>
                <span class="n">balance_category</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                <span class="n">balance_cat_str</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">balance_category</span><span class="p">))</span>
                <span class="n">tfr_cats</span><span class="p">[</span><span class="n">tfrecord</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance_cat_str</span>
                <span class="n">tiles</span> <span class="o">=</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfrecord</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">balance_cat_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                    <span class="n">categories</span><span class="p">[</span><span class="n">balance_cat_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">categories</span><span class="p">[</span><span class="n">balance_cat_str</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tiles</span>

            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="n">min_cat_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">categories</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">])</span>
                <span class="n">cat_fraction</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_cat_count</span> <span class="o">/</span> <span class="n">categories</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span> <span class="o">*</span> <span class="n">cat_fraction</span><span class="p">[</span><span class="n">tfr_cats</span><span class="p">[</span><span class="n">tfr</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">manifest</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">max_tiles</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tfr</span><span class="p">:</span> <span class="p">(</span><span class="n">max_tiles</span> <span class="k">if</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_tiles</span> <span class="k">else</span> <span class="n">totals</span><span class="p">[</span><span class="n">tfr</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">manifest</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">convert_xml_rois</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert ImageScope XML ROI files to QuPath format CSV ROI files.&quot;&quot;&quot;</span>
        <span class="n">n_converted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xml_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">xml_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;roi&#39;</span><span class="p">],</span> <span class="s2">&quot;*.xml&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xml_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                        <span class="s1">&#39;No XML files found. Check dataset configuration.&#39;</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">xml</span> <span class="ow">in</span> <span class="n">xml_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sf</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">xml_to_csv</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">ROIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to convert XML roi </span><span class="si">{</span><span class="n">xml</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_converted</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Converted </span><span class="si">{</span><span class="n">n_converted</span><span class="si">}</span><span class="s1"> XML ROIs -&gt; CSV&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tile_dataframe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a pandas dataframe with tile-level ROI labels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pandas dataframe of all tiles, with the following columns:</span>
<span class="sd">            - ``loc_x``: X-coordinate of tile center</span>
<span class="sd">            - ``loc_y``: Y-coordinate of tile center</span>
<span class="sd">            - ``grid_x``: X grid index of the tile</span>
<span class="sd">            - ``grid_y``: Y grid index of the tile</span>
<span class="sd">            - ``roi_name``: Name of the ROI if tile is in an ROI, else None</span>
<span class="sd">            - ``roi_desc``: Description of the ROI if tile is in ROI, else None</span>
<span class="sd">            - ``label``: ROI label, if present.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">_get_tile_df</span><span class="p">,</span>
                <span class="n">tile_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="n">tile_um</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="n">rois</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">(),</span>
                <span class="n">stride_div</span><span class="o">=</span><span class="n">stride_div</span><span class="p">,</span>
                <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_df</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()),</span>
                            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Building...&#39;</span><span class="p">,</span>
                            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()),</span>
                            <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_unique_roi_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of unique ROI labels for all slides in this dataset.&quot;&quot;&quot;</span>

        <span class="c1"># Get a list of unique labels.</span>
        <span class="n">roi_unique_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">():</span>
            <span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_df</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roi_unique_labels</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">roi_unique_labels</span> <span class="o">+=</span> <span class="n">unique</span>
        <span class="n">without_nan</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
            <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">roi_unique_labels</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
        <span class="p">])</span>
        <span class="k">if</span> <span class="n">allow_empty</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roi_unique_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">without_nan</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">without_nan</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">without_nan</span>

    <span class="k">def</span> <span class="nf">extract_cells</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">masks_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SlideReport</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract cell images from slides, with a tile at each cell centroid.</span>

<span class="sd">        Requires that cells have already been segmented with</span>
<span class="sd">        ``Dataset.cell_segmentation()``.</span>

<span class="sd">        Args:</span>
<span class="sd">            masks_path (str): Location of saved segmentation masks.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            apply_masks (bool): Apply cell segmentation masks to the extracted</span>
<span class="sd">                tiles. Defaults to True.</span>
<span class="sd">            **kwargs: All other keyword arguments for</span>
<span class="sd">                :meth:`Dataset.extract_tiles()`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping slide paths to each slide&#39;s SlideReport</span>
<span class="sd">            (:class:`slideflow.slide.report.SlideReport`)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">slideflow.cellseg.seg_utils</span> <span class="kn">import</span> <span class="n">ApplySegmentation</span>

        <span class="c1"># Add WSI segmentation as slide-level transformation.</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="s1">&#39;qc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;qc&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">qc</span> <span class="o">=</span> <span class="p">[</span><span class="n">qc</span><span class="p">]</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ApplySegmentation</span><span class="p">(</span><span class="n">masks_path</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qc</span>

        <span class="c1"># Extract tiles from segmentation centroids.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span>
            <span class="n">from_centroids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_tiles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">save_tiles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_tfrecords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">roi_filter_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
        <span class="n">skip_extracted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">tma</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">randomize_origin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">q_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">qc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_edge_tiles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">artifact_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span>
        <span class="n">mpp_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SlideReport</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extract tiles from a group of slides.</span>

<span class="sd">        Extracted tiles are saved either loose image or in TFRecord format.</span>

<span class="sd">        Extracted tiles are either saved in TFRecord format</span>
<span class="sd">        (``save_tfrecords=True``, default) or as loose \*.jpg / \*.png images</span>
<span class="sd">        (``save_tiles=True``). TFRecords or image tiles are saved in the</span>
<span class="sd">        the tfrecord and tile directories configured by</span>
<span class="sd">        :class:`slideflow.Dataset`.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            save_tiles (bool, optional): Save tile images in loose format.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            save_tfrecords (bool): Save compressed image data from</span>
<span class="sd">                extracted tiles into TFRecords in the corresponding TFRecord</span>
<span class="sd">                directory. Defaults to True.</span>
<span class="sd">            source (str, optional): Name of dataset source from which to select</span>
<span class="sd">                slides for extraction. Defaults to None. If not provided, will</span>
<span class="sd">                default to all sources in project.</span>
<span class="sd">            stride_div (int): Stride divisor for tile extraction.</span>
<span class="sd">                A stride of 1 will extract non-overlapping tiles.</span>
<span class="sd">                A stride_div of 2 will extract overlapping tiles, with a stride</span>
<span class="sd">                equal to 50% of the tile width. Defaults to 1.</span>
<span class="sd">            enable_downsample (bool): Enable downsampling for slides.</span>
<span class="sd">                This may result in corrupted image tiles if downsampled slide</span>
<span class="sd">                layers are corrupted or incomplete. Defaults to True.</span>
<span class="sd">            roi_method (str): Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, or &#39;ignore&#39;.</span>
<span class="sd">                Determines how ROIs are used to extract tiles.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and skip the slide if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            roi_filter_method (str or float): Method of filtering tiles with</span>
<span class="sd">                ROIs. Either &#39;center&#39; or float (0-1). If &#39;center&#39;, tiles are</span>
<span class="sd">                filtered with ROIs based on the center of the tile. If float,</span>
<span class="sd">                tiles are filtered based on the proportion of the tile inside</span>
<span class="sd">                the ROI, and ``roi_filter_method`` is interpreted as a</span>
<span class="sd">                threshold. If the proportion of a tile inside the ROI is</span>
<span class="sd">                greater than this number, the tile is included. For example,</span>
<span class="sd">                if ``roi_filter_method=0.7``, a tile that is 80% inside of an</span>
<span class="sd">                ROI will be included, and a tile that is 50% inside of an ROI</span>
<span class="sd">                will be excluded. Defaults to &#39;center&#39;.</span>
<span class="sd">            skip_extracted (bool): Skip slides that have already</span>
<span class="sd">                been extracted. Defaults to True.</span>
<span class="sd">            tma (bool): Reads slides as Tumor Micro-Arrays (TMAs).</span>
<span class="sd">                Deprecated argument; all slides are now read as standard WSIs.</span>
<span class="sd">            randomize_origin (bool): Randomize pixel starting</span>
<span class="sd">                position during extraction. Defaults to False.</span>
<span class="sd">            buffer (str, optional): Slides will be copied to this directory</span>
<span class="sd">                before extraction. Defaults to None. Using an SSD or ramdisk</span>
<span class="sd">                buffer vastly improves tile extraction speed.</span>
<span class="sd">            q_size (int): Size of queue when using a buffer.</span>
<span class="sd">                Defaults to 2.</span>
<span class="sd">            qc (str, optional): &#39;otsu&#39;, &#39;blur&#39;, &#39;both&#39;, or None. Perform blur</span>
<span class="sd">                detection quality control - discarding tiles with detected</span>
<span class="sd">                out-of-focus regions or artifact - and/or otsu&#39;s method.</span>
<span class="sd">                Increases tile extraction time. Defaults to None.</span>
<span class="sd">            report (bool): Save a PDF report of tile extraction.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            normalizer (str, optional): Normalization strategy.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Stain normalization preset or</span>
<span class="sd">                path to a source image. Valid presets include &#39;v1&#39;, &#39;v2&#39;, and</span>
<span class="sd">                &#39;v3&#39;. If None, will use the default present (&#39;v3&#39;).</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Discard tiles</span>
<span class="sd">                with this fraction of whitespace. If 1, will not perform</span>
<span class="sd">                whitespace filtering. Defaults to 1.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace.</span>
<span class="sd">                If 1, will not perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            img_format (str, optional): &#39;png&#39; or &#39;jpg&#39;. Defaults to &#39;jpg&#39;.</span>
<span class="sd">                Image format to use in tfrecords. PNG (lossless) for fidelity,</span>
<span class="sd">                JPG (lossy) for efficiency.</span>
<span class="sd">            shuffle (bool, optional): Shuffle tiles prior to storage in</span>
<span class="sd">                tfrecords. Defaults to True.</span>
<span class="sd">            num_threads (int, optional): Number of worker processes for each</span>
<span class="sd">                tile extractor. When using cuCIM slide reading backend,</span>
<span class="sd">                defaults to the total number of available CPU cores, using the</span>
<span class="sd">                &#39;fork&#39; multiprocessing method. With Libvips, this defaults to</span>
<span class="sd">                the total number of available CPU cores or 32, whichever is</span>
<span class="sd">                lower, using &#39;spawn&#39; multiprocessing.</span>
<span class="sd">            qc_blur_radius (int, optional): Quality control blur radius for</span>
<span class="sd">                out-of-focus area detection. Used if qc=True. Defaults to 3.</span>
<span class="sd">            qc_blur_threshold (float, optional): Quality control blur threshold</span>
<span class="sd">                for detecting out-of-focus areas. Only used if qc=True.</span>
<span class="sd">                Defaults to 0.1</span>
<span class="sd">            qc_filter_threshold (float, optional): Float between 0-1. Tiles</span>
<span class="sd">                with more than this proportion of blur will be discarded.</span>
<span class="sd">                Only used if qc=True. Defaults to 0.6.</span>
<span class="sd">            qc_mpp (float, optional): Microns-per-pixel indicating image</span>
<span class="sd">                magnification level at which quality control is performed.</span>
<span class="sd">                Defaults to mpp=4 (effective magnification 2.5 X)</span>
<span class="sd">            dry_run (bool, optional): Determine tiles that would be extracted,</span>
<span class="sd">                but do not export any images. Defaults to None.</span>
<span class="sd">            max_tiles (int, optional): Only extract this many tiles per slide.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            use_edge_tiles (bool): Use edge tiles in extraction. Areas</span>
<span class="sd">                outside the slide will be padded white. Defaults to False.</span>
<span class="sd">            artifact_labels (list(str) or str, optional): List of ROI issue labels</span>
<span class="sd">                to treat as artifacts. Whenever this is not None, all the ROIs with</span>
<span class="sd">                referred label will be inverted with ROI.invert().</span>
<span class="sd">                Defaults to an empty list.</span>
<span class="sd">            mpp_override (float, optional): Override the microns-per-pixel</span>
<span class="sd">                for each slide. If None, will auto-detect microns-per-pixel</span>
<span class="sd">                for all slides and raise an error if MPP is not found.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping slide paths to each slide&#39;s SlideReport</span>
<span class="sd">            (:class:`slideflow.slide.report.SlideReport`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tma</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;tma=True is deprecated and will be removed in a future &quot;</span>
                <span class="s2">&quot;version. Tumor micro-arrays are read as standard slides. &quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;Dataset tile_px and tile_um must be != 0 to extract tiles&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>  <span class="c1"># type: List[str]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">all_reports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_annotations_slides</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artifact_labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">artifact_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">artifact_labels</span><span class="p">]</span>

        <span class="c1"># Log the active slide reading backend</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cucim&#39;</span> <span class="k">else</span> <span class="s1">&#39;cyan&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide reading backend: [</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span>

        <span class="c1"># Set up kwargs for tile extraction generator and quality control</span>
        <span class="n">qc_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;qc_&#39;</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;qc_&#39;</span><span class="p">}</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">log_extraction_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on dataset source [bold]</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">[/]...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">roi_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roi_dir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">src_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;dry_run&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dry_run&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">save_tfrecords</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tfrecords_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tfrecords path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">save_tfrecords</span><span class="p">:</span>
                    <span class="n">tfrecord_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                        <span class="n">src_conf</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">],</span>
                        <span class="n">src_conf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tfrecord_dir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">save_tiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiles_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tiles path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">save_tiles</span><span class="p">:</span>
                    <span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">src_conf</span><span class="p">[</span><span class="s1">&#39;tiles&#39;</span><span class="p">],</span> <span class="n">src_conf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tiles_dir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">save_tfrecords</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">save_tiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">save_tfrecords</span><span class="p">,</span> <span class="n">save_tiles</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
                <span class="n">tfrecord_dir</span><span class="p">,</span> <span class="n">tiles_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Prepare list of slides for extraction</span>
            <span class="n">slide_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>

            <span class="c1"># Check for interrupted or already-extracted tfrecords</span>
            <span class="k">if</span> <span class="n">skip_extracted</span> <span class="ow">and</span> <span class="n">save_tfrecords</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">_dir</span> <span class="o">=</span> <span class="n">tfrecord_dir</span> <span class="k">if</span> <span class="n">tfrecord_dir</span> <span class="k">else</span> <span class="n">tiles_dir</span>
                <span class="n">unfinished</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">((</span><span class="n">_dir</span><span class="p">),</span> <span class="s1">&#39;*.unfinished&#39;</span><span class="p">))</span>
                <span class="n">interrupted</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">unfinished</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interrupted</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Re-extracting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interrupted</span><span class="p">)</span><span class="si">}</span><span class="s1"> interrupted:&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">interrupted_slide</span> <span class="ow">in</span> <span class="n">interrupted</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">interrupted_slide</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">interrupted_slide</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">done</span><span class="p">[</span><span class="n">done</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">interrupted_slide</span><span class="p">)]</span>

                <span class="n">slide_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slide_list</span> <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">)</span><span class="si">}</span><span class="s1"> slides; already done.&#39;</span><span class="p">)</span>
            <span class="n">_tail</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(tile_px=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="si">}</span><span class="s2">, tile_um=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting tiles from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> slides </span><span class="si">{</span><span class="n">_tail</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Use multithreading if specified, extracting tiles</span>
            <span class="c1"># from all slides in the filtered list</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>  <span class="c1"># type: Queue</span>
                <span class="c1"># Forking incompatible with some libvips configurations</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;spawn&#39;</span> <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;libvips&#39;</span> <span class="k">else</span> <span class="s1">&#39;fork&#39;</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
                <span class="n">reports</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span>

                <span class="c1"># Use a single shared multiprocessing pool</span>
                <span class="k">if</span> <span class="s1">&#39;num_threads&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">num_threads</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">8</span>
                    <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;libvips&#39;</span><span class="p">:</span>
                        <span class="n">num_threads</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_threads</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_threads</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">num_threads</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                        <span class="n">num_threads</span><span class="p">,</span>
                        <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
                    <span class="p">)</span>
                    <span class="n">qc_kwargs</span><span class="p">[</span><span class="s1">&#39;pool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">ptype</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">num_threads</span><span class="si">}</span><span class="s1"> processes (pool=</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

                <span class="c1"># Set up the multiprocessing progress bar</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">TileExtractionProgress</span><span class="p">()</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
                    <span class="s2">&quot;Speed: &quot;</span><span class="p">,</span>
                    <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">slide_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Extracting (</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">,</span>
                    <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;slide_progress&quot;</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">))</span>

                <span class="n">wsi_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;tile_px&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                    <span class="s1">&#39;tile_um&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                    <span class="s1">&#39;stride_div&#39;</span><span class="p">:</span> <span class="n">stride_div</span><span class="p">,</span>
                    <span class="s1">&#39;enable_downsample&#39;</span><span class="p">:</span> <span class="n">enable_downsample</span><span class="p">,</span>
                    <span class="s1">&#39;roi_dir&#39;</span><span class="p">:</span> <span class="n">roi_dir</span><span class="p">,</span>
                    <span class="s1">&#39;roi_method&#39;</span><span class="p">:</span> <span class="n">roi_method</span><span class="p">,</span>
                    <span class="s1">&#39;roi_filter_method&#39;</span><span class="p">:</span> <span class="n">roi_filter_method</span><span class="p">,</span>
                    <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;random&#39;</span> <span class="k">if</span> <span class="n">randomize_origin</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;pb&#39;</span><span class="p">:</span> <span class="n">pb</span><span class="p">,</span>
                    <span class="s1">&#39;use_edge_tiles&#39;</span><span class="p">:</span> <span class="n">use_edge_tiles</span><span class="p">,</span>
                    <span class="s1">&#39;artifact_labels&#39;</span><span class="p">:</span> <span class="n">artifact_labels</span><span class="p">,</span>
                    <span class="s1">&#39;mpp&#39;</span><span class="p">:</span> <span class="n">mpp_override</span>
                <span class="p">}</span>
                <span class="n">extraction_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;tfrecord_dir&#39;</span><span class="p">:</span> <span class="n">tfrecord_dir</span><span class="p">,</span>
                    <span class="s1">&#39;tiles_dir&#39;</span><span class="p">:</span> <span class="n">tiles_dir</span><span class="p">,</span>
                    <span class="s1">&#39;reports&#39;</span><span class="p">:</span> <span class="n">reports</span><span class="p">,</span>
                    <span class="s1">&#39;qc&#39;</span><span class="p">:</span> <span class="n">qc</span><span class="p">,</span>
                    <span class="s1">&#39;generator_kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
                    <span class="s1">&#39;qc_kwargs&#39;</span><span class="p">:</span> <span class="n">qc_kwargs</span><span class="p">,</span>
                    <span class="s1">&#39;wsi_kwargs&#39;</span><span class="p">:</span> <span class="n">wsi_kwargs</span><span class="p">,</span>
                    <span class="s1">&#39;render_thumb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cleanup_progress</span><span class="p">(</span><span class="n">pb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
                        <span class="c1"># Start the worker threads</span>
                        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">=</span><span class="n">_fill_queue</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">slide_list</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_size</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                        <span class="c1"># Grab slide path from queue and start extraction</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                                <span class="k">break</span>
                            <span class="n">_tile_extractor</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">extraction_kwargs</span><span class="p">)</span>
                            <span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">slide_task</span><span class="p">)</span>
                            <span class="n">_debuffer_slide</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                            <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">_handle_slide_errors</span><span class="p">(</span><span class="n">slide</span><span class="p">):</span>
                                <span class="n">wsi</span> <span class="o">=</span> <span class="n">_prepare_slide</span><span class="p">(</span>
                                    <span class="n">slide</span><span class="p">,</span>
                                    <span class="n">report_dir</span><span class="o">=</span><span class="n">tfrecord_dir</span><span class="p">,</span>
                                    <span class="n">wsi_kwargs</span><span class="o">=</span><span class="n">wsi_kwargs</span><span class="p">,</span>
                                    <span class="n">qc</span><span class="o">=</span><span class="n">qc</span><span class="p">,</span>
                                    <span class="n">qc_kwargs</span><span class="o">=</span><span class="n">qc_kwargs</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">wsi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting tiles for </span><span class="si">{</span><span class="n">wsi</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="n">wsi_report</span> <span class="o">=</span> <span class="n">wsi</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span>
                                        <span class="n">tfrecord_dir</span><span class="o">=</span><span class="n">tfrecord_dir</span><span class="p">,</span>
                                        <span class="n">tiles_dir</span><span class="o">=</span><span class="n">tiles_dir</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span>
                                    <span class="p">)</span>
                                    <span class="n">reports</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">wsi</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="n">wsi_report</span><span class="p">})</span>
                                    <span class="k">del</span> <span class="n">wsi</span>
                            <span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">slide_task</span><span class="p">)</span>

                <span class="c1"># Generate PDF report.</span>
                <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating PDF (this may take some time)...&#39;</span><span class="p">,</span> <span class="p">)</span>
                    <span class="n">rep_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">reports</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="p">)</span>  <span class="c1"># type: List[SlideReport]</span>
                    <span class="n">all_reports</span> <span class="o">+=</span> <span class="n">rep_vals</span>
                    <span class="n">num_slides</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span>
                    <span class="n">img_kwargs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: Dict</span>
                    <span class="n">img_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">img_kwargs</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_update_kw_with_defaults</span><span class="p">(</span><span class="n">img_kwargs</span><span class="p">)</span>
                    <span class="n">report_meta</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">(</span>
                        <span class="n">tile_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                        <span class="n">tile_um</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                        <span class="n">qc</span><span class="o">=</span><span class="n">qc</span><span class="p">,</span>
                        <span class="n">total_slides</span><span class="o">=</span><span class="n">num_slides</span><span class="p">,</span>
                        <span class="n">slides_skipped</span><span class="o">=</span><span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rep_vals</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]),</span>
                        <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
                        <span class="n">stride</span><span class="o">=</span><span class="n">stride_div</span><span class="p">,</span>
                        <span class="n">gs_frac</span><span class="o">=</span><span class="n">img_kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_fraction&#39;</span><span class="p">],</span>
                        <span class="n">gs_thresh</span><span class="o">=</span><span class="n">img_kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_threshold&#39;</span><span class="p">],</span>
                        <span class="n">ws_frac</span><span class="o">=</span><span class="n">img_kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_fraction&#39;</span><span class="p">],</span>
                        <span class="n">ws_thresh</span><span class="o">=</span><span class="n">img_kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_threshold&#39;</span><span class="p">],</span>
                        <span class="n">normalizer</span><span class="o">=</span><span class="n">img_kwargs</span><span class="p">[</span><span class="s1">&#39;normalizer&#39;</span><span class="p">],</span>
                        <span class="n">img_format</span><span class="o">=</span><span class="n">img_kwargs</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">pdf_report</span> <span class="o">=</span> <span class="n">ExtractionReport</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rep_vals</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">meta</span><span class="o">=</span><span class="n">report_meta</span><span class="p">,</span>
                        <span class="n">pool</span><span class="o">=</span><span class="n">pool</span>
                    <span class="p">)</span>
                    <span class="n">_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
                    <span class="n">pdf_dir</span> <span class="o">=</span> <span class="n">tfrecord_dir</span> <span class="k">if</span> <span class="n">tfrecord_dir</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">pdf_report</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">pdf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;tile_extraction_report-</span><span class="si">{</span><span class="n">_time</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">pdf_report</span><span class="o">.</span><span class="n">update_csv</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">pdf_dir</span><span class="p">,</span> <span class="s1">&#39;extraction_report.csv&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">warn_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">pdf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;warn_report-</span><span class="si">{</span><span class="n">_time</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pdf_report</span><span class="o">.</span><span class="n">warn_txt</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">warn_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">warn_f</span><span class="p">:</span>
                            <span class="n">warn_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pdf_report</span><span class="o">.</span><span class="n">warn_txt</span><span class="p">)</span>

                <span class="c1"># Close the multiprocessing pool.</span>
                <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Update manifest &amp; rebuild indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">(</span><span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">all_reports</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_reports</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">report</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="n">report</span> <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">all_reports</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">extract_tiles_from_tfrecords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract tiles from a set of TFRecords.</span>

<span class="sd">        Args:</span>
<span class="sd">            dest (str): Path to directory in which to save tile images.</span>
<span class="sd">                If None, uses dataset default. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">to_extract_tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dest</span><span class="p">:</span>
                <span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiles_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;tiles&#39;</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tiles directory not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">to_extract_tfrecords</span><span class="p">:</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span><span class="n">tfr</span><span class="p">,</span> <span class="n">tiles_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a filtered dataset.</span>

<span class="sd">        This method can either accept a single argument (``filters``) or any</span>
<span class="sd">        combination of keyword arguments (``filters``, ``filter_blank``, or</span>
<span class="sd">        ``min_tiles``).</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            filters (dict, optional): Dictionary used for filtering</span>
<span class="sd">                the dataset. Dictionary keys should be column headers in the</span>
<span class="sd">                patient annotations, and the values should be the variable</span>
<span class="sd">                states to be included in the dataset. For example,</span>
<span class="sd">                ``filters={&#39;HPV_status&#39;: [&#39;negative&#39;, &#39;positive&#39;]}``</span>
<span class="sd">                would filter the dataset by the column ``HPV_status`` and only</span>
<span class="sd">                include slides with values of either ``&#39;negative&#39;`` or</span>
<span class="sd">                ``&#39;positive&#39;`` in this column.</span>
<span class="sd">                See `Filtering &lt;https://slideflow.dev/datasets_and_val/#filtering&gt;`_</span>
<span class="sd">                for further discussion. Defaults to None.</span>
<span class="sd">            filter_blank (list(str) or str, optional): Skip slides that have</span>
<span class="sd">                blank values in these patient annotation columns.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int): Filter out tfrecords that have less than this</span>
<span class="sd">                minimum number of tiles. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`slideflow.Dataset`: Dataset with filter added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;filters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;filter() accepts either one argument (filters), or any &quot;</span>
                <span class="s2">&quot;combination of keywords (filters, filter_blank, min_tiles)&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwarg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_blank&#39;</span><span class="p">,</span> <span class="s1">&#39;min_tiles&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown filtering argument </span><span class="si">{</span><span class="n">kwarg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;filters&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;filters&#39; must be a dict.&quot;</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;filter_blank&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">]]</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span> <span class="o">+=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;min_tiles&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;min_tiles&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;min_tiles&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;min_tiles&#39; must be an int.&quot;</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">_min_tiles</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;min_tiles&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">filter_bags_by_roi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bags_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">tile_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter bags by tiles in an ROI.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="c1">#TODO: extend to tfrecords</span>
        <span class="c1">#TODO: accelerate with multiprocessing</span>
        <span class="c1">#TODO: save filtered indices</span>
        <span class="c1">#TODO: copy bags config</span>

        <span class="k">if</span> <span class="n">tile_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tile_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile_dataframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="c1"># Subset the dataframe to only include tiles with an ROI</span>
        <span class="n">roi_df</span> <span class="o">=</span> <span class="n">tile_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tile_df</span><span class="o">.</span><span class="n">roi_name</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>

        <span class="n">n_complete</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">roi_df</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">bags_path</span><span class="p">,</span> <span class="n">slide</span><span class="o">+</span><span class="s1">&#39;.pt&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="c1"># Get the bag</span>
            <span class="n">bag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">bags_path</span><span class="p">,</span> <span class="n">slide</span><span class="o">+</span><span class="s1">&#39;.pt&#39;</span><span class="p">))</span>
            <span class="n">bag_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">bags_path</span><span class="p">,</span> <span class="n">slide</span><span class="o">+</span><span class="s1">&#39;.index.npz&#39;</span><span class="p">))[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>

            <span class="c1"># Subset the ROI based on this slide</span>
            <span class="n">slide_df</span> <span class="o">=</span> <span class="n">roi_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">roi_df</span><span class="o">.</span><span class="n">slide</span> <span class="o">==</span> <span class="n">slide</span><span class="p">]</span>

            <span class="c1"># Get the common locations (in an ROI)</span>
            <span class="n">bag_locs</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bag_index</span><span class="p">}</span>
            <span class="n">roi_locs</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">slide_df</span><span class="o">.</span><span class="n">loc_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">slide_df</span><span class="o">.</span><span class="n">loc_y</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
            <span class="n">common_locs</span> <span class="o">=</span> <span class="n">bag_locs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">roi_locs</span><span class="p">)</span>

            <span class="c1"># Find indices in the bag that match the common locations (in an ROI)</span>
            <span class="n">bag_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bag_index</span><span class="p">)</span> <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="n">common_locs</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">bag_i</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No common locations found for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slide</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Subset and save the bag</span>
            <span class="n">bag</span> <span class="o">=</span> <span class="n">bag</span><span class="p">[</span><span class="n">bag_i</span><span class="p">]</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">bag</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">slide</span><span class="o">+</span><span class="s1">&#39;.pt&#39;</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subset size (</span><span class="si">{}</span><span class="s2">): </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bag_index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bag</span><span class="p">)))</span>
            <span class="n">n_complete</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bag filtering complete. </span><span class="si">{}</span><span class="s2"> bags filtered.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_complete</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">find_rois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find an ROI path from a given slide.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide (str): Slide name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Matching path to ROI, if found. If not found, returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rois</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="o">==</span> <span class="n">slide</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">roi</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">find_slide</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">patient</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a slide path from a given slide or patient.</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            slide (str): Find a tfrecord associated with this slide name.</span>
<span class="sd">            patient (str): Find a tfrecord associated with this patient.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Matching path to slide, if found. If not found, returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply either slide or patient.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply either slide or patient, not both.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">({</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">slide</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">({</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="p">})</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matching</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">find_tfrecord</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">patient</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a TFRecord path from a given slide or patient.</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            slide (str): Find a tfrecord associated with this slide name.</span>
<span class="sd">            patient (str): Find a tfrecord associated with this patient.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Matching path to tfrecord, if found. Otherwise, returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply either slide or patient.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply either slide or patient, not both.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">({</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">slide</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">({</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="p">})</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matching</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">generate_feature_bags</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;BaseFeatureExtractor&quot;</span><span class="p">],</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force_regenerate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">slide_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">num_gpus</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate bags of tile-level features for slides for use with MIL models.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model from which to generate activations.</span>
<span class="sd">                May provide either this or &quot;pt_files&quot;</span>
<span class="sd">            outdir (str, optional): Save exported activations in .pt format.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            layers (list): Which model layer(s) generate activations.</span>
<span class="sd">                If ``model`` is a saved model, this defaults to &#39;postconv&#39;.</span>
<span class="sd">                Not used if ``model`` is pretrained feature extractor.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            force_regenerate (bool): Forcibly regenerate activations</span>
<span class="sd">                for all slides even if .pt file exists. Defaults to False.</span>
<span class="sd">            batch_size (int): Batch size during feature calculation.</span>
<span class="sd">                Defaults to 32.</span>
<span class="sd">            slide_batch_size (int): Interleave feature calculation across</span>
<span class="sd">                this many slides. Higher values may improve performance</span>
<span class="sd">                but require more memory. Defaults to 16.</span>
<span class="sd">            num_gpus (int): Number of GPUs to use for feature extraction.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            **kwargs: Additional keyword arguments are passed to</span>
<span class="sd">                :class:`slideflow.DatasetFeatures`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">torch_available</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Pytorch is required for generating feature bags. &quot;</span>
                <span class="s2">&quot;Please install Pytorch and try again.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Interpret model argument.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">is_extractor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="c1"># Model is a architecture name (for Imagenet pretrained model)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building feature extractor: [green]</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span>
            <span class="n">layer_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;layers&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">build_feature_extractor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">layer_kw</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="c1"># Model is a path to a trained slideflow model</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using model: [green]</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="c1"># Model is a string but not a path to a saved model</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; is neither a path to a saved model nor the name &quot;</span>
                <span class="s2">&quot;of a valid feature extractor (use sf.model.list_extractors() &quot;</span>
                <span class="s2">&quot;for a list of all available feature extractors).&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Model is a feature extractor object</span>
            <span class="kn">from</span> <span class="nn">slideflow.model.base</span> <span class="kn">import</span> <span class="n">BaseFeatureExtractor</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">BaseFeatureExtractor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; is neither a path to a saved model nor the name &quot;</span>
                    <span class="s2">&quot;of a valid feature extractor (use sf.model.list_extractors() &quot;</span>
                    <span class="s2">&quot;for a list of all available feature extractors).&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using feature extractor: [green]</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span>

        <span class="c1"># Create the pt_files directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># Detect already generated pt files</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">path_to_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;pt&#39;</span>
        <span class="p">]</span>

        <span class="c1"># Work from this dataset.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_regenerate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">):</span>
            <span class="n">all_slides</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">slides_to_generate</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_slides</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides_to_generate</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_slides</span><span class="p">):</span>
                <span class="n">to_skip</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_slides</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides_to_generate</span><span class="p">)</span>
                <span class="n">skip_p</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_skip</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_slides</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">skip_p</span><span class="si">}</span><span class="s2"> finished slides.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slides_to_generate</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No slides for which to generate features.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">outdir</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">slides_to_generate</span><span class="p">})</span>
            <span class="n">filtered_slides_to_generate</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_slides_to_generate</span><span class="p">)</span><span class="si">}</span><span class="s1"> slides&#39;</span><span class="p">)</span>

        <span class="c1"># Verify TFRecords are available</span>
        <span class="n">n_tfrecords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span>
        <span class="n">n_slides</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n_tfrecords</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to generate features; no TFRecords found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">outdir</span>
        <span class="k">elif</span> <span class="n">n_tfrecords</span> <span class="o">&lt;</span> <span class="n">n_slides</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> tfrecords missing.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_slides</span> <span class="o">-</span> <span class="n">n_tfrecords</span><span class="p">))</span>

        <span class="c1"># Rebuild any missing index files.</span>
        <span class="c1"># Must be done before the progress bar is started.</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Set up progress bar.</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">FeatureExtractionProgress</span><span class="p">()</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="s2">&quot;Speed: &quot;</span><span class="p">,</span>
            <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tiles</span>
        <span class="p">)</span>
        <span class="n">slide_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="s2">&quot;Generating...&quot;</span><span class="p">,</span>
            <span class="n">progress_type</span><span class="o">=</span><span class="s2">&quot;slide_progress&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="n">n_slides</span>
        <span class="p">)</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Prepare keyword arguments.</span>
        <span class="n">dts_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">include_preds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Set up activations interface.</span>
        <span class="c1"># Calculate features one slide at a time to reduce memory consumption.</span>
        <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cleanup_progress</span><span class="p">(</span><span class="n">pb</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">num_gpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">_export_bags</span><span class="p">(</span>
                    <span class="n">model</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="p">,</span>
                    <span class="n">slides</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">(),</span>
                    <span class="n">slide_batch_size</span><span class="o">=</span><span class="n">slide_batch_size</span><span class="p">,</span>
                    <span class="n">pb</span><span class="o">=</span><span class="n">pb</span><span class="p">,</span>
                    <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                    <span class="n">slide_task</span><span class="o">=</span><span class="n">slide_task</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">dts_kwargs</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;dump_config&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Feature extraction with multiple GPUs is only &quot;</span>
                        <span class="s2">&quot;supported for feature extractors with a dump_config() &quot;</span>
                        <span class="s2">&quot;attribute. Please set num_gpus=1 or use a different &quot;</span>
                        <span class="s2">&quot;feature extractor.&quot;</span>
                    <span class="p">)</span>
                <span class="kn">import</span> <span class="nn">torch</span>
                <span class="n">model_cfg</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extractors</span><span class="o">.</span><span class="n">extractor_to_config</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

                <span class="c1"># Mixed precision and channels_last config</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;mixed_precision&quot;</span><span class="p">):</span>
                    <span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mixed_precision</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mixed_precision</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;channels_last&quot;</span><span class="p">):</span>
                    <span class="n">channels_last</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">channels_last</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">channels_last</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">with</span> <span class="n">MultiprocessProgress</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="k">as</span> <span class="n">mp_pb</span><span class="p">:</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span>
                        <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">_distributed_export</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">model_cfg</span><span class="p">,</span>
                            <span class="n">dataset</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">(),</span>
                                                                <span class="n">num_gpus</span><span class="p">)],</span>
                            <span class="n">slide_batch_size</span><span class="p">,</span>
                            <span class="n">mp_pb</span><span class="o">.</span><span class="n">tracker</span><span class="p">,</span>
                            <span class="n">outdir</span><span class="p">,</span>
                            <span class="n">slide_task</span><span class="p">,</span>
                            <span class="n">dts_kwargs</span><span class="p">,</span>
                            <span class="n">mixed_precision</span><span class="p">,</span>
                            <span class="n">channels_last</span>
                        <span class="p">),</span>
                        <span class="n">nprocs</span><span class="o">=</span><span class="n">num_gpus</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_rois</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dest</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate ROIs using a U-Net model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model (zip) or model configuration (json).</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            overwrite (bool, optional): Overwrite existing ROIs. Defaults to False.</span>
<span class="sd">            dest (str, optional): Destination directory for generated ROIs.</span>
<span class="sd">                If not provided, uses the dataset&#39;s default ROI directory.</span>
<span class="sd">            sq_mm_threshold (float, optional): If not None, filter out ROIs with an area</span>
<span class="sd">                less than the given threshold (in square millimeters). Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Load the model configuration.</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">qc</span><span class="o">.</span><span class="n">StridedSegment</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Generating...&#39;</span><span class="p">):</span>

            <span class="c1"># Set the destination directory</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slide_source</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;roi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                    <span class="s2">&quot;No ROI directory set. Please set an ROI directory in the &quot;</span>
                    <span class="s2">&quot;dataset configuration, or provide a destination directory &quot;</span>
                    <span class="s2">&quot;with the `dest` argument.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

            <span class="c1"># Check if an ROI already exists.</span>
            <span class="n">existing_rois</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span> <span class="ow">in</span> <span class="n">existing_rois</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overwriting ROI for slide </span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI already exists for slide </span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1"># Load the slide and remove any existing auto-loaded ROIs.</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Working on </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slide</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">wsi</span><span class="o">.</span><span class="n">rois</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Generate and apply ROIs.</span>
                <span class="n">segment</span><span class="o">.</span><span class="n">generate_rois</span><span class="p">(</span><span class="n">wsi</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate ROIs for </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Export ROIs to CSV.</span>
            <span class="n">wsi</span><span class="o">.</span><span class="n">export_rois</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">wsi</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_slide_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the source of a given slide.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide (str): Slide name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Source name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">paths</span> <span class="ow">or</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">source</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find slide &#39;</span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tfrecord_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of locations stored in an associated TFRecord.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide (str): Slide name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tuples of (x, y) coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_tfrecord</span><span class="p">(</span><span class="n">slide</span><span class="o">=</span><span class="n">slide</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tfr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TFRecordsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find associated TFRecord for slide &#39;</span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="n">tfr_idx</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tfr_idx</span><span class="p">:</span>
            <span class="n">_create_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tfr_idx</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating index for </span><span class="si">{</span><span class="n">tfr</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tfr_idx</span><span class="p">)</span>
            <span class="n">_create_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_locations_from_tfrecord</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">harmonize_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">,</span>
        <span class="n">header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Harmonize labels with another dataset.</span>

<span class="sd">        Returns categorical label assignments converted to int, harmonized with</span>
<span class="sd">        another dataset to ensure label consistency between datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args (:class:`slideflow.Dataset`): Any number of Datasets.</span>
<span class="sd">            header (str): Categorical annotation header.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict mapping slide names to categories.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply kwarg &#39;header&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Harmonized labels require a single header.&#39;</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">my_unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">other_uniques</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dts</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">dts</span> <span class="ow">in</span> <span class="n">args</span>
        <span class="p">]</span>
        <span class="n">other_uniques</span> <span class="o">=</span> <span class="n">other_uniques</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">my_unique</span><span class="p">)]</span>
        <span class="n">uniques_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">other_uniques</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">all_unique</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">uniques_list</span><span class="p">)))</span>
        <span class="n">labels_to_int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_unique</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_unique</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">labels_to_int</span>

    <span class="k">def</span> <span class="nf">is_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if labels in the given header can all be converted to float.</span>

<span class="sd">        Args:</span>
<span class="sd">            header (str): Annotations column header.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: If all values from header can be converted to float.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;Annotations not loaded.&quot;</span><span class="p">)</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">filtered_labels</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">kfold_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preserved_site</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">site_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the dataset into k cross-folds.</span>

<span class="sd">        Args:</span>
<span class="sd">            k (int): Number of cross-folds.</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            labels (dict or str, optional):  Either a dictionary mapping slides</span>
<span class="sd">                to labels, or an outcome label (``str``). Used for balancing</span>
<span class="sd">                outcome labels in training and validation cohorts. If None,</span>
<span class="sd">                will not balance k-fold splits by outcome labels. Defaults</span>
<span class="sd">                to None.</span>
<span class="sd">            preserved_site (bool): Split with site-preserved cross-validation.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            site_labels (dict, optional): Dict mapping patients to site labels,</span>
<span class="sd">                or an outcome column with site labels. Only used for site</span>
<span class="sd">                preserved cross validation. Defaults to &#39;site&#39;.</span>
<span class="sd">            splits (str, optional): Path to JSON file containing validation</span>
<span class="sd">                splits. Defaults to None.</span>
<span class="sd">            read_only (bool): Prevents writing validation splits to file.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;_splits.json&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">crossval_splits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k_fold_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">split_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">val_strategy</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;k-fold-preserved-site&#39;</span> <span class="k">if</span> <span class="n">preserved_site</span>
                              <span class="k">else</span> <span class="s1">&#39;k-fold&#39;</span><span class="p">),</span>
                <span class="n">val_k_fold</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">k_fold_iter</span><span class="o">=</span><span class="n">k_fold_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">site_labels</span><span class="o">=</span><span class="n">site_labels</span><span class="p">,</span>
                <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
                <span class="n">read_only</span><span class="o">=</span><span class="n">read_only</span>
            <span class="p">)</span>
            <span class="n">crossval_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="o">**</span><span class="n">split_kw</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">crossval_splits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">use_float</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">assign</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span>
                             <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                             <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of slide names mapped to patient id and label(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            headers (list(str)) Annotation header(s) that specifies label.</span>
<span class="sd">                May be a list or string.</span>
<span class="sd">            use_float (bool, optional) Either bool, dict, or &#39;auto&#39;.</span>
<span class="sd">                If true, convert data into float; if unable, raise TypeError.</span>
<span class="sd">                If false, interpret all data as categorical.</span>
<span class="sd">                If a dict(bool), look up each header to determine type.</span>
<span class="sd">                If &#39;auto&#39;, will try to convert all data into float. For each</span>
<span class="sd">                header in which this fails, will interpret as categorical.</span>
<span class="sd">            assign (dict, optional):  Dictionary mapping label ids to</span>
<span class="sd">                label names. If not provided, will map ids to names by sorting</span>
<span class="sd">                alphabetically.</span>
<span class="sd">            format (str, optional): Either &#39;index&#39; or &#39;name.&#39; Indicates which</span>
<span class="sd">                format should be used for categorical outcomes when returning</span>
<span class="sd">                the label dictionary. If &#39;name&#39;, uses the string label name.</span>
<span class="sd">                If &#39;index&#39;, returns an int (index corresponding with the</span>
<span class="sd">                returned list of unique outcomes as str). Defaults to &#39;index&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing</span>

<span class="sd">                **dict**: Dictionary mapping slides to outcome labels in</span>
<span class="sd">                numerical format (float for continuous outcomes, int of outcome</span>
<span class="sd">                label id for categorical outcomes).</span>

<span class="sd">                **list**: List of unique labels. For categorical outcomes,</span>
<span class="sd">                this will be a list of str; indices correspond with the outcome</span>
<span class="sd">                label id.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;Annotations not loaded.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot generate labels: dataset is empty after filtering.&quot;</span>
            <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">filtered_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="o">.</span><span class="n">patient</span>
        <span class="n">filtered_slides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="o">.</span><span class="n">slide</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">assign</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">assign</span><span class="p">):</span>
                <span class="n">assigned_for_header</span> <span class="o">=</span> <span class="n">assign</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">assign</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to read outcome assignments for header </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; (assign=</span><span class="si">{</span><span class="n">assign</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assigned_for_header</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">unique_labels_for_this_header</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filtered_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing column </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># Determine whether values should be converted into float</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_float</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;use_float is dict, but header </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2"> is missing.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">header_is_float</span> <span class="o">=</span> <span class="n">use_float</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">header_is_float</span> <span class="o">=</span> <span class="n">use_float</span>
            <span class="k">elif</span> <span class="n">use_float</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">header_is_float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_float</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid use_float option </span><span class="si">{</span><span class="n">use_float</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Ensure labels can be converted to desired type,</span>
            <span class="c1"># then assign values</span>
            <span class="k">if</span> <span class="n">header_is_float</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_float</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to convert all labels of </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2"> into &#39;float&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">header_is_float</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Interpreting column &quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s1">&quot; as continuous&#39;</span><span class="p">)</span>
                <span class="n">filtered_labels</span> <span class="o">=</span> <span class="n">filtered_labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Interpreting column &quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s1">&quot; as categorical&#39;</span><span class="p">)</span>
                <span class="n">unique_labels_for_this_header</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">))</span>
                <span class="n">unique_labels_for_this_header</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ul</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels_for_this_header</span><span class="p">):</span>
                    <span class="n">n_matching_filtered</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="n">ul</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered_labels</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">assigned_for_header</span> <span class="ow">and</span> <span class="n">ul</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assigned_for_header</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;assign was provided, but label </span><span class="si">{</span><span class="n">ul</span><span class="si">}</span><span class="s2"> missing&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">assigned_for_header</span><span class="p">:</span>
                        <span class="n">val_msg</span> <span class="o">=</span> <span class="n">assigned_for_header</span><span class="p">[</span><span class="n">ul</span><span class="p">]</span>
                        <span class="n">n_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_matching_filtered</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ul</span><span class="si">}</span><span class="s2"> assigned </span><span class="si">{</span><span class="n">val_msg</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">n_s</span><span class="si">}</span><span class="s2"> slides]&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_matching_filtered</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ul</span><span class="si">}</span><span class="s2"> assigned </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">n_s</span><span class="si">}</span><span class="s2"> slides]&quot;</span>
                        <span class="p">)</span>

            <span class="k">def</span> <span class="nf">_process_cat_label</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">assigned_for_header</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">assigned_for_header</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">o</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">unique_labels_for_this_header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

            <span class="c1"># Check for multiple, different labels per patient and warn</span>
            <span class="n">pt_assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">filtered_pts</span><span class="p">,</span> <span class="n">filtered_labels</span><span class="p">))))</span>
            <span class="n">unique_pt</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pt_assign</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">unique_pt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)][:,</span> <span class="mi">0</span><span class="p">]:</span>
                <span class="n">dup_vals</span> <span class="o">=</span> <span class="n">pt_assign</span><span class="p">[</span><span class="n">pt_assign</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">pt</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">dups</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dup_vals</span><span class="p">])</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Multiple labels for patient &quot;</span><span class="si">{</span><span class="n">pt</span><span class="si">}</span><span class="s1">&quot; (header </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s1">): &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dups</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="c1"># Assemble results dictionary</span>
            <span class="k">for</span> <span class="n">slide</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filtered_slides</span><span class="p">,</span> <span class="n">filtered_labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">header_is_float</span><span class="p">:</span>
                    <span class="n">lbl</span> <span class="o">=</span> <span class="n">_process_cat_label</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lbl</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">header_is_float</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lbl</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span>
            <span class="n">unique_labels</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_labels_for_this_header</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">unique_labels</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">unique_labels</span>

    <span class="k">def</span> <span class="nf">load_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return TFRecord indices.&quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">DPool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">load_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">):</span>
            <span class="n">tfr_name</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">tfrecord2idx</span><span class="o">.</span><span class="n">load_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tfr_name</span><span class="p">,</span> <span class="n">index</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading indices...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tfr_name</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">load_index</span><span class="p">,</span> <span class="n">tfrecords</span><span class="p">):</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">tfr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">indices</span>

    <span class="k">def</span> <span class="nf">manifest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a manifest of all tfrecords.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): Either &#39;path&#39; (default) or &#39;name&#39;. Determines key format</span>
<span class="sd">                in the manifest dictionary.</span>
<span class="sd">            filter (bool): Apply active filters to manifest.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dict mapping key (path or slide name) to number of tiles.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;key&#39; must be in [&#39;path, &#39;name&#39;]&quot;</span><span class="p">)</span>

        <span class="n">all_manifest</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tfrecords_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tfrecords path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tfrecord_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">manifest_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">,</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No manifest at </span><span class="si">{</span><span class="n">tfrecord_dir</span><span class="si">}</span><span class="s2">; creating now&quot;</span><span class="p">)</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">update_manifest_at_dir</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">):</span>
                <span class="n">relative_manifest</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relative_manifest</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">global_manifest</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">relative_manifest</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                <span class="n">global_manifest</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">relative_manifest</span><span class="p">[</span><span class="n">record</span><span class="p">]})</span>
            <span class="n">all_manifest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">global_manifest</span><span class="p">)</span>
        <span class="c1"># Now filter out any tfrecords that would be excluded by filters</span>
        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="n">filtered_tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
            <span class="n">manifest_tfrecords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_manifest</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">manifest_tfrecords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tfr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_tfrecords</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">all_manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span>
        <span class="c1"># Log clipped tile totals if applicable</span>
        <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">all_manifest</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">:</span>
                <span class="n">all_manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;clipped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">[</span><span class="n">tfr</span><span class="p">],</span>
                                                   <span class="n">all_manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;clipped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_manifest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_manifest</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">manifest_histogram</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">binrange</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot histograms of tiles-per-slide.</span>

<span class="sd">        Example</span>
<span class="sd">            Create histograms of tiles-per-slide, stratified by site.</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    import matplotlib.pyplot as plt</span>

<span class="sd">                    dataset.manifest_histogram(by=&#39;site&#39;)</span>
<span class="sd">                    plt.show()</span>

<span class="sd">        Args:</span>
<span class="sd">            by (str, optional): Stratify histograms by this annotation column</span>
<span class="sd">                header. Defaults to None.</span>
<span class="sd">            binrange (tuple(int, int)): Histogram bin ranges. If None, uses</span>
<span class="sd">                full range. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="k">if</span> <span class="n">by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">unique_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">val_counts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">({</span><span class="n">by</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">unique_vals</span>
            <span class="p">]</span>
            <span class="n">all_counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">vc</span> <span class="ow">in</span> <span class="n">val_counts</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">vc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unique_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">all_counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">val_counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_counts</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">binrange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_count</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">all_counts</span><span class="p">)</span> <span class="o">//</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span>
            <span class="n">binrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_count</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_tight_layout</span><span class="p">({</span><span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mf">.0</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">val_counts</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">binrange</span><span class="o">=</span><span class="n">binrange</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">binrange</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Tiles per slide&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">patients</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of patient IDs from this dataset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;Annotations not loaded.&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span><span class="p">[</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span>
        <span class="p">))</span>
        <span class="k">for</span> <span class="n">slide</span><span class="p">,</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="o">!=</span> <span class="n">patient</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Slide &quot;</span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1">&quot; assigned to multiple patients: &#39;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">patient</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">slide</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">pt_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated function. Please use `Dataset.get_bags()`.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;pt_files() is deprecated. Please use Dataset.get_bags()&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bags</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_bags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">warn_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of all \*.pt files with slide names in this dataset.</span>

<span class="sd">        May return more than one \*.pt file for each slide.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str, list(str)): Directory(ies) to search for \*.pt files.</span>
<span class="sd">            warn_missing (bool): Raise a warning if any slides in this dataset</span>
<span class="sd">                do not have a \*.pt file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>

        <span class="n">bags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="n">bags_at_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pt&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">slides</span>
            <span class="p">])</span>
            <span class="n">bags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bags_at_path</span><span class="p">)</span>
        <span class="n">bags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">bags</span><span class="p">)</span>
        <span class="n">unique_slides_with_bags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bags</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_slides_with_bags</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">))</span> <span class="ow">and</span> <span class="n">warn_missing</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bags missing for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">unique_slides_with_bags</span><span class="p">)</span><span class="si">}</span><span class="s2"> slides.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bags</span>

    <span class="k">def</span> <span class="nf">read_tfrecord_by_location</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">loc</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">decode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a record from a TFRecord, indexed by location.</span>

<span class="sd">        Finds the associated TFRecord for a slide, and returns the record</span>
<span class="sd">        inside which corresponds to a given tile location.</span>

<span class="sd">        Args:</span>
<span class="sd">            slide (str): Name of slide. Will search for the slide&#39;s associated</span>
<span class="sd">                TFRecord.</span>
<span class="sd">            loc ((int, int)): ``(x, y)`` tile location. Searches the TFRecord</span>
<span class="sd">                for the tile that corresponds to this location.</span>
<span class="sd">            decode (bool): Decode the associated record, returning Tensors.</span>
<span class="sd">                Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Unprocessed raw TFRecord bytes if ``decode=False``, otherwise a</span>
<span class="sd">            tuple containing ``(slide, image)``, where ``image`` is a</span>
<span class="sd">            uint8 Tensor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_tfrecord</span><span class="p">(</span><span class="n">slide</span><span class="o">=</span><span class="n">slide</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tfr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TFRecordsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find associated TFRecord for slide &#39;</span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">decode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;decode&#39; argument to `Dataset.read_tfrecord_by_location` &quot;</span>
                <span class="s2">&quot;is deprecated and will be removed in a future version. In the &quot;</span>
                <span class="s2">&quot;future, all records will be decoded.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_tfrecord_by_location</span><span class="p">(</span><span class="n">tfr</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="n">decode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a specific filter from the active filters.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            filters (list of str): Filter keys. Will remove filters with</span>
<span class="sd">                these keys.</span>
<span class="sd">            filter_blank (list of str): Will remove these headers stored in</span>
<span class="sd">                filter_blank.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`slideflow.Dataset`: Dataset with filter removed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwarg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_blank&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown filtering argument </span><span class="si">{</span><span class="n">kwarg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;filters&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;filters&#39; must be a list.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetFilterError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Filter </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> not found in dataset (active filters:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">_filters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ret</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;filter_blank&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;filter_blank&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetFilterError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Filter_blank </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> not found in dataset (active &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;filter_blank: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span><span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">_filter_blank</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">rebuild_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rebuild index files for TFRecords.</span>

<span class="sd">        Equivalent to ``Dataset.build_index(force=True)``.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resize_tfrecords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize images in a set of TFRecords to a given pixel size.</span>

<span class="sd">        Args:</span>
<span class="sd">            tile_px (int): Target pixel size for resizing TFRecord images.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tf_available</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Dataset.resize_tfrecords() requires Tensorflow, which is &quot;</span>
                <span class="s2">&quot;not installed.&quot;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resizing TFRecord tiles to (</span><span class="si">{</span><span class="n">tile_px</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">tile_px</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">tfrecords_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Resizing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tfrecords_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> tfrecords&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords_list</span><span class="p">:</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">transform_tfrecord</span><span class="p">(</span>
                <span class="n">tfr</span><span class="p">,</span>
                <span class="n">tfr</span><span class="o">+</span><span class="s1">&#39;.transformed&#39;</span><span class="p">,</span>
                <span class="n">resize</span><span class="o">=</span><span class="n">tile_px</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">rois</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all ROIs.&quot;&quot;&quot;</span>
        <span class="n">rois_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roi_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">rois_list</span> <span class="o">+=</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;roi&#39;</span><span class="p">],</span> <span class="s2">&quot;*.csv&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;roi path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rois_list</span><span class="p">))</span> <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">slide_manifest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">tma</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">low_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dictionary of slide names and estimated number of tiles.</span>

<span class="sd">        Uses Otsu thresholding for background filtering, and the ROI strategy.</span>

<span class="sd">        Args:</span>
<span class="sd">            roi_method (str): Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, or &#39;ignore&#39;.</span>
<span class="sd">                Determines how ROIs are used to extract tiles.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and skip a slide if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            stride_div (int): Stride divisor for tile extraction.</span>
<span class="sd">                A stride of 1 will extract non-overlapping tiles.</span>
<span class="sd">                A stride_div of 2 will extract overlapping tiles, with a stride</span>
<span class="sd">                equal to 50% of the tile width. Defaults to 1.</span>
<span class="sd">            tma (bool): Deprecated argument. Tumor micro-arrays are read as</span>
<span class="sd">                standard slides. Defaults to False.</span>
<span class="sd">            source (str, optional): Dataset source name.</span>
<span class="sd">                Defaults to None (using all sources).</span>
<span class="sd">            low_memory (bool): Operate in low-memory mode at the cost of</span>
<span class="sd">                worse performance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, int]: Dictionary mapping slide names to number of</span>
<span class="sd">            estimated non-background tiles in the slide.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tma</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;tma=True is deprecated and will be removed in a future &quot;</span>
                <span class="s2">&quot;version. Tumor micro-arrays are read as standard slides. &quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;tile_px and tile_um must be set to calculate a slide manifest&quot;</span>
            <span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span><span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">read_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s1">&#39;Reading slides...&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">low_memory</span><span class="p">:</span>
            <span class="n">otsu_task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Otsu thresholding...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
        <span class="p">)</span>
        <span class="n">wsi_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                    <span class="n">rois</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">(),</span>
                    <span class="n">stride_div</span><span class="o">=</span><span class="n">stride_div</span><span class="p">,</span>
                    <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">low_memory</span><span class="p">:</span>
                    <span class="n">wsi</span><span class="o">.</span><span class="n">qc</span><span class="p">(</span><span class="s1">&#39;otsu&#39;</span><span class="p">)</span>
                    <span class="n">counts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">wsi</span><span class="o">.</span><span class="n">estimated_num_tiles</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wsi_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">wsi</span><span class="p">]</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">read_task</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">to_remove</span> <span class="o">+=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">read_task</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">otsu_task</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">low_memory</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">_count_otsu_tiles</span><span class="p">,</span> <span class="n">wsi_list</span><span class="p">):</span>
                <span class="n">counts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">otsu_task</span><span class="p">)</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">path</span><span class="p">:</span> <span class="n">counts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">slide_paths</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_filters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of paths to slides.</span>

<span class="sd">        Either returns a list of paths to all slides, or slides only matching</span>
<span class="sd">        dataset filters.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str, optional): Dataset source name.</span>
<span class="sd">                Defaults to None (using all sources).</span>
<span class="sd">            filter (bool, optional): Return only slide paths meeting filter</span>
<span class="sd">                criteria. If False, return all slides. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list(str): List of slide paths.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="c1"># Get unfiltered paths</span>
        <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slides_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;slides path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_slide_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slides_set</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;slides path not set for source </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">paths</span> <span class="o">+=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_slide_paths</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                    <span class="p">)</span>

        <span class="c1"># Remove any duplicates from shared dataset paths</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="c1"># Filter paths</span>
        <span class="k">if</span> <span class="n">apply_filters</span><span class="p">:</span>
            <span class="n">filtered_slides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">filtered_paths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filtered_slides</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">filtered_paths</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">paths</span>

    <span class="k">def</span> <span class="nf">slides</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of slide names in this dataset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="s2">&quot;No annotations loaded; is the annotations file empty?&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;slide&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;slide&#39;</span><span class="si">}</span><span class="s2"> not found in annotations file.&quot;</span>
            <span class="p">)</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_annotations</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">ann</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">)]</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">slides</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">val_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">val_fraction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">val_k_fold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">k_fold_iter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">site_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span>
        <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split this dataset into a training and validation dataset.</span>

<span class="sd">        If a validation split has already been prepared (e.g. K-fold iterations</span>
<span class="sd">        were already determined), the previously generated split will be used.</span>
<span class="sd">        Otherwise, create a new split and log the result in the TFRecord</span>
<span class="sd">        directory so future models may use the same split for consistency.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_type (str): Either &#39;classification&#39; or &#39;regression&#39;. Defaults</span>
<span class="sd">                to &#39;classification&#39; if ``labels`` is provided.</span>
<span class="sd">            labels (dict or str):  Either a dictionary of slides: labels,</span>
<span class="sd">                or an outcome label (``str``). Used for balancing outcome</span>
<span class="sd">                labels in training and validation cohorts. Defaults to None.</span>
<span class="sd">            val_strategy (str): Either &#39;k-fold&#39;, &#39;k-fold-preserved-site&#39;,</span>
<span class="sd">                &#39;bootstrap&#39;, or &#39;fixed&#39;. Defaults to &#39;fixed&#39;.</span>
<span class="sd">            splits (str, optional): Path to JSON file containing validation</span>
<span class="sd">                splits. Defaults to None.</span>
<span class="sd">            outcome_key (str, optional): Key indicating outcome label in</span>
<span class="sd">                slide_labels_dict. Defaults to &#39;outcome_label&#39;.</span>
<span class="sd">            val_fraction (float, optional): Proportion of data for validation.</span>
<span class="sd">                Not used if strategy is k-fold. Defaults to None.</span>
<span class="sd">            val_k_fold (int): K, required if using K-fold validation.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            k_fold_iter (int, optional): Which K-fold iteration to generate</span>
<span class="sd">                starting at 1. Fequired if using K-fold validation.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            site_labels (dict, optional): Dict mapping patients to site labels,</span>
<span class="sd">                or an outcome column with site labels. Only used for site</span>
<span class="sd">                preserved cross validation. Defaults to &#39;site&#39;.</span>
<span class="sd">            read_only (bool): Prevents writing validation splits to file.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing</span>

<span class="sd">                :class:`slideflow.Dataset`: Training dataset.</span>

<span class="sd">                :class:`slideflow.Dataset`: Validation dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">k_fold_iter</span> <span class="ow">and</span> <span class="s1">&#39;k-fold&#39;</span> <span class="ow">in</span> <span class="n">val_strategy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                <span class="s2">&quot;If strategy is &#39;k-fold&#39;, must supply k_fold_iter &quot;</span>
                <span class="s2">&quot;(int starting at 1)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">val_k_fold</span> <span class="ow">and</span> <span class="s1">&#39;k-fold&#39;</span> <span class="ow">in</span> <span class="n">val_strategy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                <span class="s2">&quot;If strategy is &#39;k-fold&#39;, must supply val_k_fold (K)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">site_labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                <span class="s2">&quot;k-fold-preserved-site requires site_labels (dict of &quot;</span>
                <span class="s2">&quot;patients:sites, or name of annotation column header&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span>
           <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site_labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">site_labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">site_labels</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span> <span class="ow">and</span> <span class="n">site_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Must supply site_labels for strategy </span><span class="si">{</span><span class="n">val_strategy</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Must supply val_fraction for strategy </span><span class="si">{</span><span class="n">val_strategy</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">model_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;regression&#39;</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;classification&#39;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;model_type=&#39;categorical&#39; is deprecated. Please use &quot;</span>
                <span class="s2">&quot;&#39;classification&#39; instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;classification&#39;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;model_type=&#39;linear&#39; is deprecated. Please use &quot;</span>
                <span class="s2">&quot;&#39;regression&#39; instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;regression&#39;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="s1">&#39;regression&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid model_type </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">; must be either &quot;</span>
                <span class="s2">&quot;&#39;classification&#39; or &#39;regression&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Prepare dataset</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>
        <span class="n">splits_file</span> <span class="o">=</span> <span class="n">splits</span>
        <span class="n">training_tfr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">val_tfr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">accepted_split</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">slide_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Assemble dict of patients linking to list of slides &amp; outcome labels</span>
        <span class="c1"># dataset.labels() ensures no duplicate labels for a single patient</span>
        <span class="n">tfr_dir_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">from_wsi</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
        <span class="n">skip_tfr_verification</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfr_dir_list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No tfrecords found; splitting from annotations only.&quot;</span><span class="p">)</span>
            <span class="n">tfr_dir_list</span> <span class="o">=</span> <span class="n">tfr_dir_list_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">skip_tfr_verification</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfr_dir_list</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No slides found; splitting from annotations only.&quot;</span><span class="p">)</span>
            <span class="n">tfr_dir_list</span> <span class="o">=</span> <span class="n">tfr_dir_list_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">skip_tfr_verification</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tfr_dir_list_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfr_dir_list</span>
            <span class="p">]</span>
        <span class="n">patients_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">num_warned</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">:</span>
            <span class="n">patient</span> <span class="o">=</span> <span class="n">slide</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">patients</span> <span class="k">else</span> <span class="n">patients</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span>
            <span class="c1"># Skip slides not found in directory</span>
            <span class="k">if</span> <span class="n">slide</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tfr_dir_list_names</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2"> missing tfrecord, skipping&quot;</span><span class="p">)</span>
                <span class="n">num_warned</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">patient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">patients_dict</span><span class="p">:</span>
                <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;outcome_label&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                    <span class="s1">&#39;slides&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;outcome_label&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]:</span>
                <span class="n">ol</span> <span class="o">=</span> <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;outcome_label&#39;</span><span class="p">]</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Multiple labels found for </span><span class="si">{</span><span class="n">patient</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ol</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ok</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide</span><span class="p">]</span>

        <span class="c1"># Add site labels to the patients dict if doing</span>
        <span class="c1"># preserved-site cross-validation</span>
        <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">site_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">site_slide_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">site_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">site_slide_list</span><span class="p">:</span>
                <span class="n">patient</span> <span class="o">=</span> <span class="n">slide</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">patients</span> <span class="k">else</span> <span class="n">patients</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                <span class="c1"># Skip slides not found in directory</span>
                <span class="k">if</span> <span class="n">slide</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tfr_dir_list_names</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">]:</span>
                    <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">site_labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]:</span>
                    <span class="n">ol</span> <span class="o">=</span> <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="n">site_labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span>
                    <span class="n">_tail</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">patient</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ol</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ok</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Multiple site labels found for </span><span class="si">{</span><span class="n">_tail</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">num_warned</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_warned</span><span class="si">}</span><span class="s2"> slides missing tfrecords, skipping&quot;</span><span class="p">)</span>
        <span class="n">patients_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">patients_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">sorted_patients</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients_list</span><span class="p">]</span>
        <span class="n">sorted_patients</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">patients_list</span><span class="p">)</span>

        <span class="c1"># Create and log a validation subset</span>
        <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;val_strategy is None; skipping validation&quot;</span><span class="p">)</span>
            <span class="n">train_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">val_slides</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">val_fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_fraction</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">patients_list</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Boostrap validation: selecting </span><span class="si">{</span><span class="n">num_val</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;patients at random for validation testing&quot;</span>
            <span class="p">)</span>
            <span class="n">val_patients</span> <span class="o">=</span> <span class="n">patients_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_val</span><span class="p">]</span>
            <span class="n">train_patients</span> <span class="o">=</span> <span class="n">patients_list</span><span class="p">[</span><span class="n">num_val</span><span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_patients</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_patients</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">InsufficientDataForSplitError</span>
            <span class="n">val_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">val_patients</span>
            <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">train_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">train_patients</span>
            <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to load validation split</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">splits_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">splits_file</span><span class="p">)):</span>
                <span class="n">loaded_splits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loaded_splits</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">splits_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">split_id</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loaded_splits</span><span class="p">):</span>
                <span class="c1"># First, see if strategy is the same</span>
                <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val_strategy</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># If k-fold, check that k-fold length is the same</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">val_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">)</span>
                   <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">!=</span> <span class="n">val_k_fold</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># Then, check if patient lists are the same</span>
                <span class="n">sp_pts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">sp_pts</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sp_pts</span> <span class="o">==</span> <span class="n">sorted_patients</span><span class="p">:</span>
                    <span class="c1"># Finally, check if outcome variables are the same</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="n">patients_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;outcome_label&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sp_pts</span><span class="p">]</span>
                    <span class="n">c2</span> <span class="o">=</span> <span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;outcome_label&#39;</span><span class="p">]</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sp_pts</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">c1</span> <span class="o">==</span> <span class="n">c2</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">val_strategy</span><span class="si">}</span><span class="s2"> validation split detected&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; at [green]</span><span class="si">{</span><span class="n">splits_file</span><span class="si">}</span><span class="s2">[/] (ID: </span><span class="si">{</span><span class="n">split_id</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                        <span class="n">accepted_split</span> <span class="o">=</span> <span class="n">split</span>
                        <span class="k">break</span>

            <span class="c1"># If no split found, create a new one</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">accepted_split</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">splits_file</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No compatible train/val split found.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging new split at [green]</span><span class="si">{</span><span class="n">splits_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No training/validation splits file provided.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to save or load validation splits.&quot;</span><span class="p">)</span>
                <span class="n">new_split</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="n">val_strategy</span><span class="p">,</span>
                    <span class="s1">&#39;patients&#39;</span><span class="p">:</span> <span class="n">patients_dict</span><span class="p">,</span>
                    <span class="s1">&#39;tfrecords&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>  <span class="c1"># type: Any</span>
                <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">val_fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_fraction</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">patients_list</span><span class="p">))</span>
                    <span class="n">val_patients</span> <span class="o">=</span> <span class="n">patients_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_val</span><span class="p">]</span>
                    <span class="n">train_patients</span> <span class="o">=</span> <span class="n">patients_list</span><span class="p">[</span><span class="n">num_val</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_patients</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_patients</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">InsufficientDataForSplitError</span>
                    <span class="n">val_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">val_patients</span>
                    <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">train_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">train_patients</span>
                    <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">new_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_slides</span>
                    <span class="n">new_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="s1">&#39;training&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_slides</span>

                <span class="k">elif</span> <span class="n">val_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">val_k_fold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">):</span>
                        <span class="n">k_fold_patients</span> <span class="o">=</span> <span class="n">split_patients_preserved_site</span><span class="p">(</span>
                            <span class="n">patients_dict</span><span class="p">,</span>
                            <span class="n">val_k_fold</span><span class="p">,</span>
                            <span class="n">balance</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;outcome_label&#39;</span>
                                     <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span>
                                     <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                        <span class="n">k_fold_patients</span> <span class="o">=</span> <span class="n">split_patients_balanced</span><span class="p">(</span>
                            <span class="n">patients_dict</span><span class="p">,</span>
                            <span class="n">val_k_fold</span><span class="p">,</span>
                            <span class="n">balance</span><span class="o">=</span><span class="s1">&#39;outcome_label&#39;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">k_fold_patients</span> <span class="o">=</span> <span class="n">split_patients</span><span class="p">(</span>
                            <span class="n">patients_dict</span><span class="p">,</span> <span class="n">val_k_fold</span>
                        <span class="p">)</span>
                    <span class="c1"># Verify at least one patient is in each k_fold group</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_fold_patients</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val_k_fold</span>
                       <span class="ow">or</span> <span class="ow">not</span> <span class="nb">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span> <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">k_fold_patients</span><span class="p">])):</span>
                        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">InsufficientDataForSplitError</span>
                    <span class="n">train_patients</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">val_k_fold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">new_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;k-fold-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">k_fold_patients</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">k_fold_iter</span><span class="p">:</span>
                            <span class="n">val_patients</span> <span class="o">=</span> <span class="n">k_fold_patients</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">train_patients</span> <span class="o">+=</span> <span class="n">k_fold_patients</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">val_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">val_patients</span>
                    <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">train_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="n">patients_dict</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;slides&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">train_patients</span>
                    <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unknown validation strategy </span><span class="si">{</span><span class="n">val_strategy</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Write the new split to log</span>
                <span class="n">loaded_splits</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_split</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">read_only</span> <span class="ow">and</span> <span class="n">splits_file</span><span class="p">:</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">loaded_splits</span><span class="p">,</span> <span class="n">splits_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use existing split</span>
                <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                    <span class="n">val_slides</span> <span class="o">=</span> <span class="n">accepted_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span>
                    <span class="n">train_slides</span> <span class="o">=</span> <span class="n">accepted_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="s1">&#39;training&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">val_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">val_k_fold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">k_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;k-fold-</span><span class="si">{</span><span class="n">k_fold_iter</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">val_slides</span> <span class="o">=</span> <span class="n">accepted_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="n">k_id</span><span class="p">]</span>
                    <span class="n">train_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                        <span class="n">accepted_split</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;k-fold-</span><span class="si">{</span><span class="n">ki</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">val_k_fold</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ki</span> <span class="o">!=</span> <span class="n">k_fold_iter</span>
                    <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unknown val_strategy </span><span class="si">{</span><span class="n">val_strategy</span><span class="si">}</span><span class="s2"> requested.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Perform final integrity check to ensure no patients</span>
            <span class="c1"># are in both training and validation slides</span>
            <span class="k">if</span> <span class="n">patients</span><span class="p">:</span>
                <span class="n">validation_pt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">patients</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">val_slides</span><span class="p">]))</span>
                <span class="n">training_pt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">patients</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">train_slides</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validation_pt</span><span class="p">,</span> <span class="n">training_pt</span> <span class="o">=</span> <span class="n">val_slides</span><span class="p">,</span> <span class="n">train_slides</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pt</span> <span class="ow">in</span> <span class="n">training_pt</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">validation_pt</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetSplitError</span><span class="p">(</span>
                    <span class="s2">&quot;At least one patient is in both val and training sets.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Assemble list of tfrecords</span>
        <span class="k">if</span> <span class="n">val_strategy</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">val_tfr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tfr</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfr_dir_list</span>
                <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">val_slides</span> <span class="ow">or</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">val_slides</span>
            <span class="p">]</span>
            <span class="n">training_tfr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tfr</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfr_dir_list</span>
                <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">train_slides</span> <span class="ow">or</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">train_slides</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_tfr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_slides</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of validation tfrecords (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_tfr</span><span class="p">)</span><span class="si">}</span><span class="s2">) does &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not match number of validation slides (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_slides</span><span class="p">)</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="s2">&quot;This may happen if multiple tfrecords were found for a slide.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_tfr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_slides</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of training tfrecords (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">training_tfr</span><span class="p">)</span><span class="si">}</span><span class="s2">) does &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not match number of training slides (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_slides</span><span class="p">)</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="s2">&quot;This may happen if multiple tfrecords were found for a slide.&quot;</span>
            <span class="p">)</span>
        <span class="n">training_dts</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">training_dts</span> <span class="o">=</span> <span class="n">training_dts</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">train_slides</span><span class="p">})</span>
        <span class="n">val_dts</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">val_dts</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">val_slides</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_tfr_verification</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">training_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">training_tfr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_tfr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">skip_tfr_verification</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">training_dts</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">training_tfr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_tfr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">training_dts</span><span class="p">,</span> <span class="n">val_dts</span>

    <span class="k">def</span> <span class="nf">split_tfrecords_by_roi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">roi_filter_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split dataset tfrecords into separate tfrecords according to ROI.</span>

<span class="sd">        Will generate two sets of tfrecords, with identical names: one with</span>
<span class="sd">        tiles inside the ROIs, one with tiles outside the ROIs. Will skip any</span>
<span class="sd">        tfrecords that are missing ROIs. Requires slides to be available.</span>

<span class="sd">        Args:</span>
<span class="sd">            destination (str): Destination path.</span>
<span class="sd">            roi_filter_method (str or float): Method of filtering tiles with</span>
<span class="sd">                ROIs. Either &#39;center&#39; or float (0-1). If &#39;center&#39;, tiles are</span>
<span class="sd">                filtered with ROIs based on the center of the tile. If float,</span>
<span class="sd">                tiles are filtered based on the proportion of the tile inside</span>
<span class="sd">                the ROI, and ``roi_filter_method`` is interpreted as a</span>
<span class="sd">                threshold. If the proportion of a tile inside the ROI is</span>
<span class="sd">                greater than this number, the tile is included. For example,</span>
<span class="sd">                if ``roi_filter_method=0.7``, a tile that is 80% inside of an</span>
<span class="sd">                ROI will be included, and a tile that is 50% inside of an ROI</span>
<span class="sd">                will be excluded. Defaults to &#39;center&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="p">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()}</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">()</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;tile_px and tile_um must be non-zero to process TFRecords.&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">:</span>
            <span class="n">slidename</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slidename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slide</span> <span class="o">=</span> <span class="n">WSI</span><span class="p">(</span>
                    <span class="n">slides</span><span class="p">[</span><span class="n">slidename</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                    <span class="n">rois</span><span class="o">=</span><span class="n">rois</span><span class="p">,</span>
                    <span class="n">roi_method</span><span class="o">=</span><span class="s1">&#39;inside&#39;</span><span class="p">,</span>
                    <span class="n">roi_filter_method</span><span class="o">=</span><span class="n">roi_filter_method</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_tfrecord_parser</span><span class="p">(</span>
                <span class="n">tfr</span><span class="p">,</span>
                <span class="n">decode_images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">to_numpy</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read TFRecord </span><span class="si">{</span><span class="n">tfr</span><span class="si">}</span><span class="s2">; skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;inside&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;inside&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">))</span>
            <span class="n">in_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;inside&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slidename</span><span class="si">}</span><span class="s1">.tfrecords&#39;</span><span class="p">)</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slidename</span><span class="si">}</span><span class="s1">.tfrecords&#39;</span><span class="p">)</span>
            <span class="n">inside_roi_writer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>
            <span class="n">outside_roi_writer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">manifest</span><span class="p">[</span><span class="n">tfr</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]):</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">loc_x</span><span class="p">,</span> <span class="n">loc_y</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;loc_x&#39;</span><span class="p">],</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;loc_y&#39;</span><span class="p">]</span>
                <span class="n">tile_in_roi</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span>
                    <span class="n">roi</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">loc_x</span><span class="p">,</span> <span class="n">loc_y</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">slide</span><span class="o">.</span><span class="n">rois</span>
                <span class="p">])</span>
                <span class="c1"># Convert from a Tensor -&gt; Numpy array</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tile_in_roi</span><span class="p">:</span>
                    <span class="n">inside_roi_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outside_roi_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="n">inside_roi_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">outside_roi_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a summary of this dataset.&quot;&quot;&quot;</span>
        <span class="c1"># Get ROI information.</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>
        <span class="n">has_rois</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">slides_with_roi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">patients_with_roi</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">has_rois</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="n">slides_with_roi</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">has_rois</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">():</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">patients</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slides_with_roi</span> <span class="ow">and</span> <span class="n">slides_with_roi</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                <span class="n">patients_with_roi</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Print summary.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_patients</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_patients</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overview:&quot;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Configuration file:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;Tile size (px):&quot;</span><span class="p">,</span>     <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;Tile size (um):&quot;</span><span class="p">,</span>     <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;Slides:&quot;</span><span class="p">,</span>             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">())),</span>
                 <span class="p">(</span><span class="s2">&quot;Patients:&quot;</span><span class="p">,</span>           <span class="n">num_patients</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;Slides with ROIs:&quot;</span><span class="p">,</span>   <span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slides_with_roi</span>
                                              <span class="k">if</span> <span class="n">slides_with_roi</span><span class="p">[</span><span class="n">s</span><span class="p">]])),</span>
                 <span class="p">(</span><span class="s2">&quot;Patients with ROIs:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients_with_roi</span>
                                              <span class="k">if</span> <span class="n">patients_with_roi</span><span class="p">[</span><span class="n">p</span><span class="p">]]))]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;fancy_outline&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filters:&quot;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Filters:&quot;</span><span class="p">,</span>           <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)),</span>
                 <span class="p">(</span><span class="s2">&quot;Filter Blank:&quot;</span><span class="p">,</span>       <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_blank</span><span class="p">)),</span>
                 <span class="p">(</span><span class="s2">&quot;Min Tiles:&quot;</span><span class="p">,</span>          <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_tiles</span><span class="p">))]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;fancy_grid&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sources:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;None&gt;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                               <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;fancy_outline&quot;</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of tiles in TFRecords:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Annotation columns:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;NA&gt;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tensorflow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;tf.data.Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a Tensorflow Dataset object that interleaves tfrecords.</span>

<span class="sd">        The returned dataset yields a batch of (image, label) for each tile.</span>
<span class="sd">        Labels may be specified either via a dict mapping slide names to</span>
<span class="sd">        outcomes, or a parsing function which accept and image and slide name,</span>
<span class="sd">        returning a dict {&#39;image_raw&#39;: image(tensor)} and label (int or float).</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (dict or str, optional): Dict or function. If dict, must</span>
<span class="sd">                map slide names to outcome labels. If function, function must</span>
<span class="sd">                accept an image (tensor) and slide name (str), and return a</span>
<span class="sd">                dict {&#39;image_raw&#39;: image (tensor)} and label (int or float).</span>
<span class="sd">                If not provided, all labels will be None.</span>
<span class="sd">            batch_size (int): Batch size.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            augment (str or bool): Image augmentations to perform. Augmentations include:</span>

<span class="sd">                * ``&#39;x&#39;``: Random horizontal flip</span>
<span class="sd">                * ``&#39;y&#39;``: Random vertical flip</span>
<span class="sd">                * ``&#39;r&#39;``: Random 90-degree rotation</span>
<span class="sd">                * ``&#39;j&#39;``: Random JPEG compression (50% chance to compress with quality between 50-100)</span>
<span class="sd">                * ``&#39;b&#39;``: Random Gaussian blur (10% chance to blur with sigma between 0.5-2.0)</span>
<span class="sd">                * ``&#39;n&#39;``: Random :ref:`stain_augmentation` (requires stain normalizer)</span>

<span class="sd">                Combine letters to define augmentations, such as ``&#39;xyrjn&#39;``.</span>
<span class="sd">                A value of True will use ``&#39;xyrjb&#39;``.</span>
<span class="sd">            deterministic (bool, optional): When num_parallel_calls is specified,</span>
<span class="sd">                if this boolean is specified, it controls the order in which the</span>
<span class="sd">                transformation produces elements. If set to False, the</span>
<span class="sd">                transformation is allowed to yield elements out of order to trade</span>
<span class="sd">                determinism for performance. Defaults to False.</span>
<span class="sd">            drop_last (bool, optional): Drop the last non-full batch.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            from_wsi (bool): Generate predictions from tiles dynamically</span>
<span class="sd">                extracted from whole-slide images, rather than TFRecords.</span>
<span class="sd">                Defaults to False (use TFRecords).</span>
<span class="sd">            incl_loc (str, optional): &#39;coord&#39;, &#39;grid&#39;, or None. Return (x,y)</span>
<span class="sd">                origin coordinates (&#39;coord&#39;) for each tile center along with tile</span>
<span class="sd">                images, or the (x,y) grid coordinates for each tile.</span>
<span class="sd">                Defaults to &#39;coord&#39;.</span>
<span class="sd">            incl_slidenames (bool, optional): Include slidenames as third returned</span>
<span class="sd">                variable. Defaults to False.</span>
<span class="sd">            infinite (bool, optional): Create an finite dataset. WARNING: If</span>
<span class="sd">                infinite is False &amp;&amp; balancing is used, some tiles will be skipped.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            img_size (int): Image width in pixels.</span>
<span class="sd">            normalizer (:class:`slideflow.norm.StainNormalizer`, optional):</span>
<span class="sd">                Normalizer to use on images. Defaults to None.</span>
<span class="sd">            num_parallel_reads (int, optional): Number of parallel reads for each</span>
<span class="sd">                TFRecordDataset. Defaults to 4.</span>
<span class="sd">            num_shards (int, optional): Shard the tfrecord datasets, used for</span>
<span class="sd">                multiprocessing datasets. Defaults to None.</span>
<span class="sd">            pool (multiprocessing.Pool): Shared multiprocessing pool. Useful</span>
<span class="sd">                if ``from_wsi=True``, for sharing a unified processing pool between</span>
<span class="sd">                dataloaders. Defaults to None.</span>
<span class="sd">            rois (list(str), optional): List of ROI paths. Only used if</span>
<span class="sd">                from_wsi=True.  Defaults to None.</span>
<span class="sd">            roi_method (str, optional): Method for extracting ROIs. Only used if</span>
<span class="sd">                from_wsi=True. Defaults to &#39;auto&#39;.</span>
<span class="sd">            shard_idx (int, optional): Index of the tfrecord shard to use.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            standardize (bool, optional): Standardize images to (0,1).</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            tile_um (int, optional): Size of tiles to extract from WSI, in</span>
<span class="sd">                microns. Only used if from_wsi=True. Defaults to None.</span>
<span class="sd">            tfrecord_parser (Callable, optional): Custom parser for TFRecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            transform (Callable, optional): Arbitrary transform function.</span>
<span class="sd">                Performs transformation after augmentations but before</span>
<span class="sd">                standardization. Defaults to None.</span>
<span class="sd">            **decode_kwargs (dict): Keyword arguments to pass to</span>
<span class="sd">                :func:`slideflow.io.tensorflow.decode_image`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.data.Dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">slideflow.io.tensorflow</span> <span class="kn">import</span> <span class="n">interleave</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;tile_px and tile_um must be non-zero&quot;</span>
                                      <span class="s2">&quot;to create dataloaders.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Dataset balancing is disabled when `from_wsi=True`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">and</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Dataset clipping is disabled when `from_wsi=True`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;from_wsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">prob_weights</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
            <span class="n">prob_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_weights</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tfrecords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TFRecordsNotFoundError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_img_format</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interleave</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="n">tfrecords</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                          <span class="n">img_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                          <span class="n">prob_weights</span><span class="o">=</span><span class="n">prob_weights</span><span class="p">,</span>
                          <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tfrecord_report</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a PDF report of TFRecords.</span>

<span class="sd">        Reports include 10 example tiles per TFRecord. Report is saved</span>
<span class="sd">        in the target destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            dest (str): Directory in which to save the PDF report.</span>
<span class="sd">            normalizer (`slideflow.norm.StainNormalizer`, optional):</span>
<span class="sd">                Normalizer to use on image tiles. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">normalizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using realtime </span><span class="si">{</span><span class="n">normalizer</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> normalization&#39;</span><span class="p">)</span>

        <span class="n">tfrecord_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating TFRecords report...&#39;</span><span class="p">)</span>
        <span class="c1"># Get images for report</span>
        <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">tfrecord_list</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Generating report...&#39;</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_tfrecord_parser</span><span class="p">(</span>
                <span class="n">tfr</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;image_raw&#39;</span><span class="p">,),</span>
                <span class="n">to_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">decode_images</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sample_tiles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">image_raw_data</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">record</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">normalizer</span><span class="p">:</span>
                    <span class="n">image_raw_data</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">jpeg_to_jpeg</span><span class="p">(</span><span class="n">image_raw_data</span><span class="p">)</span>
                <span class="n">sample_tiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">image_raw_data</span><span class="p">]</span>
            <span class="n">reports</span> <span class="o">+=</span> <span class="p">[</span><span class="n">SlideReport</span><span class="p">(</span><span class="n">sample_tiles</span><span class="p">,</span>
                                    <span class="n">tfr</span><span class="p">,</span>
                                    <span class="n">tile_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                                    <span class="n">tile_um</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                                    <span class="n">ignore_thumb_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

        <span class="c1"># Generate and save PDF</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating PDF (this may take some time)...&#39;</span><span class="p">)</span>
        <span class="n">pdf_report</span> <span class="o">=</span> <span class="n">ExtractionReport</span><span class="p">(</span><span class="n">reports</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;TFRecord Report&#39;</span><span class="p">)</span>
        <span class="n">timestring</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isdir</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;tfrecord_report-</span><span class="si">{</span><span class="n">timestring</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find destination directory </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">pdf_report</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TFRecord report saved to [green]</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tfrecord_heatmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tfrecord</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">tile_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a tfrecord-based WSI heatmap.</span>

<span class="sd">        Uses a dictionary of tile values for heatmap display, and saves to</span>
<span class="sd">        the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            tfrecord (str or list(str)): Path(s) to tfrecord(s).</span>
<span class="sd">            tile_dict (dict): Dictionary mapping tfrecord indices to a</span>
<span class="sd">                tile-level value for display in heatmap format</span>
<span class="sd">            filename (str): Destination filename for heatmap.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slide_paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">sp</span><span class="p">):</span> <span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;Dataset tile_px &amp; tile_um must be set to create TFRecords.&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_paths</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to find slide </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tfrecord_heatmap</span><span class="p">(</span>
                <span class="n">tfrecord</span><span class="o">=</span><span class="n">tfr</span><span class="p">,</span>
                <span class="n">slide</span><span class="o">=</span><span class="n">slide_paths</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">tile_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="n">tile_um</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="n">tile_dict</span><span class="o">=</span><span class="n">tile_dict</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">tfrecords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all tfrecords.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str, optional): Only return tfrecords from this dataset</span>
<span class="sd">                source. Defaults to None (return all tfrecords in dataset).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tfrecords paths.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sources_to_search</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># type: List[str]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sources_to_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">]</span>

        <span class="n">tfrecords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">folders_to_search</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources_to_search</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tfrecords_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tfrecords path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tfrecord_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tfrecords</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tfrecord_path</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;TFRecords path not found: </span><span class="si">{</span><span class="n">tfrecord_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">folders_to_search</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tfrecord_path</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders_to_search</span><span class="p">:</span>
            <span class="n">tfrecords_list</span> <span class="o">+=</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;*.tfrecords&quot;</span><span class="p">))</span>
        <span class="n">tfrecords_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tfrecords_list</span><span class="p">))</span>

        <span class="c1"># Filter the list by filters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">filtered_tfrecords_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tfrecord</span> <span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">tfrecords_list</span>
                <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span> <span class="ow">in</span> <span class="n">slides</span>
            <span class="p">]</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">filtered_tfrecords_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error filtering TFRecords, are annotations empty?&quot;</span><span class="p">)</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">tfrecords_list</span>

        <span class="c1"># Filter by min_tiles</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">f</span> <span class="ow">in</span> <span class="n">manifest</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">()</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tiles</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">manifest</span> <span class="ow">and</span> <span class="n">manifest</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_tiles</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">manifest</span> <span class="ow">and</span> <span class="n">manifest</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">tfrecords_by_subfolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all tfrecords in a specific subfolder.</span>

<span class="sd">        Ignores any dataset filters.</span>

<span class="sd">        Args:</span>
<span class="sd">            subfolder (str): Path to subfolder to check for tfrecords.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tfrecords paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfrecords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">folders_to_search</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tfrecords_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tfrecords path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">tfrecord_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tfrecord_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to find subfolder [bold]</span><span class="si">{</span><span class="n">subfolder</span><span class="si">}</span><span class="s2">[/] in &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;source [bold]</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">[/], tfrecord directory: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;[green]</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">folders_to_search</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tfrecord_path</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders_to_search</span><span class="p">:</span>
            <span class="n">tfrecords_list</span> <span class="o">+=</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;*.tfrecords&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tfrecords_list</span>

    <span class="k">def</span> <span class="nf">tfrecords_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return folders containing tfrecords.&quot;&quot;&quot;</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tfrecords_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tfrecords path not set for source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">folders</span> <span class="o">+=</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="p">)]</span>
        <span class="k">return</span> <span class="n">folders</span>

    <span class="k">def</span> <span class="nf">tfrecords_from_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete_tiles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create tfrecord files from a collection of raw images.</span>

<span class="sd">        Images must be stored in the dataset source(s) tiles directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            delete_tiles (bool): Remove tiles after storing in tfrecords.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;Dataset tile_px &amp; tile_um must be set to create TFRecords.&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on dataset source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tiles_set</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tfrecords_set</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;tiles and/or tfrecords paths not set for &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tfrecord_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tfrecords&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
            <span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tiles&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No tiles found for source [bold]</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_tfrecords_multi</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="n">tfrecord_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">delete_tiles</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tfrecords_have_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if TFRecords have associated tile location information.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tfr_has_loc</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tfrecord_has_locations</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TFRecordsError</span><span class="p">:</span>
                <span class="c1"># Encountered when the TFRecord is empty.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tfr_has_loc</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tfr</span><span class="si">}</span><span class="s2">: Tile location information missing.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">thumbnails</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
        <span class="n">roi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate square slide thumbnails with black borders of fixed size.</span>

<span class="sd">        Saves thumbnails to the specified directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            size (int, optional): Width/height of thumbnail in pixels.</span>
<span class="sd">                Defaults to 512.</span>
<span class="sd">            dataset (:class:`slideflow.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate activations. If not supplied, will</span>
<span class="sd">                calculate activations for all tfrecords at the tile_px/tile_um</span>
<span class="sd">                matching the supplied model, optionally using provided filters</span>
<span class="sd">                and filter_blank.</span>
<span class="sd">            filters (dict, optional): Dataset filters to use for</span>
<span class="sd">                selecting slides. See :meth:`slideflow.Dataset.filter` for</span>
<span class="sd">                more information. Defaults to None.</span>
<span class="sd">            filter_blank (list(str) or str, optional): Skip slides that have</span>
<span class="sd">                blank values in these patient annotation columns.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            roi (bool, optional): Include ROI in the thumbnail images.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            enable_downsample (bool, optional): If True and a thumbnail is not</span>
<span class="sd">                embedded in the slide file, downsampling is permitted to</span>
<span class="sd">                accelerate thumbnail calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slide_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
        <span class="n">rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving thumbnails to [green]</span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">slide_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">slide_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating thumbnails...&quot;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on [green]</span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span><span class="si">}</span><span class="s1">[/]...&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">whole_slide</span> <span class="o">=</span> <span class="n">WSI</span><span class="p">(</span><span class="n">slide_path</span><span class="p">,</span>
                                  <span class="n">tile_px</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                  <span class="n">tile_um</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                  <span class="n">stride_div</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">enable_downsample</span><span class="o">=</span><span class="n">enable_downsample</span><span class="p">,</span>
                                  <span class="n">rois</span><span class="o">=</span><span class="n">rois</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingROIError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">slide_path</span><span class="si">}</span><span class="s2">; missing ROI&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error generating thumbnail for </span><span class="si">{</span><span class="n">slide_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
                <span class="n">thumb</span> <span class="o">=</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">rois</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thumb</span> <span class="o">=</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">square_thumb</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">thumb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">whole_slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Thumbnail generation complete.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_val_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated function.&quot;&quot;&quot;</span>  <span class="c1"># noqa: D401</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Dataset.train_val_split() is deprecated and will be &quot;</span>
            <span class="s2">&quot;removed in a future version. Please use Dataset.split()&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transform_tfrecords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform TFRecords, saving to a target path.</span>

<span class="sd">        Tfrecords will be saved in the output directory nested by source name.</span>

<span class="sd">        Args:</span>
<span class="sd">            dest (str): Destination.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working on source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tfr_dest</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tfr_dest</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tfr_dest</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">):</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">transform_tfrecord</span><span class="p">(</span>
                    <span class="n">tfr</span><span class="p">,</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tfr_dest</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">tfr</span><span class="p">)),</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> transformed tfrecords to </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">torch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rebuild_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataLoader&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a PyTorch DataLoader object that interleaves tfrecords.</span>

<span class="sd">        The returned dataloader yields a batch of (image, label) for each tile.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (dict, str, or pd.DataFrame, optional): If a dict is provided,</span>
<span class="sd">                expect a dict mapping slide names to outcome labels. If a str,</span>
<span class="sd">                will intepret as categorical annotation header. For regression</span>
<span class="sd">                tasks, or outcomes with manually assigned labels, pass the</span>
<span class="sd">                first result of dataset.labels(...). If None, returns slide</span>
<span class="sd">                instead of label.</span>
<span class="sd">            batch_size (int): Batch size.</span>
<span class="sd">            rebuild_index (bool): Re-build index files even if already present.</span>
<span class="sd">                Defaults to True.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            augment (str or bool): Image augmentations to perform. Augmentations include:</span>

<span class="sd">                * ``&#39;x&#39;``: Random horizontal flip</span>
<span class="sd">                * ``&#39;y&#39;``: Random vertical flip</span>
<span class="sd">                * ``&#39;r&#39;``: Random 90-degree rotation</span>
<span class="sd">                * ``&#39;j&#39;``: Random JPEG compression (50% chance to compress with quality between 50-100)</span>
<span class="sd">                * ``&#39;b&#39;``: Random Gaussian blur (10% chance to blur with sigma between 0.5-2.0)</span>
<span class="sd">                * ``&#39;n&#39;``: Random :ref:`stain_augmentation` (requires stain normalizer)</span>

<span class="sd">                Combine letters to define augmentations, such as ``&#39;xyrjn&#39;``.</span>
<span class="sd">                A value of True will use ``&#39;xyrjb&#39;``.</span>
<span class="sd">            chunk_size (int, optional): Chunk size for image decoding.</span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">            drop_last (bool, optional): Drop the last non-full batch.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            from_wsi (bool): Generate predictions from tiles dynamically</span>
<span class="sd">                extracted from whole-slide images, rather than TFRecords.</span>
<span class="sd">                Defaults to False (use TFRecords).</span>
<span class="sd">            incl_loc (bool, optional): Include loc_x and loc_y (image tile</span>
<span class="sd">                center coordinates, in base / level=0 dimension) as additional</span>
<span class="sd">                returned variables. Defaults to False.</span>
<span class="sd">            incl_slidenames (bool, optional): Include slidenames as third returned</span>
<span class="sd">                variable. Defaults to False.</span>
<span class="sd">            infinite (bool, optional): Infinitely repeat data. Defaults to True.</span>
<span class="sd">            max_size (bool, optional): Unused argument present for legacy</span>
<span class="sd">                compatibility; will be removed.</span>
<span class="sd">            model_type (str, optional): Used to generate random labels</span>
<span class="sd">                (for StyleGAN2). Not required. Defaults to &#39;classification&#39;.</span>
<span class="sd">            num_replicas (int, optional): Number of GPUs or unique instances which</span>
<span class="sd">                will have their own DataLoader. Used to interleave results among</span>
<span class="sd">                workers without duplications. Defaults to 1.</span>
<span class="sd">            num_workers (int, optional): Number of DataLoader workers.</span>
<span class="sd">                Defaults to 2.</span>
<span class="sd">            normalizer (:class:`slideflow.norm.StainNormalizer`, optional):</span>
<span class="sd">                Normalizer. Defaults to None.</span>
<span class="sd">            onehot (bool, optional): Onehot encode labels. Defaults to False.</span>
<span class="sd">            persistent_workers (bool, optional): Sets the DataLoader</span>
<span class="sd">                persistent_workers flag. Defaults toNone (4 if not using a SPAMS</span>
<span class="sd">                normalizer, 1 if using SPAMS).</span>
<span class="sd">            pin_memory (bool, optional): Pin memory to GPU. Defaults to True.</span>
<span class="sd">            pool (multiprocessing.Pool): Shared multiprocessing pool. Useful</span>
<span class="sd">                if from_wsi=True, for sharing a unified processing pool between</span>
<span class="sd">                dataloaders. Defaults to None.</span>
<span class="sd">            prefetch_factor (int, optional): Number of batches to prefetch in each</span>
<span class="sd">                SlideflowIterator. Defaults to 1.</span>
<span class="sd">            rank (int, optional): Worker ID to identify this worker.</span>
<span class="sd">                Used to interleave results.</span>
<span class="sd">                among workers without duplications. Defaults to 0 (first worker).</span>
<span class="sd">            rois (list(str), optional): List of ROI paths. Only used if</span>
<span class="sd">                from_wsi=True.  Defaults to None.</span>
<span class="sd">            roi_method (str, optional): Method for extracting ROIs. Only used if</span>
<span class="sd">                from_wsi=True. Defaults to &#39;auto&#39;.</span>
<span class="sd">            standardize (bool, optional): Standardize images to mean 0 and</span>
<span class="sd">                variance of 1. Defaults to True.</span>
<span class="sd">            tile_um (int, optional): Size of tiles to extract from WSI, in</span>
<span class="sd">                microns. Only used if from_wsi=True. Defaults to None.</span>
<span class="sd">            transform (Callable, optional): Arbitrary torchvision transform</span>
<span class="sd">                function. Performs transformation after augmentations but</span>
<span class="sd">                before standardization. Defaults to None.</span>
<span class="sd">            tfrecord_parser (Callable, optional): Custom parser for TFRecords.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">slideflow.io.torch</span> <span class="kn">import</span> <span class="n">interleave_dataloader</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="s2">&quot;tile_px and tile_um must be non-zero&quot;</span>
                                      <span class="s2">&quot;to create dataloaders.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">and</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Dataset clipping is disabled when `from_wsi=True`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_index</span><span class="p">(</span><span class="n">rebuild_index</span><span class="p">)</span>
            <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tfrecords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TFRecordsNotFoundError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_img_format</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">_idx_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_indices</span><span class="p">()</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">_idx_dict</span><span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)]</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">]</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_weights</span><span class="p">:</span>
            <span class="n">prob_weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_weights</span><span class="p">[</span><span class="n">tfr</span><span class="p">]</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_weights</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">interleave_dataloader</span><span class="p">(</span><span class="n">tfrecords</span><span class="o">=</span><span class="n">tfrecords</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                     <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                                     <span class="n">num_tiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">,</span>
                                     <span class="n">prob_weights</span><span class="o">=</span><span class="n">prob_weights</span><span class="p">,</span>
                                     <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
                                     <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
                                     <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unclip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dataset object with all clips removed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`slideflow.Dataset`: Dataset with clips removed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">update_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update tfrecord manifests.</span>

<span class="sd">        Args:</span>
<span class="sd">            forced_update (bool, optional): Force regeneration of the</span>
<span class="sd">                manifests from scratch.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfrecords_folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords_folders</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tfr_folder</span> <span class="ow">in</span> <span class="n">tfrecords_folders</span><span class="p">:</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">update_manifest_at_dir</span><span class="p">(</span>
                <span class="n">directory</span><span class="o">=</span><span class="n">tfr_folder</span><span class="p">,</span>
                <span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_annotations_with_slidenames</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">annotations_file</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Automatically associated slide names and paths in the annotations.</span>

<span class="sd">        Attempts to automatically associate slide names from a directory</span>
<span class="sd">        with patients in a given annotations file, skipping any slide names</span>
<span class="sd">        that are already present in the annotations file.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotations_file (str): Path to annotations file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">read_annotations</span><span class="p">(</span><span class="n">annotations_file</span><span class="p">)</span>
        <span class="n">slide_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(</span><span class="n">apply_filters</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># First, load all patient names from the annotations file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">patient_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;patient&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Patient header </span><span class="si">{</span><span class="s1">&#39;patient&#39;</span><span class="si">}</span><span class="s2"> not found in annotations.&quot;</span>
            <span class="p">)</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt_to_slide</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotations_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                <span class="n">patients</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">patient_index</span><span class="p">]])</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">patients</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of patients in annotations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patients</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slides found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Then, check for sets of slides that would match to the same patient;</span>
        <span class="c1"># due to ambiguity, these will be skipped.</span>
        <span class="n">n_occur</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n_occur</span><span class="p">:</span>
                <span class="n">n_occur</span><span class="p">[</span><span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_occur</span><span class="p">[</span><span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">slides_to_skip</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slide_list</span> <span class="k">if</span> <span class="n">n_occur</span><span class="p">[</span><span class="n">_shortname</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Next, search through the slides folder for all valid slide files</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">:</span>
            <span class="n">slide</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="c1"># First, skip this slide due to ambiguity if needed</span>
            <span class="k">if</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides_to_skip</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2"> due to ambiguity&quot;</span><span class="p">)</span>
            <span class="c1"># Then, make sure the shortname and long name</span>
            <span class="c1"># aren&#39;t both in the annotation file</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">slide</span> <span class="o">!=</span> <span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">))</span>
               <span class="ow">and</span> <span class="p">(</span><span class="n">slide</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">)</span>
               <span class="ow">and</span> <span class="p">(</span><span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">)):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s2"> due to ambiguity&quot;</span><span class="p">)</span>
            <span class="c1"># Check if either the slide name or the shortened version</span>
            <span class="c1"># are in the annotation file</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">patients</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">slide</span><span class="p">,</span> <span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">)]):</span>
                <span class="n">slide</span> <span class="o">=</span> <span class="n">slide</span> <span class="k">if</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">patients</span> <span class="k">else</span> <span class="n">_shortname</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="n">pt_to_slide</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">slide</span><span class="p">:</span> <span class="n">slide</span><span class="p">})</span>

        <span class="c1"># Now, write the assocations</span>
        <span class="n">n_updated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_missing</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotations_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;temp.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_outfile</span><span class="p">:</span>
                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_outfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="c1"># Write to existing &quot;slide&quot; column in the annotations file,</span>
                <span class="c1"># otherwise create new column</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">slide_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;slide&#39;</span><span class="p">])</span>
                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                        <span class="n">patient</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">patient_index</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">pt_to_slide</span><span class="p">:</span>
                            <span class="n">row</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pt_to_slide</span><span class="p">[</span><span class="n">patient</span><span class="p">]])</span>
                            <span class="n">n_updated</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">row</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
                            <span class="n">n_missing</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">patient_index</span><span class="p">]</span>
                        <span class="c1"># Only write column if no slide is in the annotation</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pt</span> <span class="ow">in</span> <span class="n">pt_to_slide</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">slide_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                            <span class="n">row</span><span class="p">[</span><span class="n">slide_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_to_slide</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span>
                            <span class="n">n_updated</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pt_to_slide</span><span class="p">)</span>
                              <span class="ow">and</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">slide_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
                            <span class="n">n_missing</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_updated</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done; associated slides with </span><span class="si">{</span><span class="n">n_updated</span><span class="si">}</span><span class="s2"> annotations.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_missing</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slides not found for </span><span class="si">{</span><span class="n">n_missing</span><span class="si">}</span><span class="s2"> annotations.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n_missing</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slides missing for </span><span class="si">{</span><span class="n">n_missing</span><span class="si">}</span><span class="s2"> annotations.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Annotations up-to-date, no changes made.&quot;</span><span class="p">)</span>

        <span class="c1"># Finally, backup the old annotation file and overwrite</span>
        <span class="c1"># existing with the new data</span>
        <span class="n">backup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotations_file</span><span class="si">}</span><span class="s2">.backup&quot;</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">backup_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">backup_file</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotations_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">annotations_file</span><span class="p">,</span> <span class="n">backup_file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s1">&#39;temp.csv&#39;</span><span class="p">,</span> <span class="n">annotations_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_annotations_slides</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that annotations are correctly loaded.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Annotations not loaded.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Verify no duplicate slide names are found</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">())]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ann</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="s2">&quot;Duplicate slide names detected in the annotation file.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Verify that there are no tfrecords with the same name.</span>
        <span class="c1"># This is a problem because the tfrecord name is used to</span>
        <span class="c1"># identify the slide.</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfrecords</span><span class="p">):</span>
            <span class="n">tfrecord_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tfrecord_names</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfrecord_names</span><span class="p">):</span>
                <span class="n">duplicate_tfrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">tfr</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">tfrecords</span>
                    <span class="k">if</span> <span class="n">tfrecord_names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">]</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                    <span class="s2">&quot;Multiple TFRecords with the same names detected: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duplicate_tfrs</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Verify all slides in the annotation column are valid</span>
        <span class="n">n_missing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">])</span>
             <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
        <span class="p">])</span>
        <span class="k">if</span> <span class="n">n_missing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;1 patient does not have a slide assigned.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_missing</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_missing</span><span class="si">}</span><span class="s2"> patients do not have a slide assigned.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_img_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that all tfrecords have the same image format (PNG/JPG).</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: image format (png or jpeg)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfrecords</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(),</span>
                         <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">img_formats</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mapped</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">detect_tfrecord_format</span><span class="p">,</span>
                    <span class="n">tfrecords</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
                    <span class="n">mapped</span> <span class="o">=</span> <span class="n">track</span><span class="p">(</span>
                        <span class="n">mapped</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Verifying tfrecord formats...&quot;</span><span class="p">,</span>
                        <span class="n">transient</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">img_formats</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fmt</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">img_formats</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;Mismatched TFRecord image formats:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">tfr</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tfrecords</span><span class="p">,</span> <span class="n">img_formats</span><span class="p">):</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tfr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">MismatchedImageFormatsError</span><span class="p">(</span>
                        <span class="s2">&quot;Mismatched TFRecord image formats detected&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_formats</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">img_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">verify_slide_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that slide names inside TFRecords match the file names.</span>

<span class="sd">        Args:</span>
<span class="sd">            allow_errors (bool): Do not raise an error if there is a mismatch.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: If all slide names inside TFRecords match the TFRecord</span>
<span class="sd">                file names.</span>

<span class="sd">        Raises:</span>
<span class="sd">            sf.errors.MismatchedSlideNamesError: If any slide names inside</span>
<span class="sd">                TFRecords do not match the TFRecord file names,</span>
<span class="sd">                and allow_errors=False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tfrecords</span><span class="p">):</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="n">track</span><span class="p">(</span>
                <span class="n">tfrecords</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Verifying tfrecord slide names...&quot;</span><span class="p">,</span>
                <span class="n">transient</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">pb</span><span class="p">:</span>
                <span class="n">first_record</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_tfrecord_by_index</span><span class="p">(</span><span class="n">tfr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_record</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">allow_errors</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">MismatchedSlideNamesError</span><span class="p">(</span>
                        <span class="s2">&quot;Mismatched slide name in TFRecord </span><span class="si">{}</span><span class="s2">: expected slide &quot;</span>
                        <span class="s2">&quot;name </span><span class="si">{}</span><span class="s2"> based on filename, but found </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">tfr</span><span class="p">,</span>
                            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">),</span>
                            <span class="n">first_record</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>
</pre></div>

             </article>

            </div>
            <footer>




    <hr>



  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, James M Dolezal.

    </p>
  </div>

      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>


</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">

            </div>
          </div>
        </div>
      </section>
    </div>







       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>



  <script type="text/javascript" src="../../../_static/js/vendor/jquery-3.6.3.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>