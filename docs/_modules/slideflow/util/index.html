


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>slideflow.util &mdash; slideflow 3.0.0 documentation</title>















  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />




  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-Light.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexSans/IBMPlexSans-MediumItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <script defer data-domain="slideflow.dev" src="https://plausible.io/js/script.js"></script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">





    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">





                <div class="version">
                  3.0
                </div>









<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


          </div>







              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_setup/">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets_and_val/">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide_processing/">Slide Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../evaluation/">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../posthoc/">Layer Activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uq/">Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/">Generating Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mil/">Multiple-Instance Learning (MIL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ssl/">Self-Supervised Learning (SSL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stylegan/">Generative Networks (GANs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../saliency/">Saliency Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../segmentation/">Tissue Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cellseg/">Cell Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_loops/">Custom Training Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../studio/">Slideflow Studio: Live Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tfrecords/">TFRecords: Reading and Writing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataloaders/">Dataloaders: Sampling and Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_extractors/">Custom Feature Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tile_labels/">Strong Supervision with Tile Labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins/">Creating a Slideflow Plugin</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../slideflow/">slideflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project/">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataset/">slideflow.Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataset_features/">slideflow.DatasetFeatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heatmap/">slideflow.Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_params/">slideflow.ModelParams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mosaic/">slideflow.Mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slidemap/">slideflow.SlideMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../biscuit/">slideflow.biscuit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slideflow_cellseg/">slideflow.cellseg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io_tensorflow/">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io_torch/">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gan/">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grad/">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mil_module/">slideflow.mil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model/">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_tensorflow/">slideflow.model.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_torch/">slideflow.model.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../norm/">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simclr/">slideflow.simclr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide/">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide_qc/">slideflow.slide.qc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stats/">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../util/">slideflow.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../studio_module/">slideflow.studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial1/">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial2/">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial3/">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial4/">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial5/">Tutorial 5: Creating a mosaic map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial6/">Tutorial 6: Custom slide filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial7/">Tutorial 7: Training with custom augmentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial8/">Tutorial 8: Multiple-Instance Learning</a></li>
</ul>



        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">

      <li>
        <a href="../../../">

            Docs

        </a> &gt;
      </li>


          <li><a href="../../">Module code</a> &gt;</li>

      <li>slideflow.util</li>


      <li class="pytorch-breadcrumbs-aside">

      </li>

  </ul>


</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">



          <div class="rst-content">

            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">

  <h1>Source code for slideflow.util</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">rich</span> <span class="kn">import</span> <span class="n">progress</span>
<span class="kn">from</span> <span class="nn">rich.logging</span> <span class="kn">import</span> <span class="n">RichHandler</span>
<span class="kn">from</span> <span class="nn">rich.highlighter</span> <span class="kn">import</span> <span class="n">NullHighlighter</span>
<span class="kn">from</span> <span class="nn">rich.panel</span> <span class="kn">import</span> <span class="n">Panel</span>
<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.progress</span> <span class="kn">import</span> <span class="n">Progress</span><span class="p">,</span> <span class="n">TextColumn</span><span class="p">,</span> <span class="n">BarColumn</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">example_pb2</span><span class="p">,</span> <span class="n">log_utils</span>
<span class="kn">from</span> <span class="nn">.colors</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># noqa F403,F401 - Here for compatibility</span>
<span class="kn">from</span> <span class="nn">.smac_utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">broad_search_space</span><span class="p">,</span> <span class="n">shallow_search_space</span><span class="p">,</span>
                         <span class="n">create_search_space</span><span class="p">)</span>

<span class="n">tf_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">)</span>
<span class="n">torch_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">&#39;torch&#39;</span><span class="p">)</span>

<span class="c1"># Enable color sequences on Windows</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes.windll</span>
    <span class="n">kernel32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">SetConsoleMode</span><span class="p">(</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetStdHandle</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="c1"># --- Global vars -------------------------------------------------------------</span>

<span class="n">SUPPORTED_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;svs&#39;</span><span class="p">,</span> <span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;ndpi&#39;</span><span class="p">,</span> <span class="s1">&#39;vms&#39;</span><span class="p">,</span> <span class="s1">&#39;vmu&#39;</span><span class="p">,</span> <span class="s1">&#39;scn&#39;</span><span class="p">,</span> <span class="s1">&#39;mrxs&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;svslide&#39;</span><span class="p">,</span> <span class="s1">&#39;bif&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ome.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;ome.tiff&#39;</span><span class="p">]</span>
<span class="n">EMPTY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
<span class="n">CPLEX_AVAILABLE</span> <span class="o">=</span> <span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">&#39;cplex&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyomo.environ</span> <span class="k">as</span> <span class="nn">pyo</span>
    <span class="kn">from</span> <span class="nn">pyomo.opt</span> <span class="kn">import</span> <span class="n">SolverFactory</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;bonmin&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SolverNotFoundError</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">BONMIN_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">BONMIN_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>


<span class="c1"># --- Commonly used types -----------------------------------------------------</span>

<span class="c1"># Outcome labels</span>
<span class="n">Labels</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span>

<span class="c1"># Normalizer fit keyword arguments</span>
<span class="n">NormFit</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]]</span>

<span class="c1"># --- Detect CPU cores --------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sched_getaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">count</span>

<span class="c1"># --- Configure logging--------------------------------------------------------</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;slideflow&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<div class="viewcode-block" id="setLoggingLevel"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.setLoggingLevel">[docs]</a><span class="k">def</span> <span class="nf">setLoggingLevel</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the logging level.</span>

<span class="sd">    Uses standard python logging levels:</span>

<span class="sd">    - 50: CRITICAL</span>
<span class="sd">    - 40: ERROR</span>
<span class="sd">    - 30: WARNING</span>
<span class="sd">    - 20: INFO</span>
<span class="sd">    - 10: DEBUG</span>
<span class="sd">    - 0:  NOTSET</span>

<span class="sd">    Args:</span>
<span class="sd">        level (int): Logging level numeric value.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></div>


<div class="viewcode-block" id="getLoggingLevel"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.getLoggingLevel">[docs]</a><span class="k">def</span> <span class="nf">getLoggingLevel</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the current logging level.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">log</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">level</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">logging_level</span><span class="p">(</span><span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">_initial</span> <span class="o">=</span> <span class="n">getLoggingLevel</span><span class="p">()</span>
    <span class="n">setLoggingLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">setLoggingLevel</span><span class="p">(</span><span class="n">_initial</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">addLoggingFileHandler</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">log_utils</span><span class="o">.</span><span class="n">FileFormatter</span><span class="p">())</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">log_utils</span><span class="o">.</span><span class="n">MultiProcessingHandler</span><span class="p">(</span>
        <span class="s2">&quot;mp-file-handler-</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">handlers</span><span class="p">)),</span>
        <span class="n">sub_handler</span><span class="o">=</span><span class="n">fh</span>
    <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>


<span class="c1"># Add tqdm-friendly stream handler</span>
<span class="c1">#ch = log_utils.TqdmLoggingHandler()</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">RichHandler</span><span class="p">(</span>
    <span class="n">markup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">log_time_format</span><span class="o">=</span><span class="s2">&quot;[</span><span class="si">%X</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="n">show_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">highlighter</span><span class="o">=</span><span class="n">NullHighlighter</span><span class="p">(),</span>
    <span class="n">rich_tracebacks</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">log_utils</span><span class="o">.</span><span class="n">LogFormatter</span><span class="p">())</span>
<span class="k">if</span> <span class="s1">&#39;SF_LOGGING_LEVEL&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">intLevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SF_LOGGING_LEVEL&#39;</span><span class="p">])</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">intLevel</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="c1"># Add multiprocessing-friendly file handler</span>
<span class="n">addLoggingFileHandler</span><span class="p">(</span><span class="s2">&quot;slideflow.log&quot;</span><span class="p">)</span>

<span class="c1"># Workaround for duplicate logging with TF 2.9</span>
<span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="TileExtractionSpeedColumn"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.TileExtractionSpeedColumn">[docs]</a><span class="k">class</span> <span class="nc">TileExtractionSpeedColumn</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ProgressColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders human readable transfer speed.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TileExtractionSpeedColumn.render"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.TileExtractionSpeedColumn.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;progress.Task&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show data transfer speed.&quot;&quot;&quot;</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">finished_speed</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">speed</span>
        <span class="k">if</span> <span class="n">speed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;progress.data.speed&quot;</span><span class="p">)</span>
        <span class="n">data_speed</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span><span class="si">}</span><span class="s1"> img&#39;</span>
        <span class="k">return</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_speed</span><span class="si">}</span><span class="s2">/s&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;progress.data.speed&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LabeledMofNCompleteColumn"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.LabeledMofNCompleteColumn">[docs]</a><span class="k">class</span> <span class="nc">LabeledMofNCompleteColumn</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">MofNCompleteColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders a completion column with labels.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LabeledMofNCompleteColumn.__init__"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.LabeledMofNCompleteColumn.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span></div>

<div class="viewcode-block" id="LabeledMofNCompleteColumn.render"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.LabeledMofNCompleteColumn.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;progress.Task&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show completion status with labels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;progress.spinner&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">completed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">total</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;progress.spinner&quot;</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="ImgBatchSpeedColumn"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.ImgBatchSpeedColumn">[docs]</a><span class="k">class</span> <span class="nc">ImgBatchSpeedColumn</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ProgressColumn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders human readable transfer speed.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ImgBatchSpeedColumn.__init__"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.ImgBatchSpeedColumn.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></div>

<div class="viewcode-block" id="ImgBatchSpeedColumn.render"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.ImgBatchSpeedColumn.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="s2">&quot;progress.Task&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show data transfer speed.&quot;&quot;&quot;</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">finished_speed</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">speed</span>
        <span class="k">if</span> <span class="n">speed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;progress.data.speed&quot;</span><span class="p">)</span>
        <span class="n">data_speed</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span><span class="si">}</span><span class="s1"> img&#39;</span>
        <span class="k">return</span> <span class="n">progress</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_speed</span><span class="si">}</span><span class="s2">/s&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;progress.data.speed&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TileExtractionProgress"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.TileExtractionProgress">[docs]</a><span class="k">class</span> <span class="nc">TileExtractionProgress</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
<div class="viewcode-block" id="TileExtractionProgress.get_renderables"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.TileExtractionProgress.get_renderables">[docs]</a>    <span class="k">def</span> <span class="nf">get_renderables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;speed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">TileExtractionSpeedColumn</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;slide_progress&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">BarColumn</span><span class="p">(),</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">TaskProgressColumn</span><span class="p">(),</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">MofNCompleteColumn</span><span class="p">(),</span>
                    <span class="s2">&quot;●&quot;</span><span class="p">,</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">TimeRemainingColumn</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_tasks_table</span><span class="p">([</span><span class="n">task</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="FeatureExtractionProgress"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.FeatureExtractionProgress">[docs]</a><span class="k">class</span> <span class="nc">FeatureExtractionProgress</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
<div class="viewcode-block" id="FeatureExtractionProgress.get_renderables"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.FeatureExtractionProgress.get_renderables">[docs]</a>    <span class="k">def</span> <span class="nf">get_renderables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;speed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">TileExtractionSpeedColumn</span><span class="p">(),</span>
                    <span class="n">LabeledMofNCompleteColumn</span><span class="p">(</span><span class="s1">&#39;tiles&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;●&quot;</span><span class="p">,</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">TimeRemainingColumn</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;slide_progress&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">BarColumn</span><span class="p">(),</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">TaskProgressColumn</span><span class="p">(),</span>
                    <span class="n">LabeledMofNCompleteColumn</span><span class="p">(</span><span class="s1">&#39;slides&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_tasks_table</span><span class="p">([</span><span class="n">task</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="set_ignore_sigint"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.set_ignore_sigint">[docs]</a><span class="k">def</span> <span class="nf">set_ignore_sigint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ignore keyboard interrupts.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">signal</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span></div>


<div class="viewcode-block" id="MultiprocessProgressTracker"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.MultiprocessProgressTracker">[docs]</a><span class="k">class</span> <span class="nc">MultiprocessProgressTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for a rich.progress tracker that can be shared across processes.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultiprocessProgressTracker.__init__"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.MultiprocessProgressTracker.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">completed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_values</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">get_lock</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_values</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">amount</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_values</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="MultiprocessProgress"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.MultiprocessProgress">[docs]</a><span class="k">class</span> <span class="nc">MultiprocessProgress</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for a rich.progress bar that can be shared across processes.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultiprocessProgress.__init__"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.MultiprocessProgress.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">MultiprocessProgressTracker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<span class="c1"># --- Slideflow header --------------------------------------------------------</span>

<div class="viewcode-block" id="about"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.about">[docs]</a><span class="k">def</span> <span class="nf">about</span><span class="p">(</span><span class="n">console</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a summary of the slideflow version and active backends.</span>

<span class="sd">    Example</span>
<span class="sd">        &gt;&gt;&gt; sf.about()</span>
<span class="sd">        ╭=======================╮</span>
<span class="sd">        │       Slideflow       │</span>
<span class="sd">        │    Version: 3.0.0     │</span>
<span class="sd">        │  Backend: torch       │</span>
<span class="sd">        │ Slide Backend: cucim  │</span>
<span class="sd">        │ https://slideflow.dev │</span>
<span class="sd">        ╰=======================╯</span>

<span class="sd">    Args:</span>
<span class="sd">        console (rich.console.Console, optional): Active console, if one exists.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">console</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span> <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;tensorflow&#39;</span> <span class="k">else</span> <span class="s1">&#39;purple&#39;</span>
    <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;libvips&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pyvips</span>
            <span class="n">_version</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pyvips</span><span class="o">.</span><span class="n">major</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">micro</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_version</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="n">col2</span> <span class="o">=</span> <span class="s1">&#39;cyan&#39;</span>
        <span class="n">slide_backend</span> <span class="o">=</span> <span class="s1">&#39;libvips (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_version</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slide_backend</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span>
        <span class="n">col2</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
        <span class="n">Panel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[white bold]Slideflow[/]&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Version: </span><span class="si">{</span><span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backend: [</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span><span class="si">}</span><span class="s2">[/]&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Slide Backend: [</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">slide_backend</span><span class="si">}</span><span class="s2">[/]&quot;</span>
              <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[blue]https://slideflow.dev[/]&quot;</span><span class="p">,</span>
              <span class="n">border_style</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">),</span>
        <span class="n">justify</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span></div>


<span class="c1"># --- Data download functions -------------------------------------------------</span>

<div class="viewcode-block" id="download_from_tcga"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.download_from_tcga">[docs]</a><span class="k">def</span> <span class="nf">download_from_tcga</span><span class="p">(</span>
    <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Downloading...&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download a file from TCGA (GDC) by UUID.&quot;&quot;&quot;</span>
    <span class="n">data_endpt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.gdc.cancer.gov/data/&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">data_endpt</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">uuid</span><span class="p">]}),</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
        <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">response_head_cd</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Disposition&quot;</span><span class="p">]</span>
    <span class="n">block_size</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="n">block_per_mb</span> <span class="o">=</span> <span class="n">block_size</span> <span class="o">/</span> <span class="mi">1000000</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="mi">1000000</span>
    <span class="n">running_total_mb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;filename=(.+)&quot;</span><span class="p">,</span> <span class="n">response_head_cd</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="n">file_size_mb</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MB&#39;</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2">: </span><span class="si">{percentage:3.0f}</span><span class="s2">%|</span><span class="si">{bar}</span><span class="s2">| &quot;</span>
                           <span class="s2">&quot;</span><span class="si">{n:.2f}</span><span class="s2">/</span><span class="si">{total:.2f}</span><span class="s2"> [</span><span class="si">{elapsed}</span><span class="s2">&lt;</span><span class="si">{remaining}</span><span class="s2">] &quot;</span>
                           <span class="s2">&quot;</span><span class="si">{rate_fmt}{postfix}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">):</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">block_per_mb</span> <span class="o">+</span> <span class="n">running_total_mb</span> <span class="o">&lt;</span> <span class="n">file_size_mb</span><span class="p">:</span>
                <span class="n">running_total_mb</span> <span class="o">+=</span> <span class="n">block_per_mb</span>  <span class="c1"># type: ignore</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">block_per_mb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">running_total_mb</span> <span class="o">+=</span> <span class="n">file_size_mb</span> <span class="o">-</span> <span class="n">running_total_mb</span>  <span class="c1"># type: ignore</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_size_mb</span> <span class="o">-</span> <span class="n">running_total_mb</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">make_cache_dir_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;HOME&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">],</span> <span class="s1">&#39;.cache&#39;</span><span class="p">,</span> <span class="s1">&#39;slideflow&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;USERPROFILE&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;USERPROFILE&#39;</span><span class="p">],</span> <span class="s1">&#39;.cache&#39;</span><span class="p">,</span> <span class="s1">&#39;slideflow&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="s1">&#39;.cache&#39;</span><span class="p">,</span> <span class="s1">&#39;slideflow&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dest</span>


<span class="k">def</span> <span class="nf">get_gdc_manifest</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">sf_cache</span> <span class="o">=</span> <span class="n">make_cache_dir_path</span><span class="p">(</span><span class="s1">&#39;gdc&#39;</span><span class="p">)</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sf_cache</span><span class="p">,</span> <span class="s1">&#39;gdc_manifest.tsv&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">manifest</span><span class="p">):</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="s1">&#39;gdc_manifest.tar.xz&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://raw.githubusercontent.com/slideflow/slideflow/1.4.0/datasets/</span><span class="si">{</span><span class="n">tar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">sf_cache</span><span class="p">,</span> <span class="n">tar</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">sf_cache</span><span class="p">,</span> <span class="n">tar</span><span class="p">))</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">sf_cache</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">sf_cache</span><span class="p">,</span> <span class="n">tar</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">manifest</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to download GDC manifest.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1"># --- Utility functions and classes -------------------------------------------</span>

<span class="k">class</span> <span class="nc">no_scope</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="EasyDict"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.EasyDict">[docs]</a><span class="k">class</span> <span class="nc">EasyDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience class that behaves like a dict but allows access</span>
<span class="sd">    with the attribute syntax.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<span class="k">def</span> <span class="nf">zip_allowed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;SF_ALLOW_ZIP&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SF_ALLOW_ZIP&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">enable_zip</span><span class="p">(</span><span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
    <span class="n">_zip_allowed</span> <span class="o">=</span> <span class="n">zip_allowed</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SF_ALLOW_ZIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
    <span class="k">yield</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SF_ALLOW_ZIP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">_zip_allowed</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>

<div class="viewcode-block" id="md5"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.md5">[docs]</a><span class="k">def</span> <span class="nf">md5</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate and return MD5 checksum for a file.&quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
        <span class="c1"># No walrus for Python 3.7 :(</span>
        <span class="k">while</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">allow_gpu_memory_growth</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_memory_growth</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">def</span> <span class="nf">model_backend</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">torch_available</span> <span class="ow">and</span> <span class="s1">&#39;torch&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">torch</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;torch&#39;</span>
    <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tf_available</span> <span class="ow">and</span> <span class="s1">&#39;tensorflow&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;tensorflow&#39;</span>
        <span class="kn">from</span> <span class="nn">tensorflow.lite.python.interpreter</span> <span class="kn">import</span> <span class="n">SignatureRunner</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SignatureRunner</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;tflite&#39;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to interpret model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">detuple</span><span class="p">(</span><span class="n">arg1</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">arg1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg1</span>

<span class="k">def</span> <span class="nf">_as_list</span><span class="p">(</span><span class="n">arg1</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg1</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg1</span>

<div class="viewcode-block" id="batch"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.batch">[docs]</a><span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="n">iterable</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Separates an interable into batches of maximum size `n`.&quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">iterable</span><span class="p">[</span><span class="n">ndx</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">ndx</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">)]</span></div>


<div class="viewcode-block" id="batch_generator"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.batch_generator">[docs]</a><span class="k">def</span> <span class="nf">batch_generator</span><span class="p">(</span><span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Separates an interable into batches of maximum size `n`.&quot;&quot;&quot;</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">batch</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">batch</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">as_list</span><span class="p">(</span><span class="n">arg1</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">arg1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg1</span>


<div class="viewcode-block" id="isnumeric"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.isnumeric">[docs]</a><span class="k">def</span> <span class="nf">isnumeric</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the given value is numeric (numpy or python).</span>

<span class="sd">    Tensors will return False.</span>

<span class="sd">    Specifically checks if the value is a python int or float,</span>
<span class="sd">    or if the value is a numpy array with a numeric dtype (int or float).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">float_np_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="n">float_np_types</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">float_np_types</span></div>


<span class="k">def</span> <span class="nf">is_mag</span><span class="p">(</span><span class="n">arg1</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">arg1_split</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg1_split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">arg1_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arg1_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="is_model"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_model">[docs]</a><span class="k">def</span> <span class="nf">is_model</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given path is a valid Slideflow model.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">is_tensorflow_model_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_torch_model_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_project"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_project">[docs]</a><span class="k">def</span> <span class="nf">is_project</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given path is a valid Slideflow project.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_slide"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_slide">[docs]</a><span class="k">def</span> <span class="nf">is_slide</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given path is a supported slide.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">SUPPORTED_FORMATS</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_tensorflow_model_path"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_tensorflow_model_path">[docs]</a><span class="k">def</span> <span class="nf">is_tensorflow_model_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given path is a valid Slideflow/Tensorflow model.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>
                 <span class="ow">or</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))))</span></div>


<div class="viewcode-block" id="is_torch_model_path"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_torch_model_path">[docs]</a><span class="k">def</span> <span class="nf">is_torch_model_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given path is a valid Slideflow/PyTorch model.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span>
            <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="is_simclr_model_path"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_simclr_model_path">[docs]</a><span class="k">def</span> <span class="nf">is_simclr_model_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given path is a valid SimCLR model or checkpoint.&quot;&quot;&quot;</span>
    <span class="n">is_model</span> <span class="o">=</span>  <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                 <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;args.json&#39;</span><span class="p">)))</span>
    <span class="n">is_checkpoint</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                     <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ckpt&#39;</span><span class="p">)</span>
                     <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;args.json&#39;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">is_model</span> <span class="ow">or</span> <span class="n">is_checkpoint</span></div>


<div class="viewcode-block" id="is_uq_model"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_uq_model">[docs]</a><span class="k">def</span> <span class="nf">is_uq_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given model path points to a UQ-enabled model.&quot;&quot;&quot;</span>
    <span class="n">is_model_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_tensorflow_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
                     <span class="ow">or</span> <span class="n">is_torch_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_model_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_model_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;uq&#39;</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">assert_is_mag</span><span class="p">(</span><span class="n">arg1</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_mag</span><span class="p">(</span><span class="n">arg1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Invalid magnification </span><span class="si">{</span><span class="n">arg1</span><span class="si">}</span><span class="s1">. Must be of format&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; [int/float]x, such as &quot;10x&quot;, &quot;20X&quot;, or &quot;2.5x&quot;&#39;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">to_mag</span><span class="p">(</span><span class="n">arg1</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">assert_is_mag</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">arg1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>


<div class="viewcode-block" id="is_tile_size_compatible"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.is_tile_size_compatible">[docs]</a><span class="k">def</span> <span class="nf">is_tile_size_compatible</span><span class="p">(</span>
    <span class="n">tile_px1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">tile_um1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">tile_px2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">tile_um2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether tile sizes are compatible.</span>

<span class="sd">    Compatibility is defined as:</span>
<span class="sd">        - Equal size in pixels</span>
<span class="sd">        - If tile width (tile_um) is defined in microns (int) for both, these must be equal</span>
<span class="sd">        - If tile width (tile_um) is defined as a magnification (str) for both, these must be equal</span>
<span class="sd">        - If one is defined in microns and the other as a magnification, the calculated magnification must be +/- 2.</span>

<span class="sd">    Example 1:</span>
<span class="sd">    - tile_px1=299, tile_um1=302</span>
<span class="sd">    - tile_px2=299, tile_um2=304</span>
<span class="sd">    - Incompatible (unequal micron width)</span>

<span class="sd">    Example 2:</span>
<span class="sd">    - tile_px1=299, tile_um1=10x</span>
<span class="sd">    - tile_px2=299, tile_um2=9x</span>
<span class="sd">    - Incompatible (unequal magnification)</span>

<span class="sd">    Example 3:</span>
<span class="sd">    - tile_px1=299, tile_um1=302</span>
<span class="sd">    - tile_px2=299, tile_um2=10x</span>
<span class="sd">    - Compatible (first has an equivalent magnification of 9.9x, which is +/- 2 compared to 10x)</span>


<span class="sd">    Args:</span>
<span class="sd">        tile_px1 (int): Tile size (in pixels) of first slide.</span>
<span class="sd">        tile_um1 (int or str): Tile size (in microns) of first slide.</span>
<span class="sd">            Can also be expressed as a magnification level, e.g. ``&#39;10x&#39;``</span>
<span class="sd">        tile_px2 (int): Tile size (in pixels) of second slide.</span>
<span class="sd">        tile_um2 (int or str): Tile size (in microns) of second slide.</span>
<span class="sd">            Can also be expressed as a magnification level, e.g. ``&#39;10x&#39;``</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: Whether the tile sizes are compatible.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Type checks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_px1</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected tile_px1 to be an int, got: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tile_px1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected tile_um1 to be a str or int, got: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_px2</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected tile_px2 to be an int, got: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tile_px2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected tile_um2 to be a str or int, got: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">)))</span>

    <span class="c1"># Enforce equivalent pixel size</span>
    <span class="k">if</span> <span class="n">tile_px1</span> <span class="o">!=</span> <span class="n">tile_px2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># If both are defined as a magnification, check if these are equal</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tile_um1</span> <span class="o">==</span> <span class="n">tile_um2</span>
    <span class="c1"># If both are defined in microns, check if these are equal</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tile_um1</span> <span class="o">==</span> <span class="n">tile_um2</span>
    <span class="c1"># If one is defined in microns and the other as magnification,</span>
    <span class="c1"># check if they are compatible.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">mag2</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span><span class="n">tile_um2</span> <span class="o">/</span> <span class="n">tile_px2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mag2</span> <span class="o">-</span> <span class="n">to_mag</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um1</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mag1</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span><span class="n">tile_um1</span> <span class="o">/</span> <span class="n">tile_px1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mag1</span> <span class="o">-</span> <span class="n">to_mag</span><span class="p">(</span><span class="n">tile_um2</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error assessing tile size compatibility between px=</span><span class="si">{}</span><span class="s2">, um=</span><span class="si">{}</span><span class="s2"> and px=</span><span class="si">{}</span><span class="s2">, um=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tile_px1</span><span class="p">,</span> <span class="n">tile_um1</span><span class="p">,</span> <span class="n">tile_px2</span><span class="p">,</span> <span class="n">tile_um2</span>
        <span class="p">))</span></div>


<div class="viewcode-block" id="multi_warn"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.multi_warn">[docs]</a><span class="k">def</span> <span class="nf">multi_warn</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">compare</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logs multiple warning</span>

<span class="sd">    Args:</span>
<span class="sd">        arr (List): Array to compare.</span>
<span class="sd">        compare (Callable): Comparison to perform on array. If True, will warn.</span>
<span class="sd">        msg (str): Warning message.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of warnings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_warned</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">warn_threshold</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">compare</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">warn</span> <span class="k">if</span> <span class="n">num_warned</span> <span class="o">&lt;</span> <span class="n">warn_threshold</span> <span class="k">else</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">fn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                <span class="n">fn</span><span class="p">(</span><span class="n">msg</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="n">num_warned</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">num_warned</span> <span class="o">&gt;=</span> <span class="n">warn_threshold</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;...</span><span class="si">{</span><span class="n">num_warned</span><span class="si">}</span><span class="s1"> total warnings, see log for details&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_warned</span></div>


<div class="viewcode-block" id="to_onehot"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.to_onehot">[docs]</a><span class="k">def</span> <span class="nf">to_onehot</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">max</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts value to one-hot encoding</span>

<span class="sd">    Args:</span>
<span class="sd">        val (int): Value to encode</span>
<span class="sd">        max (int): Maximum value (length of onehot encoding)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">onehot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">onehot</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">onehot</span></div>


<span class="k">def</span> <span class="nf">clear_console</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[K&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<div class="viewcode-block" id="make_dir"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.make_dir">[docs]</a><span class="k">def</span> <span class="nf">make_dir</span><span class="p">(</span><span class="n">_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Makes a directory if one does not already exist,</span>
<span class="sd">    in a manner compatible with multithreading.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="relative_path"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.relative_path">[docs]</a><span class="k">def</span> <span class="nf">relative_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a relative path, from a given root directory.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;$ROOT&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid path prefix $ROOT; update project settings&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="global_path"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.global_path">[docs]</a><span class="k">def</span> <span class="nf">global_path</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns global path from a local path.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path_string</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path_string</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;./&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path_string</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="n">path_string</span> <span class="ow">and</span> <span class="p">(</span><span class="n">path_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path_string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path_string</span></div>


<span class="k">def</span> <span class="nf">_shortname</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
        <span class="c1"># May be TCGA slide with long name; convert to</span>
        <span class="c1"># patient name by returning first 12 characters</span>
        <span class="k">return</span> <span class="n">string</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span>


<div class="viewcode-block" id="yes_no_input"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.yes_no_input">[docs]</a><span class="k">def</span> <span class="nf">yes_no_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Prompts user for yes/no input.&#39;&#39;&#39;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">default</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid response.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="path_input"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.path_input">[docs]</a><span class="k">def</span> <span class="nf">path_input</span><span class="p">(</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">create_on_invalid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">filetype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Prompts user for directory input.&#39;&#39;&#39;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">relative_response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">reponse</span> <span class="o">=</span> <span class="n">global_path</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_response</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relative_response</span> <span class="ow">and</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">relative_response</span> <span class="o">=</span> <span class="n">default</span>
            <span class="n">reponse</span> <span class="o">=</span> <span class="n">global_path</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verify</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reponse</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filetype</span> <span class="ow">and</span> <span class="n">create_on_invalid</span><span class="p">:</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Path &quot;</span><span class="si">{</span><span class="n">reponse</span><span class="si">}</span><span class="s1">&quot; does not exist. Create? [Y/n] &#39;</span>
                <span class="k">if</span> <span class="n">yes_no_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">reponse</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">relative_response</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">filetype</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to locate file &quot;</span><span class="si">{</span><span class="n">reponse</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">filetype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reponse</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to locate directory &quot;</span><span class="si">{</span><span class="n">reponse</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">resp_type</span> <span class="o">=</span> <span class="n">path_to_ext</span><span class="p">(</span><span class="n">reponse</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="ow">and</span> <span class="p">(</span><span class="n">resp_type</span> <span class="o">!=</span> <span class="n">filetype</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incorrect filetype &quot;</span><span class="si">{</span><span class="n">resp_type</span><span class="si">}</span><span class="s1">&quot;, expected &quot;</span><span class="si">{</span><span class="n">filetype</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">return</span> <span class="n">relative_response</span></div>


<div class="viewcode-block" id="choice_input"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.choice_input">[docs]</a><span class="k">def</span> <span class="nf">choice_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">valid_choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multi_choice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">input_type</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Prompts user for multi-choice input.&#39;&#39;&#39;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_choice</span> <span class="ow">and</span> <span class="n">response</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_choices</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid option.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">multi_choice</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">replaced</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_type</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">replaced</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid selection (response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">invalid</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_choices</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">invalid</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid selection (response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="load_json"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.load_json">[docs]</a><span class="k">def</span> <span class="nf">load_json</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Reads JSON data from file.&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="ValidJSONEncoder"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.ValidJSONEncoder">[docs]</a><span class="k">class</span> <span class="nc">ValidJSONEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
<div class="viewcode-block" id="ValidJSONEncoder.default"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.ValidJSONEncoder.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span></div></div>


<div class="viewcode-block" id="write_json"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.write_json">[docs]</a><span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write data to JSON file.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (Any): Data to write.</span>
<span class="sd">        filename (str): Path to JSON file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, remove any invalid entries that are not serializable</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">ValidJSONEncoder</span><span class="p">)</span></div>


<div class="viewcode-block" id="log_manifest"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.log_manifest">[docs]</a><span class="k">def</span> <span class="nf">log_manifest</span><span class="p">(</span>
    <span class="n">train_tfrecords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">val_tfrecords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">remove_extension</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves the training manifest in CSV format and returns as a string.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_tfrecords (list(str)], optional): List of training TFRecords.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        val_tfrecords (list(str)], optional): List of validation TFRecords.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Keyword args:</span>
<span class="sd">        labels (dict, optional): TFRecord outcome labels. Defaults to None.</span>
<span class="sd">        filename (str, optional): Path to CSV file to save. Defaults to None.</span>
<span class="sd">        remove_extension (bool, optional): Remove file extension from slide</span>
<span class="sd">            names. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Saved manifest in str format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">has_labels</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">save_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">save_file</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;outcome_label&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">train_tfrecords</span> <span class="ow">or</span> <span class="n">val_tfrecords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">train_tfrecords</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">train_tfrecords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_extension</span><span class="p">:</span>
                    <span class="n">slide</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slide</span> <span class="o">=</span> <span class="n">tfrecord</span>
                <span class="n">outcome_label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_labels</span> <span class="k">else</span> <span class="s1">&#39;NA&#39;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">slide</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outcome_label</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">slide</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="n">outcome_label</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">val_tfrecords</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">val_tfrecords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_extension</span><span class="p">:</span>
                    <span class="n">slide</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slide</span> <span class="o">=</span> <span class="n">tfrecord</span>
                <span class="n">outcome_label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_labels</span> <span class="k">else</span> <span class="s1">&#39;NA&#39;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">slide</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outcome_label</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">slide</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="n">outcome_label</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">save_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="get_slides_from_model_manifest"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_slides_from_model_manifest">[docs]</a><span class="k">def</span> <span class="nf">get_slides_from_model_manifest</span><span class="p">(</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get list of slides from a model manifest.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path (str): Path to model from which to load the model manifest.</span>
<span class="sd">        dataset (str):  &#39;training&#39; or &#39;validation&#39;. Will return only slides</span>
<span class="sd">            from this dataset. Defaults to None (all).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list(str): List of slide names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">slides</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)):</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Slide manifest not found in model directory&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading manifest from parent directory.&quot;</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Slide manifest not found in model folder&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">manifest_file</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="n">dataset_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
        <span class="n">slide_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">dataset_index</span><span class="p">]</span>
            <span class="n">slide_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">slide_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="n">dataset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">slides</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">slides</span></div>


<div class="viewcode-block" id="get_gan_config"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_gan_config">[docs]</a><span class="k">def</span> <span class="nf">get_gan_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads a GAN training_options.json for an associated network PKL.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;training_options.json&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;training_options.json&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsNotFoundError</span></div>


<div class="viewcode-block" id="get_model_config"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_model_config">[docs]</a><span class="k">def</span> <span class="nf">get_model_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads model configuration JSON file.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">model_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;params.json&#39;</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">torch_available</span>
                <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Hyperparameters not in model directory; loading from parent&quot;</span>
                <span class="s2">&quot; directory. Please move params.json into model folder.&quot;</span>
            <span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsNotFoundError</span>
    <span class="c1"># Compatibility for pre-1.1</span>
    <span class="k">if</span> <span class="s1">&#39;norm_mean&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;target_means&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">],</span>
            <span class="s1">&#39;target_stds&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_std&#39;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="s1">&#39;outcome_label_headers&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replacing outcome_label_headers in params.json -&gt; outcomes&quot;</span><span class="p">)</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outcome_label_headers&#39;</span><span class="p">)</span>
    <span class="c1"># Compatibility for pre-3.0</span>
    <span class="k">if</span> <span class="s1">&#39;model_type&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;classification&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;model_type&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;regression&#39;</span>
    <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="get_ensemble_model_config"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_ensemble_model_config">[docs]</a><span class="k">def</span> <span class="nf">get_ensemble_model_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads ensemble model configuration JSON file.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;ensemble_params.json&#39;</span><span class="p">)):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;ensemble_params.json&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;ensemble_params.json&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">torch_available</span>
                <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Hyperparameters not in model directory; loading from parent&quot;</span>
                <span class="s2">&quot; directory. Please move ensemble_params.json into model folder.&quot;</span>
            <span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsNotFoundError</span>
    <span class="c1"># Compatibility for pre-1.1</span>
    <span class="k">if</span> <span class="s1">&#39;norm_mean&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;target_means&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">],</span>
            <span class="s1">&#39;target_stds&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_std&#39;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="s1">&#39;outcome_label_headers&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replacing outcome_label_headers in params.json -&gt; outcomes&quot;</span><span class="p">)</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outcome_label_headers&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="get_model_normalizer"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_model_normalizer">[docs]</a><span class="k">def</span> <span class="nf">get_model_normalizer</span><span class="p">(</span>
    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.norm.StainNormalizer&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads and fits normalizer using configuration at a model path.&quot;&quot;&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_torch_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="s1">&#39;torch&#39;</span>
    <span class="k">elif</span> <span class="n">is_tensorflow_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="s1">&#39;tensorflow&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to determine backend for model at </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;normalizer&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;slideflow_version&#39;</span> <span class="ow">in</span> <span class="n">config</span>
       <span class="ow">and</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slideflow_version&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.2.2&quot;</span><span class="p">)</span>
       <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;normalizer&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;vahadane&#39;</span><span class="p">,</span> <span class="s1">&#39;macenko&#39;</span><span class="p">)):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Detected model trained with Macenko or Vahadane &quot;</span>
                 <span class="s2">&quot;normalization with Slideflow version &lt;= 1.2.2. Macenko &quot;</span>
                 <span class="s2">&quot;and Vahadane algorithms were optimized in 1.2.3 and may &quot;</span>
                 <span class="s2">&quot;now yield slightly different results. &quot;</span><span class="p">)</span>

    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">autoselect</span><span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;normalizer&#39;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;normalizer_source&#39;</span><span class="p">],</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">normalizer</span></div>


<div class="viewcode-block" id="get_preprocess_fn"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_preprocess_fn">[docs]</a><span class="k">def</span> <span class="nf">get_preprocess_fn</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a function which preprocesses a uint8 image for a model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path (str): Path to a saved Slideflow model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A function which accepts a single image or batch of uint8 images,</span>
<span class="sd">        and returns preprocessed (and stain normalized) float32 images.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">get_model_normalizer</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_torch_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">slideflow.io.torch</span> <span class="kn">import</span> <span class="n">preprocess_uint8</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">preprocess_uint8</span><span class="p">,</span> <span class="n">normalizer</span><span class="o">=</span><span class="n">normalizer</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_tensorflow_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">slideflow.io.tensorflow</span> <span class="kn">import</span> <span class="n">preprocess_uint8</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">preprocess_uint8</span><span class="p">,</span> <span class="n">normalizer</span><span class="o">=</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized model: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_slide_paths"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_slide_paths">[docs]</a><span class="k">def</span> <span class="nf">get_slide_paths</span><span class="p">(</span><span class="n">slides_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get all slide paths from a given directory containing slides.&#39;&#39;&#39;</span>
    <span class="n">slide_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">slides_dir</span><span class="p">,</span> <span class="s1">&#39;**/*.*&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">is_slide</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="n">slide_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">slides_dir</span><span class="p">,</span> <span class="s1">&#39;*.*&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">is_slide</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">slide_list</span></div>


<div class="viewcode-block" id="read_annotations"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.read_annotations">[docs]</a><span class="k">def</span> <span class="nf">read_annotations</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Read an annotations file.&#39;&#39;&#39;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="c1"># First, try to open file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to open annotations file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="n">row_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                <span class="n">row_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">results</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row_dict</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">results</span></div>


<div class="viewcode-block" id="get_relative_tfrecord_paths"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_relative_tfrecord_paths">[docs]</a><span class="k">def</span> <span class="nf">get_relative_tfrecord_paths</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns relative tfrecord paths with respect to the given directory.&#39;&#39;&#39;</span>

    <span class="n">tfrecords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.tfrecords&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">:</span>
        <span class="n">tfrecords</span> <span class="o">+=</span> <span class="n">get_relative_tfrecord_paths</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">sub</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tfrecords</span></div>


<span class="k">def</span> <span class="nf">contains_nested_subdirs</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_dir</span> <span class="k">for</span> <span class="n">_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">_dir</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">subdir</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">c</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="path_to_name"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.path_to_name">[docs]</a><span class="k">def</span> <span class="nf">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns name of a file, without extension,</span>
<span class="sd">    from a given full path string.&#39;&#39;&#39;</span>
    <span class="n">_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">dot_split</span> <span class="o">=</span> <span class="n">_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dot_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_file</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dot_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="ow">in</span> <span class="n">SUPPORTED_FORMATS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dot_split</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dot_split</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="path_to_ext"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.path_to_ext">[docs]</a><span class="k">def</span> <span class="nf">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns extension of a file path string.&#39;&#39;&#39;</span>
    <span class="n">_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">dot_split</span> <span class="o">=</span> <span class="n">_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dot_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dot_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="ow">in</span> <span class="n">SUPPORTED_FORMATS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="update_results_log"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.update_results_log">[docs]</a><span class="k">def</span> <span class="nf">update_results_log</span><span class="p">(</span>
    <span class="n">results_log_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">results_dict</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Dynamically update results_log when recording training metrics.&#39;&#39;&#39;</span>
    <span class="c1"># First, read current results log into a dictionary</span>
    <span class="n">results_log</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Any]</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">results_file</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">results_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_name_i</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
                    <span class="n">result_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;model_name&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">model_name_i</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
                    <span class="n">result_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">model_name_i</span><span class="p">]</span>
                    <span class="n">results_log</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">result_keys</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">result_key</span><span class="p">)]</span>
                        <span class="n">results_log</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">result_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="c1"># Move the current log file into a temporary file</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_log_path</span><span class="si">}</span><span class="s2">.temp&quot;</span><span class="p">)</span>

    <span class="c1"># Next, update the results log with the new results data</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
        <span class="n">results_log</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">epoch</span><span class="p">]})</span>

    <span class="c1"># Finally, create a new log file incorporating the new data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">results_file</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">results_file</span><span class="p">)</span>
        <span class="n">result_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Search through results to find all results keys</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results_log</span><span class="p">:</span>
            <span class="n">result_keys</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_log</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Remove duplicate result keys</span>
        <span class="n">result_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">result_keys</span><span class="p">))</span>
        <span class="n">result_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1"># Write header labels</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">result_keys</span><span class="p">)</span>
        <span class="c1"># Iterate through model results and record</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results_log</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
            <span class="c1"># Include all saved metrics</span>
            <span class="k">for</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">result_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">results_log</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">results_log</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">result_key</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># Delete the old results log file</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_log_path</span><span class="si">}</span><span class="s2">.temp&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_log_path</span><span class="si">}</span><span class="s2">.temp&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="map_values_to_slide_grid"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.map_values_to_slide_grid">[docs]</a><span class="k">def</span> <span class="nf">map_values_to_slide_grid</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">wsi</span><span class="p">:</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">,</span>
    <span class="n">background</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bicubic&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map heatmap values to a slide grid, using tile location information.</span>

<span class="sd">    Args:</span>
<span class="sd">        locations (np.ndarray): Array of shape ``(n_tiles, 2)`` containing x, y</span>
<span class="sd">            coordinates for all image tiles. Coordinates represent the center</span>
<span class="sd">            for an associated tile, and must be in a grid.</span>
<span class="sd">        values (np.ndarray): Array of shape ``(n_tiles,)`` containing heatmap</span>
<span class="sd">            values for each tile.</span>
<span class="sd">        wsi (slideflow.wsi.WSI): WSI object.</span>

<span class="sd">    Keyword args:</span>
<span class="sd">        background (str, optional): Background strategy for heatmap. Can be</span>
<span class="sd">            &#39;min&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;max&#39;, or &#39;mask&#39;. Defaults to &#39;min&#39;.</span>
<span class="sd">        interpolation (str, optional): Interpolation strategy for smoothing</span>
<span class="sd">            heatmap. Defaults to &#39;bicubic&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">no_interpolation</span> <span class="o">=</span> <span class="p">(</span><span class="n">interpolation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

    <span class="c1"># Slide coordinate information</span>
    <span class="n">loc_grid_dict</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">wsi</span><span class="o">.</span><span class="n">coord</span><span class="p">}</span>

    <span class="c1"># Determine the heatmap background</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">wsi</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wsi</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_interpolation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;&#39;mask&#39; background is not compatible with interpolation method &quot;</span>
            <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;. Expected: None or &#39;nearest&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized value for background: </span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>

    <span class="c1"># Transform from coordinates as center locations to top-left locations.</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">locations</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">wsi</span><span class="o">.</span><span class="n">full_extract_px</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wsi_dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">locations</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">loc_grid_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">wsi_dim</span><span class="p">)]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">CoordinateAlignmentError</span><span class="p">(</span>
                <span class="s2">&quot;Error plotting value at location </span><span class="si">{}</span><span class="s2"> for slide </span><span class="si">{}</span><span class="s2">. The heatmap &quot;</span>
                <span class="s2">&quot;grid is not aligned to the slide coordinate grid. Ensure &quot;</span>
                <span class="s2">&quot;that tile_px (got: </span><span class="si">{}</span><span class="s2">) and tile_um (got: </span><span class="si">{}</span><span class="s2">) match the given &quot;</span>
                <span class="s2">&quot;location values. If you are using data stored in TFRecords, &quot;</span>
                <span class="s2">&quot;verify that the TFRecord was generated using the same &quot;</span>
                <span class="s2">&quot;tile_px and tile_um.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">tuple</span><span class="p">(</span><span class="n">wsi_dim</span><span class="p">),</span> <span class="n">wsi</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">wsi</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">wsi</span><span class="o">.</span><span class="n">tile_um</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Mask out background, if interpolation is not used and background == &#39;mask&#39;</span>
    <span class="k">if</span> <span class="n">no_interpolation</span> <span class="ow">and</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
        <span class="n">masked_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masked_grid</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="k">return</span> <span class="n">masked_grid</span></div>


<div class="viewcode-block" id="bin_values_to_slide_grid"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.bin_values_to_slide_grid">[docs]</a><span class="k">def</span> <span class="nf">bin_values_to_slide_grid</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">wsi</span><span class="p">:</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">,</span>
    <span class="n">background</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bin heatmap values to a slide grid, using tile location information.</span>

<span class="sd">    Args:</span>
<span class="sd">        locations (np.ndarray): Array of shape ``(n_tiles, 2)`` containing x, y</span>
<span class="sd">            coordinates for all image tiles. Coordinates represent the center</span>
<span class="sd">            for an associated tile, and must be in a grid.</span>
<span class="sd">        values (np.ndarray): Array of shape ``(n_tiles,)`` containing heatmap</span>
<span class="sd">            values for each tile.</span>
<span class="sd">        wsi (slideflow.wsi.WSI): WSI object.</span>

<span class="sd">    Keyword args:</span>
<span class="sd">        background (str, optional): Background strategy for heatmap. Can be</span>
<span class="sd">            &#39;min&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;max&#39;, or &#39;mask&#39;. Defaults to &#39;min&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binned_statistic_2d</span>
    <span class="n">masked_grid</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic_2d</span><span class="p">(</span>
        <span class="n">locations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">locations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">values</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">wsi</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">wsi</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">wsi</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="p">)</span>
    <span class="n">masked_grid</span> <span class="o">=</span> <span class="n">masked_grid</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nan_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">masked_grid</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
        <span class="c1"># No action needed</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
        <span class="n">masked_grid</span><span class="p">[</span><span class="n">nan_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">masked_grid</span><span class="p">[</span><span class="n">nan_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">masked_grid</span><span class="p">[</span><span class="n">nan_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">masked_grid</span><span class="p">[</span><span class="n">nan_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized value for background: </span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">masked_grid</span></div>


<div class="viewcode-block" id="infer_stride"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.infer_stride">[docs]</a><span class="k">def</span> <span class="nf">infer_stride</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">wsi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer the stride of a grid of locations from a set of locations.</span>

<span class="sd">    Args:</span>
<span class="sd">        locations (np.ndarray): Nx2 array of locations</span>
<span class="sd">        wsi (slideflow.wsi.WSI): WSI object</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: inferred stride divisor in pixels</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sort_unique_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">locations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">sort_unique_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">locations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">min_stride_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">sort_unique_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">sort_unique_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">min_stride_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">sort_unique_y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">sort_unique_y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">inferred_stride_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_stride_x</span><span class="p">,</span> <span class="n">min_stride_y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wsi</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="n">inferred_stride_px</span></div>


<div class="viewcode-block" id="location_heatmap"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.location_heatmap">[docs]</a><span class="k">def</span> <span class="nf">location_heatmap</span><span class="p">(</span>
    <span class="n">locations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">slide</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bicubic&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span><span class="p">,</span>
    <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">background</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a heatmap for a slide.</span>

<span class="sd">    Args:</span>
<span class="sd">        locations (np.ndarray): Array of shape ``(n_tiles, 2)`` containing x, y</span>
<span class="sd">            coordinates for all image tiles. Coordinates represent the center</span>
<span class="sd">            for an associated tile, and must be in a grid.</span>
<span class="sd">        values (np.ndarray): Array of shape ``(n_tiles,)`` containing heatmap</span>
<span class="sd">            values for each tile.</span>
<span class="sd">        slide (str): Path to corresponding slide.</span>
<span class="sd">        tile_px (int): Tile pixel size.</span>
<span class="sd">        tile_um (int, str): Tile micron or magnification size.</span>
<span class="sd">        filename (str): Destination filename for heatmap.</span>

<span class="sd">    Keyword args:</span>
<span class="sd">        interpolation (str, optional): Interpolation strategy for smoothing</span>
<span class="sd">            heatmap. Defaults to &#39;bicubic&#39;.</span>
<span class="sd">        cmap (str, optional): Matplotlib colormap for heatmap. Can be any</span>
<span class="sd">            valid matplotlib colormap. Defaults to &#39;inferno&#39;.</span>
<span class="sd">        norm (str, optional): Normalization strategy for assigning heatmap</span>
<span class="sd">            values to colors. Either &#39;two_slope&#39;, or any other valid value</span>
<span class="sd">            for the ``norm`` argument of ``matplotlib.pyplot.imshow``.</span>
<span class="sd">            If &#39;two_slope&#39;, normalizes values less than 0 and greater than 0</span>
<span class="sd">            separately. Defaults to None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error generating heatmap. &#39;values&#39; should be a numpy array &quot;</span>
            <span class="s2">&quot;with shape (n_tiles, )&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error generating heatmap. Expected &#39;values&#39; to have (n_tiles,) &quot;</span>
            <span class="s2">&quot;but got shape </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating heatmap for [green]</span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1">[/]...&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2"> values&quot;</span><span class="p">)</span>
    <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="n">infer_stride</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">wsi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stride</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="c1"># Large inferred strides are likely due to unaligned grid.</span>
        <span class="c1"># Rather than attempting to build a coordinate grid for verifying</span>
        <span class="c1"># grid alignment, we will assume that the grid is unaligned and</span>
        <span class="c1"># use the default stride (1). This will cause map_values_to_slide_grid</span>
        <span class="c1"># to recognize that the grid is unaligned, and the heatmap will be built</span>
        <span class="c1"># using histogram2d.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed sanity check for inferred stride (</span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred stride: </span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span><span class="p">,</span> <span class="n">stride_div</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">masked_grid</span> <span class="o">=</span> <span class="n">map_values_to_slide_grid</span><span class="p">(</span>
            <span class="n">locations</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">wsi</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">CoordinateAlignmentError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Coordinate alignment error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to align grid for plotting heatmap. Heatmap will be &quot;</span>
                  <span class="s2">&quot;binned with a stride of 1.&quot;</span><span class="p">)</span>
        <span class="n">masked_grid</span> <span class="o">=</span> <span class="n">bin_values_to_slide_grid</span><span class="p">(</span>
            <span class="n">locations</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">wsi</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span>
        <span class="p">)</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcol</span>
    <span class="k">with</span> <span class="n">matplotlib_backend</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">):</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">wsi</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">mpp</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
        <span class="n">gca</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">gca</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
            <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">labeltop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate overlay offset</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">heatmap</span><span class="o">.</span><span class="n">calculate_heatmap_extent</span><span class="p">(</span><span class="n">wsi</span><span class="p">,</span> <span class="n">thumb</span><span class="p">,</span> <span class="n">masked_grid</span><span class="p">)</span>

        <span class="c1"># Plot</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;two_slope&#39;</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">mcol</span><span class="o">.</span><span class="n">TwoSlopeNorm</span><span class="p">(</span>
                <span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="n">vcenter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">masked_grid</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">thumb</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">thumb</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Saving figure...&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="tfrecord_heatmap"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.tfrecord_heatmap">[docs]</a><span class="k">def</span> <span class="nf">tfrecord_heatmap</span><span class="p">(</span>
    <span class="n">tfrecord</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">slide</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">tile_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a tfrecord-based WSI heatmap using a dictionary of tile values</span>
<span class="sd">    for heatmap display.</span>

<span class="sd">    Args:</span>
<span class="sd">        tfrecord (str): Path to tfrecord.</span>
<span class="sd">        slide (str): Path to whole-slide image.</span>
<span class="sd">        tile_dict (dict): Dictionary mapping tfrecord indices to a</span>
<span class="sd">            tile-level value for display in heatmap format.</span>
<span class="sd">        tile_px (int): Tile width in pixels.</span>
<span class="sd">        tile_um (int or str): Tile width in microns (int) or magnification</span>
<span class="sd">            (str, e.g. &quot;20x&quot;).</span>
<span class="sd">        filename (str): Destination filename for heatmap.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_locations_from_tfrecord</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TFRecordsError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;tile_dict length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tile_dict</span><span class="p">)</span><span class="si">}</span><span class="s1">) != TFRecord length &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span><span class="si">}</span><span class="s1">).&#39;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">location_heatmap</span><span class="p">(</span>
        <span class="n">locations</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locations</span><span class="p">),</span>
        <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tile_dict</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">))]),</span>
        <span class="n">slide</span><span class="o">=</span><span class="n">slide</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="o">=</span><span class="n">tile_px</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="tile_size_label"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.tile_size_label">[docs]</a><span class="k">def</span> <span class="nf">tile_size_label</span><span class="p">(</span><span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the string label of the given tile size.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tile_px</span><span class="si">}</span><span class="s2">px_</span><span class="si">{</span><span class="n">tile_um</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tile_px</span><span class="si">}</span><span class="s2">px_</span><span class="si">{</span><span class="n">tile_um</span><span class="si">}</span><span class="s2">um&quot;</span></div>


<div class="viewcode-block" id="get_valid_model_dir"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.get_valid_model_dir">[docs]</a><span class="k">def</span> <span class="nf">get_valid_model_dir</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function returns the path of the first indented directory from root.</span>
<span class="sd">    This only works when the indented folder name starts with a 5 digit number,</span>
<span class="sd">    like &quot;00000%&quot;.</span>

<span class="sd">    Examples</span>
<span class="sd">        If the root has 3 files:</span>
<span class="sd">        root/00000-foldername/</span>
<span class="sd">        root/00001-foldername/</span>
<span class="sd">        root/00002-foldername/</span>

<span class="sd">        The function returns &quot;root/00000-foldername/&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">prev_run_dirs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="n">prev_run_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d+&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_run_dirs</span><span class="p">]</span>
    <span class="n">prev_run_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_run_ids</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">prev_run_ids</span><span class="p">,</span> <span class="n">prev_run_dirs</span></div>


<span class="k">def</span> <span class="nf">get_new_model_dir</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">prev_run_ids</span><span class="p">,</span> <span class="n">prev_run_dirs</span> <span class="o">=</span> <span class="n">get_valid_model_dir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">cur_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">prev_run_ids</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cur_id</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_dir</span>


<span class="k">def</span> <span class="nf">create_new_model_dir</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">get_new_model_dir</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>


<div class="viewcode-block" id="split_list"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.split_list">[docs]</a><span class="k">def</span> <span class="nf">split_list</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to split a list into n components&#39;&#39;&#39;</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span></div>


<span class="c1"># --- TFRecord utility functions ----------------------------------------------</span>

<span class="k">def</span> <span class="nf">process_feature</span><span class="p">(</span>
    <span class="n">feature</span><span class="p">:</span> <span class="n">example_pb2</span><span class="o">.</span><span class="n">Feature</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">typename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">typename_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># NOTE: We assume that each key in the example has only one field</span>
    <span class="c1"># (either &quot;bytes_list&quot;, &quot;float_list&quot;, or &quot;int64_list&quot;)!</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">ListFields</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
    <span class="n">inferred_typename</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="k">if</span> <span class="n">typename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tf_typename</span> <span class="o">=</span> <span class="n">typename_mapping</span><span class="p">[</span><span class="n">typename</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tf_typename</span> <span class="o">!=</span> <span class="n">inferred_typename</span><span class="p">:</span>
            <span class="n">reversed_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">typename_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incompatible type &#39;</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">&#39; for `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">` &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(should be &#39;</span><span class="si">{</span><span class="n">reversed_mapping</span><span class="p">[</span><span class="n">inferred_typename</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;).&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">inferred_typename</span> <span class="o">==</span> <span class="s2">&quot;bytes_list&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">inferred_typename</span> <span class="o">==</span> <span class="s2">&quot;float_list&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">inferred_typename</span> <span class="o">==</span> <span class="s2">&quot;int64_list&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">extract_feature_dict</span><span class="p">(</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">example_pb2</span><span class="o">.</span><span class="n">FeatureLists</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">example_pb2</span><span class="o">.</span><span class="n">Features</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]],</span>
    <span class="n">typename_mapping</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">example_pb2</span><span class="o">.</span><span class="n">FeatureLists</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">feature_list</span>  <span class="c1"># type: ignore</span>

        <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">typename_mapping</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">process_feature</span><span class="p">,</span>
                <span class="n">typename</span><span class="o">=</span><span class="n">typename</span><span class="p">,</span>
                <span class="n">typename_mapping</span><span class="o">=</span><span class="n">typename_mapping</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">key</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">feature</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">example_pb2</span><span class="o">.</span><span class="n">Features</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">feature</span>  <span class="c1"># type: ignore</span>

        <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">typename_mapping</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">process_feature</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">typename</span><span class="p">,</span>
                                   <span class="n">typename_mapping</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incompatible type: features should be either of type &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;example_pb2.Features or example_pb2.FeatureLists and &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># type: ignore</span>

    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">all_keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">processed_features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">typename</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> doesn&#39;t exist (select from </span><span class="si">{</span><span class="n">all_keys</span><span class="si">}</span><span class="s2">)!&quot;</span><span class="p">)</span>

        <span class="n">processed_features</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">typename_mapping</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">processed_features</span>


<div class="viewcode-block" id="load_predictions"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.load_predictions">[docs]</a><span class="k">def</span> <span class="nf">load_predictions</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads a &#39;csv&#39;, &#39;parquet&#39; or &#39;feather&#39; file to a pandas dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to the file to be read.</span>

<span class="sd">    Returns:</span>
<span class="sd">        df (pd.DataFrame): The dataframe read from the path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;gzip&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;feather&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized extension &quot;</span><span class="si">{</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">cleanup_progress</span><span class="p">(</span><span class="n">pb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Progress&quot;</span><span class="p">]):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pb</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="n">pb</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">matplotlib_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">original_backend</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">original_backend</span><span class="p">)</span>


<div class="viewcode-block" id="create_triangles"><a class="viewcode-back" href="../../../util/#slideflow.model.tensorflow.create_triangles">[docs]</a><span class="k">def</span> <span class="nf">create_triangles</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">hole_vertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hole_points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tessellate a complex polygon, possibly with holes.</span>

<span class="sd">    :param vertices: A list of vertices [(x1, y1), (x2, y2), ...] defining the polygon boundary.</span>
<span class="sd">    :param holes: An optional list of points [(hx1, hy1), (hx2, hy2), ...] inside each hole in the polygon.</span>
<span class="sd">    :return: A numpy array of vertices for the tessellated triangles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">triangle</span> <span class="k">as</span> <span class="nn">tr</span>

    <span class="c1"># Prepare the segment information for the exterior boundary</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">))])</span>

    <span class="c1"># Prepare the polygon for Triangle</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vertices&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertices</span><span class="p">),</span> <span class="s1">&#39;segments&#39;</span><span class="p">:</span> <span class="n">segments</span><span class="p">}</span>

    <span class="c1"># If there are holes and hole boundaries, add them to the polygon definition</span>
    <span class="k">if</span> <span class="n">hole_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hole_vertices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hole_vertices</span><span class="p">):</span>
        <span class="n">polygon</span><span class="p">[</span><span class="s1">&#39;holes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hole_points</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Start adding hole segments after the exterior segments</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hole</span> <span class="ow">in</span> <span class="n">hole_vertices</span><span class="p">:</span>
            <span class="n">hole_segments</span> <span class="o">=</span> <span class="p">[[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">hole</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hole</span><span class="p">))]</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">segments</span><span class="p">,</span> <span class="n">hole_segments</span><span class="p">])</span>
            <span class="n">start_idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hole</span><span class="p">)</span>

        <span class="c1"># Update the vertices and segments in the polygon</span>
        <span class="n">all_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vertices</span><span class="p">]</span> <span class="o">+</span> <span class="n">hole_vertices</span><span class="p">)</span>
        <span class="n">polygon</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_vertices</span>
        <span class="n">polygon</span><span class="p">[</span><span class="s1">&#39;segments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segments</span>

    <span class="c1"># Tessellate the polygon</span>
    <span class="n">tess</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="s1">&#39;pF&#39;</span><span class="p">)</span>

    <span class="c1"># Extract tessellated triangle vertices</span>
    <span class="k">if</span> <span class="s1">&#39;triangles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tess</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">tessellated_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tess</span><span class="p">[</span><span class="s1">&#39;vertices&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tess</span><span class="p">[</span><span class="s1">&#39;triangles&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Convert to float32</span>
    <span class="n">tessellated_vertices</span> <span class="o">=</span> <span class="n">tessellated_vertices</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tessellated_vertices</span></div>
</pre></div>

             </article>

            </div>
            <footer>




    <hr>



  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, James M Dolezal.

    </p>
  </div>

      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>


</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">

            </div>
          </div>
        </div>
      </section>
    </div>







       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>



  <script type="text/javascript" src="../../../_static/js/vendor/jquery-3.6.3.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>