


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slideflow.model.tensorflow &mdash; slideflow 1.2.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-43E5QNVXH2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-43E5QNVXH2');
  </script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1.html">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/jamesdolezal/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  1.2
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_setup.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../layer_activations.html">Features / layer activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_loops.html">Custom training loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uq.html">Uncertainty quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../clam.html">CLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../project.html">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataset.html">slideflow.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heatmap.html">slideflow.heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io.html">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io_tensorflow.html">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io_torch.html">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gan.html">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grad.html">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model.html">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mosaic.html">slideflow.mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../norm.html">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slide.html">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stats.html">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../util.html">slideflow.util</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial1.html">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial2.html">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial3.html">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial4.html">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial5.html">Tutorial 5: Creating a mosaic map</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../model.html">slideflow.model</a> &gt;</li>
        
      <li>slideflow.model.tensorflow</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for slideflow.model.tensorflow</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Tensorflow backend for the slideflow.model submodule.&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">import</span> <span class="nn">slideflow.model.base</span> <span class="k">as</span> <span class="nn">_base</span>
<span class="kn">import</span> <span class="nn">slideflow.util.neptune_utils</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">tensorflow_utils</span> <span class="k">as</span> <span class="n">tf_utils</span>
<span class="kn">from</span> <span class="nn">slideflow.model.base</span> <span class="kn">import</span> <span class="n">log_manifest</span><span class="p">,</span> <span class="n">no_scope</span>
<span class="kn">from</span> <span class="nn">slideflow.model.tensorflow_utils</span> <span class="kn">import</span> <span class="n">unwrap</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">NormFit</span><span class="p">,</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">log</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">applications</span> <span class="k">as</span> <span class="n">kapps</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">slideflow.norm</span> <span class="kn">import</span> <span class="n">StainNormalizer</span>


<span class="k">class</span> <span class="nc">StaticDropout</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="ModelParams"><a class="viewcode-back" href="../../../model.html#slideflow.model.ModelParams">[docs]</a><span class="k">class</span> <span class="nc">ModelParams</span><span class="p">(</span><span class="n">_base</span><span class="o">.</span><span class="n">_ModelParams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build a set of hyperparameters.&quot;&quot;&quot;</span>

    <span class="n">ModelDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;xception&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">Xception</span><span class="p">,</span>
        <span class="s1">&#39;vgg16&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">VGG16</span><span class="p">,</span>
        <span class="s1">&#39;vgg19&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">VGG19</span><span class="p">,</span>
        <span class="s1">&#39;resnet50&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet50</span><span class="p">,</span>
        <span class="s1">&#39;resnet101&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet101</span><span class="p">,</span>
        <span class="s1">&#39;resnet152&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet152</span><span class="p">,</span>
        <span class="s1">&#39;resnet50_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet50V2</span><span class="p">,</span>
        <span class="s1">&#39;resnet101_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet101V2</span><span class="p">,</span>
        <span class="s1">&#39;resnet152_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet152V2</span><span class="p">,</span>
        <span class="s1">&#39;inception&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">InceptionV3</span><span class="p">,</span>
        <span class="s1">&#39;nasnet_large&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">NASNetLarge</span><span class="p">,</span>
        <span class="s1">&#39;inception_resnet_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">InceptionResNetV2</span><span class="p">,</span>
        <span class="s1">&#39;mobilenet&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">MobileNet</span><span class="p">,</span>
        <span class="s1">&#39;mobilenet_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">,</span>
        <span class="c1"># &#39;ResNeXt50&#39;: kapps.ResNeXt50,</span>
        <span class="c1"># &#39;ResNeXt101&#39;: kapps.ResNeXt101,</span>
        <span class="c1"># &#39;DenseNet&#39;: kapps.DenseNet,</span>
        <span class="c1"># &#39;NASNet&#39;: kapps.NASNet</span>
    <span class="p">}</span>

<div class="viewcode-block" id="ModelParams.__init__"><a class="viewcode-back" href="../../../model.html#slideflow.model.ModelParams.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Adam&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
            <span class="s1">&#39;SGD&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">,</span>
            <span class="s1">&#39;RMSprop&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">,</span>
            <span class="s1">&#39;Adagrad&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">,</span>
            <span class="s1">&#39;Adadelta&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adadelta</span><span class="p">,</span>
            <span class="s1">&#39;Adamax&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adamax</span><span class="p">,</span>
            <span class="s1">&#39;Nadam&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B0&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b0&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B0</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B1&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b1&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B1</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B2&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B2</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B3&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b3&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B3</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2S&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2s&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2S</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2M&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2m&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2M</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2L&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2l&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2L</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LinearLossDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">loss</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mean_absolute_percentage_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mean_squared_logarithmic_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;squared_hinge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;hinge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;logcosh&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LinearLossDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">loss</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mean_absolute_percentage_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mean_squared_logarithmic_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;squared_hinge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;hinge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;categorical_hinge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;logcosh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;huber&#39;</span><span class="p">,</span>
                <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;kullback_leibler_divergence&#39;</span><span class="p">,</span>
                <span class="s1">&#39;poisson&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;batch_loss_crossentropy&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">batch_loss_crossentropy</span><span class="p">,</span>
            <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span>
        <span class="p">})</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_add_hidden_layers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">regularizer</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Adds hidden layer(s) to a model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (tf.keras.Model): Tensorflow model.</span>
<span class="sd">            regularizer (tf.keras.layers.Layer): Regularization for hidden layers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing</span>

<span class="sd">                tf.keras.Model: Model with hidden layers added.</span>

<span class="sd">                tf.keras.layers.Layer: Last linear layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using Batch normalization&quot;</span><span class="p">)</span>
        <span class="n">last_linear</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_width</span><span class="p">,</span>
                                          <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;hidden_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                          <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                                          <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">last_linear</span> <span class="o">=</span> <span class="n">model</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">StaticDropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">last_linear</span>

    <span class="k">def</span> <span class="nf">_get_dense_regularizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return regularizer for dense (hidden) layers.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L2 regularization for dense layers (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 regularization for dense layers (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="si">}</span><span class="s2">) and L2 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="si">}</span><span class="s2">) reg for dense layers&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1_l2</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not using regularization for dense layers&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_add_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add non-hidden layer regularization.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (tf.keras.Model): Tensorflow model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Tensorflow model with regularization added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L2 regularization for base model (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 regularization for base model (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="si">}</span><span class="s2">) and L2 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="si">}</span><span class="s2">) regularization for base model&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1_l2</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not using regularization for base model&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">regularizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">add_regularization</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">regularizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_freeze_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Freeze last X layers, where X = self.trainable_layers.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (tf.keras.Model): Tensorflow model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Tensorflow model with frozen layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">freezeIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainable_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># - self.hp.hidden_layers - 1))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only training on last </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trainable_layers</span><span class="si">}</span><span class="s1"> layers (of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="si">}</span><span class="s1"> total)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="n">freezeIndex</span><span class="p">]:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_get_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a Keras model of the appropriate architecture, input shape,</span>
<span class="sd">        pooling, and initial weights.</span>

<span class="sd">        Args:</span>
<span class="sd">            weights (Optional[str], optional): Pretrained weights to use.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Core model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">model_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="n">input_shape</span><span class="p">,</span>
            <span class="s1">&#39;include_top&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_top</span><span class="p">,</span>
            <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">weights</span>
        <span class="p">}</span>
        <span class="c1"># Only pass kwargs accepted by model function</span>
        <span class="n">model_fn_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_fn</span><span class="p">)</span>
        <span class="n">model_kw</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_fn_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
        <span class="p">]</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">model_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_kw</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_kwargs</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">model_fn</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_base</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;&quot;Builds the base image model, from a Keras model core, with the</span>
<span class="sd">        appropriate input tensors and identity layers.</span>

<span class="sd">        Args:</span>
<span class="sd">            pretrain (str, optional): Pretrained weights to load.</span>
<span class="sd">                Defaults to &#39;imagenet&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Base model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">tile_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tile_image&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pretrain</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using pretraining from [magenta]</span><span class="si">{</span><span class="n">pretrain</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pretrain</span> <span class="ow">and</span> <span class="n">pretrain</span> <span class="o">!=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">:</span>
            <span class="n">pretrained_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">pretrain</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This is the tile_image input</span>
                <span class="n">pretrained_input</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tile_image&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">input</span>
                <span class="c1"># Name of the pretrained model core, which should be at layer 1</span>
                <span class="n">pretrained_name</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># This is the post-convolution layer</span>
                <span class="n">pretrained_output</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;post_convolution&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
                <span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">pretrained_input</span><span class="p">,</span>
                                            <span class="n">outputs</span><span class="o">=</span><span class="n">pretrained_output</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;pretrained_</span><span class="si">{</span><span class="n">pretrained_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to automatically read pretrained model, will try legacy format&#39;</span><span class="p">)</span>
                <span class="n">base_model</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_core</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">pretrain</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_top</span><span class="p">:</span>
                <span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                    <span class="n">outputs</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
        <span class="c1"># Add regularization</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_regularization</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>

        <span class="c1"># Allow only a subset of layers in the base model to be trainable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_layers</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_layers</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>

        <span class="c1"># This is an identity layer that simply returns the last layer, allowing us to name and access this layer later</span>
        <span class="n">post_convolution_identity_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;post_convolution&#39;</span><span class="p">)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tile_input_tensor</span><span class="p">,</span> <span class="n">base_model</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()]</span>
        <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">post_convolution_identity_layer</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">StaticDropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)]</span>
        <span class="n">tile_image_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tile_image_model</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tile_image_model</span><span class="p">,</span> <span class="n">model_inputs</span>

    <span class="k">def</span> <span class="nf">_build_categorical_or_linear_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">num_slide_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;softmax&#39;</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assembles categorical or linear model, using pretraining (imagenet)</span>
<span class="sd">        or the base layers of a supplied model.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_classes (int or dict): Either int (single categorical outcome,</span>
<span class="sd">                indicating number of classes) or dict (dict mapping categorical</span>
<span class="sd">                outcome names to number of unique categories in each outcome).</span>
<span class="sd">            num_slide_features (int): Number of slide-level features separate</span>
<span class="sd">                from image input. Defaults to 0.</span>
<span class="sd">            activation (str): Type of final layer activation to use.</span>
<span class="sd">                Defaults to softmax.</span>
<span class="sd">            pretrain (str): Either &#39;imagenet&#39; or path to model to use as</span>
<span class="sd">                pretraining. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str): Path to checkpoint from which to resume model</span>
<span class="sd">                training. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tile_image_model</span><span class="p">,</span> <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_base</span><span class="p">(</span><span class="n">pretrain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_slide_features</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model has </span><span class="si">{</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1"> slide input features&#39;</span><span class="p">)</span>
            <span class="n">slide_feature_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_slide_features</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slide_feature_input&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not using any slide-level input features.&#39;</span><span class="p">)</span>

        <span class="c1"># Merge layers</span>
        <span class="k">if</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating model with only slide-level input - no images&#39;</span><span class="p">)</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">slide_feature_input_tensor</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="n">num_slide_features</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Add slide feature input tensors, if there are more slide features</span>
            <span class="c1">#    than just the event input tensor for CPH models</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_merge&#39;</span><span class="p">)(</span>
                <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">,</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Add hidden layers</span>
        <span class="n">regularizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dense_regularizer</span><span class="p">()</span>
        <span class="n">merged_model</span><span class="p">,</span> <span class="n">last_linear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_hidden_layers</span><span class="p">(</span>
            <span class="n">merged_model</span><span class="p">,</span> <span class="n">regularizer</span>
        <span class="p">)</span>

        <span class="c1"># Multi-categorical outcomes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_classes</span><span class="p">:</span>
                <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                    <span class="n">num_classes</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;prelogits-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                        <span class="n">activation</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span>
                <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;prelogits&#39;</span>
            <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                    <span class="n">activation</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span>
                <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="c1"># Assemble final model</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">activation</span><span class="si">}</span><span class="s1"> activation&#39;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
        <span class="c1"># Disable experimental batch loss</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add_loss</span><span class="p">(</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">batch_loss_crossentropy</span><span class="p">(</span><span class="n">last_linear</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading checkpoint weights from [green]</span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_build_cph_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">num_slide_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assembles a Cox Proportional Hazards (CPH) model, using pretraining</span>
<span class="sd">        (imagenet) or the base layers of a supplied model.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_classes (int or dict): Either int (single categorical outcome,</span>
<span class="sd">                indicating number of classes) or dict (dict mapping categorical</span>
<span class="sd">                outcome names to number of unique categories in each outcome).</span>
<span class="sd">            num_slide_features (int): Number of slide-level features separate</span>
<span class="sd">                from image input. Defaults to 0.</span>
<span class="sd">            activation (str): Type of final layer activation to use.</span>
<span class="sd">                Defaults to softmax.</span>
<span class="sd">            pretrain (str): Either &#39;imagenet&#39; or path to model to use as</span>
<span class="sd">                pretraining. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str): Path to checkpoint from which to resume model</span>
<span class="sd">                training. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
        <span class="n">tile_image_model</span><span class="p">,</span> <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_base</span><span class="p">(</span><span class="n">pretrain</span><span class="p">)</span>

        <span class="c1"># Add slide feature input tensors, if there are more slide features</span>
        <span class="c1">#    than just the event input tensor for CPH models</span>
        <span class="n">event_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;event_input&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">num_slide_features</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">slide_feature_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_slide_features</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slide_feature_input&#39;</span>
            <span class="p">)</span>
        <span class="c1"># Merge layers</span>
        <span class="k">if</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">):</span>
            <span class="c1"># Add images</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating model with only slide-level input - no images&#39;</span><span class="p">)</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">slide_feature_input_tensor</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">,</span> <span class="n">event_input_tensor</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="n">num_slide_features</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Add slide feature input tensors, if there are more slide features</span>
            <span class="c1">#    than just the event input tensor for CPH models</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_merge&#39;</span><span class="p">)(</span>
                <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">,</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">,</span> <span class="n">event_input_tensor</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">event_input_tensor</span><span class="p">]</span>

        <span class="c1"># Add hidden layers</span>
        <span class="n">regularizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dense_regularizer</span><span class="p">()</span>
        <span class="n">merged_model</span><span class="p">,</span> <span class="n">last_linear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_hidden_layers</span><span class="p">(</span>
            <span class="n">merged_model</span><span class="p">,</span> <span class="n">regularizer</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">activation</span><span class="si">}</span><span class="s1"> activation&#39;</span><span class="p">)</span>

        <span class="c1"># Multi-categorical outcomes</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_classes</span><span class="p">:</span>
                <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                    <span class="n">num_classes</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;prelogits-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                    <span class="n">activation</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span>
                <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;prelogits&#39;</span>
            <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                <span class="n">activation</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span>
            <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)]</span>
        <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_merge_CPH&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span>
        <span class="p">)([</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">event_input_tensor</span><span class="p">])</span>

        <span class="c1"># Assemble final model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading checkpoint weights from [green]</span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

<div class="viewcode-block" id="ModelParams.build_model"><a class="viewcode-back" href="../../../model.html#slideflow.model.ModelParams.build_model">[docs]</a>    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Auto-detects model type (categorical, linear, CPH) from parameters</span>
<span class="sd">        and builds, using pretraining or the base layers of a supplied model.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (dict, optional): Dict mapping slide names to outcomes.</span>
<span class="sd">                Used to detect number of outcome categories.</span>
<span class="sd">            num_classes (int or dict, optional): Either int (single categorical</span>
<span class="sd">                outcome, indicating number of classes) or dict (dict mapping</span>
<span class="sd">                categorical outcome names to number of unique categories in</span>
<span class="sd">                each outcome). Must supply either `num_classes` or `label`</span>
<span class="sd">                (can detect number of classes from labels)</span>
<span class="sd">            num_slide_features (int, optional): Number of slide-level features</span>
<span class="sd">                separate from image input. Defaults to 0.</span>
<span class="sd">            activation (str, optional): Type of final layer activation to use.</span>
<span class="sd">                Defaults to &#39;softmax&#39; (categorical models) or &#39;linear&#39;</span>
<span class="sd">                (linear or CPH models).</span>
<span class="sd">            pretrain (str, optional): Either &#39;imagenet&#39; or path to model to use</span>
<span class="sd">                as pretraining. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str, optional): Path to checkpoint from which to resume</span>
<span class="sd">                model training. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_classes_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_categorical_or_linear_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_categorical_or_linear_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cph_model</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown model type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">Loss</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]</span>

<div class="viewcode-block" id="ModelParams.get_opt"><a class="viewcode-back" href="../../../model.html#slideflow.model.ModelParams.get_opt">[docs]</a>    <span class="k">def</span> <span class="nf">get_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns optimizer with appropriate learning rate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">initial_learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span>
            <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">ExponentialDecay</span><span class="p">(</span>
                <span class="n">initial_learning_rate</span><span class="p">,</span>
                <span class="n">decay_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay_steps</span><span class="p">,</span>
                <span class="n">decay_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay</span><span class="p">,</span>
                <span class="n">staircase</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">](</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr_schedule</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">](</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelParams.model_type"><a class="viewcode-back" href="../../../model.html#slideflow.model.ModelParams.model_type">[docs]</a>    <span class="k">def</span> <span class="nf">model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns &#39;linear&#39;, &#39;categorical&#39;, or &#39;cph&#39;, reflecting the loss.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;cph&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LinearLossDict</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;linear&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;categorical&#39;</span></div></div>


<span class="k">class</span> <span class="nc">_PredictionAndEvaluationCallback</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="c1"># TODO: log early stopping batch number, and record</span>

    <span class="sd">&quot;&quot;&quot;Prediction and Evaluation Callback used during model training.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;Trainer&quot;</span><span class="p">,</span> <span class="n">cb_args</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_PredictionAndEvaluationCallback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span> <span class="o">=</span> <span class="n">cb_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">=</span> <span class="n">cb_args</span><span class="o">.</span><span class="n">starting_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="p">{}}</span>  <span class="c1"># type: Dict[str, Dict]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">neptune_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_metrics_from_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">epoch_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pred_args</span><span class="p">:</span> <span class="n">SimpleNamespace</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics_from_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validation_data_with_slidenames</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">epoch_label</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
            <span class="n">num_tiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">num_val_tiles</span><span class="p">,</span>
            <span class="n">save_predictions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">save_predictions</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">reduce_method</span><span class="p">,</span>
            <span class="n">pred_args</span><span class="o">=</span><span class="n">pred_args</span><span class="p">,</span>
            <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\033</span><span class="s1">[K&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="ow">in</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">]</span>
           <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;trained_model&#39;</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">_epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">save_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trained model saved to [green]</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Try to copy model settings/hyperparameters file</span>
                <span class="c1"># into the model folder</span>
                <span class="n">params_dest</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">params_dest</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
                            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
                            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;neptune_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;sys/id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">params_dest</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">),</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to copy params.json/slide_manifest&#39;</span>
                                    <span class="s1">&#39;.csv files into model folder.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">using_validation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span>

    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Neptune logging for training metrics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;metrics/train/batch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
            <span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/train/batch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
            <span class="p">)</span>

        <span class="c1"># Check if manual early stopping has been triggered</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span>
           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">):</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_epoch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_epoch</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_batch</span> <span class="o">&lt;=</span> <span class="n">batch</span><span class="p">):</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Manual early stop triggered: epoch &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">, batch </span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span> <span class="o">=</span> <span class="n">batch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Validation metrics</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">using_validation</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validate_on_batch</span>
           <span class="ow">and</span> <span class="p">(</span><span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
           <span class="ow">and</span> <span class="p">(</span><span class="n">batch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validate_on_batch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">val_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validation_data</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validation_steps</span><span class="p">,</span>
                <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">val_loss</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
               <span class="ow">and</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">val_metrics</span><span class="p">):</span>
                <span class="n">early_stop_value</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
                <span class="n">val_acc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">early_stop_value</span> <span class="o">=</span> <span class="n">val_loss</span>
                <span class="n">val_acc</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val_metrics</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_metrics</span>
                    <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">v</span>
                <span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
                <span class="n">train_acc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">train_acc</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">logs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logs</span>
                    <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">v</span>
                <span class="p">])</span>
            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\033</span><span class="s1">[K&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span> <span class="o">+=</span> <span class="p">[</span><span class="n">early_stop_value</span><span class="p">]</span>

            <span class="c1"># Log to neptune</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_metrics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metrics/val/batch/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="nb">round</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
                        <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;metrics/val/batch/exp_moving_avg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                        <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/stopped_early&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Base logging message</span>
            <span class="n">batch_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[blue]Batch </span><span class="si">{</span><span class="n">batch</span><span class="si">:</span><span class="s1">&lt;5</span><span class="si">}</span><span class="s1">[/]&#39;</span>
            <span class="n">loss_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[green]loss[/]: </span><span class="si">{</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">val_loss_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[magenta]val_loss[/]: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
                <span class="n">acc_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[green]acc[/]: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">val_acc_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[magenta]val_acc[/]: </span><span class="si">{</span><span class="n">val_acc</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">log_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">batch_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">loss_msg</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">acc_msg</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="n">log_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_loss_msg</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">val_acc_msg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">batch_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">loss_msg</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">val_loss_msg</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Calculate exponential moving average of validation accuracy</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">ema_observations</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only keep track of the last [ema_observations] val accuracies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Calculate simple moving average</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">)</span>
                                     <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (SMA: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Update exponential moving average</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">ema_smoothing</span>
                    <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">ema_observations</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="p">((</span><span class="n">early_stop_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">obs</span><span class="p">)))</span>
                                     <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">obs</span><span class="p">)))))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (EMA: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

            <span class="c1"># If early stopping and our patience criteria has been met,</span>
            <span class="c1">#   check if validation accuracy is still improving</span>
            <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">steps_per_epoch</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
               <span class="ow">and</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps_per_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="p">)</span>
                    <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_patience</span><span class="p">):</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
                          <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span><span class="p">)</span>
                         <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span>
                             <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span><span class="p">))):</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Early stop: epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">, batch &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span> <span class="o">=</span> <span class="n">batch</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># Log early stop to neptune</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/early_stop_epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/early_stop_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/stopped_early&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;sys/tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;early_stopped&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span>

        <span class="c1"># Update global step (for tracking metrics across epochs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\033</span><span class="s1">[K&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;sys/tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;training_complete&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Evaluating model from evaluation callback&quot;</span><span class="p">)</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span>
        <span class="n">metrics</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_from_dataset</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;val_epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span> <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Note that Keras loss during training includes regularization losses,</span>
        <span class="c1"># so this loss will not match validation loss calculated during training</span>
        <span class="n">val_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Validation metrics: &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;train_metrics&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;val&#39;</span><span class="p">},</span>
            <span class="s1">&#39;val_metrics&#39;</span><span class="p">:</span> <span class="n">val_metrics</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;early_stop_epoch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span><span class="p">,</span>
                <span class="s1">&#39;early_stop_batch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;tile_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;slide_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;patient_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span>

        <span class="n">epoch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">results_log</span><span class="p">,</span>
            <span class="s1">&#39;trained_model&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">epoch_results</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Log epoch results to Neptune</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="c1"># Training epoch metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;metrics/train/epoch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/train/epoch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="c1"># Validation epoch metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;metrics/val/epoch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/val/epoch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]:</span>
                    <span class="c1"># If only one outcome, log to metrics/val/epoch/[metric].</span>
                    <span class="c1"># If more than one outcome, log to</span>
                    <span class="c1"># metrics/val/epoch/[metric]/[outcome_name]</span>
                    <span class="k">def</span> <span class="nf">metric_label</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;metrics/val/epoch/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;metrics/val/epoch/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">outcome</span><span class="si">}</span><span class="s1">&#39;</span>

                    <span class="n">tile_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>
                    <span class="n">slide_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>
                    <span class="n">patient_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>

                    <span class="c1"># If only one value for a metric, log to .../[metric]</span>
                    <span class="c1"># If more than one value for a metric (e.g. AUC for each</span>
                    <span class="c1"># category), log to .../[metric]/[i]</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">),</span>
                        <span class="n">tile_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
                    <span class="p">)</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">),</span>
                        <span class="n">slide_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
                    <span class="p">)</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;patient&#39;</span><span class="p">),</span>
                        <span class="n">patient_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
                    <span class="p">)</span>


<div class="viewcode-block" id="Trainer"><a class="viewcode-back" href="../../../model.html#slideflow.model.Trainer">[docs]</a><span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base trainer class containing functionality for model building, input</span>
<span class="sd">    processing, training, and evaluation.</span>

<span class="sd">    This base class requires categorical outcome(s). Additional outcome types</span>
<span class="sd">    are supported by :class:`slideflow.model.LinearTrainer` and</span>
<span class="sd">    :class:`slideflow.model.CPHTrainer`.</span>

<span class="sd">    Slide-level (e.g. clinical) features can be used as additional model input</span>
<span class="sd">    by providing slide labels in the slide annotations dictionary, under the</span>
<span class="sd">    key &#39;input&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span>

<div class="viewcode-block" id="Trainer.__init__"><a class="viewcode-back" href="../../../model.html#slideflow.model.Trainer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hp</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">patients</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">slide_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Trainer&#39;</span><span class="p">,</span>
        <span class="n">manifest</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_sizes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">outcome_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_neptune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">neptune_api</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">neptune_workspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;Sets base configuration, preparing model inputs and outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            hp (:class:`slideflow.model.ModelParams`): ModelParams object.</span>
<span class="sd">            outdir (str): Path for event logs and checkpoints.</span>
<span class="sd">            labels (dict): Dict mapping slide names to outcome labels (int or</span>
<span class="sd">                float format).</span>
<span class="sd">            patients (dict): Dict mapping slide names to patient ID, as some</span>
<span class="sd">                patients may have multiple slides. If not provided, assumes 1:1</span>
<span class="sd">                mapping between slide names and patients.</span>
<span class="sd">            slide_input (dict): Dict mapping slide names to additional</span>
<span class="sd">                slide-level input, concatenated after post-conv.</span>
<span class="sd">            name (str, optional): Optional name describing the model, used for</span>
<span class="sd">                model saving. Defaults to &#39;Trainer&#39;.</span>
<span class="sd">            manifest (dict, optional): Manifest dictionary mapping TFRecords to</span>
<span class="sd">                number of tiles. Defaults to None.</span>
<span class="sd">            feature_sizes (list, optional): List of sizes of input features.</span>
<span class="sd">                Required if providing additional input features as input to</span>
<span class="sd">                the model.</span>
<span class="sd">            feature_names (list, optional): List of names for input features.</span>
<span class="sd">                Used when permuting feature importance.</span>
<span class="sd">            outcome_names (list, optional): Name of each outcome. Defaults to</span>
<span class="sd">                &quot;Outcome {X}&quot; for each outcome.</span>
<span class="sd">            mixed_precision (bool, optional): Use FP16 mixed precision (rather</span>
<span class="sd">                than FP32). Defaults to True.</span>
<span class="sd">            config (dict, optional): Training configuration dictionary, used</span>
<span class="sd">                for logging. Defaults to None.</span>
<span class="sd">            use_neptune (bool, optional): Use Neptune API logging.</span>
<span class="sd">                Defaults to False</span>
<span class="sd">            neptune_api (str, optional): Neptune API token, used for logging.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            neptune_workspace (str, optional): Neptune workspace.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="o">=</span> <span class="n">slide_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_sizes</span> <span class="o">=</span> <span class="n">feature_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_sizes</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_sizes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">mixed_precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_callback</span> <span class="o">=</span> <span class="n">_PredictionAndEvaluationCallback</span>  <span class="c1"># type: tf.keras.callbacks.Callback</span>

        <span class="k">if</span> <span class="n">patients</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="n">patients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># Format outcome labels (ensures compatibility with single</span>
        <span class="c1"># and multi-outcome models)</span>
        <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">outcome_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outcome_names</span><span class="p">:</span>
            <span class="n">outcome_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;Outcome </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="n">outcome_names</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">num_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span>
            <span class="n">num_outcomes</span> <span class="o">=</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Size of outcome_names (</span><span class="si">{</span><span class="n">num_names</span><span class="si">}</span><span class="s1">) != &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;number of outcomes </span><span class="si">{</span><span class="n">num_outcomes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span> <span class="o">=</span> <span class="n">outcome_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inputs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">_detect_classes_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/cpu&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">StaticHashTable</span><span class="p">(</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">KeyValueTensorInitializer</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">,</span>
                            <span class="n">outcome_labels</span><span class="p">[:,</span> <span class="n">oi</span><span class="p">]</span>
                        <span class="p">),</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Normalization setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_normalizer</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using realtime </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">normalizer</span><span class="si">}</span><span class="s1"> normalization&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">:</span>
            <span class="n">_policy</span> <span class="o">=</span> <span class="s1">&#39;mixed_float16&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Enabling mixed precision (</span><span class="si">{</span><span class="n">_policy</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2.8&quot;</span><span class="p">):</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">mixed_precision</span><span class="o">.</span><span class="n">set_global_policy</span><span class="p">(</span><span class="n">_policy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">policy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">mixed_precision</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">Policy</span><span class="p">(</span><span class="n">_policy</span><span class="p">)</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">mixed_precision</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

        <span class="c1"># Log parameters</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(),</span>
                <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>

        <span class="c1"># Initialize Neptune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span> <span class="o">=</span> <span class="n">use_neptune</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neptune_api</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">neptune_workspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If using Neptune, must supply values &quot;</span>
                                 <span class="s2">&quot;neptune_api and neptune_workspace.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">NeptuneLog</span><span class="p">(</span>
                <span class="n">neptune_api</span><span class="p">,</span>
                <span class="n">neptune_workspace</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup slide-level input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training with both images and &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1"> categories of slide-&#39;</span>
                             <span class="s1">&#39;level input&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Unable to find slide-level input at &quot;</span>
                                        <span class="s2">&quot;&#39;input&#39; key in annotations&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                    <span class="n">num_in_feature_table</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Length of input for slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1"> does not match &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;feature_sizes; expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1">, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="n">num_in_feature_table</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compile keras model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(),</span>
            <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fit_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fit the Trainer normalizer using the specified fit, if applicable.</span>

<span class="sd">        Args:</span>
<span class="sd">            norm_fit (Optional[Dict[str, np.ndarray]]): Normalizer fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">norm_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_fit supplied, but model params do not&quot;</span>
                             <span class="s2">&quot;specify a normalizer.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="ow">and</span> <span class="n">norm_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">norm_fit</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span>
              <span class="ow">and</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
              <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detecting normalizer fit from model config&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_parse_tfrecord_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Parses raw entry read from TFRecord.&quot;&quot;&quot;</span>

        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tile_image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">oi</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>

        <span class="c1"># Add additional non-image feature inputs if indicated,</span>
        <span class="c1">#     excluding the event feature used for CPH models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">slide_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)]</span>

            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="n">slide_feature_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">slide_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_features</span>
            <span class="p">)</span>
            <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;slide_feature_input&#39;</span><span class="p">:</span> <span class="n">slide_feature_input_val</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_dict</span><span class="p">,</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">_retrain_top_layers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">validation_data</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">steps_per_epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrain only the top layer, leaving all other layers frozen.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retraining top layer&#39;</span><span class="p">)</span>
        <span class="c1"># Freeze the base layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">val_steps</span> <span class="o">=</span> <span class="mi">200</span> <span class="k">if</span> <span class="n">validation_data</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">()</span>

        <span class="n">toplayer_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">),</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_data</span><span class="p">,</span>
            <span class="n">validation_steps</span><span class="o">=</span><span class="n">val_steps</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span>
        <span class="p">)</span>
        <span class="c1"># Unfreeze the base layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">toplayer_model</span><span class="o">.</span><span class="n">history</span>

    <span class="k">def</span> <span class="nf">_interleave_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_tfrecord_labels</span><span class="p">,</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interleave_kwargs_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_metric_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
            <span class="n">neptune_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.predict"><a class="viewcode-back" href="../../../model.html#slideflow.model.Trainer.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform inference on a model, saving tile-level predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset containing</span>
<span class="sd">                TFRecords to evaluate.</span>
<span class="sd">            batch_size (int, optional): Evaluation batch size. Defaults to the</span>
<span class="sd">                same as training (per self.hp)</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            format (str, optional): Format in which to save predictions. Either</span>
<span class="sd">                &#39;csv&#39;, &#39;feather&#39;, or &#39;parquet&#39;. Defaults to &#39;parquet&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame of tile-level predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;feather&#39;</span><span class="p">,</span> <span class="s1">&#39;parquet&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized format </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fit normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="c1"># Load and initialize model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelNotLoadedError</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
            <span class="n">interleave_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs_val</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">augment</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">tf_dts_w_slidenames</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">interleave_kwargs</span>
            <span class="p">)</span>
        <span class="c1"># Generate predictions</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating predictions...&#39;</span><span class="p">)</span>
        <span class="n">pred_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">))</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">predict_from_dataset</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">tf_dts_w_slidenames</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
            <span class="n">pred_args</span><span class="o">=</span><span class="n">pred_args</span><span class="p">,</span>
            <span class="n">num_tiles</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Save predictions</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">save_dfs</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dfs</span></div>

<div class="viewcode-block" id="Trainer.evaluate"><a class="viewcode-back" href="../../../model.html#slideflow.model.Trainer.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model, saving metrics and predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset containing</span>
<span class="sd">                TFRecords to evaluate.</span>
<span class="sd">            batch_size (int, optional): Evaluation batch size. Defaults to the</span>
<span class="sd">                same as training (per self.hp)</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical outcomes.</span>
<span class="sd">                Either &#39;average&#39; or &#39;proportion&#39;. If &#39;average&#39;, will reduce with</span>
<span class="sd">                average of each logit across tiles. If &#39;proportion&#39;, will convert</span>
<span class="sd">                tile predictions into onehot encoding then reduce by averaging</span>
<span class="sd">                these onehot values. Defaults to &#39;average&#39;.</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            uq (bool or str, optional): Enable UQ estimation (for</span>
<span class="sd">                applicable models). Defaults to &#39;auto&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of evaluation metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uq</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uq</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized value </span><span class="si">{</span><span class="n">uq</span><span class="si">}</span><span class="s2"> for uq&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span> <span class="o">=</span> <span class="n">uq</span>

        <span class="c1"># Fit normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="c1"># Load and initialize model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelNotLoadedError</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Neptune logging</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">log_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;data/slide_manifest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
            <span class="n">interleave_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs_val</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">augment</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">tf_dts_w_slidenames</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">interleave_kwargs</span>
            <span class="p">)</span>
        <span class="c1"># Generate performance metrics</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating performance metrics...&#39;</span><span class="p">)</span>
        <span class="n">metric_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric_kwargs</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">tf_dts_w_slidenames</span><span class="p">,</span>
            <span class="n">num_tiles</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span>
        <span class="p">)</span>
        <span class="n">pred_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
            <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">metrics</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics_from_dataset</span><span class="p">(</span>
            <span class="n">save_predictions</span><span class="o">=</span><span class="n">save_predictions</span><span class="p">,</span>
            <span class="n">pred_args</span><span class="o">=</span><span class="n">pred_args</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span><span class="p">,</span>
            <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">metric_kwargs</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="p">{}}</span>  <span class="c1"># type: Dict[str, Dict[str, float]]</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tile </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Patient </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="sa">f</span><span class="s1">&#39;tile_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">],</span>
                    <span class="sa">f</span><span class="s1">&#39;slide_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">],</span>
                    <span class="sa">f</span><span class="s1">&#39;patient_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="c1"># Note that Keras loss during training includes regularization losses,</span>
        <span class="c1"># so this loss will not match validation loss calculated during training</span>
        <span class="n">val_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
        <span class="n">results_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Evaluation metrics:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">val_metrics</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">val_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">)</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span><span class="n">results_log</span><span class="p">,</span> <span class="s1">&#39;eval_model&#39;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="c1"># Update neptune log</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;eval/results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Trainer.train"><a class="viewcode-back" href="../../../model.html#slideflow.model.Trainer.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_dts</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">val_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">],</span>
        <span class="n">log_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">validate_on_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">validation_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">starting_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ema_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">ema_smoothing</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">use_tensorboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">steps_per_epoch_override</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">resume_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_checkpoints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">multi_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds and trains a model from hyperparameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_dts (:class:`slideflow.Dataset`): Training dataset. Will call</span>
<span class="sd">                the `.tensorflow()` method to retrieve the tf.data.Dataset</span>
<span class="sd">                used for model fitting.</span>
<span class="sd">            val_dts (:class:`slideflow.Dataset`): Validation dataset. Will call</span>
<span class="sd">                the `.tensorflow()` method to retrieve the tf.data.Dataset</span>
<span class="sd">                used for model fitting.</span>
<span class="sd">            log_frequency (int, optional): How frequent to update Tensorboard</span>
<span class="sd">                logs, in batches. Defaults to 100.</span>
<span class="sd">            validate_on_batch (int, optional): Validation will also be performed</span>
<span class="sd">                every N batches. Defaults to 0.</span>
<span class="sd">            validation_batch_size (int, optional): Validation batch size.</span>
<span class="sd">                Defaults to same as training (per self.hp).</span>
<span class="sd">            validation_steps (int, optional): Number of batches to use for each</span>
<span class="sd">                instance of validation. Defaults to 200.</span>
<span class="sd">            starting_epoch (int, optional): Starts training at the specified</span>
<span class="sd">                epoch. Defaults to 0.</span>
<span class="sd">            ema_observations (int, optional): Number of observations over which</span>
<span class="sd">                to perform exponential moving average smoothing. Defaults to 20.</span>
<span class="sd">            ema_smoothing (int, optional): Exponential average smoothing value.</span>
<span class="sd">                Defaults to 2.</span>
<span class="sd">            use_tensoboard (bool, optional): Enable tensorboard callbacks.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            steps_per_epoch_override (int, optional): Manually set the number</span>
<span class="sd">                of steps per epoch. Defaults to 0 (automatic).</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            save_model (bool, optional): Save models when evaluating at</span>
<span class="sd">                specified epochs. Defaults to True.</span>
<span class="sd">            resume_training (str, optional): Path to Tensorflow model to</span>
<span class="sd">                continue training. Defaults to None.</span>
<span class="sd">            pretrain (str, optional): Either &#39;imagenet&#39; or path to Tensorflow</span>
<span class="sd">                model from which to load weights. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt from which to load</span>
<span class="sd">                weights. Defaults to None.</span>
<span class="sd">            save_checkpoint(bool, optional): Save checkpoints at each epoch.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            multi_gpu(bool, optional): Enable multi-GPU training using</span>
<span class="sd">                Tensorflow/Keras MirroredStrategy.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical outcomes.</span>
<span class="sd">                Either &#39;average&#39; or &#39;proportion&#39;. If &#39;average&#39;, will reduce with</span>
<span class="sd">                average of each logit across tiles. If &#39;proportion&#39;, will convert</span>
<span class="sd">                tile predictions into onehot encoding then reduce by averaging</span>
<span class="sd">                these onehot values. Defaults to &#39;average&#39;.</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Nested results dict with metrics for each evaluated epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">:</span>
            <span class="n">hp_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incompatible models: </span><span class="si">{</span><span class="n">hp_model</span><span class="si">}</span><span class="s2"> (hp) and &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="si">}</span><span class="s2"> (model)&quot;</span><span class="p">)</span>

        <span class="c1"># Clear prior Tensorflow graph to free memory</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
        <span class="n">results_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Fit the normalizer to the training data and log the source mean/stddev</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">normalizer_source</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                    <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">get_fit</span><span class="p">(</span><span class="n">as_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

        <span class="c1"># Save training / validation manifest</span>
        <span class="n">val_tfrecords</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="n">train_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">val_tfrecords</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Neptune logging</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;k-fold&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]:</span>
                <span class="n">tags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;k-fold</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;k_fold_i&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
                <span class="n">train_dts</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="n">tags</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">log_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;data/slide_manifest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set up multi-GPU strategy</span>
        <span class="k">if</span> <span class="n">multi_gpu</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multi-GPU training with &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span><span class="si">}</span><span class="s1"> devices&#39;</span><span class="p">)</span>
            <span class="c1"># Fixes &quot;OSError: [Errno 9] Bad file descriptor&quot; after training</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">_extended</span><span class="o">.</span><span class="n">_collective_ops</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">()</span> <span class="k">if</span> <span class="n">strategy</span> <span class="k">else</span> <span class="n">no_scope</span><span class="p">():</span>
            <span class="c1"># Build model from ModeLParams</span>
            <span class="k">if</span> <span class="n">resume_training</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">resume_training</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">,</span>
                    <span class="n">pretrain</span><span class="o">=</span><span class="n">pretrain</span><span class="p">,</span>
                    <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
                <span class="n">tf_utils</span><span class="o">.</span><span class="n">log_summary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
                <span class="n">t_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs</span><span class="p">(</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">infinite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">augment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">augment</span>
                <span class="p">)</span>
                <span class="n">train_data</span> <span class="o">=</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">t_kwargs</span><span class="p">)</span>

            <span class="c1"># Set up validation data</span>
            <span class="n">using_validation</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_dts</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">using_validation</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_batch_size</span><span class="p">:</span>
                        <span class="n">validation_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
                    <span class="n">v_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs_val</span><span class="p">(</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">validation_batch_size</span><span class="p">,</span>
                        <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">augment</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="n">val_data</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span><span class="o">**</span><span class="n">v_kwargs</span><span class="p">)</span>
                    <span class="n">val_data_w_slidenames</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                        <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">v_kwargs</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">validate_on_batch</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: every &#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">validate_on_batch</span><span class="si">}</span><span class="s1"> steps and at epoch end&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: at epoch end&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validation_steps</span><span class="p">:</span>
                    <span class="n">validation_data_for_training</span> <span class="o">=</span> <span class="n">val_data</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span>
                    <span class="n">num_samples</span> <span class="o">=</span> <span class="n">validation_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">validation_steps</span><span class="si">}</span><span class="s1"> batches (</span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39; samples) each validation check&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">validation_data_for_training</span> <span class="o">=</span> <span class="n">val_data</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using entire validation set each val check&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: None&#39;</span><span class="p">)</span>
                <span class="n">validation_data_for_training</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">val_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">val_data_w_slidenames</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">validation_steps</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Calculate parameters</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">starting_epoch</span><span class="p">:</span>
                <span class="n">max_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting epoch (</span><span class="si">{</span><span class="n">starting_epoch</span><span class="si">}</span><span class="s1">) cannot be greater&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39; than max target epoch (</span><span class="si">{</span><span class="n">max_epoch</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span> <span class="o">!=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to use &#39;accuracy&#39; early stopping with model &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">starting_epoch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting training at epoch </span><span class="si">{</span><span class="n">starting_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps_per_epoch_override</span><span class="p">:</span>
                <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">steps_per_epoch_override</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">train_dts</span><span class="o">.</span><span class="n">num_tiles</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

            <span class="n">cb_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
                <span class="n">starting_epoch</span><span class="o">=</span><span class="n">starting_epoch</span><span class="p">,</span>
                <span class="n">using_validation</span><span class="o">=</span><span class="n">using_validation</span><span class="p">,</span>
                <span class="n">validate_on_batch</span><span class="o">=</span><span class="n">validate_on_batch</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span>
                <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">,</span>
                <span class="n">ema_observations</span><span class="o">=</span><span class="n">ema_observations</span><span class="p">,</span>
                <span class="n">ema_smoothing</span><span class="o">=</span><span class="n">ema_smoothing</span><span class="p">,</span>
                <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                <span class="n">validation_data_with_slidenames</span><span class="o">=</span><span class="n">val_data_w_slidenames</span><span class="p">,</span>
                <span class="n">num_val_tiles</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">),</span>
                <span class="n">save_predictions</span><span class="o">=</span><span class="n">save_predictions</span><span class="p">,</span>
                <span class="n">save_model</span><span class="o">=</span><span class="n">save_model</span><span class="p">,</span>
                <span class="n">results_log</span><span class="o">=</span><span class="n">results_log</span><span class="p">,</span>
                <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span>
            <span class="p">)</span>

            <span class="c1"># Create callbacks for early stopping, checkpoint saving,</span>
            <span class="c1"># summaries, and history</span>
            <span class="n">val_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_args</span><span class="p">)</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">History</span><span class="p">(),</span> <span class="n">val_callback</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">save_checkpoints</span><span class="p">:</span>
                <span class="n">cp_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;cp.ckpt&#39;</span><span class="p">),</span>
                    <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cp_callback</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">use_tensorboard</span><span class="p">:</span>
                <span class="n">tensorboard_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TensorBoard</span><span class="p">(</span>
                    <span class="n">log_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                    <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">write_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">update_freq</span><span class="o">=</span><span class="n">log_frequency</span>
                <span class="p">)</span>
                <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tensorboard_callback</span><span class="p">]</span>

            <span class="c1"># Retrain top layer only, if using transfer learning and</span>
            <span class="c1"># not resuming training</span>
            <span class="n">total_epochs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span>
                            <span class="o">+</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span> <span class="o">-</span> <span class="n">starting_epoch</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retrain_top_layers</span><span class="p">(</span>
                    <span class="n">train_data</span><span class="p">,</span>
                    <span class="n">validation_data_for_training</span><span class="p">,</span>
                    <span class="n">steps_per_epoch</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span>
                <span class="p">)</span>
            <span class="c1"># Train the model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beginning training&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">train_data</span><span class="p">,</span>
                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">),</span>
                    <span class="n">initial_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_data_for_training</span><span class="p">,</span>
                    <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ResourceExhaustedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training failed for [bold]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/], &quot;</span>
                          <span class="s2">&quot;GPU memory exceeded.&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">val_callback</span><span class="o">.</span><span class="n">results</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">results</span></div></div>


<div class="viewcode-block" id="LinearTrainer"><a class="viewcode-back" href="../../../model.html#slideflow.model.LinearTrainer">[docs]</a><span class="k">class</span> <span class="nc">LinearTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Extends the base :class:`slideflow.model.Trainer` class to add support</span>
<span class="sd">    for linear/continuous outcomes. Requires that all outcomes be continuous,</span>
<span class="sd">    with appropriate linear loss function. Uses R-squared as the evaluation</span>
<span class="sd">    metric, rather than AUROC.&quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>

<div class="viewcode-block" id="LinearTrainer.__init__"><a class="viewcode-back" href="../../../model.html#slideflow.model.LinearTrainer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(),</span>
                           <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
                           <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">_parse_tfrecord_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tile_image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="p">]</span>

        <span class="c1"># Add additional non-image feature inputs if indicated,</span>
        <span class="c1">#     excluding the event feature used for CPH models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">slide_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)]</span>

            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="n">slide_feature_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">slide_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_features</span>
            <span class="p">)</span>
            <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;slide_feature_input&#39;</span><span class="p">:</span> <span class="n">slide_feature_input_val</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_dict</span><span class="p">,</span> <span class="n">label</span></div>


<div class="viewcode-block" id="CPHTrainer"><a class="viewcode-back" href="../../../model.html#slideflow.model.CPHTrainer">[docs]</a><span class="k">class</span> <span class="nc">CPHTrainer</span><span class="p">(</span><span class="n">LinearTrainer</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Cox Proportional Hazards model. Requires that the user provide event</span>
<span class="sd">    data as the first input feature, and time to outcome as the linear outcome.</span>
<span class="sd">    Uses concordance index as the evaluation metric.&quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;cph&#39;</span>

<div class="viewcode-block" id="CPHTrainer.__init__"><a class="viewcode-back" href="../../../model.html#slideflow.model.CPHTrainer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s1">&#39;Model error - CPH models must &#39;</span>
                                    <span class="s1">&#39;include event input&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Setup slide-level input</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_features</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training with both images and </span><span class="si">{</span><span class="n">num_features</span><span class="si">}</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;categories of slide-level input&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Interpreting first feature as event for CPH model&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training with images alone. Interpreting first &#39;</span>
                         <span class="s1">&#39;feature as event for CPH model&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Unable to find slide-level input at &quot;</span>
                                    <span class="s2">&quot;&#39;input&#39; key in annotations&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                <span class="n">num_in_feature_table</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Length of input for slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1"> does not match &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;feature_sizes; expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1">, got &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_in_feature_table</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="n">custom_objects</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">,</span>
            <span class="s1">&#39;concordance_index&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">concordance_index</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">loss</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">concordance_index</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(),</span>
                           <span class="n">loss</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">,</span>
                           <span class="n">metrics</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">concordance_index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_tfrecord_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tile_image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="p">]</span>

        <span class="c1"># Add additional non-image feature inputs if indicated,</span>
        <span class="c1">#     excluding the event feature used for CPH models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="c1"># Time-to-event data must be added as a separate feature</span>

            <span class="k">def</span> <span class="nf">slide_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">def</span> <span class="nf">event_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">event_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">event_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;event_input&#39;</span><span class="p">:</span> <span class="n">event_input_val</span><span class="p">})</span>
            <span class="n">slide_feature_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">slide_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_features</span>
            <span class="p">)</span>
            <span class="c1"># Add slide input features, excluding the event feature</span>
            <span class="c1"># used for CPH models</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;slide_feature_input&#39;</span><span class="p">:</span> <span class="n">slide_feature_input_val</span><span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">image_dict</span><span class="p">,</span> <span class="n">label</span></div>


<div class="viewcode-block" id="Features"><a class="viewcode-back" href="../../../model.html#slideflow.model.Features">[docs]</a><span class="k">class</span> <span class="nc">Features</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Interface for obtaining logits and features from intermediate layer</span>
<span class="sd">    activations from Slideflow models.</span>

<span class="sd">    Use by calling on either a batch of images (returning outputs for a single</span>
<span class="sd">    batch), or by calling on a :class:`slideflow.WSI` object, which will</span>
<span class="sd">    generate an array of spatially-mapped activations matching the slide.</span>

<span class="sd">    Examples</span>
<span class="sd">        *Calling on batch of images:*</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            interface = Features(&#39;/model/path&#39;, layers=&#39;postconv&#39;)</span>
<span class="sd">            for image_batch in train_data:</span>
<span class="sd">                # Return shape: (batch_size, num_features)</span>
<span class="sd">                batch_features = interface(image_batch)</span>

<span class="sd">        *Calling on a slide:*</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            slide = sf.WSI(...)</span>
<span class="sd">            interface = Features(&#39;/model/path&#39;, layers=&#39;postconv&#39;)</span>
<span class="sd">            # Returns shape:</span>
<span class="sd">            # (slide.grid.shape[0], slide.grid.shape[1], num_features)</span>
<span class="sd">            activations_grid = interface(slide)</span>

<span class="sd">    Note:</span>
<span class="sd">        When this interface is called on a batch of images, no image processing</span>
<span class="sd">        or stain normalization will be performed, as it is assumed that</span>
<span class="sd">        normalization will occur during data loader image processing. When the</span>
<span class="sd">        interface is called on a `slideflow.WSI`, the normalization strategy</span>
<span class="sd">        will be read from the model configuration file, and normalization will</span>
<span class="sd">        be performed on image tiles extracted from the WSI. If this interface</span>
<span class="sd">        was created from an existing model and there is no model configuration</span>
<span class="sd">        file to read, a slideflow.norm.StainNormalizer object may be passed</span>
<span class="sd">        during initialization via the argument `wsi_normalizer`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Features.__init__"><a class="viewcode-back" href="../../../model.html#slideflow.model.Features.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="n">include_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a features interface from a saved slideflow model which</span>
<span class="sd">        outputs feature activations at the designated layers.</span>

<span class="sd">        Intermediate layers are returned in the order of layers.</span>
<span class="sd">        Logits are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to saved Slideflow model.</span>
<span class="sd">            layers (list(str), optional): Layers from which to generate</span>
<span class="sd">                activations.  The post-convolution activation layer is accessed</span>
<span class="sd">                via &#39;postconv&#39;. Defaults to &#39;postconv&#39;.</span>
<span class="sd">            include_logits (bool, optional): Include logits in output. Will be</span>
<span class="sd">                returned last. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_uncertainty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting up Features interface&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;img_format&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ModelParams</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_normalizer</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;norm_fit found in model config file, but model &#39;</span>
                             <span class="s1">&#39;params does not use a normalizer. Ignoring.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span>
                <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">include_logits</span><span class="o">=</span><span class="n">include_logits</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Features.from_model"><a class="viewcode-back" href="../../../model.html#slideflow.model.Features.from_model">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="n">include_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wsi_normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a features interface from a loaded slideflow model which</span>
<span class="sd">        outputs feature activations at the designated layers.</span>

<span class="sd">        Intermediate layers are returned in the order of layers.</span>
<span class="sd">        Logits are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (:class:`tensorflow.keras.models.Model`): Loaded model.</span>
<span class="sd">            layers (list(str), optional): Layers from which to generate</span>
<span class="sd">                activations.  The post-convolution activation layer is accessed</span>
<span class="sd">                via &#39;postconv&#39;. Defaults to &#39;postconv&#39;.</span>
<span class="sd">            include_logits (bool, optional): Include logits in output. Will be</span>
<span class="sd">                returned last. Defaults to False.</span>
<span class="sd">            wsi_normalizer (:class:`slideflow.norm.StainNormalizer`): Stain</span>
<span class="sd">                normalizer to use on whole-slide images. Is not used on</span>
<span class="sd">                individual tile datasets via __call__. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">include_logits</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Model is not a valid Tensorflow model.&quot;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">include_logits</span><span class="o">=</span><span class="n">include_logits</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="n">wsi_normalizer</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Process a given input and return features and/or logits.</span>
<span class="sd">        Expects either a batch of images or a :class:`slideflow.WSI`.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_slide</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_slide</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate activations from slide =&gt; activation grid array.&quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide prediction (batch_size=</span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;img_format=</span><span class="si">{</span><span class="n">img_format</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Unable to auto-detect image format (png or jpg). Set the &#39;</span>
                <span class="s1">&#39;format by passing img_format=... to the call function.&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">img_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span>
        <span class="n">total_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_uncertainty</span>
        <span class="n">features_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">total_out</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">features_grid</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">img_format</span><span class="o">=</span><span class="n">img_format</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">generator</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No tiles extracted from slide [green]</span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">tile_generator</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">image_dict</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">():</span>
                <span class="k">yield</span> <span class="p">{</span>
                    <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">image_dict</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image_dict</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="p">}</span>

        <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
        <span class="k">def</span> <span class="nf">_parse_function</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">img_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">img_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">,):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_png</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="o">.</span><span class="n">tf_to_tf</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">parsed_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">per_image_standardization</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">parsed_image</span><span class="o">.</span><span class="n">set_shape</span><span class="p">([</span><span class="n">slide</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">slide</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">parsed_image</span><span class="p">,</span> <span class="n">loc</span>

        <span class="c1"># Generate dataset from the generator</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;dataset_input&#39;</span><span class="p">):</span>
            <span class="n">output_signature</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
                <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span>
                <span class="n">tile_generator</span><span class="p">,</span>
                <span class="n">output_signature</span><span class="o">=</span><span class="n">output_signature</span>
            <span class="p">)</span>
            <span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tile_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="n">_parse_function</span><span class="p">,</span>
                <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">8</span>
            <span class="p">)</span>
            <span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tile_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tile_dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">act_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loc_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_images</span><span class="p">,</span> <span class="n">batch_loc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tile_dataset</span><span class="p">):</span>
            <span class="n">model_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_out</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">model_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_out</span><span class="p">]</span>
            <span class="n">act_arr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model_out</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">loc_arr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">batch_loc</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]</span>

        <span class="n">act_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">act_arr</span><span class="p">)</span>
        <span class="n">loc_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">loc_arr</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">act</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">act_arr</span><span class="p">):</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">loc_arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="n">loc_arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">features_grid</span><span class="p">[</span><span class="n">yi</span><span class="p">][</span><span class="n">xi</span><span class="p">]</span> <span class="o">=</span> <span class="n">act</span>

        <span class="k">return</span> <span class="n">features_grid</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return activations for a single batch of images.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
        <span class="n">include_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Builds the interface model that outputs feature activations at the</span>
<span class="sd">        designated layers and/or logits. Intermediate layers are returned in</span>
<span class="sd">        the order of layers. Logits are returned last.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">layers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up interface to return activations from layers &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">other_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">la</span> <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">layers</span> <span class="k">if</span> <span class="n">la</span> <span class="o">!=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">intermediate_core</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">ol</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
                    <span class="k">for</span> <span class="n">ol</span> <span class="ow">in</span> <span class="n">other_layers</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">int_out</span> <span class="o">=</span> <span class="n">intermediate_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">la</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other_layers</span><span class="p">):</span>
                    <span class="n">outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_out</span><span class="p">[</span><span class="n">la</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_layers</span><span class="p">):</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">other_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">intermediate_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;postconv&#39;</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;postconv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_output_at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">outputs_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">layers</span> <span class="k">else</span> <span class="p">[</span><span class="n">outputs</span><span class="p">[</span><span class="n">la</span><span class="p">]</span> <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_logits</span><span class="p">:</span>
            <span class="n">outputs_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">outputs_list</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">outputs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Multi-categorical outcomes not yet supported &quot;</span>
                        <span class="s2">&quot;for this interface.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">include_logits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">include_logits</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of logits: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of activation features: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">UncertaintyInterface</span><span class="p">(</span><span class="n">Features</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting up UncertaintyInterface&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">include_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># TODO: As the below to-do suggests, this should be updated</span>
        <span class="c1"># for multi-class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_uncertainty</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_logits</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;UncertaintyInterface not yet implemented for multi-class&quot;</span>
                     <span class="s2">&quot; models&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wsi_normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">include_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">wsi_normalizer</span><span class="o">=</span><span class="n">wsi_normalizer</span>
        <span class="p">)</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return activations (mean), predictions (mean), and uncertainty</span>
<span class="sd">        (stdev) for a single batch of images.&quot;&quot;&quot;</span>

        <span class="n">out_drop</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">):</span>
                <span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">yp</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">yp</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">):</span>
            <span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># TODO: Only takes STDEV from first outcome category which works for</span>
        <span class="c1"># outcomes with 2 categories, but a better solution is needed</span>
        <span class="c1"># for num_categories &gt; 2</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="p">[</span><span class="n">logits</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">uncertainty</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, James M Dolezal.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1.html">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/jamesdolezal/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>