


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>slideflow.model.tensorflow &mdash; slideflow 3.0.0 documentation</title>















  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../search/" />




  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-Light.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-MediumItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <script defer data-domain="slideflow.dev" src="https://plausible.io/js/script.js"></script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">





    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">





                <div class="version">
                  3.0
                </div>









<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search/" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


          </div>







              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview/">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../project_setup/">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datasets_and_val/">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slide_processing/">Slide Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../training/">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../evaluation/">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../posthoc/">Layer Activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../uq/">Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features/">Generating Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mil/">Multiple-Instance Learning (MIL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ssl/">Self-Supervised Learning (SSL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stylegan/">Generative Networks (GANs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../saliency/">Saliency Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../segmentation/">Tissue Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cellseg/">Cell Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../custom_loops/">Custom Training Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../studio/">Slideflow Studio: Live Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tfrecords/">TFRecords: Reading and Writing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataloaders/">Dataloaders: Sampling and Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../custom_extractors/">Custom Feature Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tile_labels/">Strong Supervision with Tile Labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/">Creating a Slideflow Plugin</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../slideflow/">slideflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../project/">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataset/">slideflow.Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataset_features/">slideflow.DatasetFeatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heatmap/">slideflow.Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_params/">slideflow.ModelParams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mosaic/">slideflow.Mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slidemap/">slideflow.SlideMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../biscuit/">slideflow.biscuit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slideflow_cellseg/">slideflow.cellseg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io_tensorflow/">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io_torch/">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gan/">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../grad/">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mil_module/">slideflow.mil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model/">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_tensorflow/">slideflow.model.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_torch/">slideflow.model.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../norm/">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../simclr/">slideflow.simclr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slide/">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slide_qc/">slideflow.slide.qc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stats/">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../util/">slideflow.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../studio_module/">slideflow.studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial1/">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial2/">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial3/">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial4/">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial5/">Tutorial 5: Creating a mosaic map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial6/">Tutorial 6: Custom slide filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial7/">Tutorial 7: Training with custom augmentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial8/">Tutorial 8: Multiple-Instance Learning</a></li>
</ul>



        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">

      <li>
        <a href="../../../../">

            Docs

        </a> &gt;
      </li>


          <li><a href="../../../">Module code</a> &gt;</li>

          <li><a href="../">slideflow.model</a> &gt;</li>

      <li>slideflow.model.tensorflow</li>


      <li class="pytorch-breadcrumbs-aside">

      </li>

  </ul>


</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">



          <div class="rst-content">

            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">

  <h1>Source code for slideflow.model.tensorflow</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Tensorflow backend for the slideflow.model submodule.&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">applications</span> <span class="k">as</span> <span class="n">kapps</span>

<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">import</span> <span class="nn">slideflow.model.base</span> <span class="k">as</span> <span class="nn">_base</span>
<span class="kn">import</span> <span class="nn">slideflow.util.neptune_utils</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">NormFit</span><span class="p">,</span> <span class="n">no_scope</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tensorflow_utils</span> <span class="k">as</span> <span class="n">tf_utils</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">log_manifest</span><span class="p">,</span> <span class="n">BaseFeatureExtractor</span>
<span class="kn">from</span> <span class="nn">.tensorflow_utils</span> <span class="kn">import</span> <span class="n">unwrap</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">eval_from_model</span><span class="p">,</span> <span class="n">build_uq_model</span>  <span class="c1"># type: ignore</span>

<span class="c1"># Set the tensorflow logger</span>
<span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>

<span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">allow_gpu_memory_growth</span><span class="p">()</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">slideflow.norm</span> <span class="kn">import</span> <span class="n">StainNormalizer</span>


<span class="k">class</span> <span class="nc">StaticDropout</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelParams</span><span class="p">(</span><span class="n">_base</span><span class="o">.</span><span class="n">_ModelParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a set of hyperparameters.&quot;&quot;&quot;</span>

    <span class="n">ModelDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;xception&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">Xception</span><span class="p">,</span>
        <span class="s1">&#39;vgg16&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">VGG16</span><span class="p">,</span>
        <span class="s1">&#39;vgg19&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">VGG19</span><span class="p">,</span>
        <span class="s1">&#39;resnet50&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet50</span><span class="p">,</span>
        <span class="s1">&#39;resnet101&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet101</span><span class="p">,</span>
        <span class="s1">&#39;resnet152&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet152</span><span class="p">,</span>
        <span class="s1">&#39;resnet50_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet50V2</span><span class="p">,</span>
        <span class="s1">&#39;resnet101_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet101V2</span><span class="p">,</span>
        <span class="s1">&#39;resnet152_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">ResNet152V2</span><span class="p">,</span>
        <span class="s1">&#39;inception&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">InceptionV3</span><span class="p">,</span>
        <span class="s1">&#39;nasnet_large&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">NASNetLarge</span><span class="p">,</span>
        <span class="s1">&#39;inception_resnet_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">InceptionResNetV2</span><span class="p">,</span>
        <span class="s1">&#39;mobilenet&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">MobileNet</span><span class="p">,</span>
        <span class="s1">&#39;mobilenet_v2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">,</span>
        <span class="s1">&#39;densenet_121&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">DenseNet121</span><span class="p">,</span>
        <span class="s1">&#39;densenet_169&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">DenseNet169</span><span class="p">,</span>
        <span class="s1">&#39;densenet_201&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">DenseNet201</span><span class="p">,</span>
        <span class="c1"># &#39;ResNeXt50&#39;: kapps.ResNeXt50,</span>
        <span class="c1"># &#39;ResNeXt101&#39;: kapps.ResNeXt101,</span>
        <span class="c1"># &#39;NASNet&#39;: kapps.NASNet</span>
    <span class="p">}</span>
    <span class="n">OptDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Adam&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
        <span class="s1">&#39;SGD&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">,</span>
        <span class="s1">&#39;RMSprop&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">,</span>
        <span class="s1">&#39;Adagrad&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">,</span>
        <span class="s1">&#39;Adadelta&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adadelta</span><span class="p">,</span>
        <span class="s1">&#39;Adamax&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adamax</span><span class="p">,</span>
        <span class="s1">&#39;Nadam&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B0&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b0&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B0</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B1&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b1&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B1</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B2&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b2&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B2</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2B3&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2b3&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2B3</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2S&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2s&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2S</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2M&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2m&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2M</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kapps</span><span class="p">,</span> <span class="s1">&#39;EfficientNetV2L&#39;</span><span class="p">):</span>
        <span class="n">ModelDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;efficientnet_v2l&#39;</span><span class="p">:</span> <span class="n">kapps</span><span class="o">.</span><span class="n">EfficientNetV2L</span><span class="p">})</span>
    <span class="n">RegressionLossDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_absolute_percentage_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_squared_logarithmic_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;squared_hinge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hinge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;logcosh&#39;</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">RegressionLossDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span>
    <span class="p">})</span>
    <span class="n">AllLossDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_absolute_percentage_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_squared_logarithmic_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;squared_hinge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hinge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;categorical_hinge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;logcosh&#39;</span><span class="p">,</span>
            <span class="s1">&#39;huber&#39;</span><span class="p">,</span>
            <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kullback_leibler_divergence&#39;</span><span class="p">,</span>
            <span class="s1">&#39;poisson&#39;</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">AllLossDict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;batch_loss_crossentropy&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">batch_loss_crossentropy</span><span class="p">,</span>
        <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span>
    <span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_hidden_layers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">regularizer</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds hidden layer(s) to a model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (tf.keras.Model): Tensorflow model.</span>
<span class="sd">            regularizer (tf.keras.layers.Layer): Regularization for hidden layers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing</span>

<span class="sd">                tf.keras.Model: Model with hidden layers added.</span>

<span class="sd">                tf.keras.layers.Layer: Last linear layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using Batch normalization&quot;</span><span class="p">)</span>
        <span class="n">last_linear</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_width</span><span class="p">,</span>
                                          <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;hidden_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                          <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                                          <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">last_linear</span> <span class="o">=</span> <span class="n">model</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">StaticDropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">last_linear</span>

    <span class="k">def</span> <span class="nf">_get_dense_regularizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return regularizer for dense (hidden) layers.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L2 regularization for dense layers (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 regularization for dense layers (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="si">}</span><span class="s2">) and L2 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="si">}</span><span class="s2">) reg for dense layers&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1_l2</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_dense</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2_dense</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not using regularization for dense layers&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_add_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add non-hidden layer regularization.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (tf.keras.Model): Tensorflow model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Tensorflow model with regularization added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L2 regularization for base model (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 regularization for base model (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using L1 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="si">}</span><span class="s2">) and L2 (weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="si">}</span><span class="s2">) regularization for base model&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1_l2</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not using regularization for base model&quot;</span><span class="p">)</span>
            <span class="n">regularizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">regularizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">add_regularization</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">regularizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_freeze_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Freeze last X layers, where X = self.trainable_layers.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (tf.keras.Model): Tensorflow model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Tensorflow model with frozen layers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">freezeIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainable_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># - self.hp.hidden_layers - 1))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only training on last </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trainable_layers</span><span class="si">}</span><span class="s1"> layers (of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="si">}</span><span class="s1"> total)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="n">freezeIndex</span><span class="p">]:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_get_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a Keras model of the appropriate architecture, input shape,</span>
<span class="sd">        pooling, and initial weights.</span>

<span class="sd">        Args:</span>
<span class="sd">            weights (Optional[str], optional): Pretrained weights to use.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Core model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">model_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="n">input_shape</span><span class="p">,</span>
            <span class="s1">&#39;include_top&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_top</span><span class="p">,</span>
            <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">weights</span>
        <span class="p">}</span>
        <span class="c1"># Only pass kwargs accepted by model function</span>
        <span class="n">model_fn_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_fn</span><span class="p">)</span>
        <span class="n">model_kw</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_fn_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
        <span class="p">]</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">model_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_kw</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_kwargs</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">model_fn</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_base</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;Builds the base image model, from a Keras model core, with the</span>
<span class="sd">        appropriate input tensors and identity layers.</span>

<span class="sd">        Args:</span>
<span class="sd">            pretrain (str, optional): Pretrained weights to load.</span>
<span class="sd">                Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            load_method (str): Either &#39;full&#39; or &#39;weights&#39;. Method to use</span>
<span class="sd">                when loading a Tensorflow model. If &#39;full&#39;, loads the model with</span>
<span class="sd">                ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">                ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">                and then load weights from the given model with</span>
<span class="sd">                ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">                compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">                may improve compatibility across hardware &amp; environments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tf.keras.Model: Base model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">tile_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tile_image&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pretrain</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using pretraining from [magenta]</span><span class="si">{</span><span class="n">pretrain</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pretrain</span> <span class="ow">and</span> <span class="n">pretrain</span> <span class="o">!=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">:</span>
            <span class="n">pretrained_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">pretrain</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">load_method</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This is the tile_image input</span>
                <span class="n">pretrained_input</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tile_image&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">input</span>
                <span class="c1"># Name of the pretrained model core, which should be at layer 1</span>
                <span class="n">pretrained_name</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># This is the post-convolution layer</span>
                <span class="n">pretrained_output</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;post_convolution&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
                <span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">pretrained_input</span><span class="p">,</span>
                                            <span class="n">outputs</span><span class="o">=</span><span class="n">pretrained_output</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;pretrained_</span><span class="si">{</span><span class="n">pretrained_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to automatically read pretrained model, will try legacy format&#39;</span><span class="p">)</span>
                <span class="n">base_model</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_core</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">pretrain</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_top</span><span class="p">:</span>
                <span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                    <span class="n">outputs</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
        <span class="c1"># Add regularization</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_regularization</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>

        <span class="c1"># Allow only a subset of layers in the base model to be trainable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_layers</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_layers</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>

        <span class="c1"># This is an identity layer that simply returns the last layer, allowing us to name and access this layer later</span>
        <span class="n">post_convolution_identity_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;post_convolution&#39;</span><span class="p">)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">tile_input_tensor</span><span class="p">,</span> <span class="n">base_model</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()]</span>
        <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">post_convolution_identity_layer</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uq</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">StaticDropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)]</span>
        <span class="n">tile_image_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tile_image_model</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tile_image_model</span><span class="p">,</span> <span class="n">model_inputs</span>

    <span class="k">def</span> <span class="nf">_build_classification_or_regression_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">num_slide_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">activation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;softmax&#39;</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assembles classification or regression model, using pretraining (imagenet)</span>
<span class="sd">        or the base layers of a supplied model.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_classes (int or dict): Either int (single categorical outcome,</span>
<span class="sd">                indicating number of classes) or dict (dict mapping categorical</span>
<span class="sd">                outcome names to number of unique categories in each outcome).</span>
<span class="sd">            num_slide_features (int): Number of slide-level features separate</span>
<span class="sd">                from image input. Defaults to 0.</span>
<span class="sd">            activation (str): Type of final layer activation to use.</span>
<span class="sd">                Defaults to softmax.</span>
<span class="sd">            pretrain (str): Either &#39;imagenet&#39; or path to model to use as</span>
<span class="sd">                pretraining. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str): Path to checkpoint from which to resume model</span>
<span class="sd">                training. Defaults to None.</span>
<span class="sd">            load_method (str): Either &#39;full&#39; or &#39;weights&#39;. Method to use</span>
<span class="sd">                when loading a Tensorflow model. If &#39;full&#39;, loads the model with</span>
<span class="sd">                ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">                ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">                and then load weights from the given model with</span>
<span class="sd">                ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">                compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">                may improve compatibility across hardware &amp; environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tile_image_model</span><span class="p">,</span> <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_base</span><span class="p">(</span><span class="n">pretrain</span><span class="p">,</span> <span class="n">load_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_slide_features</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model has </span><span class="si">{</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1"> slide input features&#39;</span><span class="p">)</span>
            <span class="n">slide_feature_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_slide_features</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slide_feature_input&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not using any slide-level input features.&#39;</span><span class="p">)</span>

        <span class="c1"># Merge layers</span>
        <span class="k">if</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating model with only slide-level input - no images&#39;</span><span class="p">)</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">slide_feature_input_tensor</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">num_slide_features</span><span class="p">:</span>
            <span class="c1"># Add slide feature input tensors</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_merge&#39;</span><span class="p">)(</span>
                <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">,</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Add hidden layers</span>
        <span class="n">regularizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dense_regularizer</span><span class="p">()</span>
        <span class="n">merged_model</span><span class="p">,</span> <span class="n">last_linear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_hidden_layers</span><span class="p">(</span>
            <span class="n">merged_model</span><span class="p">,</span> <span class="n">regularizer</span>
        <span class="p">)</span>

        <span class="c1"># Multi-categorical outcomes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_classes</span><span class="p">:</span>
                <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                    <span class="n">num_classes</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;logits-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                        <span class="n">activation</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span>
                <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;logits&#39;</span>
            <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                    <span class="n">activation</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span>
                <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="c1"># Assemble final model</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">activation</span><span class="si">}</span><span class="s1"> activation&#39;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
        <span class="c1"># Disable experimental batch loss</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add_loss</span><span class="p">(</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">batch_loss_crossentropy</span><span class="p">(</span><span class="n">last_linear</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading checkpoint weights from [green]</span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_build_survival_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">num_slide_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
        <span class="n">training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assembles a survival model, using pretraining (imagenet)</span>
<span class="sd">        or the base layers of a supplied model.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_classes (int or dict): Either int (single categorical outcome,</span>
<span class="sd">                indicating number of classes) or dict (dict mapping categorical</span>
<span class="sd">                outcome names to number of unique categories in each outcome).</span>
<span class="sd">            num_slide_features (int): Number of slide-level features separate</span>
<span class="sd">                from image input. Defaults to 0.</span>
<span class="sd">            activation (str): Type of final layer activation to use.</span>
<span class="sd">                Defaults to softmax.</span>
<span class="sd">            pretrain (str): Either &#39;imagenet&#39; or path to model to use as</span>
<span class="sd">                pretraining. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str): Path to checkpoint from which to resume model</span>
<span class="sd">                training. Defaults to None.</span>
<span class="sd">            load_method (str): Either &#39;full&#39; or &#39;weights&#39;. Method to use</span>
<span class="sd">                when loading a Tensorflow model. If &#39;full&#39;, loads the model with</span>
<span class="sd">                ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">                ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">                and then load weights from the given model with</span>
<span class="sd">                ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">                compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">                may improve compatibility across hardware &amp; environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
        <span class="n">tile_image_model</span><span class="p">,</span> <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_base</span><span class="p">(</span><span class="n">pretrain</span><span class="p">,</span> <span class="n">load_method</span><span class="p">)</span>

        <span class="c1"># Add slide feature input tensors, if there are more slide features</span>
        <span class="c1"># than just the event input tensor for survival models</span>
        <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
            <span class="n">event_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;event_input&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">num_slide_features</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">slide_feature_input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_slide_features</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slide_feature_input&#39;</span>
            <span class="p">)</span>
        <span class="c1"># Merge layers</span>
        <span class="k">if</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">):</span>
            <span class="c1"># Add images</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating model with only slide-level input - no images&#39;</span><span class="p">)</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">slide_feature_input_tensor</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
                <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">event_input_tensor</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">num_slide_features</span> <span class="ow">and</span> <span class="n">num_slide_features</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Add slide feature input tensors, if there are more slide features</span>
            <span class="c1"># than just the event input tensor for survival models</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_merge&#39;</span><span class="p">)(</span>
                <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">,</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">slide_feature_input_tensor</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
                <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">event_input_tensor</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged_model</span> <span class="o">=</span> <span class="n">tile_image_model</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
                <span class="n">model_inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">event_input_tensor</span><span class="p">]</span>

        <span class="c1"># Add hidden layers</span>
        <span class="n">regularizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dense_regularizer</span><span class="p">()</span>
        <span class="n">merged_model</span><span class="p">,</span> <span class="n">last_linear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_hidden_layers</span><span class="p">(</span>
            <span class="n">merged_model</span><span class="p">,</span> <span class="n">regularizer</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">activation</span><span class="si">}</span><span class="s1"> activation&#39;</span><span class="p">)</span>

        <span class="c1"># Multi-categorical outcomes</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_classes</span><span class="p">:</span>
                <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                    <span class="n">num_classes</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;logits-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                    <span class="n">activation</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_dense_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span>
                <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizer</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;logits&#39;</span>
            <span class="p">)(</span><span class="n">merged_model</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span>
                <span class="n">activation</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span>
            <span class="p">)(</span><span class="n">final_dense_layer</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
            <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_merge_survival&#39;</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span>
            <span class="p">)([</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">event_input_tensor</span><span class="p">])</span>

        <span class="c1"># Assemble final model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading checkpoint weights from [green]</span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-detects model type (classification, regression, survival) from parameters</span>
<span class="sd">        and builds, using pretraining or the base layers of a supplied model.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (dict, optional): Dict mapping slide names to outcomes.</span>
<span class="sd">                Used to detect number of outcome categories.</span>
<span class="sd">            num_classes (int or dict, optional): Either int (single categorical</span>
<span class="sd">                outcome, indicating number of classes) or dict (dict mapping</span>
<span class="sd">                categorical outcome names to number of unique categories in</span>
<span class="sd">                each outcome). Must supply either `num_classes` or `label`</span>
<span class="sd">                (can detect number of classes from labels)</span>
<span class="sd">            num_slide_features (int, optional): Number of slide-level features</span>
<span class="sd">                separate from image input. Defaults to 0.</span>
<span class="sd">            activation (str, optional): Type of final layer activation to use.</span>
<span class="sd">                Defaults to &#39;softmax&#39; (classification models) or &#39;regression&#39;</span>
<span class="sd">                (regression or survival models).</span>
<span class="sd">            pretrain (str, optional): Either &#39;imagenet&#39; or path to model to use</span>
<span class="sd">                as pretraining. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str, optional): Path to checkpoint from which to resume</span>
<span class="sd">                model training. Defaults to None.</span>
<span class="sd">            load_method (str): Either &#39;full&#39; or &#39;weights&#39;. Method to use</span>
<span class="sd">                when loading a Tensorflow model. If &#39;full&#39;, loads the model with</span>
<span class="sd">                ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">                ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">                and then load weights from the given model with</span>
<span class="sd">                ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">                compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">                may improve compatibility across hardware &amp; environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_classes_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_classification_or_regression_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_classification_or_regression_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;survival&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_survival_model</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown model type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">Loss</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns optimizer with appropriate learning rate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">initial_learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span>
            <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">ExponentialDecay</span><span class="p">(</span>
                <span class="n">initial_learning_rate</span><span class="p">,</span>
                <span class="n">decay_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay_steps</span><span class="p">,</span>
                <span class="n">decay_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay</span><span class="p">,</span>
                <span class="n">staircase</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">](</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr_schedule</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">](</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns &#39;regression&#39;, &#39;classification&#39;, or &#39;survival&#39;, reflecting the loss.&quot;&quot;&quot;</span>
        <span class="c1">#check if loss is custom_[type] and returns type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;survival&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RegressionLossDict</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;regression&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;classification&#39;</span>


<span class="k">class</span> <span class="nc">_PredictionAndEvaluationCallback</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prediction and Evaluation Callback used during model training.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;Trainer&quot;</span><span class="p">,</span> <span class="n">cb_args</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_PredictionAndEvaluationCallback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span> <span class="o">=</span> <span class="n">cb_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">=</span> <span class="n">cb_args</span><span class="o">.</span><span class="n">starting_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="p">{}}</span>  <span class="c1"># type: Dict[str, Dict]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">neptune_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_summary_writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">create_file_writer</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_summary_writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">create_file_writer</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">))</span>

        <span class="c1"># Circumvents buffer overflow error with Python 3.10.</span>
        <span class="c1"># Without this, a buffer overflow error will be encountered when</span>
        <span class="c1"># attempting to make a matplotlib figure (with the tkagg backend)</span>
        <span class="c1"># during model evaluation. I have not yet been able to track down</span>
        <span class="c1"># the root cause.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">using_validation</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_log_training_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log training metrics to Tensorboard/Neptune.&quot;&quot;&quot;</span>
        <span class="c1"># Log to Tensorboard.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_summary_writer</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;batch_</span><span class="si">{</span><span class="n">_log</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">logs</span><span class="p">[</span><span class="n">_log</span><span class="p">],</span>
                    <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
        <span class="c1"># Log to neptune.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;metrics/train/batch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/train/batch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_validation_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log validation metrics to Tensorboard/Neptune.&quot;&quot;&quot;</span>
        <span class="c1"># Tensorboard logging for validation metrics</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_summary_writer</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_log</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;batch_</span><span class="si">{</span><span class="n">_log</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="n">_log</span><span class="p">],</span>
                    <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
        <span class="c1"># Log to neptune</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metrics/val/batch/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="nb">round</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;metrics/val/batch/exp_moving_avg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/stopped_early&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_log_epoch_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_results</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log the end-of-epoch evaluation to CSV, Tensorboard, and Neptune.&quot;&quot;&quot;</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span>
        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">results_log</span><span class="p">,</span>
            <span class="s1">&#39;trained_model&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">epoch_results</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_summary_writer</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="c1"># Note: Tensorboard epoch logging starts with index=0,</span>
            <span class="c1"># whereas all other logging starts with index=1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)):</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;epoch_accuracy-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">accuracy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">accuracy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;epoch_accuracy&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loss</span><span class="p">)):</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;epoch_loss-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;epoch_loss&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Log epoch results to Neptune</span>
        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="c1"># Training epoch metrics</span>
            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;metrics/train/epoch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="n">run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/train/epoch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">logs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="c1"># Validation epoch metrics</span>
            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;metrics/val/epoch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="n">run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/val/epoch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">accuracy</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]:</span>
                    <span class="c1"># If only one outcome, log to metrics/val/epoch/[metric].</span>
                    <span class="c1"># If more than one outcome, log to</span>
                    <span class="c1"># metrics/val/epoch/[metric]/[outcome_name]</span>
                    <span class="k">def</span> <span class="nf">metric_label</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;metrics/val/epoch/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;metrics/val/epoch/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">outcome</span><span class="si">}</span><span class="s1">&#39;</span>

                    <span class="n">tile_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>
                    <span class="n">slide_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>
                    <span class="n">patient_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>

                    <span class="c1"># If only one value for a metric, log to .../[metric]</span>
                    <span class="c1"># If more than one value for a metric (e.g. AUC for each</span>
                    <span class="c1"># category), log to .../[metric]/[i]</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="n">run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">),</span>
                        <span class="n">tile_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
                    <span class="p">)</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="n">run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">),</span>
                        <span class="n">slide_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
                    <span class="p">)</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="n">run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;patient&#39;</span><span class="p">),</span>
                        <span class="n">patient_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">epoch</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_metrics_from_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">epoch_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics_from_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validation_data</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">epoch_label</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
            <span class="n">num_tiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">num_val_tiles</span><span class="p">,</span>
            <span class="n">save_predictions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">save_predictions</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">reduce_method</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
            <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\033</span><span class="s1">[K&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="ow">in</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">]</span>
           <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;trained_model&#39;</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">_epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">save_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trained model saved to [green]</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Try to copy model settings/hyperparameters file</span>
                <span class="c1"># into the model folder</span>
                <span class="n">params_dest</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">params_dest</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
                            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
                            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;neptune_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;sys/id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">params_dest</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_path</span><span class="p">),</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">),</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to copy params.json/slide_manifest&#39;</span>
                                    <span class="s1">&#39;.csv files into model folder.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">using_validation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span>

    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Tensorboard logging for training metrics</span>
        <span class="k">if</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">batch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">log_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#with self.train_summary_writer.as_default():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_training_metrics</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>

        <span class="c1"># Check if manual early stopping has been triggered</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span>
           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">):</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_epoch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_epoch</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_batch</span> <span class="o">&lt;=</span> <span class="n">batch</span><span class="p">):</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Manual early stop triggered: epoch &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">, batch </span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span> <span class="o">=</span> <span class="n">batch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Validation metrics</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">using_validation</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validate_on_batch</span>
           <span class="ow">and</span> <span class="p">(</span><span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
           <span class="ow">and</span> <span class="p">(</span><span class="n">batch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validate_on_batch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">eval_from_model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">mid_train_validation_data</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
                <span class="n">uq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
                <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">validation_steps</span><span class="p">,</span>
                <span class="n">verbosity</span><span class="o">=</span><span class="s1">&#39;quiet&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">val_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
            <span class="n">val_log_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
                <span class="n">val_log_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
            <span class="k">elif</span> <span class="n">acc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">val_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;accuracy-</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acc</span><span class="p">))})</span>
                <span class="n">val_log_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acc</span><span class="p">))})</span>

            <span class="n">val_loss</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
               <span class="ow">and</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">val_metrics</span><span class="p">):</span>
                <span class="n">early_stop_value</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
                <span class="n">val_acc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">early_stop_value</span> <span class="o">=</span> <span class="n">val_loss</span>
                <span class="n">val_acc</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val_metrics</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_metrics</span>
                    <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">v</span>
                <span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
                <span class="n">train_acc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">train_acc</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">logs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logs</span>
                    <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">v</span>
                <span class="p">])</span>
            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\033</span><span class="s1">[K&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span> <span class="o">+=</span> <span class="p">[</span><span class="n">early_stop_value</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_validation_metrics</span><span class="p">(</span><span class="n">val_log_metrics</span><span class="p">)</span>
            <span class="c1"># Log training metrics if not already logged this batch</span>
            <span class="k">if</span> <span class="n">batch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">log_frequency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_training_metrics</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>

            <span class="c1"># Base logging message</span>
            <span class="n">batch_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[blue]Batch </span><span class="si">{</span><span class="n">batch</span><span class="si">:</span><span class="s1">&lt;5</span><span class="si">}</span><span class="s1">[/]&#39;</span>
            <span class="n">loss_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[green]loss[/]: </span><span class="si">{</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">val_loss_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[magenta]val_loss[/]: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">acc_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[green]acc[/]: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">val_acc_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[magenta]val_acc[/]: </span><span class="si">{</span><span class="n">val_acc</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">log_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">batch_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">loss_msg</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">acc_msg</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="n">log_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_loss_msg</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">val_acc_msg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">batch_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">loss_msg</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">val_loss_msg</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Calculate exponential moving average of validation accuracy</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">ema_observations</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only keep track of the last [ema_observations] val accuracies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Calculate simple moving average</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">)</span>
                                     <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (SMA: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Update exponential moving average</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">ema_smoothing</span>
                    <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">ema_observations</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="p">((</span><span class="n">early_stop_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">obs</span><span class="p">)))</span>
                                     <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">sm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">obs</span><span class="p">)))))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (EMA: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

            <span class="c1"># If early stopping and our patience criteria has been met,</span>
            <span class="c1">#   check if validation accuracy is still improving</span>
            <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_args</span><span class="o">.</span><span class="n">steps_per_epoch</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
               <span class="ow">and</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps_per_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="p">)</span>
                    <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_patience</span><span class="p">):</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
                          <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span><span class="p">)</span>
                         <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span>
                             <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span><span class="p">))):</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Early stop: epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">, batch &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span> <span class="o">=</span> <span class="n">batch</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># Log early stop to neptune</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/early_stop_epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/early_stop_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/stopped_early&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;sys/tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;early_stopped&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span>

        <span class="c1"># Update global step (for tracking metrics across epochs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\033</span><span class="s1">[K&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;sys/tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;training_complete&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Evaluating model from evaluation callback&quot;</span><span class="p">)</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_count</span>
        <span class="n">metrics</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_from_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;val_epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Note that Keras loss during training includes regularization losses,</span>
        <span class="c1"># so this loss will not match validation loss calculated during training</span>
        <span class="n">val_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Validation metrics: &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;train_metrics&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;val&#39;</span><span class="p">},</span>
            <span class="s1">&#39;val_metrics&#39;</span><span class="p">:</span> <span class="n">val_metrics</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;early_stop_epoch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_epoch</span><span class="p">,</span>
                <span class="s1">&#39;early_stop_batch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop_batch</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;tile_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;slide_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;patient_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span>

        <span class="n">epoch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_epoch_evaluation</span><span class="p">(</span>
            <span class="n">epoch_results</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="n">logs</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base trainer class containing functionality for model building, input</span>
<span class="sd">    processing, training, and evaluation.</span>

<span class="sd">    This base class requires categorical outcome(s). Additional outcome types</span>
<span class="sd">    are supported by :class:`slideflow.model.RegressionTrainer` and</span>
<span class="sd">    :class:`slideflow.model.SurvivalTrainer`.</span>

<span class="sd">    Slide-level (e.g. clinical) features can be used as additional model input</span>
<span class="sd">    by providing slide labels in the slide annotations dictionary, under the</span>
<span class="sd">    key &#39;input&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;classification&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hp</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">slide_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Trainer&#39;</span><span class="p">,</span>
        <span class="n">feature_sizes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">outcome_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_tf32</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_neptune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">neptune_api</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">neptune_workspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
        <span class="n">custom_objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets base configuration, preparing model inputs and outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            hp (:class:`slideflow.ModelParams`): ModelParams object.</span>
<span class="sd">            outdir (str): Path for event logs and checkpoints.</span>
<span class="sd">            labels (dict): Dict mapping slide names to outcome labels (int or</span>
<span class="sd">                float format).</span>
<span class="sd">            slide_input (dict): Dict mapping slide names to additional</span>
<span class="sd">                slide-level input, concatenated after post-conv.</span>
<span class="sd">            name (str, optional): Optional name describing the model, used for</span>
<span class="sd">                model saving. Defaults to &#39;Trainer&#39;.</span>
<span class="sd">            feature_sizes (list, optional): List of sizes of input features.</span>
<span class="sd">                Required if providing additional input features as input to</span>
<span class="sd">                the model.</span>
<span class="sd">            feature_names (list, optional): List of names for input features.</span>
<span class="sd">                Used when permuting feature importance.</span>
<span class="sd">            outcome_names (list, optional): Name of each outcome. Defaults to</span>
<span class="sd">                &quot;Outcome {X}&quot; for each outcome.</span>
<span class="sd">            mixed_precision (bool, optional): Use FP16 mixed precision (rather</span>
<span class="sd">                than FP32). Defaults to True.</span>
<span class="sd">            allow_tf32 (bool): Allow internal use of Tensorfloat-32 format.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            load_method (str): Either &#39;full&#39; or &#39;weights&#39;. Method to use</span>
<span class="sd">                when loading a Tensorflow model. If &#39;full&#39;, loads the model with</span>
<span class="sd">                ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">                ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">                and then load weights from the given model with</span>
<span class="sd">                ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">                compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">                may improve compatibility across hardware &amp; environments.</span>
<span class="sd">            config (dict, optional): Training configuration dictionary, used</span>
<span class="sd">                for logging and image format verification. Defaults to None.</span>
<span class="sd">            use_neptune (bool, optional): Use Neptune API logging.</span>
<span class="sd">                Defaults to False</span>
<span class="sd">            neptune_api (str, optional): Neptune API token, used for logging.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            neptune_workspace (str, optional): Neptune workspace.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            custom_objects (dict, Optional): Dictionary mapping names</span>
<span class="sd">                (strings) to custom classes or functions. Defaults to None.</span>
<span class="sd">            transform (callable or dict, optional): Optional transform to</span>
<span class="sd">                apply to input images. If dict, must have the keys &#39;train&#39;</span>
<span class="sd">                and/or &#39;val&#39;, mapping to callables that takes a single</span>
<span class="sd">                image Tensor as input and returns a single image Tensor.</span>
<span class="sd">                If None, no transform is applied. If a single callable is</span>
<span class="sd">                provided, it will be applied to both training and validation</span>
<span class="sd">                data. If a dict is provided, the &#39;train&#39; transform will be</span>
<span class="sd">                applied to training data and the &#39;val&#39; transform will be</span>
<span class="sd">                applied to validation data. If a dict is provided and either</span>
<span class="sd">                &#39;train&#39; or &#39;val&#39; is None, no transform will be applied to</span>
<span class="sd">                that data. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">load_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized value for load_method, must be &quot;</span>
                             <span class="s2">&quot;either &#39;full&#39; or &#39;weights&#39;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="o">=</span> <span class="n">slide_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_sizes</span> <span class="o">=</span> <span class="n">feature_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_sizes</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_sizes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">mixed_precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tf32</span> <span class="o">=</span> <span class="n">allow_tf32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_callback</span> <span class="o">=</span> <span class="n">_PredictionAndEvaluationCallback</span>  <span class="c1"># type: tf.keras.callbacks.Callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_method</span> <span class="o">=</span> <span class="n">load_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_objects</span> <span class="o">=</span> <span class="n">custom_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># Format outcome labels (ensures compatibility with single</span>
        <span class="c1"># and multi-outcome models)</span>
        <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">outcome_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outcome_names</span><span class="p">:</span>
            <span class="n">outcome_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;Outcome </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="n">outcome_names</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">num_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span>
            <span class="n">num_outcomes</span> <span class="o">=</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Size of outcome_names (</span><span class="si">{</span><span class="n">num_names</span><span class="si">}</span><span class="s1">) != &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;number of outcomes </span><span class="si">{</span><span class="n">num_outcomes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span> <span class="o">=</span> <span class="n">outcome_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inputs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">_detect_classes_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/cpu&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">StaticHashTable</span><span class="p">(</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">KeyValueTensorInitializer</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">,</span>
                            <span class="n">outcome_labels</span><span class="p">[:,</span> <span class="n">oi</span><span class="p">]</span>
                        <span class="p">),</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Normalization setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_normalizer</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using realtime </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">normalizer</span><span class="si">}</span><span class="s1"> normalization&#39;</span><span class="p">)</span>

        <span class="c1"># Mixed precision and Tensorfloat-32</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">:</span>
            <span class="n">_policy</span> <span class="o">=</span> <span class="s1">&#39;mixed_float16&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Enabling mixed precision (</span><span class="si">{</span><span class="n">_policy</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2.8&quot;</span><span class="p">):</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">mixed_precision</span><span class="o">.</span><span class="n">set_global_policy</span><span class="p">(</span><span class="n">_policy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">policy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">mixed_precision</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">Policy</span><span class="p">(</span><span class="n">_policy</span><span class="p">)</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">mixed_precision</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">enable_tensor_float_32_execution</span><span class="p">(</span><span class="n">allow_tf32</span><span class="p">)</span>

        <span class="c1"># Custom transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_transforms</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

        <span class="c1"># Log parameters</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">(),</span>
                <span class="s1">&#39;git_commit&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__gitcommit__</span><span class="p">,</span>
                <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;full_model_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;outcomes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
                <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
                <span class="s1">&#39;img_format&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;tile_px&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="s1">&#39;tile_um&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="s1">&#39;input_features&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;input_feature_labels&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;img_format&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Initialize Neptune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span> <span class="o">=</span> <span class="n">use_neptune</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neptune_api</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">neptune_workspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If using Neptune, must supply values &quot;</span>
                                 <span class="s2">&quot;neptune_api and neptune_workspace.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">NeptuneLog</span><span class="p">(</span>
                <span class="n">neptune_api</span><span class="p">,</span>
                <span class="n">neptune_workspace</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_transforms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process custom transformations for training and/or validation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;transform must be a callable or dict with keys &quot;</span>
                             <span class="s2">&quot;&#39;train&#39; and/or &#39;val&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;val&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

    <span class="k">def</span> <span class="nf">_setup_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup slide-level input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training with both images and &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1"> slide-level input&#39;</span>
                             <span class="s1">&#39;features&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Unable to find slide-level input at &quot;</span>
                                        <span class="s2">&quot;&#39;input&#39; key in annotations&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                    <span class="n">num_in_feature_table</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Length of input for slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1"> does not match &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;feature_sizes; expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1">, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="n">num_in_feature_table</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile keras model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(),</span>
            <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fit_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the Trainer normalizer using the specified fit, if applicable.</span>

<span class="sd">        Args:</span>
<span class="sd">            norm_fit (Optional[Dict[str, np.ndarray]]): Normalizer fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">norm_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_fit supplied, but model params do not&quot;</span>
                             <span class="s2">&quot;specify a normalizer.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="ow">and</span> <span class="n">norm_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">norm_fit</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span>
              <span class="ow">and</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
              <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detecting normalizer fit from model config&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_parse_tfrecord_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses raw entry read from TFRecord.&quot;&quot;&quot;</span>

        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tile_image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">oi</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>

        <span class="c1"># Add additional non-image feature inputs if indicated,</span>
        <span class="c1">#     excluding the event feature used for survival models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">slide_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)]</span>

            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="n">slide_feature_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">slide_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_features</span>
            <span class="p">)</span>
            <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;slide_feature_input&#39;</span><span class="p">:</span> <span class="n">slide_feature_input_val</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_dict</span><span class="p">,</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">_retrain_top_layers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_data</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">steps_per_epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrain only the top layer, leaving all other layers frozen.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retraining top layer&#39;</span><span class="p">)</span>
        <span class="c1"># Freeze the base layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#val_steps = 200 if validation_data else None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">()</span>

        <span class="n">toplayer_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">),</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span>
        <span class="p">)</span>
        <span class="c1"># Unfreeze the base layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">toplayer_model</span><span class="o">.</span><span class="n">history</span>

    <span class="k">def</span> <span class="nf">_detect_patients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dataset_patients</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_patients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dataset_patients</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interleave_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_tfrecord_labels</span><span class="p">,</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interleave_kwargs_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_metric_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
            <span class="n">neptune_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_img_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">datasets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the image format of the dataset matches the model config.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (sf.Dataset): Dataset to check.</span>
<span class="sd">            *datasets (sf.Dataset): Additional datasets to check. May be None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Image format, either &#39;png&#39; or &#39;jpg&#39;, if a consistent image</span>
<span class="sd">                format was found, otherwise None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First, verify all datasets have the same image format</span>
        <span class="n">img_formats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">img_format</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span> <span class="k">if</span> <span class="n">d</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_formats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple image formats detected: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_formats</span><span class="p">)</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to verify image format (PNG/JPG) of dataset.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Mismatched image formats. Expected &#39;</span><span class="si">{}</span><span class="s2">&#39; per model config, &quot;</span>
                <span class="s2">&quot;but dataset has format &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_method</span><span class="p">,</span>
            <span class="n">custom_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_objects</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform inference on a model, saving tile-level predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset containing</span>
<span class="sd">                TFRecords to evaluate.</span>
<span class="sd">            batch_size (int, optional): Evaluation batch size. Defaults to the</span>
<span class="sd">                same as training (per self.hp)</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            format (str, optional): Format in which to save predictions. Either</span>
<span class="sd">                &#39;csv&#39;, &#39;feather&#39;, or &#39;parquet&#39;. Defaults to &#39;parquet&#39;.</span>
<span class="sd">            from_wsi (bool): Generate predictions from tiles dynamically</span>
<span class="sd">                extracted from whole-slide images, rather than TFRecords.</span>
<span class="sd">                Defaults to False (use TFRecords).</span>
<span class="sd">            roi_method (str): ROI method to use if from_wsi=True (ignored if</span>
<span class="sd">                from_wsi=False).  Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, &#39;ignore&#39;.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical</span>
<span class="sd">                outcomes. Options include &#39;average&#39;, &#39;mean&#39;, &#39;proportion&#39;,</span>
<span class="sd">                &#39;median&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, or a callable function.</span>
<span class="sd">                &#39;average&#39; and &#39;mean&#39; are  synonymous, with both options kept</span>
<span class="sd">                for backwards compatibility. If  &#39;average&#39; or &#39;mean&#39;, will</span>
<span class="sd">                reduce with average of each logit across  tiles. If</span>
<span class="sd">                &#39;proportion&#39;, will convert tile predictions into onehot encoding</span>
<span class="sd">                then reduce by averaging these onehot values. For all other</span>
<span class="sd">                values, will reduce with the specified function, applied via</span>
<span class="sd">                the pandas ``DataFrame.agg()`` function. Defaults to &#39;average&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, pd.DataFrame]: Dictionary with keys &#39;tile&#39;, &#39;slide&#39;, and</span>
<span class="sd">            &#39;patient&#39;, and values containing DataFrames with tile-, slide-,</span>
<span class="sd">            and patient-level predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;feather&#39;</span><span class="p">,</span> <span class="s1">&#39;parquet&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized format </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_patients</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Verify image format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_img_format</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Fit normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="c1"># Load and initialize model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelNotLoadedError</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
            <span class="n">interleave_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs_val</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                <span class="n">augment</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">tf_dts_w_slidenames</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
                <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
                <span class="o">**</span><span class="n">interleave_kwargs</span>
            <span class="p">)</span>
        <span class="c1"># Generate predictions</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating predictions...&#39;</span><span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">predict_dataset</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">tf_dts_w_slidenames</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
            <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">),</span>
            <span class="n">num_tiles</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Save predictions</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">save_dfs</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfs</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate model, saving metrics and predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset containing</span>
<span class="sd">                TFRecords to evaluate.</span>
<span class="sd">            batch_size (int, optional): Evaluation batch size. Defaults to the</span>
<span class="sd">                same as training (per self.hp)</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical</span>
<span class="sd">                outcomes. Options include &#39;average&#39;, &#39;mean&#39;, &#39;proportion&#39;,</span>
<span class="sd">                &#39;median&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, or a callable function.</span>
<span class="sd">                &#39;average&#39; and &#39;mean&#39; are  synonymous, with both options kept</span>
<span class="sd">                for backwards compatibility. If  &#39;average&#39; or &#39;mean&#39;, will</span>
<span class="sd">                reduce with average of each logit across  tiles. If</span>
<span class="sd">                &#39;proportion&#39;, will convert tile predictions into onehot encoding</span>
<span class="sd">                then reduce by averaging these onehot values. For all other</span>
<span class="sd">                values, will reduce with the specified function, applied via</span>
<span class="sd">                the pandas ``DataFrame.agg()`` function. Defaults to &#39;average&#39;.</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            uq (bool or str, optional): Enable UQ estimation (for</span>
<span class="sd">                applicable models). Defaults to &#39;auto&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of evaluation metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uq</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uq</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized value </span><span class="si">{</span><span class="n">uq</span><span class="si">}</span><span class="s2"> for uq&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span> <span class="o">=</span> <span class="n">uq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_patients</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Verify image format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_img_format</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Perform evaluation</span>
        <span class="n">_unit_type</span> <span class="o">=</span> <span class="s1">&#39;slides&#39;</span> <span class="k">if</span> <span class="n">from_wsi</span> <span class="k">else</span> <span class="s1">&#39;tfrecords&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">_unit_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Fit normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="c1"># Load and initialize model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelNotLoadedError</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Neptune logging</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">log_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;data/slide_manifest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
            <span class="n">interleave_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs_val</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                <span class="n">augment</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">tf_dts_w_slidenames</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
                <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
                <span class="o">**</span><span class="n">interleave_kwargs</span>
            <span class="p">)</span>
        <span class="c1"># Generate performance metrics</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating performance metrics...&#39;</span><span class="p">)</span>
        <span class="n">metric_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric_kwargs</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">tf_dts_w_slidenames</span><span class="p">,</span>
            <span class="n">num_tiles</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_tiles</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span>
        <span class="p">)</span>
        <span class="n">metrics</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics_from_dataset</span><span class="p">(</span>
            <span class="n">save_predictions</span><span class="o">=</span><span class="n">save_predictions</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
            <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">),</span>
            <span class="o">**</span><span class="n">metric_kwargs</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="p">{}}</span>  <span class="c1"># type: Dict[str, Dict[str, float]]</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tile </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Patient </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="sa">f</span><span class="s1">&#39;tile_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">],</span>
                    <span class="sa">f</span><span class="s1">&#39;slide_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">],</span>
                    <span class="sa">f</span><span class="s1">&#39;patient_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="c1"># Note that Keras loss during training includes regularization losses,</span>
        <span class="c1"># so this loss will not match validation loss calculated during training</span>
        <span class="n">val_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
        <span class="n">results_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Evaluation metrics:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">val_metrics</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">val_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">)</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span><span class="n">results_log</span><span class="p">,</span> <span class="s1">&#39;eval_model&#39;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="c1"># Update neptune log</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;eval/results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_dts</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">val_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">],</span>
        <span class="n">log_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">validate_on_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">validation_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">starting_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ema_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">ema_smoothing</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">use_tensorboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">steps_per_epoch_override</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">resume_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_checkpoints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">multi_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds and trains a model from hyperparameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_dts (:class:`slideflow.Dataset`): Training dataset. Will call</span>
<span class="sd">                the `.tensorflow()` method to retrieve the tf.data.Dataset</span>
<span class="sd">                used for model fitting.</span>
<span class="sd">            val_dts (:class:`slideflow.Dataset`): Validation dataset. Will call</span>
<span class="sd">                the `.tensorflow()` method to retrieve the tf.data.Dataset</span>
<span class="sd">                used for model fitting.</span>
<span class="sd">            log_frequency (int, optional): How frequent to update Tensorboard</span>
<span class="sd">                logs, in batches. Defaults to 100.</span>
<span class="sd">            validate_on_batch (int, optional): Validation will also be performed</span>
<span class="sd">                every N batches. Defaults to 0.</span>
<span class="sd">            validation_batch_size (int, optional): Validation batch size.</span>
<span class="sd">                Defaults to same as training (per self.hp).</span>
<span class="sd">            validation_steps (int, optional): Number of batches to use for each</span>
<span class="sd">                instance of validation. Defaults to 200.</span>
<span class="sd">            starting_epoch (int, optional): Starts training at the specified</span>
<span class="sd">                epoch. Defaults to 0.</span>
<span class="sd">            ema_observations (int, optional): Number of observations over which</span>
<span class="sd">                to perform exponential moving average smoothing. Defaults to 20.</span>
<span class="sd">            ema_smoothing (int, optional): Exponential average smoothing value.</span>
<span class="sd">                Defaults to 2.</span>
<span class="sd">            use_tensoboard (bool, optional): Enable tensorboard callbacks.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            steps_per_epoch_override (int, optional): Manually set the number</span>
<span class="sd">                of steps per epoch. Defaults to 0 (automatic).</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            save_model (bool, optional): Save models when evaluating at</span>
<span class="sd">                specified epochs. Defaults to True.</span>
<span class="sd">            resume_training (str, optional): Path to model to continue training.</span>
<span class="sd">                Only valid in Tensorflow backend. Defaults to None.</span>
<span class="sd">            pretrain (str, optional): Either &#39;imagenet&#39; or path to Tensorflow</span>
<span class="sd">                model from which to load weights. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt from which to load</span>
<span class="sd">                weights. Defaults to None.</span>
<span class="sd">            save_checkpoint (bool, optional): Save checkpoints at each epoch.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            multi_gpu (bool, optional): Enable multi-GPU training using</span>
<span class="sd">                Tensorflow/Keras MirroredStrategy.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical</span>
<span class="sd">                outcomes. Options include &#39;average&#39;, &#39;mean&#39;, &#39;proportion&#39;,</span>
<span class="sd">                &#39;median&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, or a callable function.</span>
<span class="sd">                &#39;average&#39; and &#39;mean&#39; are  synonymous, with both options kept</span>
<span class="sd">                for backwards compatibility. If  &#39;average&#39; or &#39;mean&#39;, will</span>
<span class="sd">                reduce with average of each logit across  tiles. If</span>
<span class="sd">                &#39;proportion&#39;, will convert tile predictions into onehot encoding</span>
<span class="sd">                then reduce by averaging these onehot values. For all other</span>
<span class="sd">                values, will reduce with the specified function, applied via</span>
<span class="sd">                the pandas ``DataFrame.agg()`` function. Defaults to &#39;average&#39;.</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Nested results dict with metrics for each evaluated epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">:</span>
            <span class="n">hp_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incompatible models: </span><span class="si">{</span><span class="n">hp_model</span><span class="si">}</span><span class="s2"> (hp) and &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="si">}</span><span class="s2"> (model)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_patients</span><span class="p">(</span><span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span><span class="p">)</span>

        <span class="c1"># Verify image format across datasets.</span>
        <span class="n">img_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_img_format</span><span class="p">(</span><span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_format</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_format</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>

        <span class="c1"># Clear prior Tensorflow graph to free memory</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
        <span class="n">results_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Fit the normalizer to the training data and log the source mean/stddev</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">normalizer_source</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                    <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">get_fit</span><span class="p">(</span><span class="n">as_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

        <span class="c1"># Prepare multiprocessing pool if from_wsi=True</span>
        <span class="k">if</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Save training / validation manifest</span>
        <span class="k">if</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">val_paths</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val_paths</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="n">train_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">val_paths</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Neptune logging</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;k-fold&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]:</span>
                <span class="n">tags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;k-fold</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;k_fold_i&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
                <span class="n">train_dts</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="n">tags</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">log_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;data/slide_manifest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set up multi-GPU strategy</span>
        <span class="k">if</span> <span class="n">multi_gpu</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Multi-GPU training with &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span><span class="si">}</span><span class="s1"> devices&#39;</span><span class="p">)</span>
            <span class="c1"># Fixes &quot;OSError: [Errno 9] Bad file descriptor&quot; after training</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">_extended</span><span class="o">.</span><span class="n">_collective_ops</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">()</span> <span class="k">if</span> <span class="n">strategy</span> <span class="k">else</span> <span class="n">no_scope</span><span class="p">():</span>
            <span class="c1"># Build model from ModelParams</span>
            <span class="k">if</span> <span class="n">resume_training</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">resume_training</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                    <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">,</span>
                    <span class="n">pretrain</span><span class="o">=</span><span class="n">pretrain</span><span class="p">,</span>
                    <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
                    <span class="n">load_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_method</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
                <span class="n">tf_utils</span><span class="o">.</span><span class="n">log_summary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
                <span class="n">t_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs</span><span class="p">(</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">infinite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">augment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">augment</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span>
                    <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
                    <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span>
                    <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span>
                <span class="p">)</span>
                <span class="n">train_data</span> <span class="o">=</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">t_kwargs</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training: </span><span class="si">{</span><span class="n">train_dts</span><span class="o">.</span><span class="n">num_tiles</span><span class="si">}</span><span class="s2"> total tiles.&quot;</span><span class="p">)</span>

            <span class="c1"># Set up validation data</span>
            <span class="n">using_validation</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_dts</span>
                                <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">from_wsi</span>
                                     <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">())))</span>
            <span class="k">if</span> <span class="n">using_validation</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_batch_size</span><span class="p">:</span>
                        <span class="n">validation_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
                    <span class="n">v_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_kwargs_val</span><span class="p">(</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">validation_batch_size</span><span class="p">,</span>
                        <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                        <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
                        <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span>
                        <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span>
                    <span class="p">)</span>
                    <span class="n">validation_data</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                        <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">v_kwargs</span>
                    <span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation: </span><span class="si">{</span><span class="n">val_dts</span><span class="o">.</span><span class="n">num_tiles</span><span class="si">}</span><span class="s2"> total tiles.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validate_on_batch</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: every &#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">validate_on_batch</span><span class="si">}</span><span class="s1"> steps and at epoch end&#39;</span><span class="p">)</span>
                    <span class="n">mid_v_kwargs</span> <span class="o">=</span> <span class="n">v_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">mid_v_kwargs</span><span class="p">[</span><span class="s1">&#39;infinite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">mid_train_validation_data</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">tensorflow</span><span class="p">(</span>
                        <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">mid_v_kwargs</span>
                    <span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: at epoch end&#39;</span><span class="p">)</span>
                    <span class="n">mid_train_validation_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">validation_steps</span><span class="p">:</span>
                    <span class="n">num_samples</span> <span class="o">=</span> <span class="n">validation_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">validation_steps</span><span class="si">}</span><span class="s1"> batches (</span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39; samples) each validation check&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using entire validation set each val check&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: None&#39;</span><span class="p">)</span>
                <span class="n">validation_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">mid_train_validation_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">validation_steps</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Calculate parameters</span>
            <span class="k">if</span> <span class="n">from_wsi</span><span class="p">:</span>
                <span class="n">train_tiles</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">est_num_tiles</span>
                <span class="n">val_tiles</span> <span class="o">=</span> <span class="n">validation_data</span><span class="o">.</span><span class="n">est_num_tiles</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">train_tiles</span> <span class="o">=</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">num_tiles</span>
                <span class="n">val_tiles</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">num_tiles</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">starting_epoch</span><span class="p">:</span>
                <span class="n">max_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting epoch (</span><span class="si">{</span><span class="n">starting_epoch</span><span class="si">}</span><span class="s1">) cannot be greater&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39; than max target epoch (</span><span class="si">{</span><span class="n">max_epoch</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span> <span class="o">!=</span> <span class="s1">&#39;classification&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to use &#39;accuracy&#39; early stopping with model &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">starting_epoch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting training at epoch </span><span class="si">{</span><span class="n">starting_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps_per_epoch_override</span><span class="p">:</span>
                <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">steps_per_epoch_override</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">train_tiles</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

            <span class="n">cb_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
                <span class="n">starting_epoch</span><span class="o">=</span><span class="n">starting_epoch</span><span class="p">,</span>
                <span class="n">using_validation</span><span class="o">=</span><span class="n">using_validation</span><span class="p">,</span>
                <span class="n">validate_on_batch</span><span class="o">=</span><span class="n">validate_on_batch</span><span class="p">,</span>
                <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">,</span>
                <span class="n">ema_observations</span><span class="o">=</span><span class="n">ema_observations</span><span class="p">,</span>
                <span class="n">ema_smoothing</span><span class="o">=</span><span class="n">ema_smoothing</span><span class="p">,</span>
                <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_data</span><span class="p">,</span>
                <span class="n">mid_train_validation_data</span><span class="o">=</span><span class="n">mid_train_validation_data</span><span class="p">,</span>
                <span class="n">num_val_tiles</span><span class="o">=</span><span class="n">val_tiles</span><span class="p">,</span>
                <span class="n">save_predictions</span><span class="o">=</span><span class="n">save_predictions</span><span class="p">,</span>
                <span class="n">save_model</span><span class="o">=</span><span class="n">save_model</span><span class="p">,</span>
                <span class="n">results_log</span><span class="o">=</span><span class="n">results_log</span><span class="p">,</span>
                <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span><span class="p">,</span>
                <span class="n">log_frequency</span><span class="o">=</span><span class="n">log_frequency</span>
            <span class="p">)</span>

            <span class="c1"># Create callbacks for early stopping, checkpoint saving,</span>
            <span class="c1"># summaries, and history</span>
            <span class="n">val_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_args</span><span class="p">)</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">History</span><span class="p">(),</span> <span class="n">val_callback</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">save_checkpoints</span><span class="p">:</span>
                <span class="n">cp_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;cp.ckpt&#39;</span><span class="p">),</span>
                    <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cp_callback</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">use_tensorboard</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Logging with Tensorboard to </span><span class="si">{}</span><span class="s2"> every </span><span class="si">{}</span><span class="s2"> batches.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">log_frequency</span>
                    <span class="p">))</span>
                <span class="n">tensorboard_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TensorBoard</span><span class="p">(</span>
                    <span class="n">log_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                    <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">write_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">update_freq</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span>
                <span class="p">)</span>
                <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tensorboard_callback</span><span class="p">]</span>

            <span class="c1"># Retrain top layer only, if using transfer learning and</span>
            <span class="c1"># not resuming training</span>
            <span class="n">total_epochs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span>
                            <span class="o">+</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span> <span class="o">-</span> <span class="n">starting_epoch</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retrain_top_layers</span><span class="p">(</span>
                    <span class="n">train_data</span><span class="p">,</span>
                    <span class="n">steps_per_epoch</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_model</span><span class="p">()</span>

            <span class="c1"># Train the model</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beginning training&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">train_data</span><span class="p">,</span>
                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">),</span>
                    <span class="n">initial_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">toplayer_epochs</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ResourceExhaustedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training failed for [bold]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/]. &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">val_callback</span><span class="o">.</span><span class="n">results</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="c1"># Cleanup</span>
            <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">mid_train_validation_data</span>

            <span class="k">return</span> <span class="n">results</span>


<span class="k">class</span> <span class="nc">RegressionTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extends the base :class:`slideflow.model.Trainer` class to add support</span>
<span class="sd">    for regression models with continuous outcomes. Requires that all outcomes be continuous,</span>
<span class="sd">    with appropriate regression loss function. Uses R-squared as the evaluation</span>
<span class="sd">    metric, rather than AUROC.&quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;regression&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(),</span>
                           <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(),</span>
                           <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">_parse_tfrecord_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tile_image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="p">]</span>

        <span class="c1"># Add additional non-image feature inputs if indicated,</span>
        <span class="c1">#     excluding the event feature used for survival models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">slide_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)]</span>

            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="n">slide_feature_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">slide_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_features</span>
            <span class="p">)</span>
            <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;slide_feature_input&#39;</span><span class="p">:</span> <span class="n">slide_feature_input_val</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_dict</span><span class="p">,</span> <span class="n">label</span>


<span class="k">class</span> <span class="nc">SurvivalTrainer</span><span class="p">(</span><span class="n">RegressionTrainer</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cox Proportional Hazards model. Requires that the user provide event</span>
<span class="sd">    data as the first input feature, and time to outcome as the continuous outcome.</span>
<span class="sd">    Uses concordance index as the evaluation metric.&quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;survival&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s1">&#39;Model error - survival models must &#39;</span>
                                    <span class="s1">&#39;include event input&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Setup slide-level input</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_features</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training with both images and </span><span class="si">{</span><span class="n">num_features</span><span class="si">}</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;categories of slide-level input&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Interpreting first feature as event for survival model&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training with images alone. Interpreting first &#39;</span>
                         <span class="s1">&#39;feature as event for survival model&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Unable to find slide-level input at &quot;</span>
                                    <span class="s2">&quot;&#39;input&#39; key in annotations&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                <span class="n">num_in_feature_table</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">slide</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Length of input for slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1"> does not match &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;feature_sizes; expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="si">}</span><span class="s1">, got &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_in_feature_table</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">custom_objects</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;negative_log_likelihood&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">,</span>
                <span class="s1">&#39;concordance_index&#39;</span><span class="p">:</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">concordance_index</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="n">loss</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">concordance_index</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(),</span>
                           <span class="n">loss</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">,</span>
                           <span class="n">metrics</span><span class="o">=</span><span class="n">tf_utils</span><span class="o">.</span><span class="n">concordance_index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_tfrecord_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">slide</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tile_image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations_tables</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="p">]</span>

        <span class="c1"># Add additional non-image feature inputs if indicated,</span>
        <span class="c1">#     excluding the event feature used for survival models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="c1"># Time-to-event data must be added as a separate feature</span>

            <span class="k">def</span> <span class="nf">slide_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">def</span> <span class="nf">event_lookup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">event_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">event_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;event_input&#39;</span><span class="p">:</span> <span class="n">event_input_val</span><span class="p">})</span>
            <span class="n">slide_feature_input_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">slide_lookup</span><span class="p">,</span>
                <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span>
                <span class="n">Tout</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_features</span>
            <span class="p">)</span>
            <span class="c1"># Add slide input features, excluding the event feature</span>
            <span class="c1"># used for survival models</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">image_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;slide_feature_input&#39;</span><span class="p">:</span> <span class="n">slide_feature_input_val</span><span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">image_dict</span><span class="p">,</span> <span class="n">label</span>


<span class="k">class</span> <span class="nc">Features</span><span class="p">(</span><span class="n">BaseFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for obtaining predictions and features from intermediate layer</span>
<span class="sd">    activations from Slideflow models.</span>

<span class="sd">    Use by calling on either a batch of images (returning outputs for a single</span>
<span class="sd">    batch), or by calling on a :class:`slideflow.WSI` object, which will</span>
<span class="sd">    generate an array of spatially-mapped activations matching the slide.</span>

<span class="sd">    Examples</span>
<span class="sd">        *Calling on batch of images:*</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            interface = Features(&#39;/model/path&#39;, layers=&#39;postconv&#39;)</span>
<span class="sd">            for image_batch in train_data:</span>
<span class="sd">                # Return shape: (batch_size, num_features)</span>
<span class="sd">                batch_features = interface(image_batch)</span>

<span class="sd">        *Calling on a slide:*</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            slide = sf.WSI(...)</span>
<span class="sd">            interface = Features(&#39;/model/path&#39;, layers=&#39;postconv&#39;)</span>
<span class="sd">            # Returns shape:</span>
<span class="sd">            # (slide.grid.shape[0], slide.grid.shape[1], num_features)</span>
<span class="sd">            activations_grid = interface(slide)</span>

<span class="sd">    Note:</span>
<span class="sd">        When this interface is called on a batch of images, no image processing</span>
<span class="sd">        or stain normalization will be performed, as it is assumed that</span>
<span class="sd">        normalization will occur during data loader image processing. When the</span>
<span class="sd">        interface is called on a `slideflow.WSI`, the normalization strategy</span>
<span class="sd">        will be read from the model configuration file, and normalization will</span>
<span class="sd">        be performed on image tiles extracted from the WSI. If this interface</span>
<span class="sd">        was created from an existing model and there is no model configuration</span>
<span class="sd">        file to read, a slideflow.norm.StainNormalizer object may be passed</span>
<span class="sd">        during initialization via the argument `wsi_normalizer`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="n">include_preds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a features interface from a saved slideflow model which</span>
<span class="sd">        outputs feature activations at the designated layers.</span>

<span class="sd">        Intermediate layers are returned in the order of layers.</span>
<span class="sd">        predictions are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to saved Slideflow model.</span>
<span class="sd">            layers (list(str), optional): Layers from which to generate</span>
<span class="sd">                activations.  The post-convolution activation layer is accessed</span>
<span class="sd">                via &#39;postconv&#39;. Defaults to &#39;postconv&#39;.</span>
<span class="sd">            include_preds (bool, optional): Include predictions in output. Will be</span>
<span class="sd">                returned last. Defaults to False.</span>
<span class="sd">            load_method (str): Either &#39;full&#39; or &#39;weights&#39;. Method to use</span>
<span class="sd">                when loading a Tensorflow model. If &#39;full&#39;, loads the model with</span>
<span class="sd">                ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">                ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">                and then load weights from the given model with</span>
<span class="sd">                ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">                compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">                may improve compatibility across hardware &amp; environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="n">include_preds</span><span class="o">=</span><span class="n">include_preds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">layers</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_preds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">load_method</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;img_format&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">ModelParams</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_normalizer</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;norm_fit found in model config file, but model &#39;</span>
                             <span class="s1">&#39;params does not use a normalizer. Ignoring.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span>
                <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">include_preds</span><span class="o">=</span><span class="n">include_preds</span><span class="p">,</span> <span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="n">include_preds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wsi_normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a features interface from a loaded slideflow model which</span>
<span class="sd">        outputs feature activations at the designated layers.</span>

<span class="sd">        Intermediate layers are returned in the order of layers.</span>
<span class="sd">        predictions are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (:class:`tensorflow.keras.models.Model`): Loaded model.</span>
<span class="sd">            layers (list(str), optional): Layers from which to generate</span>
<span class="sd">                activations.  The post-convolution activation layer is accessed</span>
<span class="sd">                via &#39;postconv&#39;. Defaults to &#39;postconv&#39;.</span>
<span class="sd">            include_preds (bool, optional): Include predictions in output. Will be</span>
<span class="sd">                returned last. Defaults to False.</span>
<span class="sd">            wsi_normalizer (:class:`slideflow.norm.StainNormalizer`): Stain</span>
<span class="sd">                normalizer to use on whole-slide images. Not used on</span>
<span class="sd">                individual tile datasets via __call__. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">include_preds</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> is not a valid Tensorflow &quot;</span>
                                    <span class="s2">&quot;model.&quot;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">include_preds</span><span class="o">=</span><span class="n">include_preds</span><span class="p">,</span> <span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="n">wsi_normalizer</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    path=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    layers=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    include_preds=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_include_preds</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    pooling=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a given input and return features and/or predictions.</span>
<span class="sd">        Expects either a batch of images or a :class:`slideflow.WSI`.</span>

<span class="sd">        When calling on a `WSI` object, keyword arguments are passed to</span>
<span class="sd">        :meth:`slideflow.WSI.build_generator()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_slide</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_slide</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;sf.norm.StainNormalizer&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate activations from slide =&gt; activation grid array.&quot;&quot;&quot;</span>

        <span class="c1"># Check image format</span>
        <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Unable to auto-detect image format (png or jpg). Set the &#39;</span>
                <span class="s1">&#39;format by passing img_format=... to the call function.&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">img_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span>

        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extractors</span><span class="o">.</span><span class="n">features_from_slide</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">slide</span><span class="p">,</span>
            <span class="n">img_format</span><span class="o">=</span><span class="n">img_format</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="p">(</span><span class="n">normalizer</span> <span class="k">if</span> <span class="n">normalizer</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="p">),</span>
            <span class="n">normalizer_source</span><span class="o">=</span><span class="n">normalizer_source</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return activations for a single batch of images.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="k">else</span> <span class="n">no_scope</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
        <span class="n">include_preds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the interface model that outputs feature activations at the</span>
<span class="sd">        designated layers and/or predictions. Intermediate layers are returned in</span>
<span class="sd">        the order of layers. predictions are returned last.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span> <span class="o">=</span> <span class="n">pooling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_preds</span> <span class="o">=</span> <span class="n">include_preds</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pooling</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pooling</span> <span class="o">==</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span>
                <span class="n">pooling</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span>
            <span class="k">elif</span> <span class="n">pooling</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                <span class="n">pooling</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPool2D</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized pooling value </span><span class="si">{</span><span class="n">pooling</span><span class="si">}</span><span class="s2">. &quot;</span>
                                 <span class="s2">&quot;Expected &#39;avg&#39;, &#39;max&#39;, or Keras layer.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">layers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;postconv&#39;</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                <span class="n">layers</span><span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;postconv&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;post_convolution&#39;</span>  <span class="c1"># type: ignore</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up interface to return activations from layers &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">pool_if_3d</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pooling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pooling</span><span class="p">()(</span><span class="n">tensor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tensor</span>

        <span class="c1"># Find the desired layers</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">outer_layer_outputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">core_layer_outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inner_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">la</span> <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">layers</span> <span class="k">if</span> <span class="n">la</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outer_layer_outputs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inner_layers</span><span class="p">:</span>
            <span class="n">intermediate_core</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">pool_if_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">il</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="n">inner_layers</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inner_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">int_out</span> <span class="o">=</span> <span class="n">intermediate_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">la</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inner_layers</span><span class="p">):</span>
                    <span class="n">core_layer_outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_out</span><span class="p">[</span><span class="n">la</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">inner_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">intermediate_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">outer_layer_outputs</span><span class="p">:</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer_layer_outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">core_layer_outputs</span><span class="p">:</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">core_layer_outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>

        <span class="c1"># Build a model that outputs the given layers</span>
        <span class="n">outputs_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">layers</span> <span class="k">else</span> <span class="p">[</span><span class="n">outputs</span><span class="p">[</span><span class="n">la</span><span class="p">]</span> <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_preds</span><span class="p">:</span>
            <span class="n">outputs_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">outputs_list</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">outputs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">include_preds</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Multi-categorical outcomes is experimental &quot;</span>
                        <span class="s2">&quot;for this interface.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">include_preds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">include_preds</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of classes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of activation features: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;slideflow.model.tensorflow.Features&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span>
                <span class="s1">&#39;include_preds&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_preds</span><span class="p">,</span>
                <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="k">class</span> <span class="nc">UncertaintyInterface</span><span class="p">(</span><span class="n">Features</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">include_preds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">load_method</span><span class="o">=</span><span class="n">load_method</span><span class="p">,</span>
            <span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span>
        <span class="p">)</span>
        <span class="c1"># TODO: As the below to-do suggests, this should be updated</span>
        <span class="c1"># for multi-class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_uncertainty</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;UncertaintyInterface not yet implemented for multi-class&quot;</span>
                     <span class="s2">&quot; models&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wsi_normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> is not a valid Tensorflow &quot;</span>
                                    <span class="s2">&quot;model.&quot;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">include_preds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="n">wsi_normalizer</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    path=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    layers=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    pooling=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return activations (mean), predictions (mean), and uncertainty</span>
<span class="sd">        (stdev) for a single batch of images.&quot;&quot;&quot;</span>

        <span class="n">out_drop</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">):</span>
                <span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">yp</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">yp</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">):</span>
            <span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># TODO: Only takes STDEV from first outcome category which works for</span>
        <span class="c1"># outcomes with 2 categories, but a better solution is needed</span>
        <span class="c1"># for num_categories &gt; 2</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">out_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="p">[</span><span class="n">predictions</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">uncertainty</span>

    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;slideflow.model.tensorflow.UncertaintyInterface&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span>
                <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span>
            <span class="p">}</span>
        <span class="p">}</span>

<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../../../model_tensorflow/#slideflow.model.tensorflow.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
    <span class="n">custom_objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a model trained with Slideflow.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to saved model. Must be a model trained in Slideflow.</span>
<span class="sd">        method (str): Method to use when loading the model; either &#39;full&#39; or</span>
<span class="sd">            &#39;weights&#39;. If &#39;full&#39;, will load the saved model with</span>
<span class="sd">            ``tf.keras.models.load_model()``. If &#39;weights&#39;, will read the</span>
<span class="sd">            ``params.json`` configuration file, build the model architecture,</span>
<span class="sd">            and then load weights from the given model with</span>
<span class="sd">            ``Model.load_weights()``. Loading with &#39;full&#39; may improve</span>
<span class="sd">            compatibility across Slideflow versions. Loading with &#39;weights&#39;</span>
<span class="sd">            may improve compatibility across hardware &amp; environments.</span>
<span class="sd">        custom_objects (dict, Optional): Dictionary mapping names</span>
<span class="sd">            (strings) to custom classes or functions. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tf.keras.models.Model: Loaded model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, expected &quot;</span>
                         <span class="s2">&quot;either &#39;full&#39; or &#39;weights&#39;&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading model with method=&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_classes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">outcome</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">]</span>
            <span class="p">}</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;survival&#39;</span><span class="p">:</span>
            <span class="n">survival_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">survival_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
            <span class="n">num_slide_features</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">]),</span>
            <span class="n">pretrain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">survival_kw</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;variables/variables&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">model</span></div>
</pre></div>

             </article>

            </div>
            <footer>




    <hr>



  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, James M Dolezal.

    </p>
  </div>

      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>


</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">

            </div>
          </div>
        </div>
      </section>
    </div>







       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/sphinx_highlight.js"></script>



  <script type="text/javascript" src="../../../../_static/js/vendor/jquery-3.6.3.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>