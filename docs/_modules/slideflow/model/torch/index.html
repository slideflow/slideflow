


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>slideflow.model.torch &mdash; slideflow 3.0.0 documentation</title>















  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../search/" />




  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-Light.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexSans/IBMPlexSans-MediumItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <script defer data-domain="slideflow.dev" src="https://plausible.io/js/script.js"></script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">





    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">





                <div class="version">
                  3.0
                </div>









<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search/" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


          </div>







              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview/">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../project_setup/">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datasets_and_val/">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slide_processing/">Slide Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../training/">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../evaluation/">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../posthoc/">Layer Activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../uq/">Uncertainty Quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features/">Generating Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mil/">Multiple-Instance Learning (MIL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ssl/">Self-Supervised Learning (SSL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stylegan/">Generative Networks (GANs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../saliency/">Saliency Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../segmentation/">Tissue Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cellseg/">Cell Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../custom_loops/">Custom Training Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../studio/">Slideflow Studio: Live Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tfrecords/">TFRecords: Reading and Writing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataloaders/">Dataloaders: Sampling and Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../custom_extractors/">Custom Feature Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tile_labels/">Strong Supervision with Tile Labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/">Creating a Slideflow Plugin</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../slideflow/">slideflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../project/">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataset/">slideflow.Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataset_features/">slideflow.DatasetFeatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heatmap/">slideflow.Heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_params/">slideflow.ModelParams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mosaic/">slideflow.Mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slidemap/">slideflow.SlideMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../biscuit/">slideflow.biscuit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slideflow_cellseg/">slideflow.cellseg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io_tensorflow/">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io_torch/">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gan/">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../grad/">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mil_module/">slideflow.mil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model/">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_tensorflow/">slideflow.model.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_torch/">slideflow.model.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../norm/">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../simclr/">slideflow.simclr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slide/">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../slide_qc/">slideflow.slide.qc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../stats/">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../util/">slideflow.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../studio_module/">slideflow.studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial1/">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial2/">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial3/">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial4/">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial5/">Tutorial 5: Creating a mosaic map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial6/">Tutorial 6: Custom slide filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial7/">Tutorial 7: Training with custom augmentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial8/">Tutorial 8: Multiple-Instance Learning</a></li>
</ul>



        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">

      <li>
        <a href="../../../../">

            Docs

        </a> &gt;
      </li>


          <li><a href="../../../">Module code</a> &gt;</li>

          <li><a href="../">slideflow.model</a> &gt;</li>

      <li>slideflow.model.torch</li>


      <li class="pytorch-breadcrumbs-aside">

      </li>

  </ul>


</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">



          <div class="rst-content">

            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">

  <h1>Source code for slideflow.model.torch</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;PyTorch backend for the slideflow.model submodule.&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>

<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">torch.nn.functional</span> <span class="kn">import</span> <span class="n">softmax</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">rich.progress</span> <span class="kn">import</span> <span class="n">Progress</span><span class="p">,</span> <span class="n">TimeElapsedColumn</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_float_dtype</span><span class="p">,</span> <span class="n">is_integer_dtype</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span><span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span>
                    <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">import</span> <span class="nn">slideflow.util.neptune_utils</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">_base</span>
<span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">torch_utils</span>
<span class="kn">from</span> <span class="nn">slideflow.model.torch_utils</span> <span class="kn">import</span> <span class="n">autocast</span>
<span class="kn">from</span> <span class="nn">slideflow.model.base</span> <span class="kn">import</span> <span class="n">log_manifest</span><span class="p">,</span> <span class="n">BaseFeatureExtractor</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">NormFit</span><span class="p">,</span> <span class="n">ImgBatchSpeedColumn</span><span class="p">,</span> <span class="n">no_scope</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">slideflow.norm</span> <span class="kn">import</span> <span class="n">StainNormalizer</span>


<span class="k">class</span> <span class="nc">LinearBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Block module that includes a linear layer -&gt; ReLU -&gt; BatchNorm&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">in_ftrs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">out_ftrs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_ftrs</span> <span class="o">=</span> <span class="n">in_ftrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_ftrs</span> <span class="o">=</span> <span class="n">out_ftrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_ftrs</span><span class="p">,</span> <span class="n">out_ftrs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">out_ftrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dropout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="k">class</span> <span class="nc">ModelWrapper</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Wrapper for PyTorch modules to support multiple outcomes, clinical</span>
<span class="sd">    (patient-level) inputs, and additional hidden layers.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">num_slide_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">hidden_layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">drop_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_top</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span> <span class="o">=</span> <span class="n">drop_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">=</span> <span class="n">num_slide_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_hidden_layers</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">hidden_layers</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">hidden_layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_aux</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model class name: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_images</span><span class="p">:</span>
            <span class="c1"># Check for auxillary classifier</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Inception3&#39;</span><span class="p">,):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Auxillary classifier detected&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_aux</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Get the last linear layer prior to the logits layer</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Xception&#39;</span><span class="p">,</span> <span class="s1">&#39;NASNetALarge&#39;</span><span class="p">):</span>
                <span class="n">num_ftrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">last_linear</span><span class="o">.</span><span class="n">in_features</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">last_linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SqueezeNet&#39;</span><span class="p">):</span>
                <span class="n">num_ftrs</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;classifier&#39;</span><span class="p">):</span>
                <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">named_children</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
                    <span class="c1"># VGG, AlexNet</span>
                    <span class="k">if</span> <span class="n">include_top</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Including existing fully-connected &quot;</span>
                                  <span class="s2">&quot;top classifier layers&quot;</span><span class="p">)</span>
                        <span class="n">last_linear_name</span><span class="p">,</span> <span class="n">last_linear</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">num_ftrs</span> <span class="o">=</span> <span class="n">last_linear</span><span class="o">.</span><span class="n">in_features</span>
                        <span class="nb">setattr</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span>
                            <span class="n">last_linear_name</span><span class="p">,</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;AlexNet&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;MobileNetV2&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;MNASNet&#39;</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing fully-connected classifier layers&quot;</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">first_classifier</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">num_ftrs</span> <span class="o">=</span> <span class="n">first_classifier</span><span class="o">.</span><span class="n">in_features</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;VGG&#39;</span><span class="p">,</span> <span class="s1">&#39;MobileNetV3&#39;</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing fully-connected classifier layers&quot;</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">first_classifier</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">num_ftrs</span> <span class="o">=</span> <span class="n">first_classifier</span><span class="o">.</span><span class="n">in_features</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_ftrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">in_features</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;fc&#39;</span><span class="p">):</span>
                <span class="n">num_ftrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">in_features</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;out_features&#39;</span><span class="p">):</span>
                <span class="n">num_ftrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">out_features</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">):</span>
                <span class="n">num_ftrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">out_features</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Unable to find last linear layer for &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;model </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_ftrs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Add slide-level features</span>
        <span class="n">num_ftrs</span> <span class="o">+=</span> <span class="n">num_slide_features</span>

        <span class="c1"># Add hidden layers</span>
        <span class="k">if</span> <span class="n">hidden_layers</span><span class="p">:</span>
            <span class="n">hl_ftrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_ftrs</span><span class="p">]</span> <span class="o">+</span> <span class="n">hidden_layers</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_layers</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">LinearBlock</span><span class="p">(</span><span class="n">hl_ftrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                   <span class="n">hl_ftrs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">))</span>
            <span class="n">num_ftrs</span> <span class="o">=</span> <span class="n">hidden_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Add the outcome/logits layers for each outcome, if multiple outcomes</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;fc</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_ftrs</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">slide_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">slide_features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected 2 inputs, got 1&quot;</span><span class="p">)</span>

        <span class="c1"># Last linear of core convolutional model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># Discard auxillary classifier</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_aux</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">logits</span>

        <span class="c1"># Merging image data with any slide-level input data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">slide_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">slide_features</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">slide_features</span>

        <span class="c1"># Hidden layers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hidden_layers</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hidden_layers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_hidden_layers</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Return a list of outputs if we have multiple outcomes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;fc</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span><span class="p">)]</span>

        <span class="c1"># Otherwise, return the single output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>  <span class="c1"># , x</span>


<div class="viewcode-block" id="ModelParams"><a class="viewcode-back" href="../../../../model_params/#slideflow.model.ModelParams">[docs]</a><span class="k">class</span> <span class="nc">ModelParams</span><span class="p">(</span><span class="n">_base</span><span class="o">.</span><span class="n">_ModelParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a set of hyperparameters.&quot;&quot;&quot;</span>

    <span class="n">ModelDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;resnet18&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet18</span><span class="p">,</span>
        <span class="s1">&#39;resnet50&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">,</span>
        <span class="s1">&#39;alexnet&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">alexnet</span><span class="p">,</span>
        <span class="s1">&#39;squeezenet&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">squeezenet</span><span class="o">.</span><span class="n">squeezenet1_1</span><span class="p">,</span>
        <span class="s1">&#39;densenet&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">densenet161</span><span class="p">,</span>
        <span class="s1">&#39;inception&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">inception_v3</span><span class="p">,</span>
        <span class="s1">&#39;googlenet&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">googlenet</span><span class="p">,</span>
        <span class="s1">&#39;shufflenet&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">shufflenet_v2_x1_0</span><span class="p">,</span>
        <span class="s1">&#39;resnext50_32x4d&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnext50_32x4d</span><span class="p">,</span>
        <span class="s1">&#39;vgg16&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">vgg16</span><span class="p">,</span>  <span class="c1"># needs support added</span>
        <span class="s1">&#39;mobilenet_v2&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="p">,</span>
        <span class="s1">&#39;mobilenet_v3_small&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">mobilenet_v3_small</span><span class="p">,</span>
        <span class="s1">&#39;mobilenet_v3_large&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">mobilenet_v3_large</span><span class="p">,</span>
        <span class="s1">&#39;wide_resnet50_2&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">wide_resnet50_2</span><span class="p">,</span>
        <span class="s1">&#39;mnasnet&#39;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">mnasnet1_0</span><span class="p">,</span>
        <span class="s1">&#39;xception&#39;</span><span class="p">:</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">xception</span><span class="p">,</span>
        <span class="s1">&#39;nasnet_large&#39;</span><span class="p">:</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">nasnetalarge</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CrossEntropy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Adadelta&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adadelta</span><span class="p">,</span>
            <span class="s1">&#39;Adagrad&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">,</span>
            <span class="s1">&#39;Adam&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
            <span class="s1">&#39;AdamW&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">,</span>
            <span class="s1">&#39;SparseAdam&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SparseAdam</span><span class="p">,</span>
            <span class="s1">&#39;Adamax&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adamax</span><span class="p">,</span>
            <span class="s1">&#39;ASGD&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">ASGD</span><span class="p">,</span>
            <span class="s1">&#39;LBFGS&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">,</span>
            <span class="s1">&#39;RMSprop&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">,</span>
            <span class="s1">&#39;Rprop&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Rprop</span><span class="p">,</span>
            <span class="s1">&#39;SGD&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RegressionLossDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;L1&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">,</span>
            <span class="s1">&#39;MSE&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">,</span>
            <span class="s1">&#39;NLL&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">,</span>  <span class="c1"># negative log likelihood</span>
            <span class="s1">&#39;HingeEmbedding&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">HingeEmbeddingLoss</span><span class="p">,</span>
            <span class="s1">&#39;SmoothL1&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">,</span>
            <span class="s1">&#39;CosineEmbedding&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CosineEmbeddingLoss</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;CrossEntropy&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">,</span>
            <span class="s1">&#39;CTC&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CTCLoss</span><span class="p">,</span>
            <span class="s1">&#39;PoissonNLL&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">PoissonNLLLoss</span><span class="p">,</span>
            <span class="s1">&#39;GaussianNLL&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">GaussianNLLLoss</span><span class="p">,</span>
            <span class="s1">&#39;KLDiv&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">KLDivLoss</span><span class="p">,</span>
            <span class="s1">&#39;BCE&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">,</span>
            <span class="s1">&#39;BCEWithLogits&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">,</span>
            <span class="s1">&#39;MarginRanking&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MarginRankingLoss</span><span class="p">,</span>
            <span class="s1">&#39;MultiLabelMargin&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MultiLabelMarginLoss</span><span class="p">,</span>
            <span class="s1">&#39;Huber&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">HuberLoss</span><span class="p">,</span>
            <span class="s1">&#39;SoftMargin&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SoftMarginLoss</span><span class="p">,</span>
            <span class="s1">&#39;MultiLabelSoftMargin&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MultiLabelSoftMarginLoss</span><span class="p">,</span>
            <span class="s1">&#39;MultiMargin&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MultiMarginLoss</span><span class="p">,</span>
            <span class="s1">&#39;TripletMargin&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TripletMarginLoss</span><span class="p">,</span>
            <span class="s1">&#39;TripletMarginWithDistance&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TripletMarginWithDistanceLoss</span><span class="p">,</span>
            <span class="s1">&#39;L1&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">,</span>
            <span class="s1">&#39;MSE&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">,</span>
            <span class="s1">&#39;NLL&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">,</span>  <span class="c1"># negative log likelihood</span>
            <span class="s1">&#39;HingeEmbedding&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">HingeEmbeddingLoss</span><span class="p">,</span>
            <span class="s1">&#39;SmoothL1&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">,</span>
            <span class="s1">&#39;CosineEmbedding&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CosineEmbeddingLoss</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;timm_&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;inception&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Model &#39;inception&#39; has an auxillary classifier, which &quot;</span>
                     <span class="s2">&quot;is currently ignored during training. Auxillary &quot;</span>
                     <span class="s2">&quot;classifier loss will be included during training &quot;</span>
                     <span class="s2">&quot;starting in version 1.3&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">get_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_to_update</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">OptDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">](</span>
            <span class="n">params_to_update</span><span class="p">,</span>
            <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">_Loss</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AllLossDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">]()</span>

    <span class="k">def</span> <span class="nf">get_model_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;timm_&#39;</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">loader</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">timm</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to load model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">; &quot;</span>
                                      <span class="s2">&quot;timm package not installed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">loader</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_slide_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>

        <span class="k">assert</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_classes_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">num_classes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;out-0&#39;</span><span class="p">:</span> <span class="n">num_classes</span><span class="p">}</span>

        <span class="c1"># Prepare custom model pretraining</span>
        <span class="k">if</span> <span class="n">pretrain</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using pretraining: [green]</span><span class="si">{</span><span class="n">pretrain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pretrain</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
           <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">pretrain</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span><span class="p">):</span>
           <span class="n">_pretrained</span> <span class="o">=</span> <span class="n">pretrain</span>
           <span class="n">pretrain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_pretrained</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Build base model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;xception&#39;</span><span class="p">,</span> <span class="s1">&#39;nasnet_large&#39;</span><span class="p">):</span>
            <span class="n">_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)(</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">pretrained</span><span class="o">=</span><span class="n">pretrain</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compatibility logic for prior versions of PyTorch</span>
            <span class="n">model_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">model_fn_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_fn</span><span class="p">)</span>
            <span class="n">model_kw</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">param</span><span class="o">.</span><span class="n">name</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_fn_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
            <span class="p">]</span>
            <span class="n">call_kw</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;image_size&#39;</span> <span class="ow">in</span> <span class="n">model_kw</span><span class="p">:</span>
                <span class="n">call_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">image_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">torchvision</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;0.13&quot;</span><span class="p">)</span>
               <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;timm_&#39;</span><span class="p">)):</span>
                <span class="c1"># New Torchvision API</span>
                <span class="n">w</span> <span class="o">=</span> <span class="s1">&#39;DEFAULT&#39;</span> <span class="k">if</span> <span class="n">pretrain</span> <span class="o">==</span> <span class="s1">&#39;imagenet&#39;</span> <span class="k">else</span> <span class="n">pretrain</span>
                <span class="n">call_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">call_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="n">pretrain</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="n">_model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="o">**</span><span class="n">call_kw</span><span class="p">)</span>

        <span class="c1"># Add final layers to models</span>
        <span class="n">hidden_layers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_width</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ModelWrapper</span><span class="p">(</span>
            <span class="n">_model</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">num_classes</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">num_slide_features</span><span class="p">,</span>
            <span class="n">hidden_layers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_images</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">include_top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">include_top</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">_pretrained</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lazy_load_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">_pretrained</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns &#39;regression&#39;, &#39;classification&#39;, or &#39;survival&#39;, reflecting the loss.&quot;&quot;&quot;</span>
        <span class="c1">#check if loss is custom_[type] and returns type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;NLL&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;survival&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RegressionLossDict</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;regression&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;classification&#39;</span></div>


<div class="viewcode-block" id="Trainer"><a class="viewcode-back" href="../../../../model/#slideflow.model.Trainer">[docs]</a><span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base trainer class containing functionality for model building, input</span>
<span class="sd">    processing, training, and evaluation.</span>

<span class="sd">    This base class requires categorical outcome(s). Additional outcome types</span>
<span class="sd">    are supported by :class:`slideflow.model.RegressionTrainer` and</span>
<span class="sd">    :class:`slideflow.model.SurvivalTrainer`.</span>

<span class="sd">    Slide-level (e.g. clinical) features can be used as additional model input</span>
<span class="sd">    by providing slide labels in the slide annotations dictionary, under</span>
<span class="sd">    the key &#39;input&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;classification&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hp</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">slide_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Trainer&#39;</span><span class="p">,</span>
        <span class="n">feature_sizes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">outcome_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_tf32</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_neptune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">neptune_api</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">neptune_workspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
        <span class="n">custom_objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pin_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets base configuration, preparing model inputs and outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            hp (:class:`slideflow.ModelParams`): ModelParams object.</span>
<span class="sd">            outdir (str): Destination for event logs and checkpoints.</span>
<span class="sd">            labels (dict): Dict mapping slide names to outcome labels (int or</span>
<span class="sd">                float format).</span>
<span class="sd">            slide_input (dict): Dict mapping slide names to additional</span>
<span class="sd">                slide-level input, concatenated after post-conv.</span>
<span class="sd">            name (str, optional): Optional name describing the model, used for</span>
<span class="sd">                model saving. Defaults to None.</span>
<span class="sd">            feature_sizes (list, optional): List of sizes of input features.</span>
<span class="sd">                Required if providing additional input features as model input.</span>
<span class="sd">            feature_names (list, optional): List of names for input features.</span>
<span class="sd">                Used when permuting feature importance.</span>
<span class="sd">            outcome_names (list, optional): Name of each outcome. Defaults to</span>
<span class="sd">                &quot;Outcome {X}&quot; for each outcome.</span>
<span class="sd">            mixed_precision (bool, optional): Use FP16 mixed precision (rather</span>
<span class="sd">                than FP32). Defaults to True.</span>
<span class="sd">            allow_tf32 (bool): Allow internal use of Tensorfloat-32 format.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            config (dict, optional): Training configuration dictionary, used</span>
<span class="sd">                for logging and image format verification. Defaults to None.</span>
<span class="sd">            use_neptune (bool, optional): Use Neptune API logging.</span>
<span class="sd">                Defaults to False</span>
<span class="sd">            neptune_api (str, optional): Neptune API token, used for logging.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            neptune_workspace (str, optional): Neptune workspace.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            load_method (str): Loading method to use when reading model.</span>
<span class="sd">                This argument is ignored in the PyTorch backend, as all models</span>
<span class="sd">                are loaded by first building the model with hyperparameters</span>
<span class="sd">                detected in ``params.json``, then loading weights with</span>
<span class="sd">                ``torch.nn.Module.load_state_dict()``. Defaults to</span>
<span class="sd">                &#39;full&#39; (ignored).</span>
<span class="sd">            transform (callable or dict, optional): Optional transform to</span>
<span class="sd">                apply to input images. If dict, must have the keys &#39;train&#39;</span>
<span class="sd">                and/or &#39;val&#39;, mapping to callables that takes a single</span>
<span class="sd">                image Tensor as input and returns a single image Tensor.</span>
<span class="sd">                If None, no transform is applied. If a single callable is</span>
<span class="sd">                provided, it will be applied to both training and validation</span>
<span class="sd">                data. If a dict is provided, the &#39;train&#39; transform will be</span>
<span class="sd">                applied to training data and the &#39;val&#39; transform will be</span>
<span class="sd">                applied to validation data. If a dict is provided and either</span>
<span class="sd">                &#39;train&#39; or &#39;val&#39; is None, no transform will be applied to</span>
<span class="sd">                that data. Defaults to None.</span>
<span class="sd">            pin_memory (bool): Set the ``pin_memory`` attribute for dataloaders.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            num_workers (int): Set the number of workers for dataloaders.</span>
<span class="sd">                Defaults to 4.</span>
<span class="sd">            chunk_size (int): Set the chunk size for TFRecord reading.</span>
<span class="sd">                Defaults to 8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[torch.nn.Module]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_model</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[torch.nn.Module]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">mixed_precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid_train_val_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">_Loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[torch.utils.tensorboard.SummaryWriter]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_training_params</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">custom_objects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;custom_objects argument ignored in PyTorch backend.&quot;</span><span class="p">)</span>

        <span class="c1"># Enable or disable Tensorflow-32</span>
        <span class="c1"># Allows PyTorch to internally use tf32 for matmul and convolutions</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="n">allow_tf32</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="n">allow_tf32</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tf32</span> <span class="o">=</span> <span class="n">allow_tf32</span>

        <span class="c1"># Slide-level input args</span>
        <span class="k">if</span> <span class="n">slide_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span> <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">slide_input</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_sizes</span> <span class="o">=</span> <span class="n">feature_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_sizes</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_sizes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_normalizer</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using realtime </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">normalizer</span><span class="si">}</span><span class="s1"> normalization&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_transforms</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_outcome_labels</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">cat_assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_category_assignments</span><span class="p">()</span>

        <span class="c1"># Log parameters</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">(),</span>
                <span class="s1">&#39;git_commit&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__gitcommit__</span><span class="p">,</span>
                <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;full_model_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;outcomes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
                <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
                <span class="s1">&#39;img_format&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;tile_px&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="s1">&#39;tile_um&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="s1">&#39;input_features&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;input_feature_labels&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cat_assign</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>

        <span class="c1"># Neptune logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;img_format&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span> <span class="o">=</span> <span class="n">use_neptune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neptune_api</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">neptune_workspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If using Neptune, must supply neptune_api&quot;</span>
                                 <span class="s2">&quot; and neptune_workspace.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">NeptuneLog</span><span class="p">(</span>
                <span class="n">neptune_api</span><span class="p">,</span>
                <span class="n">neptune_workspace</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_outcomes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">multi_outcome</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_category_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get category assignments for categorical outcome labels.</span>

<span class="sd">        Dataframes with integer labels are assumed to be categorical if</span>
<span class="sd">        if hp.model_type is &#39;classification&#39;.</span>
<span class="sd">        Dataframes with float labels are assumed to be continuous.</span>
<span class="sd">        Dataframes with other labels are assumed to be categorical, and will</span>
<span class="sd">        be assigned an integer label based on the order of unique values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected DataFrame with &#39;label&#39; column.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected DataFrame with &#39;label&#39; column.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_integer_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">is_float_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">int_to_str</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
                <span class="n">str_to_int</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">int_to_str</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Assigned integer labels to categories:&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">str_to_int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">str_to_int</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">int_to_str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_process_transforms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process custom transformations for training and/or validation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;transform must be a callable or dict with keys &quot;</span>
                             <span class="s2">&quot;&#39;train&#39; and/or &#39;val&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;val&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

    <span class="k">def</span> <span class="nf">_process_outcome_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outcome_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process outcome labels to determine number of outcomes and names.</span>

<span class="sd">        Supports experimental tile-level labels provided via pandas DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (dict): Dict mapping slide names to outcome labels (int or</span>
<span class="sd">                float format). Experimental funtionality: if labels is a</span>
<span class="sd">                pandas DataFrame, the &#39;label&#39; column will be used as the</span>
<span class="sd">                outcome labels.</span>
<span class="sd">            outcome_names (list, optional): Name of each outcome. Defaults to</span>
<span class="sd">                &quot;Outcome {X}&quot; for each outcome.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Process DataFrame tile-level labels</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Expected DataFrame with &#39;label&#39; &quot;</span>
                                        <span class="s2">&quot;column.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outcome_names</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected single outcome name for labels from a pandas dataframe.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span> <span class="o">=</span> <span class="n">outcome_names</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;Outcome 0&#39;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1"># Process dictionary slide-level labels</span>
        <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">outcome_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outcome_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;Outcome </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span> <span class="o">=</span> <span class="n">outcome_names</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">)</span> <span class="o">==</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">n_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">)</span>
            <span class="n">n_out</span> <span class="o">=</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of outcome names (</span><span class="si">{</span><span class="n">n_names</span><span class="si">}</span><span class="s2">) does&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot; not match number of outcomes (</span><span class="si">{</span><span class="n">n_out</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_training_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_frequency</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># type: bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Any]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_batch_size</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_batch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_observations</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_smoothing</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Union[Tensor, Dict[str, Tensor]]</span>

    <span class="k">def</span> <span class="nf">_accuracy_as_numpy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">acc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">acc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">acc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading checkpoint at [green]</span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">pretrain</span><span class="o">=</span><span class="n">pretrain</span><span class="p">,</span>
                <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="p">)</span>
        <span class="c1"># Create an inference model before any multi-GPU parallelization</span>
        <span class="c1"># is applied to the self.model parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

    <span class="k">def</span> <span class="nf">_calculate_accuracy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">running_corrects</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">num_records</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Reports accuracy of each outcome.&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">running_corrects</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected running_corrects to be a dict:&quot;</span>
                                 <span class="s2">&quot; num_outcomes is &gt; 1&quot;</span><span class="p">)</span>
            <span class="n">acc_desc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">acc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">running_corrects</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_records</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">running_corrects</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">running_corrects</span><span class="p">)):</span>
                <span class="n">_acc</span> <span class="o">=</span> <span class="n">running_corrects</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_records</span>
                <span class="n">acc_desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2"> acc: </span><span class="si">{</span><span class="n">_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="k">return</span> <span class="n">acc_list</span><span class="p">,</span> <span class="n">acc_desc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">running_corrects</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="n">_acc</span> <span class="o">=</span> <span class="n">running_corrects</span> <span class="o">/</span> <span class="n">num_records</span>
            <span class="k">return</span> <span class="n">_acc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;acc: </span><span class="si">{</span><span class="n">_acc</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">_calculate_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">loss_fn</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">_Loss</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Calculates loss in a manner compatible with multiple outcomes.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected labels to be a dict: num_outcomes&quot;</span>
                                 <span class="s2">&quot; is &gt; 1&quot;</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
                <span class="n">loss_fn</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">_check_early_stopping</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">val_acc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">val_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val_acc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val_loss</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_epoch</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>  <span class="c1"># type: ignore</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_batch</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Manual early stop triggered: epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;batch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                        <span class="s2">&quot;Early stopping method &#39;accuracy&#39; not supported with&quot;</span>
                        <span class="s2">&quot; multiple outcomes; use &#39;loss&#39;.&quot;</span><span class="p">)</span>
                <span class="n">early_stop_val</span> <span class="o">=</span> <span class="n">val_acc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">early_stop_val</span> <span class="o">=</span> <span class="n">val_loss</span>
            <span class="k">assert</span> <span class="n">early_stop_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">early_stop_val</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span> <span class="o">+=</span> <span class="p">[</span><span class="n">early_stop_val</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_observations</span><span class="p">:</span>
                <span class="c1"># Only keep track of the last [ema_observations]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Simple moving average</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">)</span>
                                     <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (SMA: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema_smoothing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_observations</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">=</span> <span class="p">(</span><span class="n">early_stop_val</span> <span class="o">*</span> <span class="n">alpha</span>
                                     <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)))</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (EMA: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">neptune_dest</span> <span class="o">=</span> <span class="s2">&quot;metrics/val/batch/exp_moving_avg&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="n">neptune_dest</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span>
                   <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                   <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_patience</span><span class="p">):</span>

                    <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>
                         <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span><span class="p">)</span>
                       <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span>
                           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span><span class="p">)):</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Early stop triggered: epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_early_stop_to_neptune</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">return</span> <span class="n">log_msg</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ema_two_checks_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ema_one_check_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ema</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_detect_patients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dataset_patients</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">patients</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_patients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dataset_patients</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_empty_corrects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_outcome</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_epoch_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">acc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]:</span>
        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>  <span class="c1"># type: Dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="n">epoch_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_metrics&#39;</span><span class="p">:</span> <span class="n">epoch_metrics</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_val_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate model and calculate metrics.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Dict[str, float]]: Dict with validation metrics.</span>
<span class="sd">            Returns metrics in the form:</span>
<span class="sd">            ```</span>
<span class="sd">            {</span>
<span class="sd">                &#39;val_metrics&#39;: {</span>
<span class="sd">                    &#39;loss&#39;: ...,</span>
<span class="sd">                    &#39;accuracy&#39;: ...,</span>
<span class="sd">                },</span>
<span class="sd">                &#39;tile_auc&#39;: ...,</span>
<span class="sd">                &#39;slide_auc&#39;: ...,</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;optimizer&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">results_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>
        <span class="n">epoch_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Preparations for calculating accuracy/loss in metrics_from_dataset()</span>
        <span class="k">def</span> <span class="nf">update_corrects</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">running_corrects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">running_corrects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">running_corrects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_empty_corrects</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_to_device</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_corrects</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">running_corrects</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">update_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">running_loss</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_to_device</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">running_loss</span> <span class="o">+</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>

        <span class="n">torch_args</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">update_corrects</span><span class="o">=</span><span class="n">update_corrects</span><span class="p">,</span>
            <span class="n">update_loss</span><span class="o">=</span><span class="n">update_loss</span><span class="p">,</span>
            <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">,</span>
            <span class="n">slide_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">,</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gpu_normalizer</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># Calculate patient/slide/tile metrics (AUC, R-squared, C-index, etc)</span>
        <span class="n">metrics</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics_from_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference_model</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">neptune_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
            <span class="n">torch_args</span><span class="o">=</span><span class="n">torch_args</span><span class="p">,</span>
            <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">loss_and_acc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="n">loss_and_acc</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_epoch</span><span class="p">(</span>
                <span class="s1">&#39;val&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                <span class="n">loss</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_accuracy</span><span class="p">(</span><span class="n">acc</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val_metrics&#39;</span><span class="p">:</span> <span class="n">loss_and_acc</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">epoch_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;tile_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span>
            <span class="n">epoch_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slide_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span>
            <span class="n">epoch_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;patient_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">]</span>
        <span class="n">epoch_metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">epoch_results</span><span class="p">)</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span>
            <span class="n">results_log</span><span class="p">,</span>
            <span class="s1">&#39;trained_model&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">epoch_metrics</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_eval_to_neptune</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">epoch_metrics</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">epoch_metrics</span>

    <span class="k">def</span> <span class="nf">_fit_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the Trainer normalizer using the specified fit, if applicable.</span>

<span class="sd">        Args:</span>
<span class="sd">            norm_fit (Optional[Dict[str, np.ndarray]]): Normalizer fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">norm_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_fit supplied, but model params do not&quot;</span>
                             <span class="s2">&quot;specify a normalizer.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="ow">and</span> <span class="n">norm_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">norm_fit</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span>
              <span class="ow">and</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
              <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detecting normalizer fit from model config&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_has_gpu_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">slideflow.norm.torch</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">TorchStainNormalizer</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_labels_to_device</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Moves a set of outcome labels to the given device.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected labels to be a dict: num_outcomes&quot;</span>
                                 <span class="s2">&quot; is &gt; 1&quot;</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">la</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">_log_epoch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">accuracy_desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs epoch description.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[bold blue]</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">[/] Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1"> | loss:&#39;</span>
                 <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">accuracy_desc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_manifest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">],</span>
        <span class="n">val_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log the tfrecord and label manifest to slide_manifest.csv</span>

<span class="sd">        Args:</span>
<span class="sd">            train_dts (sf.Dataset): Training dataset. May be None.</span>
<span class="sd">            val_dts (sf.Dataset): Validation dataset. May be None.</span>
<span class="sd">            labels (dict, optional): Labels dictionary. May be None.</span>
<span class="sd">                Defaults to &#39;auto&#39; (read from self.labels).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
        <span class="k">elif</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="n">_labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">log_manifest</span><span class="p">(</span>
            <span class="p">(</span><span class="n">train_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span> <span class="k">if</span> <span class="n">train_dts</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span> <span class="k">if</span> <span class="n">val_dts</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">_labels</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_to_tensorboard</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">acc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">_acc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acc</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Accuracy-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Accuracy/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_to_neptune</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">acc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs epoch loss/accuracy to Neptune.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;epoch&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;metrics/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">/loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span>
                                                                  <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accuracy_as_numpy</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">_acc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acc</span><span class="p">):</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;metrics/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">/accuracy-</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">val</span><span class="o">=</span><span class="n">_acc</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="n">step</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                    <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;metrics/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">/accuracy&#39;</span><span class="p">,</span>
                    <span class="n">val</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span>
                    <span class="n">step</span><span class="o">=</span><span class="n">step</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_early_stop_to_neptune</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Log early stop to neptune</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/early_stop_epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/early_stop_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;early_stop/method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s2">&quot;sys/tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;early_stopped&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_eval_to_neptune</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">acc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">epoch_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_results</span>

            <span class="c1"># Validation epoch metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;metrics/val/epoch/loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span>
                                                           <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                <span class="s1">&#39;metrics/val/epoch/accuracy&#39;</span><span class="p">,</span>
                <span class="n">acc</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">]:</span>
                    <span class="c1"># If only one outcome,</span>
                    <span class="c1">#   log to metrics/val/epoch/[metric].</span>
                    <span class="c1"># If more than one outcome,</span>
                    <span class="c1">#   log to metrics/val/epoch/[metric]/[outcome_name]</span>
                    <span class="k">def</span> <span class="nf">metric_label</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;metrics/val/epoch/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;metrics/val/epoch/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">outcome</span><span class="si">}</span><span class="s1">&#39;</span>

                    <span class="n">tile_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;tile&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>
                    <span class="n">slide_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;slide&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>
                    <span class="n">patient_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;patient&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span>

                    <span class="c1"># If only one value for a metric, log to .../[metric]</span>
                    <span class="c1"># If more than one value for a metric</span>
                    <span class="c1">#   (e.g. AUC for each category),</span>
                    <span class="c1"># log to .../[metric]/[i]</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">),</span>
                        <span class="n">tile_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
                    <span class="p">)</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">),</span>
                        <span class="n">slide_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
                    <span class="p">)</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">neptune_utils</span><span class="o">.</span><span class="n">list_log</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">,</span>
                        <span class="n">metric_label</span><span class="p">(</span><span class="s1">&#39;patient&#39;</span><span class="p">),</span>
                        <span class="n">patient_metric</span><span class="p">,</span>
                        <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mid_training_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform mid-epoch validation, if appropriate.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_batch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="s1">&#39;val&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_batch</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Model not yet initialized.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">running_val_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">running_val_correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_empty_corrects</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_steps</span><span class="p">):</span>
            <span class="n">val_img</span><span class="p">,</span> <span class="n">val_label</span><span class="p">,</span> <span class="n">slides</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mid_train_val_dts</span><span class="p">)</span>  <span class="c1"># type:ignore</span>
            <span class="n">val_img</span> <span class="o">=</span> <span class="n">val_img</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">val_img</span> <span class="o">=</span> <span class="n">val_img</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
                <span class="n">_mp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
                <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">mixed_precision</span><span class="o">=</span><span class="n">_mp</span><span class="p">):</span>  <span class="c1"># type: ignore</span>

                    <span class="c1"># GPU normalization, if specified.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gpu_normalizer</span><span class="p">():</span>
                        <span class="n">val_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">val_img</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                        <span class="n">_slide_in</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">]</span>
                        <span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_img</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">_slide_in</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_img</span><span class="p">,)</span>  <span class="c1"># type: ignore</span>
                    <span class="n">val_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_model</span><span class="p">(</span><span class="o">*</span><span class="n">inp</span><span class="p">)</span>
                    <span class="n">val_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_to_device</span><span class="p">(</span><span class="n">val_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">val_batch_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_loss</span><span class="p">(</span>
                        <span class="n">val_outputs</span><span class="p">,</span> <span class="n">val_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span>
                    <span class="p">)</span>

            <span class="n">running_val_loss</span> <span class="o">+=</span> <span class="n">val_batch_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">val_img</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">running_val_correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_corrects</span><span class="p">(</span>
                    <span class="n">val_outputs</span><span class="p">,</span> <span class="n">val_label</span><span class="p">,</span> <span class="n">running_val_correct</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
            <span class="n">num_val</span> <span class="o">+=</span> <span class="n">val_img</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="n">running_val_loss</span> <span class="o">/</span> <span class="n">num_val</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="n">val_acc</span><span class="p">,</span> <span class="n">val_acc_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_accuracy</span><span class="p">(</span>
                <span class="n">running_val_correct</span><span class="p">,</span> <span class="n">num_val</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val_acc</span><span class="p">,</span> <span class="n">val_acc_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># type: ignore</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Batch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s1">: val loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">val_acc_desc</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># Log validation metrics to neptune &amp; check early stopping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_neptune</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">val_acc</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>
        <span class="n">log_msg</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_early_stopping</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accuracy_as_numpy</span><span class="p">(</span><span class="n">val_acc</span><span class="p">),</span>
            <span class="n">val_loss</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># Log to tensorboard</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">running_val_correct</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="n">_val_acc</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">running_val_correct</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_val</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_outputs</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">running_val_correct</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="n">_val_acc</span> <span class="o">=</span> <span class="n">running_val_correct</span> <span class="o">/</span> <span class="n">num_val</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_tensorboard</span><span class="p">(</span>
                <span class="n">val_loss</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_accuracy_as_numpy</span><span class="p">(</span><span class="n">_val_acc</span><span class="p">),</span>
                <span class="s1">&#39;test&#39;</span>
            <span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Put model back in training mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_optimizers_and_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not yet been initialized.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_opt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">learning_rate_decay</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ExponentialLR</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">learning_rate_decay</span>
            <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using exponentially decaying learning rate&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_neptune_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;k-fold&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]:</span>
                <span class="n">tags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;k-fold</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;k_fold_i&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">],</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="n">tags</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_logger</span><span class="o">.</span><span class="n">log_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;data/slide_manifest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;slide_manifest.csv&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;neptune_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;sys/id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to log params (params.json) with Neptune.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_model_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_dts</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints model summary and logs to neptune.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not yet been initialized.&quot;</span><span class="p">)</span>
        <span class="n">empty_inp</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">tile_px</span><span class="p">]</span>
        <span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
            <span class="n">empty_inp</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">model_summary</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">print_module_summary</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">empty_inp</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_summary</span>

    <span class="k">def</span> <span class="nf">_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;trained_model&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">.zip&#39;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model saved to [green]</span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_dataloaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close dataloaders, ensuring threads have joined.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid_train_val_dts</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;_dataset&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing dataloader </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> via _dataset.close()&quot;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s1">&#39;dataset&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing dataloader </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> via dataset.close()&quot;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_dataloaders</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">],</span>
        <span class="n">val_dts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">],</span>
        <span class="n">mid_train_val</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">incl_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare dataloaders from training and validation.&quot;&quot;&quot;</span>
        <span class="n">interleave_args</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">num_replicas</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="k">if</span> <span class="n">incl_labels</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">from_wsi</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">onehot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">incl_slidenames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># Use GPU stain normalization for PyTorch normalizers, if supported</span>
        <span class="n">_augment_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">augment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gpu_normalizer</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using GPU for stain normalization&quot;</span><span class="p">)</span>
            <span class="n">interleave_args</span><span class="o">.</span><span class="n">standardize</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_augment_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_augment_str</span> <span class="o">=</span> <span class="n">_augment_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interleave_args</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span>

        <span class="k">if</span> <span class="n">train_dts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_dts</span><span class="o">.</span><span class="n">torch</span><span class="p">(</span>
                    <span class="n">infinite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">augment</span><span class="o">=</span><span class="n">_augment_str</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span>
                    <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">interleave_args</span><span class="p">)</span>
                <span class="p">))</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">val_dts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_batch_size</span><span class="p">:</span>
                <span class="n">validation_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">torch</span><span class="p">(</span>
                <span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">validation_batch_size</span><span class="p">,</span>
                <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                <span class="n">incl_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">interleave_args</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Mid-training validation dataset</span>
            <span class="k">if</span> <span class="n">mid_train_val</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mid_train_val_dts</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_batch</span><span class="p">:</span>
                <span class="n">val_log_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val_log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;every </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validate_on_batch</span><span class="p">)</span><span class="si">}</span><span class="s1"> steps and &#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation during training: </span><span class="si">{</span><span class="n">val_log_msg</span><span class="si">}</span><span class="s1">at epoch end&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_steps</span><span class="p">:</span>
                <span class="n">num_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_steps</span><span class="si">}</span><span class="s1"> batches (</span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;samples) each validation check&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using entire validation set each validation check&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validation during training: None&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">:</span> <span class="n">Progress</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">slides</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_to_device</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">_mp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">mixed_precision</span><span class="o">=</span><span class="n">_mp</span><span class="p">):</span>  <span class="c1"># type: ignore</span>

                <span class="c1"># GPU normalization, if specified.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gpu_normalizer</span><span class="p">():</span>
                    <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span>
                        <span class="n">images</span><span class="p">,</span>
                        <span class="n">augment</span><span class="o">=</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">augment</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                                 <span class="ow">and</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">augment</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Slide-level features</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">:</span>
                    <span class="n">_slide_in</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">]</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">_slide_in</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span><span class="p">,)</span>  <span class="c1"># type: ignore</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">inp</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">)</span>

            <span class="c1"># Update weights</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c1"># Update learning rate if using a scheduler</span>
            <span class="n">_lr_decay_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">learning_rate_decay_steps</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">_lr_decay_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stepping learning rate decay&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Record accuracy and loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_corrects</span><span class="p">(</span>
                <span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span>
            <span class="p">)</span>
            <span class="n">train_acc</span><span class="p">,</span> <span class="n">acc_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_accuracy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_acc</span><span class="p">,</span> <span class="n">acc_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_loss</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                  <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[bold blue]train[/] &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;loss: </span><span class="si">{</span><span class="n">_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">acc_desc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Log to tensorboard</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_train_acc</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                     <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_train_acc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span>  <span class="c1"># type: ignore</span>
                              <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_tensorboard</span><span class="p">(</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_accuracy_as_numpy</span><span class="p">(</span><span class="n">_train_acc</span><span class="p">),</span>
                <span class="s1">&#39;train&#39;</span>
            <span class="p">)</span>
        <span class="c1"># Log to neptune &amp; check early stopping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_neptune</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">train_acc</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_early_stopping</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_corrects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span>
        <span class="n">running_corrects</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Updates running accuracy in a manner compatible with &gt;1 outcomes.&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">running_corrects</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="n">preds</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;out-</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">running_corrects</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">labels</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">running_corrects</span>

    <span class="k">def</span> <span class="nf">_validate_early_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates early stopping parameters.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">and</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outcomes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Cannot combine &#39;accuracy&#39; early stopping &quot;</span>
                                    <span class="s2">&quot;with multiple categorical outcomes.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">early_stop_method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_epoch</span> <span class="ow">is</span> <span class="kc">None</span>
                 <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">manual_early_stop_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span>
                <span class="s2">&quot;Early stopping method &#39;manual&#39; requires that both &quot;</span>
                <span class="s2">&quot;manual_early_stop_epoch and manual_early_stop_batch are set &quot;</span>
                <span class="s2">&quot;in model params.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_img_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="o">*</span><span class="n">datasets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;sf.Dataset&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the image format of the dataset matches the model config.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (sf.Dataset): Dataset to check.</span>
<span class="sd">            *datasets (sf.Dataset): Additional datasets to check. May be None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Image format, either &#39;png&#39; or &#39;jpg&#39;, if a consistent image</span>
<span class="sd">                format was found, otherwise None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First, verify all datasets have the same image format</span>
        <span class="n">img_formats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">img_format</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span> <span class="k">if</span> <span class="n">d</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_formats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple image formats detected: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_formats</span><span class="p">)</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to verify image format (PNG/JPG) of dataset.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Mismatched image formats. Expected &#39;</span><span class="si">{}</span><span class="s2">&#39; per model config, &quot;</span>
                <span class="s2">&quot;but dataset has format &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">img_format</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a state dict at the given model location. Requires that the</span>
<span class="sd">        Trainer&#39;s hyperparameters (Trainer.hp)</span>
<span class="sd">        match the hyperparameters of the model to be loaded.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">),</span>
                <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform inference on a model, saving predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset containing</span>
<span class="sd">                TFRecords to evaluate.</span>
<span class="sd">            batch_size (int, optional): Evaluation batch size. Defaults to the</span>
<span class="sd">                same as training (per self.hp)</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            format (str, optional): Format in which to save predictions. Either</span>
<span class="sd">                &#39;csv&#39;, &#39;feather&#39;, or &#39;parquet&#39;. Defaults to &#39;parquet&#39;.</span>
<span class="sd">            from_wsi (bool): Generate predictions from tiles dynamically</span>
<span class="sd">                extracted from whole-slide images, rather than TFRecords.</span>
<span class="sd">                Defaults to False (use TFRecords).</span>
<span class="sd">            roi_method (str): ROI method to use if from_wsi=True (ignored if</span>
<span class="sd">                from_wsi=False).  Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, &#39;ignore&#39;.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical</span>
<span class="sd">                outcomes. Options include &#39;average&#39;, &#39;mean&#39;, &#39;proportion&#39;,</span>
<span class="sd">                &#39;median&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, or a callable function.</span>
<span class="sd">                &#39;average&#39; and &#39;mean&#39; are  synonymous, with both options kept</span>
<span class="sd">                for backwards compatibility. If  &#39;average&#39; or &#39;mean&#39;, will</span>
<span class="sd">                reduce with average of each logit across  tiles. If</span>
<span class="sd">                &#39;proportion&#39;, will convert tile predictions into onehot encoding</span>
<span class="sd">                then reduce by averaging these onehot values. For all other</span>
<span class="sd">                values, will reduce with the specified function, applied via</span>
<span class="sd">                the pandas ``DataFrame.agg()`` function. Defaults to &#39;average&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, pd.DataFrame]: Dictionary with keys &#39;tile&#39;, &#39;slide&#39;, and</span>
<span class="sd">            &#39;patient&#39;, and values containing DataFrames with tile-, slide-,</span>
<span class="sd">            and patient-level predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;feather&#39;</span><span class="p">,</span> <span class="s1">&#39;parquet&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized format </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_patients</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Verify image format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_img_format</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Fit normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>

        <span class="c1"># Load and initialize model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelNotLoadedError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_manifest</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_wsi</span> <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;libvips&#39;</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">dummy</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dataloaders</span><span class="p">(</span>
            <span class="n">train_dts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">val_dts</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">incl_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
            <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating predictions...&#39;</span><span class="p">)</span>
        <span class="n">torch_args</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">num_slide_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slide_features</span><span class="p">,</span>
            <span class="n">slide_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_input</span><span class="p">,</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_gpu_normalizer</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">predict_dataset</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
            <span class="n">torch_args</span><span class="o">=</span><span class="n">torch_args</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_names</span><span class="p">,</span>
            <span class="n">uq</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span><span class="p">),</span>
            <span class="n">patients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span>
        <span class="p">)</span>
        <span class="c1"># Save predictions</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">save_dfs</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_dataloaders</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dfs</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate model, saving metrics and predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset to evaluate.</span>
<span class="sd">            batch_size (int, optional): Evaluation batch size. Defaults to the</span>
<span class="sd">                same as training (per self.hp)</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical</span>
<span class="sd">                outcomes. Options include &#39;average&#39;, &#39;mean&#39;, &#39;proportion&#39;,</span>
<span class="sd">                &#39;median&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, or a callable function.</span>
<span class="sd">                &#39;average&#39; and &#39;mean&#39; are  synonymous, with both options kept</span>
<span class="sd">                for backwards compatibility. If  &#39;average&#39; or &#39;mean&#39;, will</span>
<span class="sd">                reduce with average of each logit across  tiles. If</span>
<span class="sd">                &#39;proportion&#39;, will convert tile predictions into onehot encoding</span>
<span class="sd">                then reduce by averaging these onehot values. For all other</span>
<span class="sd">                values, will reduce with the specified function, applied via</span>
<span class="sd">                the pandas ``DataFrame.agg()`` function. Defaults to &#39;average&#39;.</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            uq (bool or str, optional): Enable UQ estimation (for</span>
<span class="sd">                applicable models). Defaults to &#39;auto&#39;.</span>
<span class="sd">            from_wsi (bool): Generate predictions from tiles dynamically</span>
<span class="sd">                extracted from whole-slide images, rather than TFRecords.</span>
<span class="sd">                Defaults to False (use TFRecords).</span>
<span class="sd">            roi_method (str): ROI method to use if from_wsi=True (ignored if</span>
<span class="sd">                from_wsi=False).  Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, &#39;ignore&#39;.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of evaluation metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uq</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uq</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized value </span><span class="si">{</span><span class="n">uq</span><span class="si">}</span><span class="s2"> for uq&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">uq</span> <span class="o">=</span> <span class="n">uq</span>
        <span class="k">if</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelNotLoadedError</span>
        <span class="k">if</span> <span class="n">from_wsi</span> <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;libvips&#39;</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">dummy</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_patients</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_img_format</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_loss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_manifest</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_neptune_run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dataloaders</span><span class="p">(</span>
            <span class="n">train_dts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">val_dts</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
            <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>

        <span class="c1"># Generate performance metrics</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Performing evaluation...&#39;</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val_metrics</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">,</span>
            <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span><span class="p">,</span>
            <span class="n">save_predictions</span><span class="o">=</span><span class="n">save_predictions</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;val_metrics&#39;</span>
        <span class="p">}}</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;val_metrics&#39;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
        <span class="n">results_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation metrics: </span><span class="si">{</span><span class="n">results_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">results_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span><span class="n">results_log</span><span class="p">,</span> <span class="s1">&#39;eval_model&#39;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;eval/results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_dataloaders</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_dts</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">val_dts</span><span class="p">:</span> <span class="s2">&quot;sf.Dataset&quot;</span><span class="p">,</span>
        <span class="n">log_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">validate_on_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">validation_batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">starting_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ema_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">ema_smoothing</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">use_tensorboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">steps_per_epoch_override</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
        <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">resume_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pretrain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_checkpoints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">multi_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">norm_fit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NormFit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reduce_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">from_wsi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds and trains a model from hyperparameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_dts (:class:`slideflow.dataset.Dataset`): Training dataset.</span>
<span class="sd">            val_dts (:class:`slideflow.dataset.Dataset`): Validation dataset.</span>
<span class="sd">            log_frequency (int, optional): How frequent to update Tensorboard</span>
<span class="sd">                logs, in batches. Defaults to 100.</span>
<span class="sd">            validate_on_batch (int, optional): Validation will be performed</span>
<span class="sd">                every N batches. Defaults to 0.</span>
<span class="sd">            validation_batch_size (int, optional): Validation batch size.</span>
<span class="sd">                Defaults to same as training (per self.hp).</span>
<span class="sd">            validation_steps (int, optional): Number of batches to use for each</span>
<span class="sd">                instance of validation. Defaults to 200.</span>
<span class="sd">            starting_epoch (int, optional): Starts training at this epoch.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            ema_observations (int, optional): Number of observations over which</span>
<span class="sd">                to perform exponential moving average smoothing.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            ema_smoothing (int, optional): Exponential average smoothing value.</span>
<span class="sd">                Defaults to 2.</span>
<span class="sd">            use_tensoboard (bool, optional): Enable tensorboard callbacks.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            steps_per_epoch_override (int, optional): Manually set the number</span>
<span class="sd">                of steps per epoch. Defaults to None.</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            save_model (bool, optional): Save models when evaluating at</span>
<span class="sd">                specified epochs. Defaults to False.</span>
<span class="sd">            resume_training (str, optional): Not applicable to PyTorch backend.</span>
<span class="sd">                Included as argument for compatibility with Tensorflow backend.</span>
<span class="sd">                Will raise NotImplementedError if supplied.</span>
<span class="sd">            pretrain (str, optional): Either &#39;imagenet&#39; or path to Tensorflow</span>
<span class="sd">                model from which to load weights. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt from which to load</span>
<span class="sd">                weights. Defaults to None.</span>
<span class="sd">            norm_fit (Dict[str, np.ndarray]): Normalizer fit, mapping fit</span>
<span class="sd">                parameters (e.g. target_means, target_stds) to values</span>
<span class="sd">                (np.ndarray). If not provided, will fit normalizer using</span>
<span class="sd">                model params (if applicable). Defaults to None.</span>
<span class="sd">            reduce_method (str, optional): Reduction method for calculating</span>
<span class="sd">                slide-level and patient-level predictions for categorical</span>
<span class="sd">                outcomes. Options include &#39;average&#39;, &#39;mean&#39;, &#39;proportion&#39;,</span>
<span class="sd">                &#39;median&#39;, &#39;sum&#39;, &#39;min&#39;, &#39;max&#39;, or a callable function.</span>
<span class="sd">                &#39;average&#39; and &#39;mean&#39; are  synonymous, with both options kept</span>
<span class="sd">                for backwards compatibility. If  &#39;average&#39; or &#39;mean&#39;, will</span>
<span class="sd">                reduce with average of each logit across  tiles. If</span>
<span class="sd">                &#39;proportion&#39;, will convert tile predictions into onehot encoding</span>
<span class="sd">                then reduce by averaging these onehot values. For all other</span>
<span class="sd">                values, will reduce with the specified function, applied via</span>
<span class="sd">                the pandas ``DataFrame.agg()`` function. Defaults to &#39;average&#39;.</span>
<span class="sd">            seed (int): Set numpy random seed. Defaults to 0.</span>
<span class="sd">            from_wsi (bool): Generate predictions from tiles dynamically</span>
<span class="sd">                extracted from whole-slide images, rather than TFRecords.</span>
<span class="sd">                Defaults to False (use TFRecords).</span>
<span class="sd">            roi_method (str): ROI method to use if from_wsi=True (ignored if</span>
<span class="sd">                from_wsi=False).  Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, &#39;ignore&#39;.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict:   Nested dict containing metrics for each evaluated epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resume_training</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;PyTorch backend does not support `resume_training`; &quot;</span>
                <span class="s2">&quot;please use `checkpoint`&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">save_checkpoints</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The argument save_checkpoints is ignored when training models &quot;</span>
                <span class="s2">&quot;in the PyTorch backend. To save a model throughout training, &quot;</span>
                <span class="s2">&quot;use the `epochs` hyperparameter.&quot;</span>
            <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)}</span>  <span class="c1"># type: Dict[str, Any]</span>
        <span class="n">starting_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">starting_epoch</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_patients</span><span class="p">(</span><span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_training_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_batch_size</span> <span class="o">=</span> <span class="n">validation_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_batch</span> <span class="o">=</span> <span class="n">validate_on_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_steps</span> <span class="o">=</span> <span class="n">validation_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_observations</span> <span class="o">=</span> <span class="n">ema_observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_smoothing</span> <span class="o">=</span> <span class="n">ema_smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_frequency</span> <span class="o">=</span> <span class="n">log_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span> <span class="o">=</span> <span class="n">use_tensorboard</span>

        <span class="c1"># Verify image format across datasets.</span>
        <span class="n">img_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_img_format</span><span class="p">(</span><span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_format</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_format</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">protobuf_version</span>
            <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">protobuf_version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;3.21&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Tensorboard is incompatible with protobuf &gt;= 3.21.&quot;</span>
                    <span class="s2">&quot;Downgrade protobuf to enable tensorboard logging.&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">from_wsi</span> <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;libvips&#39;</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_ignore_sigint</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">from_wsi</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">dummy</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">num_cpu</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Validate early stopping parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_early_stop</span><span class="p">()</span>

        <span class="c1"># Fit normalizer to dataset, if applicable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_normalizer</span><span class="p">(</span><span class="n">norm_fit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">normalizer_source</span> <span class="o">==</span> <span class="s1">&#39;dataset&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dts</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;params.json&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
                    <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">get_fit</span><span class="p">(</span><span class="n">as_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

        <span class="c1"># Training preparation</span>
        <span class="k">if</span> <span class="n">steps_per_epoch_override</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">steps_per_epoch_override</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting steps per epoch = </span><span class="si">{</span><span class="n">steps_per_epoch_override</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">num_tiles</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Steps per epoch = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_tensorboard</span><span class="p">:</span>
            <span class="c1"># Delayed import due to protobuf version conflicts.</span>

            <span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">flush_secs</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_manifest</span><span class="p">(</span><span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span><span class="p">)</span>

        <span class="c1"># Prepare neptune run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_neptune_run</span><span class="p">(</span><span class="n">train_dts</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>

        <span class="c1"># Build model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">pretrain</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Print model summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_model_summary</span><span class="p">(</span><span class="n">train_dts</span><span class="p">)</span>

        <span class="c1"># Multi-GPU</span>
        <span class="k">if</span> <span class="n">multi_gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Setup dataloaders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dataloaders</span><span class="p">(</span>
            <span class="n">train_dts</span><span class="o">=</span><span class="n">train_dts</span><span class="p">,</span>
            <span class="n">val_dts</span><span class="o">=</span><span class="n">val_dts</span><span class="p">,</span>
            <span class="n">mid_train_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
            <span class="n">from_wsi</span><span class="o">=</span><span class="n">from_wsi</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>

        <span class="c1"># Model parameters and optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_optimizers_and_loss</span><span class="p">()</span>

        <span class="c1"># === Epoch loop ======================================================</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">starting_epoch</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[bold]Epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Training loop ---------------------------------------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_empty_corrects</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span>
                <span class="o">*</span><span class="n">Progress</span><span class="o">.</span><span class="n">get_default_columns</span><span class="p">(),</span>
                <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
                <span class="n">ImgBatchSpeedColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">batch_size</span><span class="p">),</span>
                <span class="n">transient</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">20</span>
            <span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Training...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">)</span>
            <span class="n">pb</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cleanup_progress</span><span class="p">(</span><span class="n">pb</span><span class="p">):</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_training_step</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mid_training_validation</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Update and log epoch metrics ------------------------------------</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_loss</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span>
            <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train_metrics&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">acc</span><span class="p">,</span> <span class="n">acc_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_accuracy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_corrects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_records</span>
                <span class="p">)</span>
                <span class="n">epoch_metrics</span><span class="p">[</span><span class="s1">&#39;train_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accuracy_as_numpy</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">acc</span><span class="p">,</span> <span class="n">acc_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># type: ignore</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_epoch</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">acc_desc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_neptune</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_model</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_model</span><span class="p">()</span>

            <span class="c1"># Full evaluation -------------------------------------------------</span>
            <span class="c1"># Perform full evaluation if the epoch is one of the</span>
            <span class="c1"># predetermined epochs at which to save/eval a model</span>
            <span class="k">if</span> <span class="s1">&#39;val&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
                <span class="n">epoch_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val_metrics</span><span class="p">(</span>
                    <span class="n">save_predictions</span><span class="o">=</span><span class="n">save_predictions</span><span class="p">,</span>
                    <span class="n">reduce_method</span><span class="o">=</span><span class="n">reduce_method</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;val_epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">epoch_res</span><span class="p">)</span>

            <span class="c1"># Early stopping --------------------------------------------------</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># === [end epoch loop] ================================================</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="p">[</span><span class="s1">&#39;sys/tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;training_complete&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neptune_run</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_dataloaders</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="RegressionTrainer"><a class="viewcode-back" href="../../../../model/#slideflow.model.RegressionTrainer">[docs]</a><span class="k">class</span> <span class="nc">RegressionTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extends the base :class:`slideflow.model.Trainer` class to add support</span>
<span class="sd">    for continuous outcomes. Requires that all outcomes be continuous, with appropriate</span>
<span class="sd">    regression loss function. Uses R-squared as the evaluation metric, rather</span>
<span class="sd">    than AUROC.</span>

<span class="sd">    In this case, for the PyTorch backend, the continuous outcomes support is</span>
<span class="sd">    already baked into the base Trainer class, so no additional modifications</span>
<span class="sd">    are required. This class is written to inherit the Trainer class without</span>
<span class="sd">    modification to maintain consistency with the Tensorflow backend.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_model_type</span> <span class="o">=</span> <span class="s1">&#39;regression&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SurvivalTrainer"><a class="viewcode-back" href="../../../../model/#slideflow.model.SurvivalTrainer">[docs]</a><span class="k">class</span> <span class="nc">SurvivalTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cox proportional hazards (CPH) models are not yet implemented, but are</span>
<span class="sd">    planned for a future update.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Features"><a class="viewcode-back" href="../../../../model/#slideflow.model.Features">[docs]</a><span class="k">class</span> <span class="nc">Features</span><span class="p">(</span><span class="n">BaseFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for obtaining predictions and features from intermediate layer</span>
<span class="sd">    activations from Slideflow models.</span>

<span class="sd">    Use by calling on either a batch of images (returning outputs for a single</span>
<span class="sd">    batch), or by calling on a :class:`slideflow.WSI` object, which will</span>
<span class="sd">    generate an array of spatially-mapped activations matching the slide.</span>

<span class="sd">    Examples</span>
<span class="sd">        *Calling on batch of images:*</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            interface = Features(&#39;/model/path&#39;, layers=&#39;postconv&#39;)</span>
<span class="sd">            for image_batch in train_data:</span>
<span class="sd">                # Return shape: (batch_size, num_features)</span>
<span class="sd">                batch_features = interface(image_batch)</span>

<span class="sd">        *Calling on a slide:*</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            slide = sf.slide.WSI(...)</span>
<span class="sd">            interface = Features(&#39;/model/path&#39;, layers=&#39;postconv&#39;)</span>
<span class="sd">            # Return shape:</span>
<span class="sd">            # (slide.grid.shape[0], slide.grid.shape[1], num_features)</span>
<span class="sd">            activations_grid = interface(slide)</span>

<span class="sd">    Note:</span>
<span class="sd">        When this interface is called on a batch of images, no image processing</span>
<span class="sd">        or stain normalization will be performed, as it is assumed that</span>
<span class="sd">        normalization will occur during data loader image processing. When the</span>
<span class="sd">        interface is called on a `slideflow.WSI`, the normalization strategy</span>
<span class="sd">        will be read from the model configuration file, and normalization will</span>
<span class="sd">        be performed on image tiles extracted from the WSI. If this interface</span>
<span class="sd">        was created from an existing model and there is no model configuration</span>
<span class="sd">        file to read, a slideflow.norm.StainNormalizer object may be passed</span>
<span class="sd">        during initialization via the argument `wsi_normalizer`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_preds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">channels_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_softmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an activations interface from a saved slideflow model which</span>
<span class="sd">        outputs feature activations at the designated layers.</span>

<span class="sd">        Intermediate layers are returned in the order of layers.</span>
<span class="sd">        predictions are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to saved Slideflow model.</span>
<span class="sd">            layers (list(str), optional): Layers from which to generate</span>
<span class="sd">                activations.  The post-convolution activation layer is accessed</span>
<span class="sd">                via &#39;postconv&#39;. Defaults to &#39;postconv&#39;.</span>
<span class="sd">            include_preds (bool, optional): Include predictions in output. Will be</span>
<span class="sd">                returned last. Defaults to False.</span>
<span class="sd">            mixed_precision (bool, optional): Use mixed precision.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            device (:class:`torch.device`, optional): Device for model.</span>
<span class="sd">                Defaults to torch.device(&#39;cuda&#39;)</span>
<span class="sd">            apply_softmax (bool): Apply softmax transformation to model output.</span>
<span class="sd">                Defaults to True for classification models, False for regression models.</span>
<span class="sd">            pooling (Callable or str, optional): PyTorch pooling function to use</span>
<span class="sd">                on feature layers. May be a string (&#39;avg&#39; or &#39;max&#39;) or a</span>
<span class="sd">                callable PyTorch function.</span>
<span class="sd">            load_method (str): Loading method to use when reading model.</span>
<span class="sd">                This argument is ignored in the PyTorch backend, as all models</span>
<span class="sd">                are loaded by first building the model with hyperparameters</span>
<span class="sd">                detected in ``params.json``, then loading weights with</span>
<span class="sd">                ``torch.nn.Module.load_state_dict()``. Defaults to</span>
<span class="sd">                &#39;full&#39; (ignored).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="n">include_preds</span><span class="o">=</span><span class="n">include_preds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">layers</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span> <span class="o">=</span> <span class="n">apply_softmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="n">mixed_precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels_last</span> <span class="o">=</span> <span class="n">channels_last</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_preds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Transformation for standardizing uint8 images to float32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">127.5</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Hook for storing layer activations during model inference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[Any, Tensor]</span>

        <span class="c1"># Configure device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;img_format&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="p">()</span>  <span class="c1"># type: Optional[ModelParams]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">get_normalizer</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">apply_softmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span> <span class="k">else</span> <span class="kc">False</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using apply_softmax=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;ModelWrapper&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_preds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">channels_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">wsi_normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_softmax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an activations interface from a loaded slideflow model which</span>
<span class="sd">        outputs feature activations at the designated layers.</span>

<span class="sd">        Intermediate layers are returned in the order of layers.</span>
<span class="sd">        predictions are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (:class:`tensorflow.keras.models.Model`): Loaded model.</span>
<span class="sd">            tile_px (int): Width/height of input image size.</span>
<span class="sd">            layers (list(str), optional): Layers from which to generate</span>
<span class="sd">                activations.  The post-convolution activation layer is accessed</span>
<span class="sd">                via &#39;postconv&#39;. Defaults to &#39;postconv&#39;.</span>
<span class="sd">            include_preds (bool, optional): Include predictions in output. Will be</span>
<span class="sd">                returned last. Defaults to False.</span>
<span class="sd">            mixed_precision (bool, optional): Use mixed precision.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            wsi_normalizer (:class:`slideflow.norm.StainNormalizer`): Stain</span>
<span class="sd">                normalizer to use on whole-slide images. Is not used on</span>
<span class="sd">                individual tile datasets via __call__. Defaults to None.</span>
<span class="sd">            apply_softmax (bool): Apply softmax transformation to model output.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            pooling (Callable or str, optional): PyTorch pooling function to use</span>
<span class="sd">                on feature layers. May be a string (&#39;avg&#39; or &#39;max&#39;) or a</span>
<span class="sd">                callable PyTorch function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
        <span class="k">if</span> <span class="n">include_preds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">include_preds</span><span class="o">=</span><span class="n">include_preds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">layers</span><span class="p">,</span>
            <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span><span class="p">,</span>
            <span class="n">channels_last</span><span class="o">=</span><span class="n">channels_last</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelError</span><span class="p">(</span><span class="s2">&quot;Model is not a valid PyTorch model.&quot;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;ModelWrapper&#39;</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">=</span> <span class="n">tile_px</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">wsi_normalizer</span> <span class="o">=</span> <span class="n">wsi_normalizer</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">apply_softmax</span> <span class="o">=</span> <span class="n">apply_softmax</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a given input and return activations and/or predictions. Expects</span>
<span class="sd">        either a batch of images or a :class:`slideflow.slide.WSI` object.</span>

<span class="sd">        When calling on a `WSI` object, keyword arguments are passed to</span>
<span class="sd">        :meth:`slideflow.WSI.build_generator()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">WSI</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_slide</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    path=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    layers=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    include_preds=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">include_preds</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    apply_softmax=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    pooling=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_slide</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slide</span><span class="p">:</span> <span class="s2">&quot;sf.WSI&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;StainNormalizer&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate activations from slide =&gt; activation grid array.&quot;&quot;&quot;</span>

        <span class="c1"># Check image format</span>
        <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Unable to auto-detect image format (png or jpg). Set the &#39;</span>
                <span class="s1">&#39;format by passing img_format=... to the call function.&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">img_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_format</span>

        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extractors</span><span class="o">.</span><span class="n">features_from_slide</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">slide</span><span class="p">,</span>
            <span class="n">img_format</span><span class="o">=</span><span class="n">img_format</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="p">(</span><span class="n">normalizer</span> <span class="k">if</span> <span class="n">normalizer</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsi_normalizer</span><span class="p">),</span>
            <span class="n">normalizer_source</span><span class="o">=</span><span class="n">normalizer_source</span><span class="p">,</span>
            <span class="n">preprocess_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">no_grad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return activations for a single batch of images.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">(</span><span class="n">inp</span><span class="p">),</span> <span class="s2">&quot;Input tensor must be float&quot;</span>
        <span class="n">_mp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">mixed_precision</span><span class="o">=</span><span class="n">_mp</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span> <span class="k">if</span> <span class="n">no_grad</span> <span class="k">else</span> <span class="n">no_scope</span><span class="p">():</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_last</span><span class="p">:</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">:</span>
                    <span class="n">logits</span> <span class="o">=</span> <span class="p">[</span><span class="n">softmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">logits</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">:</span>
                    <span class="n">logits</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">layer_activations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">[</span><span class="n">la</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">la</span> <span class="o">==</span> <span class="s1">&#39;postconv&#39;</span><span class="p">:</span>
                    <span class="n">act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postconv_processing</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                <span class="n">layer_activations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_preds</span><span class="p">:</span>
            <span class="n">layer_activations</span> <span class="o">+=</span> <span class="p">[</span><span class="n">logits</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">layer_activations</span>

    <span class="k">def</span> <span class="nf">_get_postconv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns post-convolutional layer.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ViT&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">to_latent</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ResNet&#39;</span><span class="p">,</span> <span class="s1">&#39;Inception3&#39;</span><span class="p">,</span> <span class="s1">&#39;GoogLeNet&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">avgpool</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;AlexNet&#39;</span><span class="p">,</span> <span class="s1">&#39;SqueezeNet&#39;</span><span class="p">,</span> <span class="s1">&#39;VGG&#39;</span><span class="p">,</span> <span class="s1">&#39;MobileNetV2&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;MobileNetV3&#39;</span><span class="p">,</span> <span class="s1">&#39;MNASNet&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Identity&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">classifier</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">children</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;DenseNet&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">norm5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ShuffleNetV2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">conv5</span><span class="o">.</span><span class="n">children</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;Xception&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">bn4</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">FeaturesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;postconv&#39; layer not configured for &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;model type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_postconv_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies processing (pooling, resizing) to post-conv outputs,</span>
<span class="sd">        to convert output to the shape (batch_size, num_features)&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">pool</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">adaptive_avg_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ViT&#39;</span><span class="p">,</span> <span class="s1">&#39;AlexNet&#39;</span><span class="p">,</span> <span class="s1">&#39;VGG&#39;</span><span class="p">,</span> <span class="s1">&#39;MobileNetV2&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;MobileNetV3&#39;</span><span class="p">,</span> <span class="s1">&#39;MNASNet&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ResNet&#39;</span><span class="p">,</span> <span class="s1">&#39;Inception3&#39;</span><span class="p">,</span> <span class="s1">&#39;GoogLeNet&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SqueezeNet&#39;</span><span class="p">,</span> <span class="s1">&#39;DenseNet&#39;</span><span class="p">,</span> <span class="s1">&#39;ShuffleNetV2&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;Xception&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">pool</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the interface model that outputs feature activations at the</span>
<span class="sd">        designated layers and/or predictions. Intermediate layers are returned in</span>
<span class="sd">        the order of layers. predictions are returned last.</span>

<span class="sd">        Args:</span>
<span class="sd">            pooling (Callable or str, optional): PyTorch pooling function to use</span>
<span class="sd">                on feature layers. May be a string (&#39;avg&#39; or &#39;max&#39;) or a</span>
<span class="sd">                callable PyTorch function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span> <span class="o">=</span> <span class="n">pooling</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pooling</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pooling</span> <span class="o">==</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span>
                <span class="n">pooling</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">adaptive_avg_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">pooling</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                <span class="n">pooling</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">adaptive_max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized pooling value </span><span class="si">{</span><span class="n">pooling</span><span class="si">}</span><span class="s2">. &quot;</span>
                                 <span class="s2">&quot;Expected &#39;avg&#39;, &#39;max&#39;, or custom Tensor op.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_activation</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">pooling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">pooling</span><span class="p">(</span><span class="n">output</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">hook</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">la</span> <span class="o">==</span> <span class="s1">&#39;postconv&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_postconv</span><span class="p">()</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span>
                        <span class="n">get_activation</span><span class="p">(</span><span class="s1">&#39;postconv&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">la_out</span> <span class="o">=</span> <span class="n">torch_utils</span><span class="o">.</span><span class="n">get_module_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">la</span><span class="p">)</span>
                    <span class="n">la_out</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span>
                        <span class="n">get_activation</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">FeaturesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                       <span class="s2">&quot; for self.layers&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate output and layer sizes</span>
        <span class="n">rand_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">rand_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_preds</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Multi-categorical outcomes is experimental &quot;</span>
                        <span class="s2">&quot;for this interface.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_preds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_preds</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of classes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of activation features: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;slideflow.model.torch.Features&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span>
                <span class="s1">&#39;include_preds&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_preds</span><span class="p">,</span>
                <span class="s1">&#39;apply_softmax&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">,</span>
                <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span>
            <span class="p">}</span>
        <span class="p">}</span></div>


<span class="k">class</span> <span class="nc">UncertaintyInterface</span><span class="p">(</span><span class="n">Features</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">channels_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">apply_softmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pooling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">load_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span><span class="p">,</span>
            <span class="n">channels_last</span><span class="o">=</span><span class="n">channels_last</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">apply_softmax</span><span class="o">=</span><span class="n">apply_softmax</span><span class="p">,</span>
            <span class="n">pooling</span><span class="o">=</span><span class="n">pooling</span><span class="p">,</span>
            <span class="n">load_method</span><span class="o">=</span><span class="n">load_method</span><span class="p">,</span>
            <span class="n">include_preds</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">torch_utils</span><span class="o">.</span><span class="n">enable_dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
        <span class="c1"># TODO: As the below to-do suggests, this should be updated</span>
        <span class="c1"># for multi-class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_uncertainty</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;UncertaintyInterface not yet implemented for multi-class&quot;</span>
                     <span class="s2">&quot; models&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;include_preds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;include_preds&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UncertaintyInterface requires include_preds=True&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;include_preds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">torch_utils</span><span class="o">.</span><span class="n">enable_dropout</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    path=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    layers=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    apply_softmax=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;    pooling=</span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">no_grad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return activations (mean), predictions (mean), and uncertainty</span>
<span class="sd">        (stdev) for a single batch of images.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">(</span><span class="n">inp</span><span class="p">),</span> <span class="s2">&quot;Input tensor must be float&quot;</span>
        <span class="n">_mp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">))</span>

        <span class="n">out_pred_drop</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">out_act_drop</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">mixed_precision</span><span class="o">=</span><span class="n">_mp</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span> <span class="k">if</span> <span class="n">no_grad</span> <span class="k">else</span> <span class="n">no_scope</span><span class="p">():</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_last</span><span class="p">:</span>
                        <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">:</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="p">[</span><span class="n">softmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">logits</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">:</span>
                        <span class="n">logits</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">):</span>
                        <span class="n">out_pred_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
                            <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">logits</span><span class="p">)</span>
                        <span class="p">]</span>

            <span class="n">layer_activations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                    <span class="n">act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">[</span><span class="n">la</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">la</span> <span class="o">==</span> <span class="s1">&#39;postconv&#39;</span><span class="p">:</span>
                        <span class="n">act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postconv_processing</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                    <span class="n">layer_activations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
                    <span class="n">out_act_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_activations</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">):</span>
            <span class="n">out_pred_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out_pred_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out_pred_drop</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># TODO: Only takes STDEV from first outcome category which works for</span>
        <span class="c1"># outcomes with 2 categories, but a better solution is needed</span>
        <span class="c1"># for num_categories &gt; 2</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out_pred_drop</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
                <span class="n">out_act_drop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out_act_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">reduced_activations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_act_drop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">reduced_activations</span> <span class="o">+</span> <span class="p">[</span><span class="n">predictions</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">uncertainty</span>

    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;slideflow.model.torch.UncertaintyInterface&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;layers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span>
                <span class="s1">&#39;apply_softmax&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_softmax</span><span class="p">,</span>
                <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pooling</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../../../model_torch/#slideflow.model.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a model trained with Slideflow.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to saved model. Must be a model trained in Slideflow.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.nn.Module: Loaded model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_classes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">outcome</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">][</span><span class="n">outcome</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
        <span class="n">num_slide_features</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">]),</span>
        <span class="n">pretrain</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="lazy_load_pretrained"><a class="viewcode-back" href="../../../../model_torch/#slideflow.model.lazy_load_pretrained">[docs]</a><span class="k">def</span> <span class="nf">lazy_load_pretrained</span><span class="p">(</span>
    <span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">to_load</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads pretrained model weights into an existing module, ignoring</span>
<span class="sd">    incompatible Tensors.</span>

<span class="sd">    Args:</span>
<span class="sd">        module (torch.nn.Module): Destination module for weights.</span>
<span class="sd">        to_load (str, torch.nn.Module): Module with weights to load. Either</span>
<span class="sd">            path to PyTorch Slideflow model, or an existing PyTorch module.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get state dictionaries</span>
    <span class="n">current_model_dict</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_load</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">loaded_state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">to_load</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loaded_state_dict</span> <span class="o">=</span> <span class="n">to_load</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

    <span class="c1"># Only transfer valid states</span>
    <span class="n">new_state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="n">current_model_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                          <span class="k">else</span>  <span class="n">current_model_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">current_model_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                     <span class="n">loaded_state_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())}</span>
    <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2"> Tensor states from &quot;</span>
             <span class="sa">f</span><span class="s2">&quot;pretrained model [green] </span><span class="si">{</span><span class="n">to_load</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">module</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">new_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</pre></div>

             </article>

            </div>
            <footer>




    <hr>



  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, James M Dolezal.

    </p>
  </div>

      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>


</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">

            </div>
          </div>
        </div>
      </section>
    </div>







       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/sphinx_highlight.js"></script>



  <script type="text/javascript" src="../../../../_static/js/vendor/jquery-3.6.3.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1/">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/slideflow/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>