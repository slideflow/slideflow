


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slideflow.slide &mdash; slideflow 1.2.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-43E5QNVXH2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-43E5QNVXH2');
  </script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1.html">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/jamesdolezal/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  1.2
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_setup.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layer_activations.html">Features / layer activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_loops.html">Custom training loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uq.html">Uncertainty quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clam.html">CLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project.html">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataset.html">slideflow.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../heatmap.html">slideflow.heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io.html">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io_tensorflow.html">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io_torch.html">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gan.html">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../grad.html">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mosaic.html">slideflow.mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../norm.html">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slide.html">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stats.html">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../util.html">slideflow.util</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial1.html">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial2.html">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial3.html">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial4.html">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial5.html">Tutorial 5: Creating a mosaic map</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../index.html">Module code</a> &gt;</li>
        
      <li>slideflow.slide</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for slideflow.slide</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;This module includes tools to convolutionally section whole slide images</span>
<span class="sd">into tiles. These tessellated tiles can be exported as PNG or JPG as raw</span>
<span class="sd">images or stored in the binary format TFRecords, with or without augmentation.</span>

<span class="sd">Requires: libvips (https://libvips.github.io/libvips/).&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcol</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio.features</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="k">as</span> <span class="nn">sg</span>
<span class="kn">import</span> <span class="nn">shapely.affinity</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">import</span> <span class="nn">skimage</span>
<span class="kn">import</span> <span class="nn">skimage.filters</span>
<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">UnidentifiedImageError</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">img_as_ubyte</span>
<span class="kn">from</span> <span class="nn">skimage.color</span> <span class="kn">import</span> <span class="n">rgb2gray</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">slideflow.slide.report</span> <span class="kn">import</span> <span class="n">ExtractionPDF</span>  <span class="c1"># noqa F401</span>
<span class="kn">from</span> <span class="nn">slideflow.slide.report</span> <span class="kn">import</span> <span class="n">ExtractionReport</span><span class="p">,</span> <span class="n">SlideReport</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">SUPPORTED_FORMATS</span><span class="p">,</span> <span class="n">Path</span>  <span class="c1"># noqa F401</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">path_to_name</span>  <span class="c1"># noqa F401</span>
<span class="kn">from</span> <span class="nn">rich.progress</span> <span class="kn">import</span> <span class="n">Progress</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyvips</span> <span class="k">as</span> <span class="nn">vips</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to load vips; slide processing will be unavailable. &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Error raised: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">DecompressionBombWarning</span><span class="p">)</span>
<span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="mi">100000000000</span>
<span class="n">DEFAULT_JPG_MPP</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">OPS_LEVEL_COUNT</span> <span class="o">=</span> <span class="s1">&#39;openslide.level-count&#39;</span>
<span class="n">OPS_MPP_X</span> <span class="o">=</span> <span class="s1">&#39;openslide.mpp-x&#39;</span>
<span class="n">OPS_VENDOR</span> <span class="o">=</span> <span class="s1">&#39;openslide.vendor&#39;</span>
<span class="n">TIF_EXIF_KEY_MPP</span> <span class="o">=</span> <span class="mi">65326</span>
<span class="n">OPS_WIDTH</span> <span class="o">=</span> <span class="s1">&#39;width&#39;</span>
<span class="n">OPS_HEIGHT</span> <span class="o">=</span> <span class="s1">&#39;height&#39;</span>
<span class="n">DEFAULT_WHITESPACE_THRESHOLD</span> <span class="o">=</span> <span class="mi">230</span>
<span class="n">DEFAULT_WHITESPACE_FRACTION</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">DEFAULT_GRAYSPACE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">DEFAULT_GRAYSPACE_FRACTION</span> <span class="o">=</span> <span class="mf">0.6</span>


<span class="k">def</span> <span class="nf">OPS_LEVEL_HEIGHT</span><span class="p">(</span><span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;openslide.level[</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">].height&#39;</span>


<span class="k">def</span> <span class="nf">OPS_LEVEL_WIDTH</span><span class="p">(</span><span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;openslide.level[</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">].width&#39;</span>


<span class="k">def</span> <span class="nf">OPS_LEVEL_DOWNSAMPLE</span><span class="p">(</span><span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;openslide.level[</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">].downsample&#39;</span>


<span class="n">VIPS_FORMAT_TO_DTYPE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;uchar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="s1">&#39;char&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
    <span class="s1">&#39;ushort&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
    <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
    <span class="s1">&#39;uint&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
    <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s1">&#39;double&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="s1">&#39;complex&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
    <span class="s1">&#39;dpcomplex&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_update_kw_with_defaults</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Updates a set of keyword arguments with default extraction values.</span>
<span class="sd">    for whitepsace/grayspace filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_fraction&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_FRACTION</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_threshold&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_THRESHOLD</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_fraction&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_FRACTION</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_threshold&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_THRESHOLD</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span>
    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">_polyArea</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_convert_img_to_format</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">img_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span>
            <span class="s1">&#39;.png&#39;</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">img_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span>
            <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">),</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">IMWRITE_JPEG_QUALITY</span><span class="p">),</span> <span class="mi">100</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown image format </span><span class="si">{</span><span class="n">img_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_draw_roi</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Draw ROIs on image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img (Union[np.ndarray, str]): Image.</span>
<span class="sd">        coords (List[List[int]]): ROI coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Image as numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">annotated_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">annotated_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">annotated_img</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">annPolys</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">zipped</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="s1">&#39;curve&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">annotated_img</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_roi_coords_from_image</span><span class="p">(</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">SimpleNamespace</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="c1"># Scale ROI according to downsample level</span>
    <span class="n">extract_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">)</span>

    <span class="c1"># Scale ROI according to image resizing</span>
    <span class="n">resize_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">proc_ann</span><span class="p">(</span><span class="n">ann</span><span class="p">):</span>
        <span class="c1"># Scale to full image size</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="c1"># Offset coordinates to extraction window</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
        <span class="c1"># Rescale according to downsampling and resizing</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="p">(</span><span class="n">extract_scale</span> <span class="o">*</span> <span class="n">resize_scale</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">coord</span>

    <span class="c1"># Filter out ROIs not in this tile</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">rois</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">proc_ann</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ll</span> <span class="o">&lt;=</span> <span class="n">coord</span><span class="p">,</span> <span class="n">coord</span> <span class="o">&lt;=</span> <span class="n">ur</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">coords_in_tile</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_in_tile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">+=</span> <span class="p">[</span><span class="n">coords_in_tile</span><span class="p">]</span>

    <span class="c1"># Convert ROI to bounding box that fits within tile</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">yolo_anns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
        <span class="n">max_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">min_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_x</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_y</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="n">yolo_anns</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">]]</span>
        <span class="n">boxes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">],</span>
            <span class="p">[</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">],</span>
            <span class="p">[</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">],</span>
            <span class="p">[</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">]</span>
        <span class="p">])]</span>
    <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">yolo_anns</span>


<span class="k">def</span> <span class="nf">_wsi_extraction_worker</span><span class="p">(</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">SimpleNamespace</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
    <span class="sd">&#39;&#39;&#39;Multiprocessing worker for WSI. Extracts tile at given coordinates.&#39;&#39;&#39;</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">x_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">)</span>
    <span class="n">y_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">)</span>

    <span class="c1"># Skip tiles filtered out with QC or ROI</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;skip&#39;</span>

    <span class="c1"># If downsampling is enabled, read image from highest level</span>
    <span class="c1"># to perform filtering; otherwise filter from our target level</span>
    <span class="n">slide</span> <span class="o">=</span> <span class="n">_VIPSWrapper</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">whitespace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">grayspace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">filter_downsample_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">filter_extract_px</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">//</span> <span class="n">args</span><span class="o">.</span><span class="n">filter_downsample_ratio</span>
            <span class="n">filter_region</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                <span class="n">args</span><span class="o">.</span><span class="n">filter_downsample_level</span><span class="p">,</span>
                <span class="p">(</span><span class="n">filter_extract_px</span><span class="p">,</span> <span class="n">filter_extract_px</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Read the region and resize to target size</span>
            <span class="n">filter_region</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                <span class="n">args</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">,</span>
                <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Perform whitespace filtering [Libvips]</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">whitespace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ws_fraction</span> <span class="o">=</span> <span class="n">filter_region</span><span class="o">.</span><span class="n">bandmean</span><span class="p">()</span><span class="o">.</span><span class="n">relational_const</span><span class="p">(</span>
                <span class="s1">&#39;more&#39;</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">whitespace_threshold</span>
            <span class="p">)</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span> <span class="o">/</span> <span class="mi">255</span>
            <span class="k">if</span> <span class="n">ws_fraction</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">whitespace_fraction</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Perform grayspace filtering [Libvips]</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grayspace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">hsv_region</span> <span class="o">=</span> <span class="n">filter_region</span><span class="o">.</span><span class="n">sRGB2HSV</span><span class="p">()</span>
            <span class="n">gs_fraction</span> <span class="o">=</span> <span class="n">hsv_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">relational_const</span><span class="p">(</span>
                <span class="s1">&#39;less&#39;</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">grayspace_threshold</span><span class="o">*</span><span class="mi">255</span>
            <span class="p">)</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span> <span class="o">/</span> <span class="mi">255</span>
            <span class="k">if</span> <span class="n">gs_fraction</span> <span class="o">&gt;</span> <span class="n">args</span><span class="o">.</span><span class="n">grayspace_fraction</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Prepare return dict with WS/GS fraction</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">]}</span>
    <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span><span class="p">]})</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">grayspace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;gs_fraction&#39;</span><span class="p">:</span> <span class="n">gs_fraction</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">whitespace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ws_fraction&#39;</span><span class="p">:</span> <span class="n">ws_fraction</span><span class="p">})</span>

    <span class="c1"># If dry run, return without the image</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="c1"># Normalizer</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">normalizer</span><span class="p">:</span>
        <span class="n">normalizer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">normalizer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">autoselect</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">normalizer</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">normalizer_source</span>
        <span class="p">)</span>

    <span class="c1"># Read the target downsample region now, if we were</span>
    <span class="c1"># filtering at a different level</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
        <span class="n">args</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">,</span>
        <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">bands</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># removes alpha</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">):</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">extract_px</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">region</span><span class="o">.</span><span class="n">height</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">img_format</span> <span class="o">!=</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">pngsave_buffer</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">jpegsave_buffer</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown image format </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">img_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Apply normalization</span>
        <span class="k">if</span> <span class="n">normalizer</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span><span class="p">:</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">png_to_png</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">img_format</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">jpeg_to_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown image format </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">img_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># The image could not be normalized,</span>
                <span class="c1"># which happens when a tile is primarily one solid color</span>
                <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Read regions into memory and convert to numpy arrays</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">vips2numpy</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

        <span class="c1"># Apply normalization</span>
        <span class="k">if</span> <span class="n">normalizer</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">rgb_to_rgb</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># The image could not be normalized,</span>
                <span class="c1"># which happens when a tile is primarily one solid color</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Include ROI / bounding box processing.</span>
    <span class="c1"># Used to visualize ROIs on extracted tiles, or to generate YoloV5 labels.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">yolo</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">draw_roi</span><span class="p">:</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">yolo_anns</span> <span class="o">=</span> <span class="n">_roi_coords_from_image</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">draw_roi</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">_draw_roi</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

    <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">yolo</span><span class="p">:</span>
        <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;yolo&#39;</span><span class="p">:</span> <span class="n">yolo_anns</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">return_dict</span>


<span class="k">def</span> <span class="nf">vips2numpy</span><span class="p">(</span><span class="n">vi</span><span class="p">:</span> <span class="s2">&quot;vips.Image&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Converts a VIPS image into a numpy array&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">vi</span><span class="o">.</span><span class="n">write_to_memory</span><span class="p">(),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="n">VIPS_FORMAT_TO_DTYPE</span><span class="p">[</span><span class="n">vi</span><span class="o">.</span><span class="n">format</span><span class="p">],</span>
                      <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">vi</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">vi</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">vi</span><span class="o">.</span><span class="n">bands</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">vips_resize</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">crop_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">target_px</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Resizes and crops an image using libvips.resize()</span>

<span class="sd">    Args:</span>
<span class="sd">        img (np.ndarray): Image.</span>
<span class="sd">        crop_width (int): Height/width of image crop (before resize).</span>
<span class="sd">        target_px (int): Target size of final image after resizing.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Resized image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="n">vips_image</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_memory</span><span class="p">(</span>
        <span class="n">img_data</span><span class="p">,</span>
        <span class="n">crop_width</span><span class="p">,</span>
        <span class="n">crop_width</span><span class="p">,</span>
        <span class="n">bands</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;uchar&quot;</span>
    <span class="p">)</span>
    <span class="n">vips_image</span> <span class="o">=</span> <span class="n">vips_image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">target_px</span><span class="o">/</span><span class="n">crop_width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vips2numpy</span><span class="p">(</span><span class="n">vips_image</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">log_extraction_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Logs tile extraction parameters.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;whitespace_fraction&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ws_f</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_FRACTION</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ws_f</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_fraction&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;whitespace_threshold&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ws_t</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_THRESHOLD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ws_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;whitespace_threshold&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;grayspace_fraction&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">gs_f</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_FRACTION</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gs_f</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_fraction&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;grayspace_threshold&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">gs_t</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_THRESHOLD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gs_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grayspace_threshold&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;normalizer&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting tiles using [magenta]</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;normalizer&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">[/] &#39;</span>
                 <span class="s1">&#39;normalization&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ws_f</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filtering tiles by whitespace fraction&#39;</span><span class="p">)</span>
        <span class="n">excl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(exclude if &gt;=</span><span class="si">{</span><span class="n">ws_f</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% whitespace)&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Whitespace defined as RGB avg &gt; </span><span class="si">{</span><span class="n">ws_t</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">excl</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gs_f</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filtering tiles by grayspace fraction&#39;</span><span class="p">)</span>
        <span class="n">excl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(exclude if &gt;=</span><span class="si">{</span><span class="n">gs_f</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% grayspace)&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Grayspace defined as HSV avg &lt; </span><span class="si">{</span><span class="n">gs_t</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">excl</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_VIPSWrapper</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for VIPS to preserve openslide-like functions.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">access</span><span class="o">=</span><span class="n">vips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">RANDOM</span>
        <span class="p">)</span>
        <span class="n">loaded_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span>

        <span class="c1"># Load image properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">loaded_image</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_WIDTH</span><span class="p">]),</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_HEIGHT</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># If Openslide MPP is not available, try reading from metadata</span>
        <span class="k">if</span> <span class="n">OPS_MPP_X</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Microns-Per-Pixel (MPP) not found, Searching EXIF&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">TIF_EXIF_KEY_MPP</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">mpp</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="n">TIF_EXIF_KEY_MPP</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Using MPP </span><span class="si">{</span><span class="n">mpp</span><span class="si">}</span><span class="s2"> per EXIF </span><span class="si">{</span><span class="n">TIF_EXIF_KEY_MPP</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpp</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">)</span>
                          <span class="ow">and</span> <span class="s1">&#39;xres&#39;</span> <span class="ow">in</span> <span class="n">loaded_image</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()):</span>
                        <span class="n">xres</span> <span class="o">=</span> <span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xres&#39;</span><span class="p">)</span>  <span class="c1"># 4000.0</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">xres</span> <span class="o">==</span> <span class="mf">4000.0</span>
                           <span class="ow">and</span> <span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution-unit&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cm&#39;</span><span class="p">):</span>
                            <span class="c1"># xres = xres # though resolution from tiffinfo</span>
                            <span class="c1"># says 40000 pixels/cm, for some reason the xres</span>
                            <span class="c1"># val is 4000.0, so multipley by 10.</span>
                            <span class="c1"># Convert from pixels/cm to cm/pixels, then convert</span>
                            <span class="c1"># to microns by multiplying by 1000</span>
                            <span class="n">mpp_x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">xres</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mpp_x</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Using MPP </span><span class="si">{</span><span class="n">mpp_x</span><span class="si">}</span><span class="s2"> per TIFF &#39;xres&#39; field&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xres&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> and &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution-unit&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Missing Microns-Per-Pixel (MPP) for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_JPG_MPP</span>
            <span class="k">except</span> <span class="n">UnidentifiedImageError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PIL error; unable to read slide </span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Prepare downsample levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_downsample_levels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">OPS_LEVEL_COUNT</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_LEVEL_COUNT</span><span class="p">])</span>
            <span class="c1"># Calculate level metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># type: List[Dict[str, Any]]</span>
            <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_count</span><span class="p">):</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OPS_LEVEL_WIDTH</span><span class="p">(</span><span class="n">lev</span><span class="p">)))</span>
                <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OPS_LEVEL_HEIGHT</span><span class="p">(</span><span class="n">lev</span><span class="p">)))</span>
                <span class="n">downsample</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OPS_LEVEL_DOWNSAMPLE</span><span class="p">(</span><span class="n">lev</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">+=</span> <span class="p">[{</span>
                    <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                    <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
                    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
                    <span class="s1">&#39;downsample&#39;</span><span class="p">:</span> <span class="n">downsample</span>
                <span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[{</span>
                    <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span>
                    <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;downsample&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_downsamples</span> <span class="o">=</span> <span class="p">[</span><span class="n">lev</span><span class="p">[</span><span class="s1">&#39;downsample&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">lev</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">best_level_for_downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downsample</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Return best level to match a given desired downsample.&#39;&#39;&#39;</span>
        <span class="n">max_downsample</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">downsample</span><span class="p">:</span>
                <span class="n">max_downsample</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_downsamples</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">max_downsample</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">max_level</span>

    <span class="k">def</span> <span class="nf">get_downsampled_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;vips.Image&quot;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Returns a VIPS image of a given downsample.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_downsample_levels</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_downsample_levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">downsampled_image</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                    <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">access</span><span class="o">=</span><span class="n">vips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">RANDOM</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_downsample_levels</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="n">level</span><span class="p">:</span> <span class="n">downsampled_image</span>
                <span class="p">})</span>
                <span class="k">return</span> <span class="n">downsampled_image</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">read_region</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_level_dim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">downsample_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">extract_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;vips.Image&quot;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Extracts a region from the image at the given downsample level.&#39;&#39;&#39;</span>
        <span class="n">base_level_x</span><span class="p">,</span> <span class="n">base_level_y</span> <span class="o">=</span> <span class="n">base_level_dim</span>
        <span class="n">extract_width</span><span class="p">,</span> <span class="n">extract_height</span> <span class="o">=</span> <span class="n">extract_size</span>
        <span class="n">downsample_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">downsample_level</span><span class="p">]</span>
        <span class="n">downsample_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_level_x</span> <span class="o">/</span> <span class="n">downsample_factor</span><span class="p">)</span>
        <span class="n">downsample_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_level_y</span> <span class="o">/</span> <span class="n">downsample_factor</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_downsampled_image</span><span class="p">(</span><span class="n">downsample_level</span><span class="p">)</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span>
            <span class="n">downsample_x</span><span class="p">,</span>
            <span class="n">downsample_y</span><span class="p">,</span>
            <span class="n">extract_width</span><span class="p">,</span>
            <span class="n">extract_height</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">region</span>


<span class="k">class</span> <span class="nc">_JPGslideToVIPS</span><span class="p">(</span><span class="n">_VIPSWrapper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for JPG files, which do not possess separate levels, to</span>
<span class="sd">    preserve openslide-like functions.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span><span class="o">.</span><span class="n">hasalpha</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span><span class="o">.</span><span class="n">addalpha</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)})</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_WIDTH</span><span class="p">])</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_HEIGHT</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_downsample_levels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_image</span>
        <span class="p">}</span>
        <span class="c1"># Calculate level metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
            <span class="s1">&#39;downsample&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_downsamples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_dimensions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)]</span>

        <span class="c1"># MPP data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TIF_EXIF_KEY_MPP</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">mpp</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="n">TIF_EXIF_KEY_MPP</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using MPP </span><span class="si">{</span><span class="n">mpp</span><span class="si">}</span><span class="s2"> per EXIF field </span><span class="si">{</span><span class="n">TIF_EXIF_KEY_MPP</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting MPP to default </span><span class="si">{</span><span class="n">DEFAULT_JPG_MPP</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_JPG_MPP</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_JPG_MPP</span>


<span class="k">class</span> <span class="nc">ROI</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Object container for ROI annotations.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Tuple[int, int]]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;ROI (coords=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">add_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scaled_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_coord</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_BaseLoader</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Loads an SVS slide and makes preparations for tile extraction.</span>

<span class="sd">    Should not be used directly; this class must be inherited and extended</span>
<span class="sd">    by either WSI or TMA child classes.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">pb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Progress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">_shortname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">=</span> <span class="n">tile_px</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_downsample</span> <span class="o">=</span> <span class="n">enable_downsample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Image.Image]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride_div</span> <span class="o">=</span> <span class="n">stride_div</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qc_mpp</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[float]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qc_method</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blur_burden</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[float]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>
        <span class="n">filetype</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Initiate supported slide reader</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find slide </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filetype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SUPPORTED_FORMATS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filetype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slide</span> <span class="o">=</span> <span class="n">_JPGslideToVIPS</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># type: _VIPSWrapper</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slide</span> <span class="o">=</span> <span class="n">_VIPSWrapper</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">vips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error loading slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: unsupported filetype &#39;</span><span class="si">{</span><span class="n">filetype</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Collect basic slide information</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_MPP_X</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Slide [green]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/] missing MPP (</span><span class="si">{</span><span class="n">OPS_MPP_X</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Calculate downsample by magnification</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">assert_is_mag</span><span class="p">(</span><span class="n">tile_um</span><span class="p">)</span>
            <span class="n">_mag_lvl</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span><span class="p">)</span>
            <span class="n">mag_levels</span> <span class="o">=</span> <span class="n">_mag_lvl</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">closest_mag</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">mag_levels</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">to_mag</span><span class="p">(</span><span class="n">tile_um</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">closest_mag</span> <span class="o">-</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">to_mag</span><span class="p">(</span><span class="n">tile_um</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Could not find magnification level &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;matching </span><span class="si">{</span><span class="n">tile_um</span><span class="si">}</span><span class="s2"> (closest: </span><span class="si">{</span><span class="n">closest_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="n">ds_level</span> <span class="o">=</span> <span class="n">mag_levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">closest_mag</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enable_downsample</span> <span class="ow">and</span> <span class="n">ds_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to use magnification </span><span class="si">{</span><span class="n">tile_um</span><span class="si">}</span><span class="s2"> with &quot;</span>
                                 <span class="s2">&quot;enable_downsample=False&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">ds_level</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">=</span> <span class="n">tile_px</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span> <span class="o">*</span> <span class="n">tile_px</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="n">tile_px</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using magnification </span><span class="si">{</span><span class="n">closest_mag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x (level=&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_level</span><span class="si">}</span><span class="s2">, tile_um=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate downsample level by tile micron size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tile_um</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="o">=</span> <span class="n">tile_um</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_um</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="n">tile_px</span>
            <span class="k">if</span> <span class="n">enable_downsample</span><span class="p">:</span>
                <span class="n">ds_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">best_level_for_downsample</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds_level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">ds_level</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span>

        <span class="c1"># Calculate filter dimensions (low magnification for filtering out</span>
        <span class="c1"># white background and performing edge detection)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_magnification</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_magnification</span><span class="p">)</span>

        <span class="c1"># Calculate shape and stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span> <span class="o">=</span> <span class="n">ds_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">ds_level</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">//</span> <span class="n">stride_div</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">//</span> <span class="n">stride_div</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vendor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">OPS_VENDOR</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">OPS_VENDOR</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_build_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">mpp_to_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpp</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">mpp</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">mpp</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dim_to_mpp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span><span class="p">)</span> <span class="o">/</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_qc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_coord</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qc_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;QC removed from slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">qc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">blur_radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">blur_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="n">filter_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">blur_mpp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Applies quality control to a slide, performing filtering based on</span>
<span class="sd">        a whole-slide image thumbnail.</span>

<span class="sd">        &#39;blur&#39; method filters out blurry or out-of-focus slide sections.</span>
<span class="sd">        &#39;otsu&#39; method filters out background based on automatic saturation</span>
<span class="sd">        thresholding in the HSV colorspace.</span>
<span class="sd">        &#39;both&#39; applies both methods of filtering.</span>

<span class="sd">        Args:</span>
<span class="sd">            method (str): Quality control method, &#39;blur&#39;, &#39;otsu&#39;, or &#39;both&#39;.</span>
<span class="sd">            blur_radius (int, optional): Blur radius.</span>
<span class="sd">            blur_threshold (float, optional): Blur threshold.</span>
<span class="sd">            filter_threshold (float, optional): Percent of a tile detected as</span>
<span class="sd">                background that will trigger a tile to be discarded.</span>
<span class="sd">                Defaults to 0.6.</span>
<span class="sd">            blur_mpp (float, optional): Size of WSI thumbnail on which to</span>
<span class="sd">                perform blur QC, in microns-per-pixel. Defaults to 4</span>
<span class="sd">                (equivalent magnification = 2.5 X).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="s1">&#39;otsu&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">QCError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown QC method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qc_mpp</span> <span class="o">=</span> <span class="n">blur_mpp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qc_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># Blur QC must be performed at a set microns-per-pixel rather than</span>
        <span class="c1"># downsample level, as blur detection is much for sensitive to</span>
        <span class="c1"># effective magnification than Otsu&#39;s thresholding</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">thumb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">mpp</span><span class="o">=</span><span class="n">blur_mpp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thumb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">QCError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Thumbnail error for slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">, QC failed&quot;</span>
                <span class="p">)</span>
            <span class="n">thumb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thumb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thumb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">thumb</span> <span class="o">=</span> <span class="n">thumb</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">rgb2gray</span><span class="p">(</span><span class="n">thumb</span><span class="p">)</span>
            <span class="n">img_laplace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">skimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">laplace</span><span class="p">(</span><span class="n">gray</span><span class="p">))</span>
            <span class="n">gaussian</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">img_laplace</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">blur_radius</span><span class="p">)</span>
            <span class="n">blur_mask</span> <span class="o">=</span> <span class="n">gaussian</span> <span class="o">&lt;=</span> <span class="n">blur_threshold</span>
            <span class="n">lev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">qc_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span>
            <span class="n">qc_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">/</span> <span class="n">blur_mpp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span> <span class="o">=</span> <span class="n">blur_mask</span>

        <span class="c1"># Otsu&#39;s thresholding can be done on the lowest downsample level</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;otsu&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">otsu_thumb</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">access</span><span class="o">=</span><span class="n">vips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_count</span><span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">otsu_thumb</span> <span class="o">=</span> <span class="n">vips2numpy</span><span class="p">(</span><span class="n">otsu_thumb</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">vips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">QCError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Thumbnail error for slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">, QC failed&quot;</span>
                <span class="p">)</span>
            <span class="n">lev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_count</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">qc_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">otsu_thumb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">otsu_thumb</span> <span class="o">=</span> <span class="n">otsu_thumb</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># Only apply Otsu thresholding within ROI, if present</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span><span class="p">):</span>
                <span class="n">ofact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span>
                <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">otsu_thumb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">otsu_thumb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">polys</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">sa</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">xfact</span><span class="o">=</span><span class="n">ofact</span><span class="p">,</span> <span class="n">yfact</span><span class="o">=</span><span class="n">ofact</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span>
                <span class="p">]</span>
                <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                    <span class="n">polys</span><span class="p">,</span>
                    <span class="n">out_shape</span><span class="o">=</span><span class="n">otsu_thumb</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">otsu_thumb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span>
                    <span class="n">otsu_thumb</span><span class="p">,</span>
                    <span class="n">otsu_thumb</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">roi_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">hsv_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">otsu_thumb</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2HSV</span><span class="p">)</span>
            <span class="n">img_med</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">hsv_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_OTSU</span><span class="o">+</span><span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">otsu_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img_med</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="n">otsu_mask</span> <span class="o">=</span> <span class="n">otsu_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span> <span class="o">=</span> <span class="n">otsu_mask</span>

        <span class="c1"># If performing both, ensure the mask sizes are equivalent (shrinks to</span>
        <span class="c1"># the size of the smaller mask - Otsu)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">blur_mask</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">blur_mask</span><span class="p">,</span> <span class="n">otsu_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">blur_mask</span> <span class="o">=</span> <span class="n">blur_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">blur_mask</span><span class="p">,</span> <span class="n">otsu_mask</span><span class="p">)</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">blur_mask</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">blur_mask</span><span class="p">,</span> <span class="n">otsu_mask</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blur_burden</span> <span class="o">=</span> <span class="n">blur</span> <span class="o">/</span> <span class="p">(</span><span class="n">blur_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">blur_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blur burden: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blur_burden</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Filter coordinates</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">qc_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">*</span> <span class="n">qc_ratio</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">qc_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">qc_ratio</span><span class="p">)</span>
            <span class="n">qc_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">qc_ratio</span><span class="p">)</span>
            <span class="n">submask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span><span class="p">[</span><span class="n">qc_y</span><span class="p">:(</span><span class="n">qc_y</span><span class="o">+</span><span class="n">qc_width</span><span class="p">),</span> <span class="n">qc_x</span><span class="p">:(</span><span class="n">qc_x</span><span class="o">+</span><span class="n">qc_width</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">submask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">filter_threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_as_ubyte</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span><span class="p">))</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s)&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;QC (</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">) complete for slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dur</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="k">def</span> <span class="nf">square_thumb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Returns a square thumbnail of the slide, with black bar borders.</span>

<span class="sd">        Args:</span>
<span class="sd">            width (int): Width/height of thumbnail in pixels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL image</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get thumbnail image and dimensions via fastest method available</span>
        <span class="n">associated_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;slide-associated-images&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;slide-associated-images&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span>
           <span class="ow">and</span> <span class="s1">&#39;thumbnail&#39;</span> <span class="ow">in</span> <span class="n">associated_images</span><span class="p">):</span>
            <span class="n">vips_thumb</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">openslideload</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">associated</span><span class="o">=</span><span class="s1">&#39;thumbnail&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_count</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">vips_thumb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">get_downsampled_image</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">vips_thumb</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">vips_thumb</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
        <span class="n">np_thumb</span> <span class="o">=</span> <span class="n">vips2numpy</span><span class="p">(</span><span class="n">vips_thumb</span><span class="p">)</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np_thumb</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

        <span class="c1"># Standardize to square with black borders as needed</span>
        <span class="n">square_thumb</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
        <span class="n">square_thumb</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">width</span><span class="o">-</span><span class="n">height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">square_thumb</span>

    <span class="k">def</span> <span class="nf">thumb</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mpp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rois</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Returns PIL thumbnail of the slide.</span>

<span class="sd">        Args:</span>
<span class="sd">            mpp (float, optional): Microns-per-pixel, used to determine</span>
<span class="sd">                thumbnail size.</span>
<span class="sd">            width (int, optional): Alternatively, goal thumbnail width</span>
<span class="sd">                may be supplied.</span>
<span class="sd">            coords (list(int), optional): List of tile extraction coordinates</span>
<span class="sd">                to show as rectangles on the thumbnail, in [(x_center,</span>
<span class="sd">                y_center), ...] format. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL image</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># If no values provided, create thumbnail of width 1024</span>
        <span class="k">if</span> <span class="n">mpp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mpp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Either mpp or width must be given, but not both&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; (got mpp=</span><span class="si">{</span><span class="n">mpp</span><span class="si">}</span><span class="s2">, width=</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Calculate goal width/height according to specified microns-per-pixel</span>
        <span class="k">if</span> <span class="n">mpp</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">mpp</span><span class="p">)</span>
        <span class="c1"># Otherwise, calculate approximate mpp based on provided width</span>
        <span class="c1"># (to generate proportional height)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">mpp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">width</span>
        <span class="c1"># Calculate appropriate height</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">mpp</span><span class="p">)</span>

        <span class="c1"># Get thumb via libvips &amp; convert PIL Image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vendor</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="s1">&#39;leica&#39;</span><span class="p">:</span>
            <span class="c1"># The libvips thumbnail function does not work appropriately</span>
            <span class="c1"># with Leica SCN images, so a downsample level must be</span>
            <span class="c1"># manually specified.</span>
            <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">access</span><span class="o">=</span><span class="n">vips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_count</span><span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">vips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">np_thumb</span> <span class="o">=</span> <span class="n">vips2numpy</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">vips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading slide thumbnail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np_thumb</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span>  <span class="c1"># type: ignore</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">wh</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">wh</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">wh</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">wh</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image</span>

    <span class="k">def</span> <span class="nf">build_generator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">whitespace_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">whitespace_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grayspace_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grayspace_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
        <span class="n">full_core</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">yolo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">draw_roi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;mp.pool.Pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="n">lead_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Extracting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="si">}</span><span class="s1">um tiles&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">:</span>
            <span class="n">resize_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(resizing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="si">}</span><span class="s1">px -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="si">}</span><span class="s1">px)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resize_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="si">}</span><span class="s1">px, not resizing)&#39;</span>
        <span class="n">stride_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;stride: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span><span class="si">}</span><span class="s1">px&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">lead_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">resize_msg</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">stride_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="p">:</span>
            <span class="n">ups_msg</span> <span class="o">=</span> <span class="s1">&#39;Tiles will be up-scaled with bilinear interpolation&#39;</span>
            <span class="n">ups_amnt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="si">}</span><span class="s1">px -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="si">}</span><span class="s1">px)&#39;</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[red]&#39;!WARN!&#39;[/]&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">warn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ups_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ups_amnt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">extract_tiles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tfrecord_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tiles_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SlideReport</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Extracts tiles from slide using the build_generator() method,</span>
<span class="sd">        saving tiles into a TFRecord file or as loose JPG tiles in a directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            tfrecord_dir (str): If provided, saves tiles into a TFRecord file</span>
<span class="sd">                (named according to slide name) here.</span>
<span class="sd">            tiles_dir (str): If provided, saves loose images in a subdirectory</span>
<span class="sd">                 (per slide name) here.</span>
<span class="sd">            img_format (str): &#39;png&#39; or &#39;jpg&#39;. Format of images for internal</span>
<span class="sd">                storage in tfrecords. PNG (lossless) format recommended for</span>
<span class="sd">                fidelity, JPG (lossy) for efficiency. Defaults to &#39;jpg&#39;.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace. If 1, will not</span>
<span class="sd">                perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            normalizer (str, optional): Normalization to use on image tiles.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Path to normalizer source image.</span>
<span class="sd">                If None, will use slideflow.slide.norm_tile.jpg.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            full_core (bool, optional): Extract an entire detected core, rather</span>
<span class="sd">                than subdividing into image tiles. Defaults to False.</span>
<span class="sd">            shuffle (bool): Shuffle images during extraction.</span>
<span class="sd">            num_threads (int): Number of threads to allocate to workers.</span>
<span class="sd">            yolo (bool, optional): Export yolo-formatted tile-level ROI</span>
<span class="sd">                annotations (.txt) in the tile directory. Requires that</span>
<span class="sd">                tiles_dir is set. Defaults to False.</span>
<span class="sd">            draw_roi (bool, optional): Draws ROIs onto extracted tiles.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            dry_run (bool, optional): Determine tiles that would be extracted,</span>
<span class="sd">                but do not export any images. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">img_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid image format </span><span class="si">{</span><span class="n">img_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Make base directories</span>
        <span class="k">if</span> <span class="n">tfrecord_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tiles_dir</span><span class="p">:</span>
            <span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">)</span>

        <span class="c1"># Log to keep track of when tiles have finished extracting</span>
        <span class="c1"># To be used in case tile extraction is interrupted, so the slide</span>
        <span class="c1"># can be flagged for re-extraction</span>

        <span class="k">if</span> <span class="n">tfrecord_dir</span> <span class="ow">or</span> <span class="n">tiles_dir</span><span class="p">:</span>
            <span class="n">unfinished_marker</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tfrecord_dir</span> <span class="k">if</span> <span class="n">tfrecord_dir</span> <span class="k">else</span> <span class="n">tiles_dir</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.unfinished&#39;</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">unfinished_marker</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">marker_file</span><span class="p">:</span>
                <span class="n">marker_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tfrecord_dir</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">join</span><span class="p">(</span>
                <span class="n">tfrecord_dir</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.tfrecords&quot;</span>
            <span class="p">))</span>

        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="c1">#(self.pb is None),</span>
            <span class="n">img_format</span><span class="o">=</span><span class="n">img_format</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">generator</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">sample_tiles</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="n">generator_iterator</span> <span class="o">=</span> <span class="n">generator</span><span class="p">()</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">grid_locations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ws_fractions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gs_fractions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_wrote_to_tfr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dry_run</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dry_run&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;dry_run&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">slidename_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tile_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator_iterator</span><span class="p">):</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span>
            <span class="n">locations</span> <span class="o">+=</span> <span class="p">[</span><span class="n">location</span><span class="p">]</span>
            <span class="n">grid_locations</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;ws_fraction&#39;</span> <span class="ow">in</span> <span class="n">tile_dict</span><span class="p">:</span>
                <span class="n">ws_fractions</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;ws_fraction&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;gs_fraction&#39;</span> <span class="ow">in</span> <span class="n">tile_dict</span><span class="p">:</span>
                <span class="n">gs_fractions</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;gs_fraction&#39;</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">image_string</span> <span class="o">=</span> <span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_tiles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">sample_tiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">image_string</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tiles_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tfrecord_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">tiles_dir</span><span class="p">:</span>
                <span class="n">img_f</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                    <span class="n">tiles_dir</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">img_format</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">img_f</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_string</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;yolo&#39;</span> <span class="ow">in</span> <span class="n">tile_dict</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;yolo&#39;</span><span class="p">]):</span>
                    <span class="n">yolo_f</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yolo_f</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;yolo&#39;</span><span class="p">]:</span>
                            <span class="n">yolo_str_fmt</span> <span class="o">=</span> <span class="s2">&quot;0 </span><span class="si">{:.3f}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yolo_str_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">ann</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">ann</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">ann</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">ann</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="p">))</span>
            <span class="k">if</span> <span class="n">tfrecord_dir</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">serialized_record</span><span class="p">(</span>
                    <span class="n">slidename_bytes</span><span class="p">,</span>
                    <span class="n">image_string</span><span class="p">,</span>
                    <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">num_wrote_to_tfr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">tfrecord_dir</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">num_wrote_to_tfr</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.tfrecords&quot;</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No tiles extracted for [green]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generator_iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tfrecord_dir</span> <span class="ow">or</span> <span class="n">tiles_dir</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">unfinished_marker</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to mark slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> as complete&quot;</span><span class="p">)</span>

        <span class="c1"># Assemble report DataFrame</span>
        <span class="n">loc_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
        <span class="n">grid_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_locations</span><span class="p">)</span>
        <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;loc_x&#39;</span><span class="p">:</span> <span class="n">loc_np</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;loc_y&#39;</span><span class="p">:</span> <span class="n">loc_np</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;grid_x&#39;</span><span class="p">:</span> <span class="n">grid_np</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;grid_y&#39;</span><span class="p">:</span> <span class="n">grid_np</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">ws_fractions</span><span class="p">:</span>
            <span class="n">df_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ws_fraction&#39;</span><span class="p">:</span> <span class="n">ws_fractions</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">gs_fractions</span><span class="p">:</span>
            <span class="n">df_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;gs_fraction&#39;</span><span class="p">:</span> <span class="n">gs_fractions</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_dict</span><span class="p">)</span>

        <span class="c1"># Generate extraction report</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">report_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">blur_burden</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blur_burden</span><span class="p">,</span>
                <span class="n">num_tiles</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">),</span>
                <span class="n">qc_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qc_mask</span><span class="p">,</span>
                <span class="n">locations</span><span class="o">=</span><span class="n">df</span>
            <span class="p">)</span>
            <span class="n">slide_report</span> <span class="o">=</span> <span class="n">SlideReport</span><span class="p">(</span>
                <span class="n">sample_tiles</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">report_data</span><span class="p">,</span>
                <span class="n">thumb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span>
                    <span class="n">coords</span><span class="o">=</span><span class="n">locations</span><span class="p">,</span>
                    <span class="n">rois</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">!=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">slide_report</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rois</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Performs a dry run of tile extraction without saving any images,</span>
<span class="sd">        returning a PIL image of the slide thumbnail annotated with a grid of</span>
<span class="sd">        tiles that were marked for extraction.</span>

<span class="sd">        Args:</span>
<span class="sd">            rois (bool, optional): Draw ROI annotation(s) onto the image.</span>
<span class="sd">                Defaults to True.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is considered</span>
<span class="sd">                whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace. If 1, will not</span>
<span class="sd">                perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            full_core (bool, optional): Extract an entire detected core, rather</span>
<span class="sd">                than subdividing into image tiles. Defaults to False.</span>
<span class="sd">            num_threads (int): Number of threads to allocate to workers.</span>
<span class="sd">            yolo (bool, optional): Export yolo-formatted tile-level ROI</span>
<span class="sd">                annotations (.txt) in the tile directory. Requires that</span>
<span class="sd">                tiles_dir is set. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;show_progress&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show_progress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">rois</span><span class="o">=</span><span class="n">rois</span><span class="p">)</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tile_dict</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">():</span>
            <span class="n">locations</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tile_dict</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">locations</span><span class="p">,</span> <span class="n">rois</span><span class="o">=</span><span class="n">rois</span><span class="p">)</span>


<div class="viewcode-block" id="WSI"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI">[docs]</a><span class="k">class</span> <span class="nc">WSI</span><span class="p">(</span><span class="n">_BaseLoader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads a slide and its annotated region of interest (ROI).&#39;&#39;&#39;</span>

<div class="viewcode-block" id="WSI.__init__"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">roi_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rois</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">randomize_origin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Progress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads slide and ROI(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to slide.</span>
<span class="sd">            tile_px (int): Size of tiles to extract, in pixels.</span>
<span class="sd">            tile_um (int or str): Size of tiles to extract, in microns (int) or</span>
<span class="sd">                magnification (str, e.g. &quot;20x&quot;).</span>
<span class="sd">            stride_div (int, optional): Stride divisor for tile extraction</span>
<span class="sd">                (1 = no tile overlap; 2 = 50% overlap, etc). Defaults to 1.</span>
<span class="sd">            enable_downsample (bool, optional): Allow use of downsampled</span>
<span class="sd">                intermediate layers in the slide image pyramid, which greatly</span>
<span class="sd">                improves tile extraction speed. May result in artifacts for</span>
<span class="sd">                slides with incompletely generated intermediates pyramids.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            roi_dir (str, optional): Directory in which to search for ROI CSV</span>
<span class="sd">                files. Defaults to None.</span>
<span class="sd">            rois (list(str)): Alternatively, a list of ROI paths can be</span>
<span class="sd">                explicitly provided. Defaults to None.</span>
<span class="sd">            roi_method (str): Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, or &#39;ignore&#39;.</span>
<span class="sd">                Determines how ROIs are used to extract tiles.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            randomize_origin (bool, optional): Offset the starting grid by a</span>
<span class="sd">                random amount. Defaults to False.</span>
<span class="sd">            pb (:class:`Progress`, optional): Multiprocessing</span>
<span class="sd">                capable Progress instance; will update progress bar during</span>
<span class="sd">                tile extraction if provided.</span>
<span class="sd">            silent (bool, optional): Suppresses warnings about slide skipping</span>
<span class="sd">                if ROIs are missing. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">tile_px</span><span class="o">=</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">,</span>
            <span class="n">stride_div</span><span class="o">=</span><span class="n">stride_div</span><span class="p">,</span>
            <span class="n">enable_downsample</span><span class="o">=</span><span class="n">enable_downsample</span><span class="p">,</span>
            <span class="n">pb</span><span class="o">=</span><span class="n">pb</span>
        <span class="p">)</span>

        <span class="c1"># Initialize calculated variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_x_size</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_y_size</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># type: int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rois</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">=</span> <span class="n">roi_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomize_origin</span> <span class="o">=</span> <span class="n">randomize_origin</span>

        <span class="c1"># Look in ROI directory if available</span>
        <span class="k">if</span> <span class="n">roi_dir</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_roi</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">))</span>

        <span class="c1"># Else try loading ROI from same folder as slide</span>
        <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_roi</span><span class="p">(</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rois</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">]:</span>
            <span class="n">matching_rois</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">:</span>
                <span class="n">rn</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rn</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">matching_rois</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rp</span><span class="p">]</span>
            <span class="n">mr</span> <span class="o">=</span> <span class="n">matching_rois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_rois</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Multiple ROIs found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">; using </span><span class="si">{</span><span class="n">mr</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_roi</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span>

        <span class="c1"># Handle missing ROIs</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span>
           <span class="ow">and</span> <span class="n">roi_method</span> <span class="o">!=</span> <span class="s1">&#39;ignore&#39;</span>
           <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rois</span> <span class="ow">or</span> <span class="n">roi_dir</span><span class="p">)):</span>
            <span class="c1"># No ROIs found because the user did not provide rois or roi_dir,</span>
            <span class="c1"># but the roi_method is not set to &#39;ignore&#39;,</span>
            <span class="c1"># indicating that this may be user error.</span>
            <span class="n">warn_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No ROIs provided for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rois</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">roi_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span> <span class="ow">and</span> <span class="n">roi_method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;inside&#39;</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingROIError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Slide [green]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/] missing ROI.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">):</span>
            <span class="n">info_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No ROI for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, using whole slide.&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="ow">and</span> <span class="n">roi_method</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">info_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span> <span class="ow">and</span> <span class="n">roi_method</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: extracting tiles from inside ROI.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">=</span> <span class="s1">&#39;inside&#39;</span>

        <span class="c1"># Build coordinate grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_coord</span><span class="p">()</span>

        <span class="n">mpp_roi_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span><span class="si">}</span><span class="s1"> um/px | </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span><span class="si">}</span><span class="s1"> ROI(s)&#39;</span>
        <span class="n">size_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">: Slide info: </span><span class="si">{</span><span class="n">mpp_roi_msg</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">size_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">grid_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">: Grid shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">grid_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;| Tiles to extract: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">grid_msg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;WSI(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;  path = </span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;  tile_px = </span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;  tile_um = </span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;  stride_div = </span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stride_div</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;  enable_downsample = </span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_downsample</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;  roi_method = </span><span class="si">{!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">base</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="c1"># Verify indices are valid</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
           <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Must supply exactly two indices: (x, y)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="s2">&quot;index </span><span class="si">{}</span><span class="s2"> is out of bounds for axis 0 with size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="s2">&quot;index </span><span class="si">{}</span><span class="s2"> is out of bounds for axis 0 with size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Find the corresponding coordinate given the provided indices.</span>
        <span class="n">coord_idx</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="n">coord_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># Check if indices correspond to a tile that is filtered out,</span>
        <span class="c1"># either by ROI or QC. If so, return None.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Extract the numpy image at this grid location.</span>
        <span class="n">image_dict</span> <span class="o">=</span> <span class="n">_wsi_extraction_worker</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span><span class="p">),</span>
            <span class="n">SimpleNamespace</span><span class="p">(</span>
                <span class="n">full_extract_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">,</span>
                <span class="n">roi_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">,</span>
                <span class="n">rois</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">,</span>
                <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                <span class="n">downsample_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">extract_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="p">,</span>
                <span class="n">tile_px</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="n">full_stride</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="p">,</span>
                <span class="n">normalizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">normalizer_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">whitespace_fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">whitespace_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">grayspace_fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">grayspace_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">img_format</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
                <span class="n">yolo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">draw_roi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">image_dict</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_build_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Set up coordinate grid.&#39;&#39;&#39;</span>

        <span class="c1"># Calculate window sizes, strides, and coordinates for windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_x_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_y_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span>

        <span class="c1"># Randomize origin, if desired</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize_origin</span><span class="p">:</span>
            <span class="n">start_x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">start_y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random origin: X: </span><span class="si">{</span><span class="n">start_x</span><span class="si">}</span><span class="s2">, Y: </span><span class="si">{</span><span class="n">start_y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_x</span> <span class="o">=</span> <span class="n">start_y</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Coordinates must be in level 0 (full) format</span>
        <span class="c1"># for the read_region function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: Union[List, np.ndarray]</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">start_y</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span>
        <span class="p">)</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">start_x</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_range</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># ROI filtering</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">!=</span> <span class="s1">&#39;ignore&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">)</span>
            <span class="n">yfact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">)</span>
            <span class="n">scaled</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sa</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">xfact</span><span class="o">=</span><span class="n">xfact</span><span class="p">,</span> <span class="n">yfact</span><span class="o">=</span><span class="n">yfact</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_mask</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span>
                <span class="n">scaled</span><span class="p">,</span>
                <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roi_mask</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">yi</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_range</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_range</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">])</span>

                <span class="c1"># ROI filtering</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">!=</span> <span class="s1">&#39;ignore&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">point_in_roi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_mask</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span>
                    <span class="c1"># If the extraction method is &#39;inside&#39;,</span>
                    <span class="c1"># skip the tile if it&#39;s not in an ROI</span>
                    <span class="k">if</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">==</span> <span class="s1">&#39;inside&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">point_in_roi</span><span class="p">)</span>
                       <span class="ow">or</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">==</span> <span class="s1">&#39;outside&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">point_in_roi</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span>

<div class="viewcode-block" id="WSI.extract_tiles"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI.extract_tiles">[docs]</a>    <span class="k">def</span> <span class="nf">extract_tiles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tfrecord_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tiles_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SlideReport</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Extracts tiles from slide using the build_generator() method,</span>
<span class="sd">        saving tiles into a TFRecord file or as loose JPG tiles in a directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            tfrecord_dir (str): If provided, saves tiles into a TFRecord file</span>
<span class="sd">            (named according to slide name) here.</span>
<span class="sd">            tiles_dir (str): If provided, saves loose images into a</span>
<span class="sd">                subdirectory (per slide name) here.</span>
<span class="sd">            img_format (str): &#39;png&#39; or &#39;jpg&#39;. Format of images for internal</span>
<span class="sd">                storage in tfrecords. PNG (lossless) format recommended for</span>
<span class="sd">                fidelity, JPG (lossy) for efficiency. Defaults to &#39;jpg&#39;.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace. If 1, will not</span>
<span class="sd">                perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            normalizer (str, optional): Normalization for image tiles.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Path to normalizer source image.</span>
<span class="sd">                If None, will use slideflow.slide.norm_tile.jpg.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            full_core (bool, optional): Extract an entire detected core, rather</span>
<span class="sd">                than subdividing into image tiles. Defaults to False.</span>
<span class="sd">            shuffle (bool): Shuffle images during extraction.</span>
<span class="sd">            num_threads (int): Number of threads to allocate to workers.</span>
<span class="sd">            yolo (bool, optional): Export yolo-formatted tile-level ROI</span>
<span class="sd">                annotations (.txt) in the tile directory. Requires that</span>
<span class="sd">                tiles_dir is set. Defaults to False.</span>
<span class="sd">            draw_roi (bool, optional): Draws ROIs onto extracted tiles.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            dry_run (bool, optional): Determine tiles that would be extracted,</span>
<span class="sd">                but do not export any images. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span>
            <span class="n">tfrecord_dir</span><span class="p">,</span>
            <span class="n">tiles_dir</span><span class="p">,</span>
            <span class="n">img_format</span><span class="p">,</span>
            <span class="n">report</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="WSI.build_generator"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI.build_generator">[docs]</a>    <span class="k">def</span> <span class="nf">build_generator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">whitespace_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">whitespace_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grayspace_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grayspace_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
        <span class="n">full_core</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">yolo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">draw_roi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;mp.pool.Pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Builds tile generator to extract tiles from this slide.</span>

<span class="sd">        Args:</span>
<span class="sd">            shuffle (bool): Shuffle images during extraction.</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace. If 1, will not</span>
<span class="sd">                perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            normalizer (str, optional): Normalization strategy to use on image</span>
<span class="sd">            tiles. Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Path to normalizer source image.</span>
<span class="sd">                If None, will use slideflow.slide.norm_tile.jpg.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            show_progress (bool, optional): Show a progress bar.</span>
<span class="sd">            img_format (str, optional): Image format. Either &#39;numpy&#39;, &#39;jpg&#39;,</span>
<span class="sd">                or &#39;png&#39;. Defaults to &#39;numpy&#39;.</span>
<span class="sd">            yolo (bool, optional): Include yolo-formatted tile-level ROI</span>
<span class="sd">                annotations in the return dictionary, under the key &#39;yolo&#39;.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            draw_roi (bool, optional): Draws ROIs onto extracted tiles.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            dry_run (bool, optional): Determine tiles that would be extracted,</span>
<span class="sd">                but do not export any images. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dict with keys &#39;image&#39; (image data), &#39;yolo&#39; (optional</span>
<span class="sd">            yolo-formatted annotations, (x_center, y_center,</span>
<span class="sd">            width, height)) and &#39;grid&#39; ((x, y) slide or grid coordinates)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build_generator</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No tiles extracted for slide [green]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Detect CPU cores if num_threads not specified</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="c1"># Shuffle coordinates to randomize extraction order</span>
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>

        <span class="c1"># Set whitespace / grayspace fraction to defaults if not provided</span>
        <span class="k">if</span> <span class="n">whitespace_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">whitespace_fraction</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_FRACTION</span>
        <span class="k">if</span> <span class="n">whitespace_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">whitespace_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_THRESHOLD</span>
        <span class="k">if</span> <span class="n">grayspace_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grayspace_fraction</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_FRACTION</span>
        <span class="k">if</span> <span class="n">grayspace_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grayspace_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_THRESHOLD</span>

        <span class="c1"># Get information about highest level downsample, as we will filter</span>
        <span class="c1"># on that layer if downsampling is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_downsample</span><span class="p">:</span>
            <span class="n">filter_lev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">filter_downsample_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="n">filter_lev</span><span class="p">]</span>
            <span class="n">lev_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">]</span>
            <span class="n">filter_downsample_ratio</span> <span class="o">=</span> <span class="n">filter_downsample_factor</span> <span class="o">//</span> <span class="n">lev_ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_lev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span>
            <span class="n">filter_downsample_ratio</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">w_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="s1">&#39;full_extract_px&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">,</span>
            <span class="s1">&#39;roi_scale&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">,</span>
            <span class="s1">&#39;rois&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">,</span>
            <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
            <span class="s1">&#39;downsample_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">,</span>
            <span class="s1">&#39;filter_downsample_level&#39;</span><span class="p">:</span> <span class="n">filter_lev</span><span class="p">,</span>
            <span class="s1">&#39;filter_downsample_ratio&#39;</span><span class="p">:</span> <span class="n">filter_downsample_ratio</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s1">&#39;extract_px&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="p">,</span>
            <span class="s1">&#39;tile_px&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="s1">&#39;full_stride&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="p">,</span>
            <span class="s1">&#39;normalizer&#39;</span><span class="p">:</span> <span class="n">normalizer</span><span class="p">,</span>
            <span class="s1">&#39;normalizer_source&#39;</span><span class="p">:</span> <span class="n">normalizer_source</span><span class="p">,</span>
            <span class="s1">&#39;whitespace_fraction&#39;</span><span class="p">:</span> <span class="n">whitespace_fraction</span><span class="p">,</span>
            <span class="s1">&#39;whitespace_threshold&#39;</span><span class="p">:</span> <span class="n">whitespace_threshold</span><span class="p">,</span>
            <span class="s1">&#39;grayspace_fraction&#39;</span><span class="p">:</span> <span class="n">grayspace_fraction</span><span class="p">,</span>
            <span class="s1">&#39;grayspace_threshold&#39;</span><span class="p">:</span> <span class="n">grayspace_threshold</span><span class="p">,</span>
            <span class="s1">&#39;img_format&#39;</span><span class="p">:</span> <span class="n">img_format</span><span class="p">,</span>
            <span class="s1">&#39;yolo&#39;</span><span class="p">:</span> <span class="n">yolo</span><span class="p">,</span>
            <span class="s1">&#39;draw_roi&#39;</span><span class="p">:</span> <span class="n">draw_roi</span><span class="p">,</span>
            <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span> <span class="n">dry_run</span>
        <span class="p">})</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">pool</span>
            <span class="n">should_close</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building generator with </span><span class="si">{</span><span class="n">num_threads</span><span class="si">}</span><span class="s2"> threads&quot;</span><span class="p">)</span>
                    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_threads</span><span class="p">)</span>
                    <span class="n">should_close</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building generator without multithreading&quot;</span><span class="p">)</span>
                    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">_wsi_extraction_worker</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">w_args</span><span class="p">)</span>
                    <span class="n">i_mapped</span> <span class="o">=</span> <span class="n">_generator</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building generator with a shared pool&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span><span class="n">transient</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">pbar</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s1">&#39;Extracting...&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">i_mapped</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span><span class="n">_wsi_extraction_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">w_args</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coord</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">i_mapped</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s1">&#39;skip&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">should_close</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">name_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[green]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s1">[/]&#39;</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">num_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">}</span><span class="s1"> tiles of </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s1"> possible)&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished tile extraction for </span><span class="si">{</span><span class="n">name_msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">num_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">generator</span></div>

<div class="viewcode-block" id="WSI.thumb"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI.thumb">[docs]</a>    <span class="k">def</span> <span class="nf">thumb</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mpp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rois</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns PIL Image of thumbnail with ROI overlay.</span>

<span class="sd">        Args:</span>
<span class="sd">            mpp (float, optional): Microns-per-pixel, used to determine</span>
<span class="sd">                thumbnail size.</span>
<span class="sd">            width (int, optional): Goal thumbnail width (alternative to mpp).</span>
<span class="sd">            coords (list(int), optional): List of tile extraction coordinates</span>
<span class="sd">                to show as rectangles on the thumbnail, in [(x_center,</span>
<span class="sd">                y_center), ...] format. Defaults to None.</span>
<span class="sd">            rois (bool, optional): Draw ROIs onto thumbnail. Defaults to False.</span>
<span class="sd">            linewidth (int, optional): Width of ROI line. Defaults to 2.</span>
<span class="sd">            color (str, optional): Color of ROI. Defaults to black.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">rois</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mpp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either mpp or width must be given, but not both&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; (got mpp=</span><span class="si">{</span><span class="n">mpp</span><span class="si">}</span><span class="s2">, width=</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="c1"># If no values provided, create thumbnail of width 1024</span>
            <span class="k">if</span> <span class="n">mpp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mi">1024</span>
            <span class="k">if</span> <span class="n">mpp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">roi_scale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                             <span class="o">/</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">mpp</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roi_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">width</span>  <span class="c1"># type: ignore</span>

        <span class="n">thumb</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">mpp</span><span class="o">=</span><span class="n">mpp</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rois</span><span class="p">:</span>
            <span class="n">annPolys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">scaled_area</span><span class="p">(</span><span class="n">roi_scale</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span>
            <span class="p">]</span>
            <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">thumb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">annPolys</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
                <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
                <span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">zipped</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="s1">&#39;curve&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">thumb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">thumb</span></div>

<div class="viewcode-block" id="WSI.load_csv_roi"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI.load_csv_roi">[docs]</a>    <span class="k">def</span> <span class="nf">load_csv_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Loads CSV ROI from a given path.&#39;&#39;&#39;</span>

        <span class="n">roi_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;roi_name&quot;</span><span class="p">)</span>
                <span class="n">index_x</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;x_base&quot;</span><span class="p">)</span>
                <span class="n">index_y</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;y_base&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ROIError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Unable to read CSV ROI [green]</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">[/]. Please ensure &#39;</span>
                    <span class="s1">&#39;headers contain &quot;ROI_name&quot;, &quot;X_base and &quot;Y_base&quot;.&#39;</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>
                <span class="n">x_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_x</span><span class="p">]))</span>
                <span class="n">y_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_y</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">roi_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="p">:</span>
                    <span class="n">roi_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">roi_name</span><span class="p">:</span> <span class="n">ROI</span><span class="p">(</span><span class="n">roi_name</span><span class="p">)})</span>
                <span class="n">roi_dict</span><span class="p">[</span><span class="n">roi_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_coord</span><span class="p">((</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">roi_object</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_object</span><span class="p">)</span>

        <span class="c1"># Load annotations as shapely.geometry objects</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">!=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">poly</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">scaled_area</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">poly</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to use ROI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> for [green]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[/].&quot;</span>
                        <span class="s2">&quot; At least 3 points required to create a shape.&quot;</span>
                    <span class="p">)</span>
            <span class="n">roi_area</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">poly</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annPolys</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_area</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">total_area</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">)</span>
                      <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_area_fraction</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">roi_area</span> <span class="k">else</span> <span class="p">(</span><span class="n">roi_area</span> <span class="o">/</span> <span class="n">total_area</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span></div>

<div class="viewcode-block" id="WSI.load_json_roi"><a class="viewcode-back" href="../../slide.html#slideflow.slide.WSI.load_json_roi">[docs]</a>    <span class="k">def</span> <span class="nf">load_json_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Loads ROI from a JSON file.&#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="n">area_reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROI</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span><span class="n">area_reduced</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TMA"><a class="viewcode-back" href="../../slide.html#slideflow.slide.TMA">[docs]</a><span class="k">class</span> <span class="nc">TMA</span><span class="p">(</span><span class="n">_BaseLoader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads a TMA-formatted slide and detects tissue cores.&#39;&#39;&#39;</span>

    <span class="n">QUEUE_SIZE</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">HEIGHT_MIN</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">WIDTH_MIN</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">BLACK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
    <span class="n">LIGHTBLUE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">WHITE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<div class="viewcode-block" id="TMA.__init__"><a class="viewcode-back" href="../../slide.html#slideflow.slide.TMA.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">report_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Progress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Initializer.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to slide.</span>
<span class="sd">            tile_px (int): Size of tiles to extract, in pixels.</span>
<span class="sd">            tile_um (int or str): Size of tiles to extract, in microns (int) or</span>
<span class="sd">                magnification (str, e.g. &quot;20x&quot;).</span>
<span class="sd">            stride_div (int, optional): Stride divisor for tile extraction</span>
<span class="sd">                (1 = no tile overlap; 2 = 50% overlap, etc). Defaults to 1.</span>
<span class="sd">            enable_downsample (bool, optional): Allow use of downsampled</span>
<span class="sd">                layers in the slide image pyramid, which greatly improves</span>
<span class="sd">                tile extraction speed. Defaults to True.</span>
<span class="sd">            pb (Progress, optional): Progress bar; will update</span>
<span class="sd">                progress bar during tile extraction if provided.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">tile_px</span><span class="p">,</span>
            <span class="n">tile_um</span><span class="p">,</span>
            <span class="n">stride_div</span><span class="p">,</span>
            <span class="n">enable_downsample</span><span class="p">,</span>
            <span class="n">pb</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_rects</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_areas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_method</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_scale</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># type: float</span>
        <span class="n">target_thumb_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">target_thumb_mpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_to_mpp</span><span class="p">((</span><span class="n">target_thumb_width</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumb</span><span class="p">(</span><span class="n">mpp</span><span class="o">=</span><span class="n">target_thumb_mpp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">THUMB_DOWNSCALE</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp_to_dim</span><span class="p">(</span><span class="n">target_thumb_mpp</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_cores</span><span class="p">(</span><span class="n">report_dir</span><span class="o">=</span><span class="n">report_dir</span><span class="p">)</span>  <span class="c1"># type: int</span>
        <span class="n">size_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mpp</span><span class="si">}</span><span class="s2"> um/px | </span><span class="si">{</span><span class="n">size_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_sub_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rect</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Gets a sub-image from the slide using the specified rectangle.&#39;&#39;&#39;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">THUMB_DOWNSCALE</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

        <span class="n">rect_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                         <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">THUMB_DOWNSCALE</span>
                         <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span><span class="p">)</span>
        <span class="n">rect_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                          <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">THUMB_DOWNSCALE</span>
                          <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span><span class="p">)</span>

        <span class="n">region_x_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">]))</span>
        <span class="n">region_x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">])</span>
        <span class="n">region_y_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">]))</span>
        <span class="n">region_y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">])</span>
        <span class="n">region_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">region_x_max</span> <span class="o">-</span> <span class="n">region_x_min</span><span class="p">)</span>
                           <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span><span class="p">)</span>
        <span class="n">region_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">region_y_max</span> <span class="o">-</span> <span class="n">region_y_min</span><span class="p">)</span>
                            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span><span class="p">)</span>

        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span>
            <span class="p">(</span><span class="n">region_x_min</span><span class="p">,</span> <span class="n">region_y_min</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">,</span>
            <span class="p">(</span><span class="n">region_width</span><span class="p">,</span> <span class="n">region_height</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">extracted</span> <span class="o">=</span> <span class="n">vips2numpy</span><span class="p">(</span><span class="n">region</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">relative_box</span> <span class="o">=</span> <span class="p">((</span><span class="n">box</span> <span class="o">-</span> <span class="p">[</span><span class="n">region_x_min</span><span class="p">,</span> <span class="n">region_y_min</span><span class="p">])</span>
                        <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span><span class="p">)</span>

        <span class="n">src_pts</span> <span class="o">=</span> <span class="n">relative_box</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_height</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[(</span><span class="n">rect_width</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[(</span><span class="n">rect_width</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_height</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">)</span>
        <span class="n">warped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_width</span><span class="p">,</span> <span class="n">rect_height</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">warped</span>

    <span class="k">def</span> <span class="nf">_resize_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_tile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Resizes image tile to the desired target output size.&#39;&#39;&#39;</span>
        <span class="n">target_MPP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_um</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span>
        <span class="n">current_MPP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span>
        <span class="n">resize_factor</span> <span class="o">=</span> <span class="n">current_MPP</span> <span class="o">/</span> <span class="n">target_MPP</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">image_tile</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">fx</span><span class="o">=</span><span class="n">resize_factor</span><span class="p">,</span>
            <span class="n">fy</span><span class="o">=</span><span class="n">resize_factor</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_split_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;Splits core into desired sub-images.&#39;&#39;&#39;</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">num_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
        <span class="n">num_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>

        <span class="c1"># If the desired micron tile size is too large,</span>
        <span class="c1"># expand and center the source image</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_y</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">num_x</span><span class="p">:</span>
            <span class="n">expand_y</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">num_y</span> <span class="k">else</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="o">-</span><span class="n">height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">expand_x</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">num_x</span> <span class="k">else</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="o">-</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                       <span class="n">expand_y</span><span class="p">,</span>
                                       <span class="n">expand_y</span><span class="p">,</span>
                                       <span class="n">expand_x</span><span class="p">,</span>
                                       <span class="n">expand_x</span><span class="p">,</span>
                                       <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">WHITE</span><span class="p">)</span>

            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">num_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
            <span class="n">num_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>

        <span class="n">y_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subtiles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_x</span><span class="p">):</span>
                <span class="n">sub_x_start</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
                <span class="n">sub_y_start</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
                <span class="n">subtiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">image</span><span class="p">[</span><span class="n">sub_y_start</span><span class="p">:</span><span class="n">sub_y_start</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                                   <span class="n">sub_x_start</span><span class="p">:</span><span class="n">sub_x_start</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">subtiles</span>

    <span class="k">def</span> <span class="nf">_detect_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Prepare annotated image</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">img_annotated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Create background mask for edge detection</span>
        <span class="n">white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">])</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="mi">28</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumb_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">white</span><span class="o">-</span><span class="n">buffer</span><span class="p">)</span>

        <span class="c1"># Fill holes and dilate mask</span>
        <span class="n">closing_kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">dilating_kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">closing</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_GRADIENT</span><span class="p">,</span> <span class="n">closing_kernel</span><span class="p">)</span>
        <span class="n">dilated</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">closing</span><span class="p">,</span> <span class="n">dilating_kernel</span><span class="p">)</span>

        <span class="c1"># Use edge detection to find individual cores</span>
        <span class="n">contours</span><span class="p">,</span> <span class="n">heirarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
            <span class="n">dilated</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_CCOMP</span><span class="p">,</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_TC89_L1</span>
        <span class="p">)</span>
        <span class="c1"># Filter out small regions that likely represent background noise</span>
        <span class="c1"># Also generate image showing identified cores</span>
        <span class="n">num_filtered</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">heirarchy</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">component</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">heir</span> <span class="o">=</span> <span class="n">component</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">WIDTH_MIN</span>
               <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">HEIGHT_MIN</span>
               <span class="ow">and</span> <span class="n">heir</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">moment</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_rects</span> <span class="o">+=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_rects</span><span class="p">),</span> <span class="n">rect</span><span class="p">)]</span>
                <span class="n">cX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="s2">&quot;m10&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">moment</span><span class="p">[</span><span class="s2">&quot;m00&quot;</span><span class="p">])</span>
                <span class="n">cY</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">moment</span><span class="p">[</span><span class="s2">&quot;m01&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">moment</span><span class="p">[</span><span class="s2">&quot;m00&quot;</span><span class="p">])</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">img_annotated</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIGHTBLUE</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img_annotated</span><span class="p">,</span> <span class="p">(</span><span class="n">cX</span><span class="p">,</span> <span class="n">cY</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">_polyArea</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box_areas</span> <span class="o">+=</span> <span class="p">[</span><span class="n">area</span><span class="p">]</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">img_annotated</span><span class="p">,</span> <span class="p">[</span><span class="n">box</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLUE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">num_filtered</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">heir</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">img_annotated</span><span class="p">,</span> <span class="p">[</span><span class="n">box</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of detected cores: </span><span class="si">{</span><span class="n">num_filtered</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Write annotated image to ExtractionReport</span>
        <span class="k">if</span> <span class="n">report_dir</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="n">report_dir</span><span class="p">,</span> <span class="s2">&quot;tma_extraction_report.jpg&quot;</span><span class="p">),</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_annotated</span><span class="p">,</span> <span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_filtered</span>

<div class="viewcode-block" id="TMA.extract_tiles"><a class="viewcode-back" href="../../slide.html#slideflow.slide.TMA.extract_tiles">[docs]</a>    <span class="k">def</span> <span class="nf">extract_tiles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tfrecord_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tiles_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SlideReport</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Extracts tiles from slide using the build_generator() method,</span>
<span class="sd">        saving tiles into a TFRecord file or as loose JPG tiles in a directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            tfrecord_dir (str): If provided, saves tiles into a TFRecord file</span>
<span class="sd">                (named according to slide name) here.</span>
<span class="sd">            tiles_dir (str): If provided, saves loose images into a</span>
<span class="sd">                subdirectory (per slide name) here.</span>
<span class="sd">            img_format (str): &#39;png&#39; or &#39;jpg&#39;. Format of images for internal</span>
<span class="sd">                storage in tfrecords. PNG (lossless) format recommended for</span>
<span class="sd">                fidelity, JPG (lossy) for efficiency.</span>
<span class="sd">                Defaults to &#39;jpg&#39;.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace. If 1, will not</span>
<span class="sd">                perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            normalizer (str, optional): Normalization for image tiles.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Path to normalizer source image.</span>
<span class="sd">                If None, will use slideflow.slide.norm_tile.jpg.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            full_core (bool, optional): Extract an entire detected core, rather</span>
<span class="sd">                than subdividing into image tiles. Defaults to False.</span>
<span class="sd">            shuffle (bool): Shuffle images during extraction.</span>
<span class="sd">            num_threads (int): Number of threads to allocate to workers.</span>
<span class="sd">            yolo (bool, optional): Export yolo-formatted tile-level ROI</span>
<span class="sd">                annotations (.txt) in the tile directory. Requires that</span>
<span class="sd">                tiles_dir is set. Defaults to False.</span>
<span class="sd">            draw_roi (bool, optional): Draws ROIs onto extracted tiles.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            dry_run (bool, optional): Determine tiles that would be extracted,</span>
<span class="sd">                but do not export any images. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span>
            <span class="n">tfrecord_dir</span><span class="p">,</span>
            <span class="n">tiles_dir</span><span class="p">,</span>
            <span class="n">img_format</span><span class="p">,</span>
            <span class="n">report</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TMA.build_generator"><a class="viewcode-back" href="../../slide.html#slideflow.slide.TMA.build_generator">[docs]</a>    <span class="k">def</span> <span class="nf">build_generator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">whitespace_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">whitespace_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grayspace_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grayspace_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalizer_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
        <span class="n">full_core</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">yolo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">draw_roi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;mp.pool.Pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Builds tile generator to extract of tiles across the slide.</span>

<span class="sd">        Args:</span>
<span class="sd">            shuffle (bool): Shuffle images during extraction.</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is  whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace. If 1, will not</span>
<span class="sd">                perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this threshold are</span>
<span class="sd">                considered grayspace.</span>
<span class="sd">            normalizer (str, optional): Normalization to use on image tiles.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Path to normalizer source image.</span>
<span class="sd">                If None, will use slideflow.slide.norm_tile.jpg</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            num_threads (int, optional): Number of threads for pool. Unused if</span>
<span class="sd">                `pool` is specified.</span>
<span class="sd">            pool (:obj:`multiprocessing.Pool`, optional): Multiprocessing pool</span>
<span class="sd">                to use. By using a shared pool, a slide no longer needs to spin</span>
<span class="sd">                up its own new pool for tile extraction, decreasing tile</span>
<span class="sd">                extraction time for large datasets. Defaults to None (create a</span>
<span class="sd">                new pool, using `num_threads`).</span>
<span class="sd">            img_format (str, optional): &#39;png&#39;, &#39;jpg&#39;, or &#39;numpy&#39;. Format images</span>
<span class="sd">                should be returned in.</span>
<span class="sd">            full_core (bool, optional): Extract an entire detected core, rather</span>
<span class="sd">                than subdividing into image tiles. Defaults to False.</span>
<span class="sd">            show_progress (bool, optional): Show a progress bar for extraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build_generator</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">yolo</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Yolo annotation export not implemented for TMA slides&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">draw_roi</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;ROI drawing not implemented for TMA slides&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Dry running not enabled for TMA slides&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Setup normalization</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">normalizer</span> <span class="k">else</span> <span class="n">sf</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">autoselect</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">normalizer</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">normalizer_source</span>
        <span class="p">)</span>
        <span class="c1"># Detect CPU cores if num_threads not specified</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="c1"># Shuffle TMAs</span>
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_rects</span><span class="p">)</span>

        <span class="c1"># Set whitespace / grayspace fraction to defaults if not provided</span>
        <span class="k">if</span> <span class="n">whitespace_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">whitespace_fraction</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_FRACTION</span>
        <span class="k">if</span> <span class="n">whitespace_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">whitespace_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_WHITESPACE_THRESHOLD</span>
        <span class="k">if</span> <span class="n">grayspace_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grayspace_fraction</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_FRACTION</span>
        <span class="k">if</span> <span class="n">grayspace_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grayspace_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_GRAYSPACE_THRESHOLD</span>

        <span class="c1"># Establish extraction queues</span>
        <span class="n">rectangle_queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>  <span class="c1"># type: mp.Queue</span>
        <span class="n">extraction_queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUEUE_SIZE</span><span class="p">)</span>  <span class="c1"># type: mp.Queue</span>

        <span class="k">def</span> <span class="nf">section_extraction_worker</span><span class="p">(</span><span class="n">read_queue</span><span class="p">,</span> <span class="n">write_queue</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">tile_id</span><span class="p">,</span> <span class="n">rect</span> <span class="o">=</span> <span class="n">read_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rect</span> <span class="o">==</span> <span class="s2">&quot;DONE&quot;</span><span class="p">:</span>
                    <span class="n">write_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">tile_id</span><span class="p">,</span> <span class="n">rect</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">image_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sub_image</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
                    <span class="n">write_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">tile_id</span><span class="p">,</span> <span class="n">image_tile</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span><span class="n">transient</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">pbar</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
                    <span class="s2">&quot;Extracting...&quot;</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">estimated_num_tiles</span>
                <span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>
            <span class="n">extraction_pool</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
                <span class="n">num_threads</span><span class="p">,</span>
                <span class="n">section_extraction_worker</span><span class="p">,</span>
                <span class="p">(</span><span class="n">rectangle_queue</span><span class="p">,</span> <span class="n">extraction_queue</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_rects</span><span class="p">:</span>
                <span class="n">rectangle_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
            <span class="n">rectangle_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;DONE&quot;</span><span class="p">))</span>

            <span class="n">queue_progress</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">queue_progress</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tile_id</span><span class="p">,</span> <span class="n">image_core</span> <span class="o">=</span> <span class="n">extraction_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">image_core</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">image_core</span> <span class="o">==</span> <span class="s2">&quot;DONE&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">resized_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_to_target</span><span class="p">(</span><span class="n">image_core</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">full_core</span><span class="p">:</span>
                        <span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                            <span class="n">image_core</span><span class="p">,</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="c1"># Convert to final image format</span>
                        <span class="k">if</span> <span class="n">img_format</span> <span class="o">!=</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
                            <span class="n">resized</span> <span class="o">=</span> <span class="n">_convert_img_to_format</span><span class="p">(</span>
                                <span class="n">resized</span><span class="p">,</span>
                                <span class="n">img_format</span>
                            <span class="p">)</span>

                        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">resized</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subtiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_core</span><span class="p">(</span><span class="n">resized_core</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">subtile</span> <span class="ow">in</span> <span class="n">subtiles</span><span class="p">:</span>
                            <span class="c1"># Perform whitespace filtering</span>
                            <span class="k">if</span> <span class="n">whitespace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subtile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                                        <span class="o">&gt;</span> <span class="n">whitespace_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                <span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">frac</span> <span class="o">&gt;</span> <span class="n">whitespace_fraction</span><span class="p">:</span>
                                    <span class="k">continue</span>

                            <span class="c1"># Perform grayspace filtering</span>
                            <span class="k">if</span> <span class="n">grayspace_fraction</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">hsv_image</span> <span class="o">=</span> <span class="n">mcol</span><span class="o">.</span><span class="n">rgb_to_hsv</span><span class="p">(</span><span class="n">subtile</span><span class="p">)</span>
                                <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsv_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
                                        <span class="o">&lt;</span> <span class="n">grayspace_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                <span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_px</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">frac</span> <span class="o">&gt;</span> <span class="n">grayspace_fraction</span><span class="p">:</span>
                                    <span class="k">continue</span>

                            <span class="c1"># Apply normalization</span>
                            <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">subtile</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rgb_to_rgb</span><span class="p">(</span><span class="n">subtile</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="c1"># The image could not be normalized, which</span>
                                    <span class="c1"># happens when a tile is primarily one</span>
                                    <span class="c1"># solid color (background)</span>
                                    <span class="k">continue</span>

                            <span class="c1"># Convert to final image format</span>
                            <span class="k">if</span> <span class="n">img_format</span> <span class="o">!=</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
                                <span class="n">subtile</span> <span class="o">=</span> <span class="n">_convert_img_to_format</span><span class="p">(</span>
                                    <span class="n">subtile</span><span class="p">,</span>
                                    <span class="n">img_format</span>
                                <span class="p">)</span>
                            <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">subtile</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>

            <span class="n">extraction_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">generator</span></div></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, James M Dolezal.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
         <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
         <script src="../../_static/jquery.js"></script>
         <script src="../../_static/underscore.js"></script>
         <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1.html">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/jamesdolezal/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>