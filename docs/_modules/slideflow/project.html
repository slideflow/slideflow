


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slideflow.project &mdash; slideflow 1.2.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-43E5QNVXH2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-43E5QNVXH2');
  </script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://slideflow.dev" aria-label="Slideflow"></a>

      <div class="main-menu">
        <ul>
          <li class="active">
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1.html">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/jamesdolezal/slideflow">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  1.2
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_setup.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../layer_activations.html">Features / layer activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_loops.html">Custom training loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uq.html">Uncertainty quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clam.html">CLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project.html">slideflow.Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataset.html">slideflow.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../heatmap.html">slideflow.heatmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io.html">slideflow.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io_tensorflow.html">slideflow.io.tensorflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io_torch.html">slideflow.io.torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gan.html">slideflow.gan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../grad.html">slideflow.grad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">slideflow.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mosaic.html">slideflow.mosaic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../norm.html">slideflow.norm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slide.html">slideflow.slide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stats.html">slideflow.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../util.html">slideflow.util</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial1.html">Tutorial 1: Model training (simple)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial2.html">Tutorial 2: Model training (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial3.html">Tutorial 3: Using a custom architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial4.html">Tutorial 4: Model evaluation &amp; heatmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial5.html">Tutorial 5: Creating a mosaic map</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../index.html">Module code</a> &gt;</li>
        
      <li>slideflow.project</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for slideflow.project</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span><span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span>
                    <span class="n">Union</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">slideflow</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">errors</span><span class="p">,</span> <span class="n">project_utils</span>
<span class="kn">from</span> <span class="nn">slideflow.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">ModelParams</span>
<span class="kn">from</span> <span class="nn">slideflow.project_utils</span> <span class="kn">import</span> <span class="n">auto_dataset</span><span class="p">,</span> <span class="n">get_validation_settings</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">path_to_name</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">ConfigSpace</span> <span class="kn">import</span> <span class="n">ConfigurationSpace</span>

    <span class="kn">from</span> <span class="nn">slideflow.model</span> <span class="kn">import</span> <span class="n">DatasetFeatures</span><span class="p">,</span> <span class="n">Trainer</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../project.html#slideflow.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Assists with project organization and execution of pipeline functions.</span>

<span class="sd">    Standard instantiation with __init__ assumes a project already exists at</span>
<span class="sd">    a given directory, or that configuration will be supplied via kwargs.</span>
<span class="sd">    Alternatively, a project may be instantiated using :meth:`from_prompt`,</span>
<span class="sd">    which interactively guides users through configuration.</span>

<span class="sd">    *Interactive instantiation:*</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        &gt;&gt;&gt; import slideflow as sf</span>
<span class="sd">        &gt;&gt;&gt; P = sf.Project.from_prompt(&#39;/project/path&#39;)</span>
<span class="sd">        What is the project name?</span>

<span class="sd">    *Manual configuration:*</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        &gt;&gt;&gt; import slideflow as sf</span>
<span class="sd">        &gt;&gt;&gt; P = sf.Project(&#39;/project/path&#39;, name=..., ...)</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Project.__init__"><a class="viewcode-back" href="../../project.html#slideflow.Project.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_neptune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initializes project at the specified project folder, creating a new</span>
<span class="sd">        project using the specified kwargs if one does not already exist.</span>
<span class="sd">        Will create a blank annotations with slide names if one does not exist.</span>

<span class="sd">        Args:</span>
<span class="sd">            root (str): Path to project directory.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            name (str): Project name. Defaults to &#39;MyProject&#39;.</span>
<span class="sd">            annotations (str): Path to annotations CSV file.</span>
<span class="sd">                Defaults to &#39;./annotations.csv&#39;</span>
<span class="sd">            dataset_config (str): Path to dataset configuration JSON file.</span>
<span class="sd">                Defaults to &#39;./datasets.json&#39;.</span>
<span class="sd">            sources (list(str)): List of dataset sources to include in project.</span>
<span class="sd">                Defaults to &#39;source1&#39;.</span>
<span class="sd">            models_dir (str): Path to directory in which to save models.</span>
<span class="sd">                Defaults to &#39;./models&#39;.</span>
<span class="sd">            eval_dir (str): Path to directory in which to save evaluations.</span>
<span class="sd">                Defaults to &#39;./eval&#39;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            slideflow.errors.ProjectError: if project folder does not exist,</span>
<span class="sd">                or the folder exists but kwargs are provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project already exists at </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_project</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating project at </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">project_utils</span><span class="o">.</span><span class="n">_project_config</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project folder </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="c1"># Create directories, if not already made</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dir</span><span class="p">)</span>

        <span class="c1"># Create blank annotations file if one does not exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_blank_annotations</span><span class="p">()</span>

        <span class="c1"># Neptune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span> <span class="o">=</span> <span class="n">use_neptune</span></div>

<div class="viewcode-block" id="Project.from_prompt"><a class="viewcode-back" href="../../project.html#slideflow.Project.from_prompt">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Project&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initializes project by creating project folder, prompting user for</span>
<span class="sd">        project settings, and saving to &quot;settings.json&quot; in project directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            root (str): Path to project directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting up new project at &quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">project_utils</span><span class="o">.</span><span class="n">interactive_project_setup</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="s2">&quot;, use_neptune=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s2">&quot;Project(root=</span><span class="si">{!r}{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Path to annotations file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_relative_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span>

    <span class="nd">@annotations</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s2">&quot;&#39;annotations&#39; must be a path.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Path to dataset configuration JSON file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_relative_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">])</span>

    <span class="nd">@dataset_config</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dataset_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s2">&quot;&#39;dataset_config&#39; must be path to JSON.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eval_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Path to evaluation directory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;eval_dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Missing eval_dir in project settings, Assuming ./eval&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_relative_path</span><span class="p">(</span><span class="s1">&#39;./eval&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_relative_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;eval_dir&#39;</span><span class="p">])</span>

    <span class="nd">@eval_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">eval_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s2">&quot;&#39;eval_dir&#39; must be a path&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;eval_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">models_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Path to models directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_relative_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">])</span>

    <span class="nd">@models_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">models_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s2">&quot;&#39;models_dir&#39; must be a path&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Descriptive project name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s2">&quot;&#39;name&#39; must be a str&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neptune_workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Neptune workspace name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;neptune_workspace&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;neptune_workspace&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;NEPTUNE_WORKSPACE&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;NEPTUNE_WORKSPACE&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@neptune_workspace</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">neptune_workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Neptune workspace name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s1">&#39;Neptune workspace must be a string.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;neptune_workspace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neptune_api</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Neptune API token.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;neptune_api&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;neptune_api&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;NEPTUNE_API_TOKEN&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;NEPTUNE_API_TOKEN&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@neptune_api</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">neptune_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Neptune API token.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s1">&#39;API token must be a string.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;neptune_api&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_token</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns list of dataset sources active in this project.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;sources&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;datasets&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&#39;sources&#39; misnamed &#39;datasets&#39; in project settings.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to find project dataset sources&#39;</span><span class="p">)</span>

    <span class="nd">@sources</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s2">&quot;&#39;sources&#39; must be a list of str&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_read_relative_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Converts relative path within project directory to global path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">relative_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">hp</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">eval_k_fold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">]]:</span>
        <span class="sd">&#39;&#39;&#39;Prepares dataset and labels.&#39;&#39;&#39;</span>

        <span class="c1"># Assign labels into int</span>
        <span class="n">conf_labels</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conf_labels</span><span class="p">:</span>
                <span class="n">outcome_label_to_int</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span>
                        <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">conf_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outcome_label_to_int</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">o</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">conf_labels</span><span class="p">[</span><span class="n">o</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">conf_labels</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcome_label_to_int</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get patient-level labels</span>
        <span class="n">use_float</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cph&#39;</span><span class="p">])</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">outcomes</span><span class="p">,</span>
            <span class="n">use_float</span><span class="o">=</span><span class="n">use_float</span><span class="p">,</span>
            <span class="n">assign</span><span class="o">=</span><span class="n">outcome_label_to_int</span>
        <span class="p">)</span>
        <span class="c1"># Prepare labels for validation splitting</span>
        <span class="k">if</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">process_label</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="n">split_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">process_label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_labels</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="c1"># If using a specific k-fold, load validation plan</span>
        <span class="k">if</span> <span class="n">eval_k_fold</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using k-fold iteration </span><span class="si">{</span><span class="n">eval_k_fold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">eval_dts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_val_split</span><span class="p">(</span>
                <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
                <span class="n">split_labels</span><span class="p">,</span>
                <span class="n">val_strategy</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">],</span>
                <span class="n">splits</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">splits</span><span class="p">),</span>
                <span class="n">val_fraction</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_fraction&#39;</span><span class="p">],</span>
                <span class="n">val_k_fold</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">],</span>
                <span class="n">k_fold_iter</span><span class="o">=</span><span class="n">eval_k_fold</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">eval_dts</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">unique</span>

        <span class="c1"># Otherwise use all TFRecords</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">unique</span>

    <span class="k">def</span> <span class="nf">_prepare_trainer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_k_fold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;splits.json&quot;</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">input_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Trainer&quot;</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Prepares a :class:`slideflow.model.Trainer` for eval or prediction.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model to evaluate.</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset</span>
<span class="sd">                from which to generate activations.</span>
<span class="sd">            outcomes (str): Str or list of str. Annotation column</span>
<span class="sd">                header specifying the outcome label(s).</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt file, if evaluating</span>
<span class="sd">                saved checkpoint. Defaults to None.</span>
<span class="sd">            eval_k_fold (int, optional): K-fold iteration number to evaluate.</span>
<span class="sd">                Defaults to None. If None, evaluate all tfrecords.</span>
<span class="sd">            splits (str, optional): Filename of JSON file in which to log</span>
<span class="sd">                training/validation splits. Looks for filename in project root.</span>
<span class="sd">                Defaults to &quot;splits.json&quot;.</span>
<span class="sd">            max_tiles (int, optional): Maximum number of tiles from each slide</span>
<span class="sd">                to evaluate. Defaults to 0 (include all tiles).</span>
<span class="sd">            mixed_precision (bool, optional): Enable mixed precision.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            input_header (str, optional): Annotation column header to use as</span>
<span class="sd">                additional input. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing</span>

<span class="sd">                :class:`slideflow.model.Trainer`: Trainer.</span>

<span class="sd">                :class:`slideflow.Dataset`: Evaluation dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">eval_k_fold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">outcomes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`eval_k_fold` invalid when predicting.&#39;</span><span class="p">)</span>

        <span class="c1"># Load hyperparameters from saved model</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="p">()</span>
        <span class="n">hp</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;eval-</span><span class="si">{</span><span class="n">basename</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># If not provided, detect outcomes from model config</span>
        <span class="n">predicting</span> <span class="o">=</span> <span class="p">(</span><span class="n">outcomes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predicting</span><span class="p">:</span>
            <span class="n">outcomes</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcomes&#39;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">outcomes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">outcomes</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span>

        <span class="c1"># Filter out slides that are blank in the outcome label,</span>
        <span class="c1"># or blank in any of the input_header categories</span>
        <span class="n">filter_blank</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outcomes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_header</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">input_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_header</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter_blank</span> <span class="o">+=</span> <span class="n">input_header</span>

        <span class="c1"># Set up outcome labels</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">predicting</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">)</span>
            <span class="n">eval_dts</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_labels</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">eval_k_fold</span><span class="o">=</span><span class="n">eval_k_fold</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eval_dts</span> <span class="o">=</span> <span class="n">dataset</span>
            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;torch&#39;</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Set max tiles</span>
        <span class="n">eval_dts</span> <span class="o">=</span> <span class="n">eval_dts</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span>

        <span class="c1"># Prepare additional slide-level input</span>
        <span class="k">if</span> <span class="n">input_header</span><span class="p">:</span>
            <span class="n">_res</span> <span class="o">=</span> <span class="n">project_utils</span><span class="o">.</span><span class="n">_setup_input_labels</span><span class="p">(</span><span class="n">eval_dts</span><span class="p">,</span> <span class="n">input_header</span><span class="p">)</span>
            <span class="n">inpt_labels</span><span class="p">,</span> <span class="n">feature_sizes</span><span class="p">,</span> <span class="n">slide_inp</span> <span class="o">=</span> <span class="n">_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inpt_labels</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">feature_sizes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">slide_inp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">n_feat</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">feature_sizes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_sizes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_sizes</span> <span class="ow">and</span> <span class="n">n_feat</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">]):</span>
            <span class="n">n_model_feat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Patient feature matrix (size </span><span class="si">{</span><span class="n">n_feat</span><span class="si">}</span><span class="s1">) &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;is different from model (size </span><span class="si">{</span><span class="n">n_model_feat</span><span class="si">}</span><span class="s1">).&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Log model settings and hyperparameters</span>
        <span class="k">if</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)),</span> <span class="n">unique</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">git_commit</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">detect_git_commit</span><span class="p">()</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_new_model_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

        <span class="c1"># Set missing validation keys to NA</span>
        <span class="k">for</span> <span class="n">v_end</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">,</span> <span class="s1">&#39;k_fold&#39;</span><span class="p">):</span>
            <span class="n">val_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;validation_</span><span class="si">{</span><span class="n">v_end</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">val_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="n">val_key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>

        <span class="n">eval_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">(),</span>
            <span class="s1">&#39;git_commit&#39;</span><span class="p">:</span> <span class="n">git_commit</span><span class="p">,</span>
            <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
            <span class="s1">&#39;model_path&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;stage&#39;</span><span class="p">:</span> <span class="s1">&#39;evaluation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tile_px&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="s1">&#39;tile_um&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
            <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
            <span class="s1">&#39;outcomes&#39;</span><span class="p">:</span> <span class="n">outcomes</span><span class="p">,</span>
            <span class="s1">&#39;input_features&#39;</span><span class="p">:</span> <span class="n">input_header</span><span class="p">,</span>
            <span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">:</span> <span class="n">feature_sizes</span><span class="p">,</span>
            <span class="s1">&#39;input_feature_labels&#39;</span><span class="p">:</span> <span class="n">inpt_labels</span><span class="p">,</span>
            <span class="s1">&#39;outcome_labels&#39;</span><span class="p">:</span> <span class="n">outcome_labels</span><span class="p">,</span>
            <span class="s1">&#39;dataset_config&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="p">,</span>
            <span class="s1">&#39;sources&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span>
            <span class="s1">&#39;annotations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="s1">&#39;validation_strategy&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">],</span>
            <span class="s1">&#39;validation_fraction&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_fraction&#39;</span><span class="p">],</span>
            <span class="s1">&#39;validation_k_fold&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">],</span>
            <span class="s1">&#39;k_fold_i&#39;</span><span class="p">:</span> <span class="n">eval_k_fold</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
            <span class="s1">&#39;pretrain&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;resume_training&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;checkpoint&#39;</span><span class="p">:</span> <span class="n">checkpoint</span><span class="p">,</span>
            <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(),</span>
            <span class="s1">&#39;max_tiles&#39;</span><span class="p">:</span> <span class="n">max_tiles</span><span class="p">,</span>
            <span class="s1">&#39;min_tiles&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">min_tiles</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;norm_fit&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">eval_config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;norm_fit&#39;</span><span class="p">]})</span>

        <span class="c1"># Build a model using the slide list as input</span>
        <span class="c1"># and the annotations dictionary as output labels</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">trainer_from_hp</span><span class="p">(</span>
            <span class="n">hp</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">eval_config</span><span class="p">,</span>
            <span class="n">patients</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">patients</span><span class="p">(),</span>
            <span class="n">slide_input</span><span class="o">=</span><span class="n">slide_inp</span><span class="p">,</span>
            <span class="n">manifest</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">manifest</span><span class="p">(),</span>
            <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span><span class="p">,</span>
            <span class="n">feature_names</span><span class="o">=</span><span class="n">input_header</span><span class="p">,</span>
            <span class="n">feature_sizes</span><span class="o">=</span><span class="n">feature_sizes</span><span class="p">,</span>
            <span class="n">outcome_names</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">use_neptune</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">,</span>
            <span class="n">neptune_api</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_api</span><span class="p">,</span>
            <span class="n">neptune_workspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neptune_workspace</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_sizes</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_sizes</span><span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">num_slide_features</span><span class="o">=</span><span class="n">n_features</span>
            <span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">eval_dts</span>

    <span class="k">def</span> <span class="nf">_train_hp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">hp_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">hp</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">val_settings</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">BaseContext</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
        <span class="n">input_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">results_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">training_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">balance_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Trains a model(s) using the specified hyperparameters.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            hp_name (str): Name of hyperparameter combination being run.</span>
<span class="sd">            hp (:class:`slideflow.ModelParams`): Model parameters.</span>
<span class="sd">            outcomes (str or list(str)): Annotation outcome headers.</span>
<span class="sd">            val_settings (:class:`types.SimpleNamspace`): Validation settings.</span>
<span class="sd">            ctx (multiprocessing.Context): Multiprocessing context for sharing</span>
<span class="sd">                results from isolated training processes.</span>
<span class="sd">            filters (dict): Dataset filters.</span>
<span class="sd">            filter_blank (list): Excludes slides blank in this annotation col.</span>
<span class="sd">            input_header (str or list(str)): Annotation col of additional</span>
<span class="sd">                slide-level input.</span>
<span class="sd">            min_tiles (int): Only includes tfrecords with &gt;= min_tiles</span>
<span class="sd">            max_tiles (int): Cap maximum tiles per tfrecord.</span>
<span class="sd">            mixed_precision (bool): Train with mixed precision.</span>
<span class="sd">            splits (str): Location of splits file for logging/reading splits.</span>
<span class="sd">            balance_headers (str, list(str)): Annotation col headers for</span>
<span class="sd">                mini-batch balancing.</span>
<span class="sd">            results_dict (dict): Multiprocessing-friendly dict for sending</span>
<span class="sd">                results from isolated training processes</span>
<span class="sd">            training_kwargs (dict): Keyword arguments for Trainer.train().</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># --- Prepare dataset ---------------------------------------------</span>
        <span class="c1"># Filter out slides that are blank in the outcome label,</span>
        <span class="c1"># or blank in any of the input_header categories</span>
        <span class="k">if</span> <span class="n">filter_blank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_blank</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">filter_blank</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_blank</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filter_blank</span><span class="p">:</span>
            <span class="n">filter_blank</span> <span class="o">+=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outcomes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_blank</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outcomes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_header</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">input_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_header</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter_blank</span> <span class="o">+=</span> <span class="n">input_header</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">,</span>
            <span class="n">min_tiles</span><span class="o">=</span><span class="n">min_tiles</span>
        <span class="p">)</span>
        <span class="c1"># --- Load labels -------------------------------------------------</span>
        <span class="n">use_float</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cph&#39;</span><span class="p">])</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="n">use_float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)),</span> <span class="n">unique</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ul</span><span class="p">)),</span> <span class="n">ul</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">unique</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)),</span> <span class="n">outcomes</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;linear&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using multi-outcome approach for categorical outcome&#39;</span><span class="p">)</span>

        <span class="c1"># If multiple categorical outcomes are used,</span>
        <span class="c1"># create a merged variable for k-fold splitting</span>
        <span class="k">if</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split_labels</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_labels</span> <span class="o">=</span> <span class="n">labels</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># --- Prepare k-fold validation configuration ---------------------</span>
        <span class="n">results_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;results_log.csv&#39;</span><span class="p">)</span>
        <span class="n">k_header</span> <span class="o">=</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k_fold_header</span>
        <span class="k">if</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_settings</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">val_settings</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="n">val_settings</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-manual&#39;</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">unique_k</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">k_header</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">valid_k</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">kf</span><span class="p">)</span> <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">unique_k</span><span class="p">]</span>
            <span class="n">k_fold</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_k</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manual folds: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="k">for</span> <span class="n">ks</span> <span class="ow">in</span> <span class="n">valid_k</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k</span><span class="p">:</span>
                <span class="n">valid_k</span> <span class="o">=</span> <span class="p">[</span><span class="n">kf</span> <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">valid_k</span> <span class="k">if</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;bootstrap&#39;</span><span class="p">):</span>
            <span class="n">k_fold</span> <span class="o">=</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k_fold</span>
            <span class="k">if</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">valid_k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_fold</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_k</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">kf</span> <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_fold</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_fold</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">valid_k</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Create model labels</span>
        <span class="n">label_string</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label_string</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">hp_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">k_fold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_iterations</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_iterations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">-kfold</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_k</span><span class="p">]</span>

        <span class="n">s_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">k_header</span><span class="o">=</span><span class="n">k_header</span><span class="p">,</span>
            <span class="n">valid_k</span><span class="o">=</span><span class="n">valid_k</span><span class="p">,</span>
            <span class="n">split_labels</span><span class="o">=</span><span class="n">split_labels</span><span class="p">,</span>
            <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">min_tiles</span><span class="o">=</span><span class="n">min_tiles</span><span class="p">,</span>
            <span class="n">max_tiles</span><span class="o">=</span><span class="n">max_tiles</span><span class="p">,</span>
            <span class="n">outcome_labels</span><span class="o">=</span><span class="n">outcome_labels</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">training_kwargs</span><span class="o">=</span><span class="n">training_kwargs</span><span class="p">,</span>
            <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span><span class="p">,</span>
            <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
            <span class="n">results_dict</span><span class="o">=</span><span class="n">results_dict</span><span class="p">,</span>
            <span class="n">bal_headers</span><span class="o">=</span><span class="n">balance_headers</span><span class="p">,</span>
            <span class="n">input_header</span><span class="o">=</span><span class="n">input_header</span>
        <span class="p">)</span>

        <span class="c1"># --- Train on a specific K-fold --------------------------------------</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_k</span><span class="p">:</span>
            <span class="n">s_args</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">val_settings</span><span class="p">,</span> <span class="n">s_args</span><span class="p">)</span>

        <span class="c1"># --- Record results --------------------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">source</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="ow">is</span> <span class="kc">None</span>
                 <span class="ow">or</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No validation performed.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">model_iterations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results_dict</span> <span class="ow">or</span> <span class="s1">&#39;epochs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">mi</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training failed for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">update_results_log</span><span class="p">(</span>
                        <span class="n">results_log_path</span><span class="p">,</span>
                        <span class="n">mi</span><span class="p">,</span>
                        <span class="n">results_dict</span><span class="p">[</span><span class="n">mi</span><span class="p">][</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training results saved: [green]</span><span class="si">{</span><span class="n">results_log_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_train_split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">hp</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">val_settings</span><span class="p">:</span> <span class="n">SimpleNamespace</span><span class="p">,</span>
        <span class="n">s_args</span><span class="p">:</span> <span class="n">SimpleNamespace</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Trains a model for a given training/validation split.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.Dataset`): Dataset to split into</span>
<span class="sd">                training and validation.</span>
<span class="sd">            hp (:class:`slideflow.ModelParams`): Model parameters.</span>
<span class="sd">            val_settings (:class:`types.SimpleNamspace`): Validation settings.</span>
<span class="sd">            s_args (:class:`types.SimpleNamspace`): Training settings.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Log current model name and k-fold iteration, if applicable</span>
        <span class="n">k_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">s_args</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s1"> #</span><span class="si">{</span><span class="n">s_args</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">getLoggingLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training model [bold]</span><span class="si">{</span><span class="n">s_args</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s1">[/]</span><span class="si">{</span><span class="n">k_msg</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Hyperparameters: </span><span class="si">{</span><span class="n">hp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Val settings: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">val_settings</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># --- Set up validation data ------------------------------------------</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">manifest</span><span class="p">()</span>

        <span class="c1"># Use an external validation dataset if supplied</span>
        <span class="k">if</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="n">train_dts</span> <span class="o">=</span> <span class="n">dataset</span>
            <span class="n">val_dts</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="n">tile_px</span><span class="o">=</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="n">tile_um</span><span class="o">=</span><span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">annotations</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
                <span class="n">filter_blank</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">filter_blank</span>
            <span class="p">)</span>
            <span class="n">is_float</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cph&#39;</span><span class="p">])</span>
            <span class="n">val_labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">s_args</span><span class="o">.</span><span class="n">outcomes</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="n">is_float</span><span class="p">)</span>
            <span class="n">s_args</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val_labels</span><span class="p">)</span>
        <span class="c1"># Use manual k-fold assignments if indicated</span>
        <span class="k">elif</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-manual&#39;</span><span class="p">:</span>
            <span class="n">t_filters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">s_args</span><span class="o">.</span><span class="n">k_header</span><span class="p">:</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">s_args</span><span class="o">.</span><span class="n">valid_k</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">s_args</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">train_dts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">t_filters</span><span class="p">)</span>
            <span class="n">val_dts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="n">s_args</span><span class="o">.</span><span class="n">k_header</span><span class="p">:</span> <span class="p">[</span><span class="n">s_args</span><span class="o">.</span><span class="n">k</span><span class="p">]})</span>
        <span class="c1"># No validation</span>
        <span class="k">elif</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">train_dts</span> <span class="o">=</span> <span class="n">dataset</span>
            <span class="n">val_dts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Otherwise, calculate k-fold splits</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">:</span>
                <span class="n">site_labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
                    <span class="n">s_args</span><span class="o">.</span><span class="n">k_header</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: Any</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">site_labels</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_val_split</span><span class="p">(</span>
                <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
                <span class="n">s_args</span><span class="o">.</span><span class="n">split_labels</span><span class="p">,</span>
                <span class="n">val_strategy</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
                <span class="n">splits</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">s_args</span><span class="o">.</span><span class="n">splits</span><span class="p">),</span>
                <span class="n">val_fraction</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span>
                <span class="n">val_k_fold</span><span class="o">=</span><span class="n">val_settings</span><span class="o">.</span><span class="n">k_fold</span><span class="p">,</span>
                <span class="n">k_fold_iter</span><span class="o">=</span><span class="n">s_args</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                <span class="n">site_labels</span><span class="o">=</span><span class="n">site_labels</span>
            <span class="p">)</span>

        <span class="c1"># ---- Balance and clip datasets --------------------------------------</span>
        <span class="k">if</span> <span class="n">s_args</span><span class="o">.</span><span class="n">bal_headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s_args</span><span class="o">.</span><span class="n">bal_headers</span> <span class="o">=</span> <span class="n">s_args</span><span class="o">.</span><span class="n">outcomes</span>
        <span class="n">train_dts</span> <span class="o">=</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">s_args</span><span class="o">.</span><span class="n">bal_headers</span><span class="p">,</span> <span class="n">hp</span><span class="o">.</span><span class="n">training_balance</span><span class="p">)</span>
        <span class="n">train_dts</span> <span class="o">=</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">s_args</span><span class="o">.</span><span class="n">max_tiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_dts</span><span class="p">:</span>
            <span class="n">val_dts</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span>
                <span class="n">s_args</span><span class="o">.</span><span class="n">bal_headers</span><span class="p">,</span>
                <span class="n">hp</span><span class="o">.</span><span class="n">validation_balance</span>
            <span class="p">)</span>
            <span class="n">val_dts</span> <span class="o">=</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">s_args</span><span class="o">.</span><span class="n">max_tiles</span><span class="p">)</span>
        <span class="n">num_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">val_dts</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">num_train</span><span class="si">}</span><span class="s1"> training TFRecords, </span><span class="si">{</span><span class="n">num_val</span><span class="si">}</span><span class="s1"> validation&#39;</span><span class="p">)</span>

        <span class="c1"># --- Prepare additional slide-level input ----------------------------</span>
        <span class="k">if</span> <span class="n">s_args</span><span class="o">.</span><span class="n">input_header</span><span class="p">:</span>
            <span class="n">_res</span> <span class="o">=</span> <span class="n">project_utils</span><span class="o">.</span><span class="n">_setup_input_labels</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">s_args</span><span class="o">.</span><span class="n">input_header</span><span class="p">,</span>
                <span class="n">val_dts</span><span class="o">=</span><span class="n">val_dts</span>
            <span class="p">)</span>
            <span class="n">inpt_labels</span><span class="p">,</span> <span class="n">feature_sizes</span><span class="p">,</span> <span class="n">slide_inp</span> <span class="o">=</span> <span class="n">_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inpt_labels</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">feature_sizes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">slide_inp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># --- Initialize model ------------------------------------------------</span>
        <span class="c1"># Using the project annotation file, assemble slides for training,</span>
        <span class="c1"># as well as the slide annotations dictionary (output labels)</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">s_args</span><span class="o">.</span><span class="n">model_name</span>
        <span class="k">if</span> <span class="n">s_args</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">full_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-kfold</span><span class="si">{</span><span class="n">s_args</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">git_commit</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">detect_git_commit</span><span class="p">()</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_new_model_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">full_name</span><span class="p">)</span>

        <span class="c1"># Log model settings and hyperparameters</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;slideflow_version&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">backend</span><span class="p">(),</span>
            <span class="s1">&#39;git_commit&#39;</span><span class="p">:</span> <span class="n">git_commit</span><span class="p">,</span>
            <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="s1">&#39;full_model_name&#39;</span><span class="p">:</span> <span class="n">full_name</span><span class="p">,</span>
            <span class="s1">&#39;stage&#39;</span><span class="p">:</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span>
            <span class="s1">&#39;img_format&#39;</span><span class="p">:</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">img_format</span><span class="p">,</span>
            <span class="s1">&#39;tile_px&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="s1">&#39;tile_um&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
            <span class="s1">&#39;max_tiles&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">max_tiles</span><span class="p">,</span>
            <span class="s1">&#39;min_tiles&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">min_tiles</span><span class="p">,</span>
            <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">model_type</span><span class="p">(),</span>
            <span class="s1">&#39;outcomes&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="s1">&#39;input_features&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">input_header</span><span class="p">,</span>
            <span class="s1">&#39;input_feature_sizes&#39;</span><span class="p">:</span> <span class="n">feature_sizes</span><span class="p">,</span>
            <span class="s1">&#39;input_feature_labels&#39;</span><span class="p">:</span> <span class="n">inpt_labels</span><span class="p">,</span>
            <span class="s1">&#39;outcome_labels&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">outcome_labels</span><span class="p">,</span>
            <span class="s1">&#39;dataset_config&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="p">,</span>
            <span class="s1">&#39;sources&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span>
            <span class="s1">&#39;annotations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="s1">&#39;validation_strategy&#39;</span><span class="p">:</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
            <span class="s1">&#39;validation_fraction&#39;</span><span class="p">:</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span>
            <span class="s1">&#39;validation_k_fold&#39;</span><span class="p">:</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">k_fold</span><span class="p">,</span>
            <span class="s1">&#39;k_fold_i&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
            <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(),</span>
            <span class="s1">&#39;training_kwargs&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">training_kwargs</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">full_name</span><span class="p">,</span>
            <span class="s1">&#39;manifest&#39;</span><span class="p">:</span> <span class="n">manifest</span><span class="p">,</span>
            <span class="s1">&#39;feature_names&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">input_header</span><span class="p">,</span>
            <span class="s1">&#39;feature_sizes&#39;</span><span class="p">:</span> <span class="n">feature_sizes</span><span class="p">,</span>
            <span class="s1">&#39;outcome_names&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="s1">&#39;outdir&#39;</span><span class="p">:</span> <span class="n">model_dir</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="s1">&#39;patients&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">patients</span><span class="p">(),</span>
            <span class="s1">&#39;slide_input&#39;</span><span class="p">:</span> <span class="n">slide_inp</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;mixed_precision&#39;</span><span class="p">:</span> <span class="n">s_args</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">,</span>
            <span class="s1">&#39;use_neptune&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_neptune</span><span class="p">,</span>
            <span class="s1">&#39;neptune_api&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_api</span><span class="p">,</span>
            <span class="s1">&#39;neptune_workspace&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">neptune_workspace</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">s_args</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">project_utils</span><span class="o">.</span><span class="n">_train_worker</span><span class="p">,</span>
                                     <span class="n">args</span><span class="o">=</span><span class="p">((</span><span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span><span class="p">),</span>
                                           <span class="n">model_kwargs</span><span class="p">,</span>
                                           <span class="n">s_args</span><span class="o">.</span><span class="n">training_kwargs</span><span class="p">,</span>
                                           <span class="n">s_args</span><span class="o">.</span><span class="n">results_dict</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">))</span>
        <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spawning training process (PID: </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<div class="viewcode-block" id="Project.add_source"><a class="viewcode-back" href="../../project.html#slideflow.Project.add_source">[docs]</a>    <span class="k">def</span> <span class="nf">add_source</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">slides</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">roi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tfrecords</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Adds a dataset source to the dataset configuration file.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Dataset source name.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            slides (str): Path to directory containing slides.</span>
<span class="sd">            roi (str): Path to directory containing CSV ROIs.</span>
<span class="sd">            tiles (str): Path to directory for storing extracted tiles.</span>
<span class="sd">            tfrecords (str): Path to directory for storing TFRecords of tiles.</span>
<span class="sd">            path (str, optional): Path to dataset configuration file.</span>
<span class="sd">                Defaults to None. If not provided, uses project default.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span>
        <span class="n">project_utils</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">slides</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">tfrecords</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.associate_slide_names"><a class="viewcode-back" href="../../project.html#slideflow.Project.associate_slide_names">[docs]</a>    <span class="k">def</span> <span class="nf">associate_slide_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Automatically associate patients with slides in the annotations.&quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">tile_px</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_um</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verification</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">update_annotations_with_slidenames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.create_blank_annotations"><a class="viewcode-back" href="../../project.html#slideflow.Project.create_blank_annotations">[docs]</a>    <span class="k">def</span> <span class="nf">create_blank_annotations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates an empty annotations file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Annotations file destination. If not provided,</span>
<span class="sd">                will use project default.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error creating annotations </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">; file already exists&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">AnnotationsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dataset config </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="si">}</span><span class="s2"> missing.&quot;</span>
            <span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span>
            <span class="n">tile_px</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tile_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">all_paths</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(</span><span class="n">apply_filters</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_paths</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_outfile</span><span class="p">:</span>
            <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_outfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;patient&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">]</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">slide</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote annotations file to [green]</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.create_hp_sweep"><a class="viewcode-back" href="../../project.html#slideflow.Project.create_hp_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">create_hp_sweep</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="s1">&#39;sweep.json&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Prepares a grid-search hyperparameter sweep, saving to a config file.</span>

<span class="sd">        To initiate a grid-search sweep using the created JSON file, pass</span>
<span class="sd">        this file to the ``params`` argument of ``Project.train()``:</span>

<span class="sd">            &gt;&gt;&gt; P.train(&#39;outcome&#39;, params=&#39;sweep.json&#39;, ...)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str, optional): Filename for hyperparameter sweep.</span>
<span class="sd">                Overwrites existing files. Saves in project root directory.</span>
<span class="sd">                Defaults to &quot;sweep.json&quot;.</span>
<span class="sd">            label (str, optional): Label to use when naming models in sweep.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            **kwargs: Parameters to include in the sweep. Parameters may either</span>
<span class="sd">                be fixed or provided as lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_epoch_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;epochs&#39;</span><span class="p">}</span>
        <span class="n">pdict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">non_epoch_kwargs</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">pdict</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdict</span><span class="p">[</span><span class="n">arg</span><span class="p">]]</span>
        <span class="n">argsv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">sweep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">argsv</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">-&#39;</span>
        <span class="n">hp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sweep</span><span class="p">):</span>
            <span class="n">full_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
            <span class="k">if</span> <span class="s1">&#39;epochs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">full_params</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="p">(</span><span class="o">**</span><span class="n">full_params</span><span class="p">)</span>
            <span class="n">hp_list</span> <span class="o">+=</span> <span class="p">[{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">HPSweep</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()}]</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">hp_list</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote hp sweep (len </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sweep</span><span class="p">)</span><span class="si">}</span><span class="s1">) to [green]</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">create_hyperparameter_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Deprecation warning: Project.create_hyperparameter_sweep() will&quot;</span>
            <span class="s2">&quot; be removed in slideflow&gt;=1.2. Use Project.create_hp_sweep().&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_hp_sweep</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Project.evaluate"><a class="viewcode-back" href="../../project.html#slideflow.Project.evaluate">[docs]</a>    <span class="nd">@auto_dataset</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_k_fold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;splits.json&quot;</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">input_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluates a saved model on a given set of tfrecords.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model to evaluate.</span>
<span class="sd">            outcomes (str): Str or list of str. Annotation column</span>
<span class="sd">                header specifying the outcome label(s).</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                to evaluate. If not supplied, will evaluate all project</span>
<span class="sd">                tfrecords at the tile_px/tile_um matching the supplied model,</span>
<span class="sd">                optionally using provided filters and filter_blank.</span>
<span class="sd">            filters (dict, optional): Filters dict to use when selecting</span>
<span class="sd">                tfrecords. Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Minimum number of tiles a slide must</span>
<span class="sd">                have to be included in evaluation. Defaults to 0.</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt file, if evaluating a</span>
<span class="sd">                saved checkpoint. Defaults to None.</span>
<span class="sd">            eval_k_fold (int, optional): K-fold iteration number to evaluate.</span>
<span class="sd">                Defaults to None. If None, will evaluate all tfrecords</span>
<span class="sd">                irrespective of K-fold.</span>
<span class="sd">            splits (str, optional): Filename of JSON file in which to log</span>
<span class="sd">                train/val splits. Looks for filename in project root directory.</span>
<span class="sd">                Defaults to &quot;splits.json&quot;.</span>
<span class="sd">            max_tiles (int, optional): Maximum number of tiles from each slide</span>
<span class="sd">                to evaluate. Defaults to 0. If zero, will include all tiles.</span>
<span class="sd">            mixed_precision (bool, optional): Enable mixed precision.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            input_header (str, optional): Annotation column header to use as</span>
<span class="sd">                additional input. Defaults to None.</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            **kwargs: Additional keyword arguments to the `Trainer.evaluate()`</span>
<span class="sd">                function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Dictionary of keras training results, nested by epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluating model at [green]</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">trainer</span><span class="p">,</span> <span class="n">eval_dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_trainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
            <span class="n">eval_k_fold</span><span class="o">=</span><span class="n">eval_k_fold</span><span class="p">,</span>
            <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
            <span class="n">max_tiles</span><span class="o">=</span><span class="n">max_tiles</span><span class="p">,</span>
            <span class="n">input_header</span><span class="o">=</span><span class="n">input_header</span><span class="p">,</span>
            <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span>
        <span class="p">)</span>
        <span class="c1"># Perform evaluation</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">())</span><span class="si">}</span><span class="s1"> tfrecords&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">eval_dts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.evaluate_clam"><a class="viewcode-back" href="../../project.html#slideflow.Project.evaluate_clam">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_clam</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pt_files</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">eval_tag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">attention_heatmaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate CLAM model on activations and export attention heatmaps.</span>

<span class="sd">        Args:</span>
<span class="sd">            exp_name (str): Name of experiment to evaluate (subfolder in clam/)</span>
<span class="sd">            pt_files (str): Path to pt_files containing tile-level features.</span>
<span class="sd">            outcomes (str or list): Annotation column that specifies labels.</span>
<span class="sd">            tile_px (int): Tile width in pixels.</span>
<span class="sd">            tile_um (int or str): Tile width in microns (int) or magnification</span>
<span class="sd">                (str, e.g. &quot;20x&quot;).</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            k (int, optional): K-fold / split iteration to evaluate. Evaluates</span>
<span class="sd">                the model saved as s_{k}_checkpoint.pt. Defaults to 0.</span>
<span class="sd">            eval_tag (str, optional): Unique identifier for this evaluation.</span>
<span class="sd">                Defaults to None</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            attention_heatmaps (bool, optional): Save attention heatmaps of</span>
<span class="sd">                validation dataset. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">slideflow.clam</span> <span class="k">as</span> <span class="nn">clam</span>
        <span class="kn">from</span> <span class="nn">slideflow.clam.create_attention</span> <span class="kn">import</span> <span class="n">export_attention</span>
        <span class="kn">from</span> <span class="nn">slideflow.clam.datasets.dataset_generic</span> <span class="kn">import</span> <span class="n">Generic_MIL_Dataset</span>

        <span class="c1"># Detect source CLAM experiment which we are evaluating.</span>
        <span class="c1"># First, assume it lives in this project&#39;s clam folder</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;clam&#39;</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">,</span> <span class="s1">&#39;experiment.json&#39;</span><span class="p">)):</span>
            <span class="n">exp_name</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;clam&#39;</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="s1">&#39;experiment.json&#39;</span><span class="p">)):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">CLAMError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find experiment &#39;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading experiment from [green]</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s1">[/], k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">eval_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">)</span>

        <span class="c1"># Set up evaluation directory with unique evaluation tag</span>
        <span class="n">existing_tags</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">eval_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_tag</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_tags</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">existing_tags</span><span class="p">))</span>

        <span class="c1"># Ensure evaluation tag will not overwrite existing results</span>
        <span class="k">if</span> <span class="n">eval_tag</span> <span class="ow">in</span> <span class="n">existing_tags</span><span class="p">:</span>
            <span class="n">unique</span><span class="p">,</span> <span class="n">base_tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">eval_tag</span>
            <span class="n">eval_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_tag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">unique</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">while</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">,</span> <span class="n">eval_tag</span><span class="p">)):</span>
                <span class="n">eval_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_tag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">unique</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">unique</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tag </span><span class="si">{</span><span class="n">base_tag</span><span class="si">}</span><span class="s2"> already exists, using tag &#39;eval_tag&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Load trained model checkpoint</span>
        <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;s_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_checkpoint.pt&#39;</span><span class="p">)</span>
        <span class="n">eval_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">,</span> <span class="n">eval_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">)</span>
        <span class="n">args_dict</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">exp_name</span><span class="p">,</span> <span class="s1">&#39;experiment.json&#39;</span><span class="p">))</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">args_dict</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">eval_dir</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span>
            <span class="n">tile_px</span><span class="o">=</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span>
        <span class="p">)</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
        <span class="n">eval_slides</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slides</span> <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">pt_files</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="s1">&#39;.pt&#39;</span><span class="p">))]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">eval_slides</span><span class="p">})</span>
        <span class="n">slide_labels</span><span class="p">,</span> <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Set up evaluation annotations file based off existing pt_files</span>
        <span class="n">outcome_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)),</span> <span class="n">unique_labels</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">,</span> <span class="s1">&#39;eval_annotations.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">eval_file</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">eval_file</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;patient&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">eval_slides</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">slide</span><span class="p">,</span> <span class="n">slide</span><span class="p">]</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">outcome_dict</span><span class="p">[</span><span class="n">slide_labels</span><span class="p">[</span><span class="n">slide</span><span class="p">]]]</span>  <span class="c1"># type: ignore</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">clam_dataset</span> <span class="o">=</span> <span class="n">Generic_MIL_Dataset</span><span class="p">(</span>
            <span class="n">csv_path</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">,</span> <span class="s1">&#39;eval_annotations.csv&#39;</span><span class="p">),</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="n">pt_files</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">print_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">label_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))),</span>
            <span class="n">patient_strat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ignore</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>

        <span class="n">clam</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">clam_dataset</span><span class="p">)</span>

        <span class="c1"># Get attention from trained model on validation set</span>
        <span class="n">attention_tfrecords</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">attention_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">,</span> <span class="s1">&#39;attention&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">attention_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">attention_dir</span><span class="p">)</span>
        <span class="n">reverse_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)),</span> <span class="n">unique_labels</span><span class="p">))</span>
        <span class="n">export_attention</span><span class="p">(</span>
            <span class="n">args_dict</span><span class="p">,</span>
            <span class="n">ckpt_path</span><span class="o">=</span><span class="n">ckpt_path</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">attention_dir</span><span class="p">,</span>
            <span class="n">pt_files</span><span class="o">=</span><span class="n">pt_files</span><span class="p">,</span>
            <span class="n">slides</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">(),</span>
            <span class="n">reverse_labels</span><span class="o">=</span><span class="n">reverse_labels</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">slide_labels</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">attention_heatmaps</span><span class="p">:</span>
            <span class="n">heatmaps_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">,</span> <span class="s1">&#39;attention_heatmaps&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">heatmaps_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">heatmaps_dir</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">attention_tfrecords</span><span class="p">:</span>
                <span class="n">attention_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">slide</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">attention_dir</span><span class="p">,</span> <span class="n">slide</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                            <span class="n">attention_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])})</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No attention scores for slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1">, skipping&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecord_heatmap</span><span class="p">(</span>
                    <span class="n">tfr</span><span class="p">,</span>
                    <span class="n">tile_dict</span><span class="o">=</span><span class="n">attention_dict</span><span class="p">,</span>
                    <span class="n">outdir</span><span class="o">=</span><span class="n">heatmaps_dir</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Project.extract_tiles"><a class="viewcode-back" href="../../project.html#slideflow.Project.extract_tiles">[docs]</a>    <span class="k">def</span> <span class="nf">extract_tiles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extracts tiles from slides. Preferred use is calling</span>
<span class="sd">        :func:`slideflow.dataset.Dataset.extract_tiles` on a</span>
<span class="sd">        :class:`slideflow.dataset.Dataset` directly.</span>

<span class="sd">        Args:</span>
<span class="sd">            tile_px (int): Size of tiles to extract, in pixels.</span>
<span class="sd">            tile_um (int or str): Size of tiles to extract, in microns (int) or</span>
<span class="sd">                magnification (str, e.g. &quot;20x&quot;).</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            save_tiles (bool, optional): Save tile images in loose format.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            save_tfrecords (bool, optional): Save tile images as TFRecords.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            source (str, optional): Process slides only from this source.</span>
<span class="sd">                Defaults to None (all slides in project).</span>
<span class="sd">            stride_div (int, optional): Stride divisor. Defaults to 1.</span>
<span class="sd">                A stride of 1 will extract non-overlapping tiles.</span>
<span class="sd">                A stride_div of 2 will extract overlapping tiles with a stride</span>
<span class="sd">                equal to 50% of the tile width.</span>
<span class="sd">            enable_downsample (bool, optional): Enable downsampling when</span>
<span class="sd">                reading slides. Defaults to True. This may result in corrupted</span>
<span class="sd">                image tiles if downsampled slide layers are corrupted or</span>
<span class="sd">                incomplete. Recommend manual confirmation of tile integrity.</span>
<span class="sd">            roi_method (str): Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, or &#39;ignore&#39;.</span>
<span class="sd">                Determines how ROIs are used to extract tiles.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and skip the slide if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            skip_extracted (bool, optional): Skip already extracted slides.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            tma (bool, optional): Reads slides as Tumor Micro-Arrays (TMAs),</span>
<span class="sd">                detecting and extracting tumor cores. Defaults to False.</span>
<span class="sd">            randomize_origin (bool, optional): Randomize pixel starting</span>
<span class="sd">                position during extraction. Defaults to False.</span>
<span class="sd">            buffer (str, optional): Copy slides here before extraction.</span>
<span class="sd">                Improves processing speed if using an SSD/ramdisk buffer.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            num_workers (int, optional): Extract tiles from this many slides</span>
<span class="sd">                simultaneously. Defaults to 1.</span>
<span class="sd">            q_size (int, optional): Queue size for buffer. Defaults to 4.</span>
<span class="sd">            qc (str, optional): &#39;otsu&#39;, &#39;blur&#39;, &#39;both&#39;, or None. Perform blur</span>
<span class="sd">                detection quality control - discarding tiles with detected</span>
<span class="sd">                out-of-focus regions or artifact - and/or otsu&#39;s method.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            report (bool, optional): Save a PDF report of tile extraction.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            normalizer (str, optional): Normalization strategy.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            normalizer_source (str, optional): Path to normalizer source image.</span>
<span class="sd">                Defaults to None (use internal image at slide.norm_tile.jpg).</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace. If 1, will not</span>
<span class="sd">                perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Threshold above</span>
<span class="sd">                which a pixel (RGB average) is considered whitespace.</span>
<span class="sd">                Defaults to 230.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Discard tiles with</span>
<span class="sd">                this fraction of grayspace. If 1, will not perform grayspace</span>
<span class="sd">                filtering. Defaults to 0.6.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Pixels in HSV</span>
<span class="sd">                format with saturation below this are considered grayspace.</span>
<span class="sd">                Defaults to 0.05.</span>
<span class="sd">            img_format (str, optional): &#39;png&#39; or &#39;jpg&#39;. Defaults to &#39;jpg&#39;.</span>
<span class="sd">                Image format to use in tfrecords. PNG (lossless) for</span>
<span class="sd">                fidelity, JPG (lossy) for efficiency.</span>
<span class="sd">            full_core (bool, optional): Only used if extracting from TMA. Save</span>
<span class="sd">                entire TMA core as image. Otherwise, will extract sub-images</span>
<span class="sd">                from each core at the tile micron size. Defaults to False.</span>
<span class="sd">            shuffle (bool, optional): Shuffle tiles before tfrecords storage.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            num_threads (int, optional): Threads for each tile extractor.</span>
<span class="sd">                Defaults to 4.</span>
<span class="sd">            qc_blur_radius (int, optional): Blur radius for out-of-focus area</span>
<span class="sd">                detection. Used if qc=True. Defaults to 3.</span>
<span class="sd">            qc_blur_threshold (float, optional): Blur threshold for detecting</span>
<span class="sd">                out-of-focus areas. Used if qc=True. Defaults to 0.1.</span>
<span class="sd">            qc_filter_threshold (float, optional): Float between 0-1.</span>
<span class="sd">                Tiles with more than this proportion of blur will be discarded.</span>
<span class="sd">                Used if qc=True. Defaults to 0.6.</span>
<span class="sd">            qc_mpp (float, optional): Microns-per-pixel indicating image</span>
<span class="sd">                magnification level at which quality control is performed.</span>
<span class="sd">                Defaults to mpp=4 (effective magnification 2.5 X)</span>
<span class="sd">            dry_run (bool, optional): Determine tiles that would be extracted,</span>
<span class="sd">                but do not export any images. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping slide paths to each slide&#39;s SlideReport</span>
<span class="sd">            (:class:`slideflow.slide.report.SlideReport`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span>
            <span class="n">tile_px</span><span class="p">,</span>
            <span class="n">tile_um</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">,</span>
            <span class="n">verification</span><span class="o">=</span><span class="s1">&#39;slides&#39;</span>
        <span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">extract_tiles</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.gan_train"><a class="viewcode-back" href="../../project.html#slideflow.Project.gan_train">[docs]</a>    <span class="k">def</span> <span class="nf">gan_train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;stylegan2&#39;</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exp_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mirror</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">augpipe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;bgcfnc&#39;</span><span class="p">,</span>
        <span class="n">allow_tf32</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Train a GAN network.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (:class:`slideflow.Dataset`): Training dataset.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            allow_tf32 (bool): Allow internal use of Tensorflow-32.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            aug (str): Augmentation mode. Options include &#39;ada&#39;,</span>
<span class="sd">                &#39;noaug&#39;, &#39;fixed&#39;. Defaults to &#39;ada&#39;.</span>
<span class="sd">            augpipe (str): Augmentation pipeline. Options include</span>
<span class="sd">                &#39;blit&#39;, &#39;geom&#39;, &#39;color&#39;, &#39;filter&#39;, &#39;noise&#39;, &#39;cutout&#39;, &#39;bg&#39;,</span>
<span class="sd">                &#39;bgc&#39;, &#39;bgcfnc&#39;. Defaults to &#39;bgcfnc&#39;.</span>
<span class="sd">            batch (int, optional): Override batch size set by `cfg`.</span>
<span class="sd">            cfg (str): StyleGAN2 base configuration. Options include</span>
<span class="sd">                &#39;auto&#39;, &#39;stylegan2&#39;, &#39;paper256&#39;, &#39;paper512&#39;, &#39;paper1024&#39;, and</span>
<span class="sd">                &#39;cifar&#39;. Defaults to &#39;auto&#39;.</span>
<span class="sd">            dry_run (bool): Set up training but do not execute.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            exp_label (str, optional): Experiment label. Defaults to None.</span>
<span class="sd">            freezed (int): Freeze this many discriminator layers.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            fp32 (bool, optional): Disable mixed-precision training. Defaults</span>
<span class="sd">                to False.</span>
<span class="sd">            gamma (float, optional): Override R1 gamma from configuration</span>
<span class="sd">                (set with `cfg`).</span>
<span class="sd">            gpus (int): Number GPUs to train on in parallel. Defaults</span>
<span class="sd">                to 1.</span>
<span class="sd">            kimg (int): Override training duration in kimg (thousand</span>
<span class="sd">                images) set by `cfg`. Most configurations default to 25,000</span>
<span class="sd">                kimg (25 million images).</span>
<span class="sd">            lazy_resume (bool). Allow lazy loading from saved pretrained</span>
<span class="sd">                networks, for example to load a non-conditional network</span>
<span class="sd">                when training a conditional network. Defaults to False.</span>
<span class="sd">            mirror (bool): Randomly flip/rotate images during</span>
<span class="sd">                training. Defaults to True.</span>
<span class="sd">            metrics (str, list(str), optional): Metrics to calculate during</span>
<span class="sd">                training. Options include &#39;fid50k&#39;, &#39;is50k&#39;, &#39;ppl_zfull&#39;,</span>
<span class="sd">                &#39;ppl_wfull&#39;, &#39;ppl_zend&#39;, &#39;ppl2_wend&#39;, &#39;ls&#39;, and &#39;pr50k3&#39;.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            model (str): Architecture to train. Only currently valid model</span>
<span class="sd">                architecture is &quot;stylegan2&quot;. Defaults to &quot;stylegan2&quot;.</span>
<span class="sd">            nhwc (bool): Use NWHC memory format with FP16. Defaults to False.</span>
<span class="sd">            nobench (bool): Disable cuDNN benchmarking. Defaults to False.</span>
<span class="sd">            outcomes (str, list(str), optional): Class conditioning outcome</span>
<span class="sd">                labels for training a class-conditioned GAN. If not provided,</span>
<span class="sd">                trains an unconditioned GAN. Defaults to None.</span>
<span class="sd">            resume (str): Load previous network. Options include</span>
<span class="sd">                &#39;noresume&#39; , &#39;ffhq256&#39;, &#39;ffhq512&#39;, &#39;ffhqq1024&#39;, &#39;celebahq256&#39;,</span>
<span class="sd">                &#39;lsundog256&#39;, &lt;file&gt;, or &lt;url&gt;. Defaults to &#39;noresume&#39;.</span>
<span class="sd">            snap (int): Snapshot interval for saving network and</span>
<span class="sd">                example images. Defaults to 50 ticks.</span>

<span class="sd">        Examples</span>
<span class="sd">            Train StyleGAN2 from a Slideflow dataset.</span>

<span class="sd">                &gt;&gt;&gt; P = sf.Project(&#39;/project/path&#39;)</span>
<span class="sd">                &gt;&gt;&gt; dataset = P.dataset(tile_px=512, tile_um=400)</span>
<span class="sd">                &gt;&gt;&gt; P.gan_train(dataset=dataset, exp_label=&quot;MyExperiment&quot;, ...)</span>

<span class="sd">            Train StyleGAN2 as a class-conditional network.</span>

<span class="sd">                &gt;&gt;&gt; P.gan_train(..., outcomes=&#39;class_label&#39;)</span>

<span class="sd">            Train using a pretrained network.</span>

<span class="sd">                &gt;&gt;&gt; P.gan_train(..., resume=&#39;/path/to/network.pkl&#39;)</span>

<span class="sd">            Train with multiple GPUs.</span>

<span class="sd">                &gt;&gt;&gt; P.gan_train(..., gpus=4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the method and import the appropriate submodule</span>
        <span class="n">supported_models</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;stylegan2&#39;</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;. Valid methods &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;include: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported_models</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;stylegan2&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">slideflow.gan</span> <span class="kn">import</span> <span class="n">stylegan2</span> <span class="k">as</span> <span class="n">network</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;StyleGAN2 metrics are not fully implemented for Slideflow.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Setup directories</span>
        <span class="n">gan_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;gan&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">gan_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gan_root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exp_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp_label</span> <span class="o">=</span> <span class="s1">&#39;gan_experiment&#39;</span>
        <span class="n">gan_dir</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_new_model_dir</span><span class="p">(</span><span class="n">gan_root</span><span class="p">,</span> <span class="n">exp_label</span><span class="p">)</span>

        <span class="c1"># Write GAN configuration</span>
        <span class="n">config_loc</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">gan_dir</span><span class="p">,</span> <span class="s1">&#39;slideflow_config.json&#39;</span><span class="p">)</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">project_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
            <span class="n">tile_px</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
            <span class="n">tile_um</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
            <span class="n">outcome_label_headers</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_filters</span><span class="p">,</span>
            <span class="n">filter_blank</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_filter_blank</span><span class="p">,</span>
        <span class="p">),</span> <span class="n">config_loc</span><span class="p">)</span>

        <span class="c1"># Train the GAN</span>
        <span class="n">network</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">gan_dir</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
            <span class="n">slideflow</span><span class="o">=</span><span class="n">config_loc</span><span class="p">,</span>
            <span class="n">cond</span><span class="o">=</span><span class="p">(</span><span class="n">outcomes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">mirror</span><span class="o">=</span><span class="n">mirror</span><span class="p">,</span>
            <span class="n">augpipe</span><span class="o">=</span><span class="n">augpipe</span><span class="p">,</span>
            <span class="n">allow_tf32</span><span class="o">=</span><span class="n">allow_tf32</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.gan_generate"><a class="viewcode-back" href="../../project.html#slideflow.Project.gan_generate">[docs]</a>    <span class="k">def</span> <span class="nf">gan_generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">network_pkl</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">out</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">seeds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate images from a trained GAN network.</span>

<span class="sd">        Args:</span>
<span class="sd">            network_pkl (str): Path to a trained StyleGAN2 network (``.pkl``)</span>
<span class="sd">            out (str): Directory in which to save generated images.</span>
<span class="sd">            seeds (list(int)): Seeds for which images will be generated.</span>

<span class="sd">        Keyword args:</span>
<span class="sd">            format (str, optional): Image format, either &#39;jpg&#39; or &#39;png&#39;.</span>
<span class="sd">                Defaults to &#39;png&#39;.</span>
<span class="sd">            truncation_psi (float, optional): Truncation PSI. Defaults to 1.</span>
<span class="sd">            noise_mode (str, optional): Either &#39;const&#39;, &#39;random&#39;, or &#39;none&#39;.</span>
<span class="sd">                Defaults to &#39;const&#39;.</span>
<span class="sd">            class_idx (int, optional): Class index to generate, for class-</span>
<span class="sd">                conditional networks. Defaults to None.</span>
<span class="sd">            save_projection (bool, optional): Save weight projection for each</span>
<span class="sd">                generated image as an `.npz` file in the out directory.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            resize (bool, optional): Crop/resize images to a target micron/pixel</span>
<span class="sd">                size. Defaults to False.</span>
<span class="sd">            gan_um (int, optional): Size of GAN images in microns. Used for</span>
<span class="sd">                cropping/resizing images to a target size. Defaults to None.</span>
<span class="sd">            gan_px (int, optional): Size of GAN images in pixels. Used for</span>
<span class="sd">                cropping/resizing images to a target size. Defaults to None.</span>
<span class="sd">            target_um (int, optional): Crop/resize GAN images to this micron</span>
<span class="sd">                size. Defaults to None.</span>
<span class="sd">            target_px (int, optional): Crop/resize GAN images to this pixel</span>
<span class="sd">                size. Defaults to None.</span>

<span class="sd">        Examples</span>
<span class="sd">            Save images as ``.png`` for seeds 0-100.</span>

<span class="sd">                &gt;&gt;&gt; network_pkl = &#39;/path/to/trained/gan.pkl&#39;</span>
<span class="sd">                &gt;&gt;&gt; P.gan_generate(</span>
<span class="sd">                ...     network_pkl,</span>
<span class="sd">                ...     out=&#39;/dir&#39;,</span>
<span class="sd">                ...     format=&#39;jpg&#39;,</span>
<span class="sd">                ...     seeds=range(100))</span>

<span class="sd">            Save images in TFRecord format.</span>

<span class="sd">                &gt;&gt;&gt; P.gan_generate(... out=&#39;target.tfrecords&#39;)</span>

<span class="sd">            Save images of class &#39;0&#39; for a class-conditional GAN.</span>

<span class="sd">                &gt;&gt;&gt; P.gan_generate(..., class_idx=0)</span>

<span class="sd">            Resize GAN images (trained at 512 px / 400 um) to match a target</span>
<span class="sd">            tile size (299 px / 302 um).</span>

<span class="sd">                &gt;&gt;&gt; P.gan_generate(</span>
<span class="sd">                ...     ...,</span>
<span class="sd">                ...     gan_px=512,</span>
<span class="sd">                ...     gan_um=400,</span>
<span class="sd">                ...     target_px=299,</span>
<span class="sd">                ...     target_um=302)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">slideflow.gan</span> <span class="kn">import</span> <span class="n">stylegan2</span>

        <span class="n">stylegan2</span><span class="o">.</span><span class="n">generate</span><span class="o">.</span><span class="n">generate_images</span><span class="p">(</span>
            <span class="n">network_pkl</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
            <span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Project.generate_features"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_features">[docs]</a>    <span class="nd">@auto_dataset</span>
    <span class="k">def</span> <span class="nf">generate_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">torch_export</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">DatasetFeatures</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate layer features / activations.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate activations. If not supplied, calculate</span>
<span class="sd">                activations for all tfrecords compatible with the model,</span>
<span class="sd">                optionally using provided filters and filter_blank.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                 Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Slides blank in these columns will</span>
<span class="sd">                be excluded. Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Only include slides with this minimum</span>
<span class="sd">                number of tiles. Defaults to 0.</span>
<span class="sd">            max_tiles (int, optional): Only include maximum of this many tiles</span>
<span class="sd">                per slide. Defaults to 0 (all tiles).</span>
<span class="sd">            outcomes (list, optional): Column header(s) in annotations file.</span>
<span class="sd">                Used for category-level comparisons. Defaults to None.</span>
<span class="sd">            torch_export (str, optional): Path. Export activations to</span>
<span class="sd">                torch-compatible file at this location. Defaults to None.</span>
<span class="sd">            layers (list(str)): Layers from which to generate activations.</span>
<span class="sd">                Defaults to &#39;postconv&#39;.</span>
<span class="sd">            export (str): Path to CSV file. Save activations in CSV format.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            cache (str): Path to PKL file. Cache activations at this location.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            include_logits (bool): Generate and store logit predictions along</span>
<span class="sd">                with layer activations. Defaults to True.</span>
<span class="sd">            batch_size (int): Batch size to use when calculating activations.</span>
<span class="sd">                Defaults to 32.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`slideflow.DatasetFeatures`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare dataset and annotations</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outcomes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">DatasetFeatures</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                                <span class="n">annotations</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch_export</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="n">torch_export</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Project.generate_features_for_clam"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_features_for_clam">[docs]</a>    <span class="k">def</span> <span class="nf">generate_features_for_clam</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;postconv&#39;</span><span class="p">,</span>
        <span class="n">force_regenerate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate tile-level features for slides for use with CLAM.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model from which to generate activations.</span>
<span class="sd">                May provide either this or &quot;pt_files&quot;</span>
<span class="sd">            outdir (str, optional): Save exported activations in .pt format.</span>
<span class="sd">                Defaults to &#39;auto&#39; (project directory).</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate activations. If not supplied, calculate</span>
<span class="sd">                activations for all tfrecords compatible with the model,</span>
<span class="sd">                optionally using provided filters and filter_blank.</span>
<span class="sd">            min_tiles (int, optional): Minimum tiles per slide. Skip slides</span>
<span class="sd">                not meeting this threshold. Defaults to 8.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Slides blank in these columns will</span>
<span class="sd">                be excluded. Defaults to None.</span>
<span class="sd">            layers (list, optional): Which model layer(s) generate activations.</span>
<span class="sd">                Defaults to &#39;postconv&#39;.</span>
<span class="sd">            max_tiles (int, optional): Maximum tiles to take per slide.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            force_regenerate (bool, optional): Forcibly regenerate activations</span>
<span class="sd">                for all slides even if .pt file exists. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to directory containing exported .pt files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if the model exists and has a valid parameters file</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-building dataset from provided model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span>
                    <span class="n">tile_px</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">],</span>
                    <span class="n">tile_um</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">],</span>
                    <span class="n">min_tiles</span><span class="o">=</span><span class="n">min_tiles</span>
                <span class="p">)</span>

            <span class="c1"># Set up the pt_files directory for storing model activations</span>
            <span class="k">if</span> <span class="n">outdir</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;k_fold_i&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="n">_end</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_kfold</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;k_fold_i&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">outdir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;pt_files&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_end</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must supply &#39;dataset&#39; if generating features from an &quot;</span>
                <span class="s2">&quot;Imagenet-pretrained model.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Verify the dataset min tiles is at least 8</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">min_tiles</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Slides must have at &gt;=8 tiles to train CLAM (provided &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dataset has min_tiles=</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">min_tiles</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If the model does not exist, check if it is an architecture name</span>
        <span class="c1"># (for using an Imagenet pretrained model)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">ModelParams</span><span class="o">.</span><span class="n">ModelDict</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating features from Imagenet-pretrained </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">_hp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">ModelParams</span><span class="p">(</span>
                <span class="n">tile_px</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="n">tile_um</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">hidden_layers</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

            <span class="c1"># Set the pt_files directory if not provided</span>
            <span class="k">if</span> <span class="n">outdir</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">outdir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;pt_files&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

            <span class="c1"># Now, overwrite the model name with the built model</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">_hp</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">pretrain</span><span class="o">=</span><span class="s1">&#39;imagenet&#39;</span>
            <span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; is neither a path to a saved model nor the name &quot;</span>
                <span class="s2">&quot;of a valid model architecture.&quot;</span><span class="p">)</span>

        <span class="c1"># Create the pt_files directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># Detect already generated pt files</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">path_to_name</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;pt&#39;</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_regenerate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">):</span>
            <span class="n">all_slides</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">slides_to_generate</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_slides</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides_to_generate</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_slides</span><span class="p">):</span>
                <span class="n">to_skip</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_slides</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides_to_generate</span><span class="p">)</span>
                <span class="n">skip_p</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_skip</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_slides</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">skip_p</span><span class="si">}</span><span class="s2"> finished slides.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slides_to_generate</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No slides to generate CLAM features.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">outdir</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slide&#39;</span><span class="p">:</span> <span class="n">slides_to_generate</span><span class="p">})</span>
            <span class="n">filtered_slides_to_generate</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">)</span><span class="si">}</span><span class="s1"> files already done.&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_slides_to_generate</span><span class="p">)</span><span class="si">}</span><span class="s1"> slides&#39;</span><span class="p">)</span>

        <span class="c1"># Set up activations interface</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">DatasetFeatures</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">include_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdir</span></div>

<div class="viewcode-block" id="Project.generate_heatmaps"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_heatmaps">[docs]</a>    <span class="nd">@auto_dataset</span>
    <span class="k">def</span> <span class="nf">generate_heatmaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inside&#39;</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">skip_completed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates predictive heatmap overlays on a set of slides.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to Tensorflow model.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate predictions. If not supplied, will</span>
<span class="sd">                generate predictions for all project tfrecords at the</span>
<span class="sd">                tile_px/tile_um matching the model, optionally using provided</span>
<span class="sd">                filters and filter_blank.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Minimum tiles per slide. Skip slides</span>
<span class="sd">                not meeting this threshold. Defaults to 8.</span>
<span class="sd">            outdir (path, optional): Directory in which to save heatmap images.</span>
<span class="sd">            resolution (str, optional): Heatmap resolution. Defaults to &#39;low&#39;.</span>
<span class="sd">                &quot;low&quot; uses a stride equal to tile width.</span>
<span class="sd">                &quot;medium&quot; uses a stride equal 1/2 tile width.</span>
<span class="sd">                &quot;high&quot; uses a stride equal to 1/4 tile width.</span>
<span class="sd">            batch_size (int, optional): Batch size during heatmap calculation.</span>
<span class="sd">                Defaults to 64.</span>
<span class="sd">            roi_method (str): Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, or &#39;ignore&#39;.</span>
<span class="sd">                Determines how ROIs are used to extract tiles.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            num_threads (int, optional): Number of threads for tile extraction.</span>
<span class="sd">                Defaults to CPU core count.</span>
<span class="sd">            img_format (str, optional): Image format (png, jpg) to use when</span>
<span class="sd">                extracting tiles from slide. Must match the image format</span>
<span class="sd">                the model was trained on. If &#39;auto&#39;, will use the format</span>
<span class="sd">                logged in the model params.json.</span>
<span class="sd">            skip_completed (bool, optional): Skip heatmaps for slides that</span>
<span class="sd">                already have heatmaps in target directory.</span>
<span class="sd">            show_roi (bool): Show ROI on heatmaps.</span>
<span class="sd">            interpolation (str): Interpolation strategy for predictions.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">                Includes all matplotlib imshow interpolation options.</span>
<span class="sd">            logit_cmap: Function or a dict used to create heatmap colormap.</span>
<span class="sd">                If None (default), separate heatmaps are generated for each</span>
<span class="sd">                category, with color representing category prediction.</span>
<span class="sd">                Each image tile will generate a list of preds of length O,</span>
<span class="sd">                If logit_cmap is a function, then the logit predictions will</span>
<span class="sd">                be passed, where O is the number of label categories.</span>
<span class="sd">                and the function is expected to return [R, G, B] values.</span>
<span class="sd">                If the logit_cmap is a dictionary, it should map &#39;r&#39;, &#39;g&#39;, and</span>
<span class="sd">                &#39;b&#39; to label indices; the prediction for these label categories</span>
<span class="sd">                will be mapped to corresponding colors. Thus, the corresponding</span>
<span class="sd">                color will only reflect predictions of up to three labels.</span>
<span class="sd">                Example (this would map predictions for label 0 to red, 3 to</span>
<span class="sd">                green, etc): {&#39;r&#39;: 0, &#39;g&#39;: 3, &#39;b&#39;: 1 }</span>
<span class="sd">            vmin (float): Minimimum value to display on heatmap. Defaults to 0.</span>
<span class="sd">            vcenter (float): Center value for color display on heatmap.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            vmax (float): Maximum value to display on heatmap. Defaults to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Prepare arguments for subprocess</span>
        <span class="n">heatmap_args</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">heatmap_args</span><span class="o">.</span><span class="n">self</span>

        <span class="c1"># Prepare dataset</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">heatmap_args</span><span class="o">.</span><span class="n">rois</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">rois</span><span class="p">()</span>

        <span class="c1"># Set resolution / stride</span>
        <span class="n">resolutions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stride_div</span> <span class="o">=</span> <span class="n">resolutions</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid resolution &#39;</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="n">heatmap_args</span><span class="o">.</span><span class="n">stride_div</span> <span class="o">=</span> <span class="n">stride_div</span>
        <span class="n">heatmap_args</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>
        <span class="n">heatmap_args</span><span class="o">.</span><span class="n">img_format</span> <span class="o">=</span> <span class="n">img_format</span>

        <span class="c1"># Attempt to auto-detect supplied model name</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;model_name&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span>

        <span class="c1"># Make output directory</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span> <span class="k">if</span> <span class="n">outdir</span> <span class="k">else</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;heatmaps&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">heatmap_args</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>

        <span class="c1"># Any function loading a slide must be kept in an isolated process,</span>
        <span class="c1"># as loading &gt;1 slide in a single process causes instability.</span>
        <span class="c1"># I suspect this is a libvips or openslide issue but I haven&#39;t been</span>
        <span class="c1"># able to identify the root cause. Isolating processes when multiple</span>
        <span class="c1"># slides are to be processed sequentially is a functional workaround.</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">slide</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">skip_completed</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">-custom.png&#39;</span><span class="p">))):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping completed heatmap for slide </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">ctx</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">project_utils</span><span class="o">.</span><span class="n">_heatmap_worker</span><span class="p">,</span>
                                  <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">heatmap_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
            <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.generate_mosaic"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_mosaic">[docs]</a>    <span class="k">def</span> <span class="nf">generate_mosaic</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="s2">&quot;DatasetFeatures&quot;</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">map_slide</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">predict_on_axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">umap_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_float</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">low_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">umap_kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">Mosaic</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates a mosaic map by overlaying images onto mapped tiles.</span>
<span class="sd">            Image tiles are extracted from the provided set of TFRecords, and</span>
<span class="sd">            predictions + features from layer activations are calculated using</span>
<span class="sd">            the specified model. Tiles are mapped either with UMAP of layer</span>
<span class="sd">            activations (default behavior), or by using outcome predictions for</span>
<span class="sd">            two categories, mapped to X- and Y-axis (via predict_on_axes).</span>

<span class="sd">        Args:</span>
<span class="sd">            df (:class:`slideflow.DatasetFeatures`): Dataset.</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate mosaic. If not supplied, will generate</span>
<span class="sd">                mosaic for all tfrecords at the tile_px/tile_um matching</span>
<span class="sd">                the supplied model, optionally using filters/filter_blank.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            filters (dict, optional): Filters dict to use when selecting</span>
<span class="sd">                tfrecords. Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Slides blank in these columns will</span>
<span class="sd">                be excluded. Defaults to None.</span>
<span class="sd">            outcomes (list, optional): Column name in annotations file from</span>
<span class="sd">                which to read category labels.</span>
<span class="sd">            map_slide (str, optional): None (default), &#39;centroid&#39; or &#39;average&#39;.</span>
<span class="sd">                If provided, will map slides using slide-level calculations,</span>
<span class="sd">                either mapping centroid tiles if &#39;centroid&#39;, or calculating</span>
<span class="sd">                node averages across tiles in a slide and mapping slide-level</span>
<span class="sd">                node averages, if &#39;average&#39;.</span>
<span class="sd">            show_prediction (int or str, optional): May be either int or str,</span>
<span class="sd">                corresponding to label category. Predictions for this category</span>
<span class="sd">                will be displayed on the exported UMAP plot.</span>
<span class="sd">            max_tiles (int, optional): Limits tiles taken from each slide.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            umap_cache (str, optional): Path to PKL file in which to save/cache</span>
<span class="sd">                UMAP coordinates. Defaults to None.</span>
<span class="sd">            use_float (bool, optional): Interpret labels as continuous instead</span>
<span class="sd">                of categorical. Defaults to False.</span>
<span class="sd">            umap_kwargs (dict, optional): Dictionary of keyword arguments to</span>
<span class="sd">                pass to the UMAP function.</span>
<span class="sd">            low_memory (bool, optional): Limit memory during UMAP calculations.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            use_norm (bool, optional): Display image tiles using the normalizer</span>
<span class="sd">                used during model training (if applicable). Detected from</span>
<span class="sd">                a model&#39;s metadata file (params.json). Defaults to True.</span>
<span class="sd">            figsize (Tuple[int, int], optional): Figure size. Defaults to</span>
<span class="sd">                (200, 200).</span>
<span class="sd">            num_tiles_x (int): Specifies the size of the mosaic map grid.</span>
<span class="sd">            expanded (bool): Controls tile assignment on grid spaces.</span>
<span class="sd">                If False, tile assignment is strict.</span>
<span class="sd">                If True, allows displaying nearby tiles if a grid is empty.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            leniency (float): UMAP leniency. Defaults to 1.5.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`slideflow.Mosaic`: Mosaic object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Set up paths</span>
        <span class="n">stats_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">)</span>
        <span class="n">mosaic_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">stats_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stats_root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">mosaic_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mosaic_root</span><span class="p">)</span>

        <span class="c1"># Prepare dataset &amp; model</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to auto-create Mosaic from DatasetFeatures created &quot;</span>
                <span class="s2">&quot;from a loaded Tensorflow/PyTorch model. Please use a &quot;</span>
                <span class="s2">&quot;DatasetFeatures object created from a saved Slideflow model, &quot;</span>
                <span class="s2">&quot;or manually create a mosaic with `sf.Mosaic`.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;tile_px&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">][</span><span class="s1">&#39;tile_um&#39;</span><span class="p">]</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">tile_px</span><span class="o">=</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">_assert_size_matches_hp</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
            <span class="n">tile_px</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tile_px</span>

        <span class="c1"># Filter and clip dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span>

        <span class="c1"># Get TFrecords, and prepare a list for focus, if requested</span>
        <span class="n">tfr</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
        <span class="n">n_slides</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tfr</span> <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">slides</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating mosaic from </span><span class="si">{</span><span class="n">n_slides</span><span class="si">}</span><span class="s1"> slides&#39;</span><span class="p">)</span>

        <span class="c1"># If a header category is supplied and we are not showing predictions,</span>
        <span class="c1"># then assign slide labels from annotations</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">use_float</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">outcomes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">show_prediction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span>
                                       <span class="n">use_float</span><span class="o">=</span><span class="n">use_float</span><span class="p">,</span>
                                       <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># If showing predictions, try to automatically load prediction labels</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">show_prediction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">use_float</span><span class="p">):</span>
            <span class="n">outcome_labels</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;outcome_labels&#39;</span><span class="p">]</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span> <span class="k">if</span> <span class="n">model_type</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded pred labels found at [green]</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Create mosaic map from UMAP of layer activations</span>
        <span class="n">umap</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">SlideMap</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">map_slide</span><span class="o">=</span><span class="n">map_slide</span><span class="p">,</span>
            <span class="n">cache</span><span class="o">=</span><span class="n">umap_cache</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="n">low_memory</span><span class="p">,</span>
            <span class="o">**</span><span class="n">umap_kwargs</span>
        <span class="p">)</span>
        <span class="c1"># If displaying centroid AND predictions, show slide-level predictions</span>
        <span class="c1"># rather than tile-level predictions</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">map_slide</span> <span class="o">==</span> <span class="s1">&#39;centroid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">show_prediction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Showing slide-level predictions at point of centroid&#39;</span><span class="p">)</span>

            <span class="c1"># If not model has not been assigned, assume categorical model</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span> <span class="k">if</span> <span class="n">model_type</span> <span class="k">else</span> <span class="s1">&#39;categorical&#39;</span>

            <span class="c1"># Get predictions</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">:</span>
                <span class="n">s_pred</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">logits_predict</span><span class="p">()</span>
                <span class="n">s_perc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">logits_percent</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_pred</span> <span class="o">=</span> <span class="n">s_perc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">logits_mean</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

            <span class="c1"># If show_prediction is provided (either a number or string),</span>
            <span class="c1"># then display ONLY the prediction for the provided category</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">show_prediction</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Showing preds for </span><span class="si">{</span><span class="n">show_prediction</span><span class="si">}</span><span class="s1"> as colormap&#39;</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">show_prediction</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s_perc</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">show_prediction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">show_prediction</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Showing preds for </span><span class="si">{</span><span class="n">show_prediction</span><span class="si">}</span><span class="s1"> as colormap&#39;</span><span class="p">)</span>
                <span class="n">reversed_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outcome_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">if</span> <span class="n">show_prediction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reversed_labels</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown category &#39;</span><span class="si">{</span><span class="n">show_prediction</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">reversed_labels</span><span class="p">[</span><span class="n">show_prediction</span><span class="p">])]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s_perc</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">show_prediction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">use_float</span><span class="p">:</span>
                <span class="c1"># Displaying linear predictions needs to be implemented here</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Showing slide preds not supported for linear outcomes.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Otherwise, show_prediction is assumed to be just &quot;True&quot;,</span>
            <span class="c1"># in which case show categorical predictions</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">outcome_labels</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s_pred</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># Try interpreting prediction label keys as strings</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">outcome_labels</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s_pred</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>

        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">umap</span><span class="o">.</span><span class="n">label_by_slide</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_prediction</span> <span class="ow">and</span> <span class="p">(</span><span class="n">map_slide</span> <span class="o">!=</span> <span class="s1">&#39;centroid&#39;</span><span class="p">):</span>
            <span class="n">umap</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;predictions&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="n">outcome_labels</span><span class="p">)</span>
        <span class="n">umap</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">slides</span><span class="p">())</span>

        <span class="n">mosaic</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Mosaic</span><span class="p">(</span>
            <span class="n">umap</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">normalizer</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">normalizer</span> <span class="k">if</span> <span class="n">use_norm</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mosaic</span></div>

<div class="viewcode-block" id="Project.generate_mosaic_from_annotations"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_mosaic_from_annotations">[docs]</a>    <span class="k">def</span> <span class="nf">generate_mosaic_from_annotations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">header_x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">header_y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">use_optimal_tile</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">Mosaic</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates mosaic map by overlaying images onto mapped tiles.</span>
<span class="sd">            Slides are mapped with slide-level annotations, x-axis determined</span>
<span class="sd">            from header_x, y-axis from header_y. If use_optimal_tile is False</span>
<span class="sd">            and no model is provided, tje first image tile in each TFRecord</span>
<span class="sd">            will be displayed. If optimal_tile is True, layer</span>
<span class="sd">            activations for all tiles in each slide are calculated using the</span>
<span class="sd">            provided model, and the tile nearest to centroid is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            header_x (str): Annotations file header with X-axis coords.</span>
<span class="sd">            header_y (str): Annotations file header with Y-axis coords.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset object.</span>
<span class="sd">            model (str, optional): Path to Tensorflow model to use when</span>
<span class="sd">                generating layer activations.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">                If not provided, mosaic will not be calculated or saved.</span>
<span class="sd">                If provided, saved in project mosaic directory.</span>
<span class="sd">            outcomes (list(str)): Column name(s) in annotations file from which</span>
<span class="sd">                to read category labels.</span>
<span class="sd">            max_tiles (int, optional): Limits the number of tiles taken from</span>
<span class="sd">                each slide. Defaults to 0.</span>
<span class="sd">            use_optimal_tile (bool, optional): Use model to calculate layer</span>
<span class="sd">                activations for all tiles in each slide, and choosing tile</span>
<span class="sd">                nearest centroid for each slide for display.</span>
<span class="sd">            cache (str, optional): Path to PKL file to cache node</span>
<span class="sd">                activations. Defaults to None.</span>
<span class="sd">            batch_size (int, optional): Batch size for model. Defaults to 64.</span>
<span class="sd">            figsize (Tuple[int, int], optional): Figure size. Defaults to</span>
<span class="sd">                (200, 200).</span>
<span class="sd">            num_tiles_x (int): Specifies the size of the mosaic map grid.</span>
<span class="sd">            expanded (bool): Controls tile assignment on grid spaces.</span>
<span class="sd">                If False, tile assignment is strict.</span>
<span class="sd">                If True, allows displaying nearby tiles if a grid is empty.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            leniency (float): UMAP leniency. Defaults to 1.5.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Setup paths</span>
        <span class="n">stats_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">)</span>
        <span class="n">mosaic_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">stats_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stats_root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">mosaic_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mosaic_root</span><span class="p">)</span>

        <span class="c1"># Filter dataset to exclude slides blank in the x and y header columns</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_blank</span><span class="o">=</span><span class="p">[</span><span class="n">header_x</span><span class="p">,</span> <span class="n">header_y</span><span class="p">])</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span>

        <span class="c1"># We are assembling a list of slides from the TFRecords path list,</span>
        <span class="c1"># because we only want to use slides that have a corresponding TFRecord</span>
        <span class="c1"># (some slides did not have a large enough ROI for tile extraction</span>
        <span class="c1"># &amp; some slides may be in the annotations but are missing a slide)</span>
        <span class="n">slides</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span> <span class="k">for</span> <span class="n">tfr</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()]</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">([</span><span class="n">header_x</span><span class="p">,</span> <span class="n">header_y</span><span class="p">],</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">umap_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                           <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">])</span>
        <span class="n">umap_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                           <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">use_optimal_tile</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Optimal tile calculation requires a model.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_optimal_tile</span><span class="p">:</span>
            <span class="c1"># Calculate most representative tile in each TFRecord for display</span>
            <span class="k">assert</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">DatasetFeatures</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                    <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
            <span class="n">opt_ind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">calculate_centroid</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">activations</span><span class="p">)</span>

            <span class="c1"># Restrict mosaic to only slides that had enough tiles to</span>
            <span class="c1"># calculate an optimal index from centroid</span>
            <span class="n">success_slides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">opt_ind</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">multi_warn</span><span class="p">(</span>
                <span class="n">slides</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">success_slides</span><span class="p">,</span>
                <span class="s1">&#39;Unable to calculate optimal tile for </span><span class="si">{}</span><span class="s1">, skipping&#39;</span>
            <span class="p">)</span>
            <span class="n">umap_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">success_slides</span>
            <span class="p">])</span>
            <span class="n">umap_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">slide</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">success_slides</span>
            <span class="p">])</span>
            <span class="n">umap_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">success_slides</span><span class="p">)</span>
            <span class="n">umap_tfr_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">opt_ind</span><span class="p">[</span><span class="n">slide</span><span class="p">]</span> <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">success_slides</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take the first tile from each slide/TFRecord</span>
            <span class="n">umap_slides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span>
            <span class="n">umap_tfr_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">))</span>

        <span class="n">umap</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">SlideMap</span><span class="o">.</span><span class="n">from_precalculated</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">umap_x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">umap_y</span><span class="p">,</span>
            <span class="n">slides</span><span class="o">=</span><span class="n">umap_slides</span><span class="p">,</span>
            <span class="n">tfr_index</span><span class="o">=</span><span class="n">umap_tfr_idx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">outcomes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slide_to_category</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">umap</span><span class="o">.</span><span class="n">label_by_slide</span><span class="p">(</span><span class="n">slide_to_category</span><span class="p">)</span>

        <span class="n">mosaic</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Mosaic</span><span class="p">(</span>
            <span class="n">umap</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">(),</span>
            <span class="n">tile_select</span><span class="o">=</span><span class="s1">&#39;centroid&#39;</span> <span class="k">if</span> <span class="n">use_optimal_tile</span> <span class="k">else</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mosaic</span></div>

<div class="viewcode-block" id="Project.generate_thumbnails"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_thumbnails">[docs]</a>    <span class="k">def</span> <span class="nf">generate_thumbnails</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">roi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generates square slide thumbnails with black borders of fixed size,</span>
<span class="sd">        and saves to project folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            size (int, optional): Width/height of thumbnail in pixels.</span>
<span class="sd">                Defaults to 512.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate activations. If not supplied, will</span>
<span class="sd">                calculate activations for all tfrecords at the tile_px/tile_um</span>
<span class="sd">                matching the supplied model, optionally using provided filters</span>
<span class="sd">                and filter_blank.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            roi (bool, optional): Include ROI in the thumbnail images.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            enable_downsample (bool, optional): If True and a thumbnail is not</span>
<span class="sd">                embedded in the slide file, downsampling is permitted to</span>
<span class="sd">                accelerate thumbnail calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Deprecation warning: Project.generate_thumbnails() will &quot;</span>
            <span class="s2">&quot;be moved to Dataset.thumbnails() in slideflow&gt;=1.2&quot;</span>
        <span class="p">)</span>
        <span class="n">thumb_folder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;thumbs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">thumb_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">thumb_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">tile_px</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_um</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">thumbnails</span><span class="p">(</span>
            <span class="n">thumb_folder</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
            <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span>
            <span class="n">enable_downsample</span><span class="o">=</span><span class="n">enable_downsample</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Project.generate_tfrecord_heatmap"><a class="viewcode-back" href="../../project.html#slideflow.Project.generate_tfrecord_heatmap">[docs]</a>    <span class="k">def</span> <span class="nf">generate_tfrecord_heatmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tfrecord</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">tile_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a tfrecord-based WSI heatmap using a dictionary of tile</span>
<span class="sd">        values for heatmap display, saving to project root directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            tfrecord (str): Path to tfrecord</span>
<span class="sd">            tile_dict (dict): Dictionary mapping tfrecord indices to a</span>
<span class="sd">                tile-level value for display in heatmap format</span>
<span class="sd">            tile_px (int): Tile width in pixels</span>
<span class="sd">            tile_um (int or str): Tile width in microns (int) or magnification</span>
<span class="sd">                (str, e.g. &quot;20x&quot;).</span>
<span class="sd">            outdir (str, optional): Destination path to save heatmap.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Deprecation warning: Project.generate_tfrecord_heatmap() will &quot;</span>
            <span class="s2">&quot;be moved to Dataset.tfrecord_heatmap() in slideflow&gt;=1.2&quot;</span>
        <span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">tile_px</span><span class="o">=</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecord_heatmap</span><span class="p">(</span><span class="n">tfrecord</span><span class="p">,</span> <span class="n">tile_dict</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.dataset"><a class="viewcode-back" href="../../project.html#slideflow.Project.dataset">[docs]</a>    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tile_px</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tile_um</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">verification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns :class:`slideflow.Dataset` object using project settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            tile_px (int): Tile size in pixels</span>
<span class="sd">            tile_um (int or str): Tile size in microns (int) or magnification</span>
<span class="sd">                (str, e.g. &quot;20x&quot;).</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            filters (dict, optional): Filters for selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Min tiles a slide must have.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            config (str, optional): Path to dataset configuration JSON file.</span>
<span class="sd">                Defaults to project default.</span>
<span class="sd">            sources (str, list(str), optional): Dataset sources to use from</span>
<span class="sd">                configuration. Defaults to project default.</span>
<span class="sd">            verification (str, optional): &#39;tfrecords&#39;, &#39;slides&#39;, or &#39;both&#39;.</span>
<span class="sd">                If &#39;slides&#39;, verify all annotations are mapped to slides.</span>
<span class="sd">                If &#39;tfrecords&#39;, check that TFRecords exist and update manifest.</span>
<span class="sd">                Defaults to &#39;both&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;config&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_config</span>
        <span class="k">if</span> <span class="s1">&#39;sources&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">):</span>
                <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annotations</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="n">tile_px</span><span class="o">=</span><span class="n">tile_px</span><span class="p">,</span>
                <span class="n">tile_um</span><span class="o">=</span><span class="n">tile_um</span><span class="p">,</span>
                <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span><span class="s1">&#39;No datasets configured.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verification</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;slides&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Verifying slide annotations...&quot;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">verify_annotations_slides</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verification</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;tfrecords&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Verifying tfrecords...&quot;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dataset</span></div>

<div class="viewcode-block" id="Project.load_project"><a class="viewcode-back" href="../../project.html#slideflow.Project.load_project">[docs]</a>    <span class="k">def</span> <span class="nf">load_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads a saved and pre-configured project from the specified path.&quot;&quot;&quot;</span>

        <span class="c1"># Enable logging</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ProjectError</span><span class="p">(</span><span class="s1">&#39;Unable to find settings.json.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.predict"><a class="viewcode-back" href="../../project.html#slideflow.Project.predict">[docs]</a>    <span class="nd">@auto_dataset</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_k_fold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;splits.json&quot;</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span>
        <span class="n">input_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;pd.DataFrame&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluates a saved model on a given set of tfrecords.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model to evaluate.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate predictions. If not supplied, will</span>
<span class="sd">                generate predictions for all project tfrecords at the</span>
<span class="sd">                tile_px/tile_um matching the model, optionally using provided</span>
<span class="sd">                filters and filter_blank.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Min tiles a slide must have</span>
<span class="sd">                to be included. Defaults to 0.</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt file, if evaluating a</span>
<span class="sd">                saved checkpoint. Defaults to None.</span>
<span class="sd">            eval_k_fold (int, optional): K-fold iteration number to evaluate.</span>
<span class="sd">                If None, will evaluate all tfrecords irrespective of K-fold.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            splits (str, optional): Filename of JSON file in which to log</span>
<span class="sd">                training/validation splits. Looks for filename in project root</span>
<span class="sd">                directory. Defaults to &quot;splits.json&quot;.</span>
<span class="sd">            max_tiles (int, optional): Maximum number of tiles from each slide</span>
<span class="sd">                to evaluate. If zero, will include all tiles. Defaults to 0.</span>
<span class="sd">            batch_size (int, optional): Batch size to use during prediction.</span>
<span class="sd">                Defaults to 32.</span>
<span class="sd">            format (str, optional): Format in which to save predictions.</span>
<span class="sd">                Either &#39;csv&#39;, &#39;feather&#39;, or &#39;parquet&#39;. Defaults to &#39;parquet&#39;.</span>
<span class="sd">            input_header (str, optional): Annotation column header to use as</span>
<span class="sd">                additional input. Defaults to None.</span>
<span class="sd">            mixed_precision (bool, optional): Enable mixed precision.</span>
<span class="sd">                Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of predictions dataframes, with the keys &#39;tile&#39;, &#39;slide&#39;,</span>
<span class="sd">            and &#39;patient&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Perform evaluation</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Predicting model results&#39;</span><span class="p">)</span>
        <span class="n">trainer</span><span class="p">,</span> <span class="n">eval_dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_trainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
            <span class="n">eval_k_fold</span><span class="o">=</span><span class="n">eval_k_fold</span><span class="p">,</span>
            <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
            <span class="n">max_tiles</span><span class="o">=</span><span class="n">max_tiles</span><span class="p">,</span>
            <span class="n">input_header</span><span class="o">=</span><span class="n">input_header</span><span class="p">,</span>
            <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">eval_dts</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Project.predict_wsi"><a class="viewcode-back" href="../../project.html#slideflow.Project.predict_wsi">[docs]</a>    <span class="nd">@auto_dataset</span>
    <span class="k">def</span> <span class="nf">predict_wsi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">stride_div</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">enable_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">roi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">img_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">randomize_origin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Using a given model, generates a map of tile-level predictions for a</span>
<span class="sd">            whole-slide image (WSI), dumping prediction arrays into pkl files</span>
<span class="sd">            for later use.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): Path to model from which to generate predictions.</span>
<span class="sd">            outdir (str): Directory for saving WSI predictions in .pkl format.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`, optional): Dataset</span>
<span class="sd">                from which to generate activations. If not supplied, will</span>
<span class="sd">                calculate activations for all tfrecords at the tile_px/tile_um</span>
<span class="sd">                matching the supplied model.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            min_tiles (int, optional): Min tiles a slide must have</span>
<span class="sd">                to be included. Defaults to 0.</span>
<span class="sd">            stride_div (int, optional): Stride divisor for extracting tiles.</span>
<span class="sd">                A stride of 1 will extract non-overlapping tiles.</span>
<span class="sd">                A stride_div of 2 will extract overlapping tiles, with a stride</span>
<span class="sd">                equal to 50% of the tile width. Defaults to 1.</span>
<span class="sd">            enable_downsample (bool, optional): Enable downsampling for slides.</span>
<span class="sd">                This may result in corrupted image tiles if downsampled slide</span>
<span class="sd">                layers are corrupted or incomplete. Defaults to True.</span>
<span class="sd">            roi_method (str): Either &#39;inside&#39;, &#39;outside&#39;, &#39;auto&#39;, or &#39;ignore&#39;.</span>
<span class="sd">                Determines how ROIs are used to extract tiles.</span>
<span class="sd">                If &#39;inside&#39; or &#39;outside&#39;, will extract tiles in/out of an ROI,</span>
<span class="sd">                and raise errors.MissingROIError if an ROI is not available.</span>
<span class="sd">                If &#39;auto&#39;, will extract tiles inside an ROI if available,</span>
<span class="sd">                and across the whole-slide if no ROI is found.</span>
<span class="sd">                If &#39;ignore&#39;, will extract tiles across the whole-slide</span>
<span class="sd">                regardless of whether an ROI is available.</span>
<span class="sd">                Defaults to &#39;auto&#39;.</span>
<span class="sd">            source (list, optional): Name(s) of dataset sources from which to</span>
<span class="sd">                get slides. If None, will use all.</span>
<span class="sd">            img_format (str, optional): Image format (png, jpg) to use when</span>
<span class="sd">                extracting tiles from slide. Must match the image format</span>
<span class="sd">                the model was trained on. If &#39;auto&#39;, will use the format</span>
<span class="sd">                logged in the model params.json.</span>
<span class="sd">            randomize_origin (bool, optional): Randomize pixel starting</span>
<span class="sd">                position during extraction. Defaults to False.</span>
<span class="sd">            whitespace_fraction (float, optional): Range 0-1. Defaults to 1.</span>
<span class="sd">                Discard tiles with this fraction of whitespace.</span>
<span class="sd">                If 1, will not perform whitespace filtering.</span>
<span class="sd">            whitespace_threshold (int, optional): Range 0-255. Defaults to 230.</span>
<span class="sd">                Threshold above which a pixel (RGB average) is whitespace.</span>
<span class="sd">            grayspace_fraction (float, optional): Range 0-1. Defaults to 0.6.</span>
<span class="sd">                Discard tiles with this fraction of grayspace.</span>
<span class="sd">                If 1, will not perform grayspace filtering.</span>
<span class="sd">            grayspace_threshold (float, optional): Range 0-1. Defaults to 0.05.</span>
<span class="sd">                Pixels in HSV format with saturation below this are grayspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating WSI prediction / activation maps...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">as_list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tile_px</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tile_um</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">DatasetError</span><span class="p">(</span>
                <span class="s2">&quot;Dataset must have non-zero tile_px and tile_um&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Prepare dataset &amp; model</span>
        <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_model_config</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">img_format</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;img_format&#39;</span><span class="p">]</span>

        <span class="c1"># Log extraction parameters</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">log_extraction_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on dataset source [bold]</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>

            <span class="c1"># Prepare list of slides for extraction</span>
            <span class="n">slide_list</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">slide_paths</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating predictions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> slides&#39;</span><span class="p">)</span>

            <span class="c1"># Verify slides and estimate total number of tiles</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Verifying slides...&#39;</span><span class="p">)</span>
            <span class="n">total_tiles</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="kn">from</span> <span class="nn">rich.progress</span> <span class="kn">import</span> <span class="n">track</span>
            <span class="k">for</span> <span class="n">slide_path</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">slide_list</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">slide</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span><span class="n">slide_path</span><span class="p">,</span>
                                   <span class="n">dataset</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                                   <span class="n">dataset</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                                   <span class="n">stride_div</span><span class="p">,</span>
                                   <span class="n">roi_dir</span><span class="o">=</span><span class="n">roi_dir</span><span class="p">,</span>
                                   <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_est</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">estimated_num_tiles</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated tiles for slide </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_est</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">total_tiles</span> <span class="o">+=</span> <span class="n">n_est</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">slide</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total estimated tiles: </span><span class="si">{</span><span class="n">total_tiles</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Predict for each WSI</span>
            <span class="k">for</span> <span class="n">slide_path</span> <span class="ow">in</span> <span class="n">slide_list</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working on slide </span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wsi</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">WSI</span><span class="p">(</span><span class="n">slide_path</span><span class="p">,</span>
                                 <span class="n">dataset</span><span class="o">.</span><span class="n">tile_px</span><span class="p">,</span>
                                 <span class="n">dataset</span><span class="o">.</span><span class="n">tile_um</span><span class="p">,</span>
                                 <span class="n">stride_div</span><span class="p">,</span>
                                 <span class="n">enable_downsample</span><span class="o">=</span><span class="n">enable_downsample</span><span class="p">,</span>
                                 <span class="n">roi_dir</span><span class="o">=</span><span class="n">roi_dir</span><span class="p">,</span>
                                 <span class="n">roi_method</span><span class="o">=</span><span class="n">roi_method</span><span class="p">,</span>
                                 <span class="n">randomize_origin</span><span class="o">=</span><span class="n">randomize_origin</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">SlideLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">MissingROIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">interface</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">include_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">wsi_grid</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span><span class="n">wsi</span><span class="p">,</span> <span class="n">img_format</span><span class="o">=</span><span class="n">img_format</span><span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">wsi</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">wsi_grid</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">TileCorruptionError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[green]</span><span class="si">{</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span><span class="si">}</span><span class="s1">[/] is &#39;</span>
                              <span class="s1">&#39;corrupt; skipping slide&#39;</span><span class="p">)</span>
                    <span class="k">continue</span></div>

<div class="viewcode-block" id="Project.save"><a class="viewcode-back" href="../../project.html#slideflow.Project.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Saves current project configuration as &quot;settings.json&quot;.&quot;&quot;&quot;</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_get_smac_runner</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span>
        <span class="n">train_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Builds a SMAC3 optimization runner.</span>

<span class="sd">        Args:</span>
<span class="sd">            outcomes (str, List[str]): Outcome label annotation header(s).</span>
<span class="sd">            params (sf.ModelParams): Model parameters for training.</span>
<span class="sd">            metric (str or Callable): Metric to monitor for optimization.</span>
<span class="sd">                May be callable function or a str. If a callable function, must</span>
<span class="sd">                accept the epoch results dict and return a float value. If</span>
<span class="sd">                a str, must be a valid metric, such as  &#39;tile_auc&#39;,</span>
<span class="sd">                &#39;patient_auc&#39;, &#39;r_squared&#39;, etc.</span>
<span class="sd">            train_kwargs (dict):  Dict of keyword arguments used for the</span>
<span class="sd">                Project.train() function call.</span>

<span class="sd">        Raises:</span>
<span class="sd">            errors.SMACError: If training does not return the designated metric.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Callable: tae_runner for SMAC optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">smac_runner</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;SMAC tae_runner function.&quot;&quot;&quot;</span>

            <span class="c1"># Load hyperparameters from SMAC configuration and train model.</span>
            <span class="n">params</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
                <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="o">**</span><span class="n">train_kwargs</span>
            <span class="p">)</span>

            <span class="c1"># Interpret results.</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_epoch</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="s1">&#39;epochs&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ambiguous epoch for SMAC. Using &#39;</span><span class="si">{</span><span class="n">last_epoch</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="n">epoch_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="s1">&#39;epochs&#39;</span><span class="p">][</span><span class="n">last_epoch</span><span class="p">]</span>

            <span class="c1"># Determine metric for optimization.</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">metric</span><span class="p">(</span><span class="n">epoch_results</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">epoch_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SMACError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric &#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39; not returned from &quot;</span>
                                       <span class="s2">&quot;training, unable to optimize.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outcomes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">epoch_results</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">SMACError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to interpret metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> (epoch results: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">epoch_results</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">epoch_results</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">outcomes</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">smac_runner</span>

<div class="viewcode-block" id="Project.smac_search"><a class="viewcode-back" href="../../project.html#slideflow.Project.smac_search">[docs]</a>    <span class="k">def</span> <span class="nf">smac_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">ModelParams</span><span class="p">,</span>
        <span class="n">smac_configspace</span><span class="p">:</span> <span class="s2">&quot;ConfigurationSpace&quot;</span><span class="p">,</span>
        <span class="n">smac_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">smac_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tile_auc&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">train_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Train a model using SMAC3 bayesian hyperparameter optimization.</span>

<span class="sd">        The hyperparameter optimization is performed with</span>
<span class="sd">        `SMAC3 &lt;https://automl.github.io/SMAC3/master/&gt;`_. Start by setting the</span>
<span class="sd">        `configuration space &lt;https://automl.github.io/ConfigSpace/master/&gt;`_:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from ConfigSpace.hyperparameters import UniformFloatHyperparameter</span>
<span class="sd">            from ConfigSpace import ConfigurationSpace</span>

<span class="sd">            cs = ConfigurationSpace()</span>
<span class="sd">            cs.add_hyperparameter(UniformIntegerHyperparameter(&quot;l1&quot;, 0, .2))</span>
<span class="sd">            cs.add_hyperparameter(UniformFloatHyperparameter(&quot;dropout&quot;, 0, 0.5))</span>

<span class="sd">        Then, use this ``smac_search()`` function as you would use</span>
<span class="sd">        ``Project.train()``, passing the configuration space to the</span>
<span class="sd">        ``smac_configspace`` argument:</span>

<span class="sd">            &gt;&gt;&gt; P.train(..., smac_configspace=cs)</span>

<span class="sd">        Args:</span>
<span class="sd">            outcomes (str, List[str]): Outcome label annotation header(s).</span>
<span class="sd">            params (ModelParams): Model parameters for training.</span>
<span class="sd">            smac_configspace (ConfigurationSpace): ConfigurationSpace to</span>
<span class="sd">                determine the SMAC optimization.</span>
<span class="sd">            smac_limit (int): Max number of function evaluations to perform</span>
<span class="sd">                during optimization. Defaults to 10.</span>
<span class="sd">            smac_metric (str, optional): Metric to monitor for optimization.</span>
<span class="sd">                May either be a callable function or a str. If a callable</span>
<span class="sd">                function, must accept the epoch results dict and return a</span>
<span class="sd">                float value. If a str, must be a valid metric, such as</span>
<span class="sd">                &#39;tile_auc&#39;, &#39;patient_auc&#39;, &#39;r_squared&#39;, etc.</span>
<span class="sd">                Defaults to &#39;tile_auc&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Configuration: Optimal hyperparameter configuration returned</span>
<span class="sd">            by SMAC4BB.optimize()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">smac.facade.smac_bb_facade</span> <span class="kn">import</span> <span class="n">SMAC4BB</span>
        <span class="kn">from</span> <span class="nn">smac.scenario.scenario</span> <span class="kn">import</span> <span class="n">Scenario</span>

        <span class="c1"># Create SMAC scenario.</span>
        <span class="n">scenario</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">({</span>
            <span class="s1">&#39;run_obj&#39;</span><span class="p">:</span> <span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="c1"># Optimize quality (alternatively: runtime)</span>
            <span class="s1">&#39;runcount-limit&#39;</span><span class="p">:</span> <span class="n">smac_limit</span><span class="p">,</span>  <span class="c1"># Max number of function evaluations</span>
            <span class="s1">&#39;cs&#39;</span><span class="p">:</span> <span class="n">smac_configspace</span>
        <span class="p">})</span>
        <span class="n">smac</span> <span class="o">=</span> <span class="n">SMAC4BB</span><span class="p">(</span>
            <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
            <span class="n">tae_runner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_smac_runner</span><span class="p">(</span>
                <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="n">smac_metric</span><span class="p">,</span>
                <span class="n">train_kwargs</span><span class="o">=</span><span class="n">train_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Optimize.</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="n">smac</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results of SMAC optimization:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">best_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_config</span></div>

<div class="viewcode-block" id="Project.train"><a class="viewcode-back" href="../../project.html#slideflow.Project.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span>
                      <span class="n">ModelParams</span><span class="p">,</span>
                      <span class="n">List</span><span class="p">[</span><span class="n">ModelParams</span><span class="p">],</span>
                      <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelParams</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">exp_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_tiles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;splits.json&quot;</span><span class="p">,</span>
        <span class="n">mixed_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">balance_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">training_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Train model(s) using a given set of parameters, outcomes, and inputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            outcomes (str or list(str)): Outcome label annotation header(s).</span>
<span class="sd">            params (:class:`slideflow.model.ModelParams`, list, dict, or str):</span>
<span class="sd">                Model parameters for training. May provide one `ModelParams`,</span>
<span class="sd">                a list, or dict mapping model names to params. If multiple</span>
<span class="sd">                params are provided, will train models for each. If JSON file</span>
<span class="sd">                is provided, will interpret as a hyperparameter sweep. See</span>
<span class="sd">                examples below for use.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            exp_label (str, optional): Experiment label to add model names.</span>
<span class="sd">            filters (dict, optional): Filters to use when selecting tfrecords.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            filter_blank (list, optional): Exclude slides blank in these cols.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            input_header (list, optional): List of annotation column headers to</span>
<span class="sd">                use as additional slide-level model input. Defaults to None.</span>
<span class="sd">            min_tiles (int): Minimum number of tiles a slide must have to</span>
<span class="sd">                include in training. Defaults to 0.</span>
<span class="sd">            max_tiles (int): Only use up to this many tiles from each slide for</span>
<span class="sd">                training. Defaults to 0 (include all tiles).</span>
<span class="sd">            splits (str, optional): Filename of JSON file in which to log</span>
<span class="sd">                train/val splits. Looks for filename in project root directory.</span>
<span class="sd">                Defaults to &quot;splits.json&quot;.</span>
<span class="sd">            mixed_precision (bool, optional): Enable mixed precision.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            balance_headers (str or list(str)): Annotation header(s) specifying</span>
<span class="sd">                labels on which to perform mini-batch balancing. If performing</span>
<span class="sd">                category-level balancing and this is set to None, will default</span>
<span class="sd">                to balancing on outcomes. Defaults to None.</span>
<span class="sd">            val_strategy (str): Validation dataset selection strategy. Options</span>
<span class="sd">                include bootstrap, k-fold, k-fold-manual,</span>
<span class="sd">                k-fold-preserved-site, fixed, and none. Defaults to &#39;k-fold&#39;.</span>
<span class="sd">            val_k_fold (int): Total number of K if using K-fold validation.</span>
<span class="sd">                Defaults to 3.</span>
<span class="sd">            val_k (int): Iteration of K-fold to train, starting at 1. Defaults</span>
<span class="sd">                to None (training all k-folds).</span>
<span class="sd">            val_k_fold_header (str): Annotations file header column for</span>
<span class="sd">                manually specifying k-fold or for preserved-site cross</span>
<span class="sd">                validation. Only used if validation strategy is &#39;k-fold-manual&#39;</span>
<span class="sd">                or &#39;k-fold-preserved-site&#39;. Defaults to None for k-fold-manual</span>
<span class="sd">                and &#39;site&#39; for k-fold-preserved-site.</span>
<span class="sd">            val_fraction (float): Fraction of dataset to use for validation</span>
<span class="sd">                testing, if strategy is &#39;fixed&#39;.</span>
<span class="sd">            val_source (str): Dataset source to use for validation. Defaults to</span>
<span class="sd">                None (same as training).</span>
<span class="sd">            val_annotations (str): Path to annotations file for validation</span>
<span class="sd">                dataset. Defaults to None (same as training).</span>
<span class="sd">            val_filters (dict): Filters to use for validation dataset.</span>
<span class="sd">                Defaults to None (same as training).</span>
<span class="sd">            checkpoint (str, optional): Path to cp.ckpt from which to load</span>
<span class="sd">                weights. Defaults to None.</span>
<span class="sd">            pretrain (str, optional): Either &#39;imagenet&#39; or path to Tensorflow</span>
<span class="sd">                model from which to load weights. Defaults to &#39;imagenet&#39;.</span>
<span class="sd">            multi_gpu (bool): Train using multiple GPUs when available.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            resume_training (str, optional): Path to Tensorflow model to</span>
<span class="sd">                continue training. Defaults to None.</span>
<span class="sd">            starting_epoch (int): Start training at the specified epoch.</span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">            steps_per_epoch_override (int): If provided, will manually set the</span>
<span class="sd">                number of steps in an epoch. Default epoch length is the number</span>
<span class="sd">                of total tiles.</span>
<span class="sd">            save_predictions (bool or str, optional): Save tile, slide, and</span>
<span class="sd">                patient-level predictions at each evaluation. May be &#39;csv&#39;,</span>
<span class="sd">                &#39;feather&#39;, or &#39;parquet&#39;. If False, will not save predictions.</span>
<span class="sd">                Defaults to &#39;parquet&#39;.</span>
<span class="sd">            save_model (bool, optional): Save models when evaluating at</span>
<span class="sd">                specified epochs. Defaults to True.</span>
<span class="sd">            validate_on_batch (int): Perform validation every N batches.</span>
<span class="sd">                Defaults to 0 (only at epoch end).</span>
<span class="sd">            validation_batch_size (int): Validation dataset batch size.</span>
<span class="sd">                Defaults to 32.</span>
<span class="sd">            use_tensorboard (bool): Add tensorboard callback for realtime</span>
<span class="sd">                training monitoring. Defaults to False.</span>
<span class="sd">            validation_steps (int): Number of steps of validation to perform</span>
<span class="sd">                each time doing a mid-epoch validation check. Defaults to 200.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict with model names mapped to train_acc, val_loss, and val_acc</span>

<span class="sd">        Examples</span>
<span class="sd">            Method 1 (hyperparameter sweep from a configuration file):</span>

<span class="sd">                &gt;&gt;&gt; P.train(&#39;outcome&#39;, params=&#39;sweep.json&#39;, ...)</span>

<span class="sd">            Method 2 (manually specified hyperparameters):</span>

<span class="sd">                &gt;&gt;&gt; hp = sf.ModelParams(...)</span>
<span class="sd">                &gt;&gt;&gt; P.train(&#39;outcome&#39;, params=hp, ...)</span>

<span class="sd">            Method 3 (list of hyperparameters):</span>

<span class="sd">                &gt;&gt;&gt; hp = [sf.ModelParams(...), sf.ModelParams(...)]</span>
<span class="sd">                &gt;&gt;&gt; P.train(&#39;outcome&#39;, params=hp, ...)</span>

<span class="sd">            Method 4 (dict of hyperparameters):</span>

<span class="sd">                &gt;&gt;&gt; hp = {&#39;HP0&#39;: sf.ModelParams(...), ...}</span>
<span class="sd">                &gt;&gt;&gt; P.train(&#39;outcome&#39;, params=hp, ...)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Prepare outcomes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="n">outcomes</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span><span class="si">}</span><span class="s1"> outcomes&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Outcomes: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Prepare hyperparameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="n">hp_dict</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">read_hp_sweep</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">params</span><span class="p">)):</span>
                <span class="n">hp_dict</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">read_hp_sweep</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find file </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">ModelParams</span><span class="p">):</span>
            <span class="n">hp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HP0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">ModelParams</span><span class="p">)</span> <span class="k">for</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsError</span><span class="p">(</span>
                    <span class="s1">&#39;If params is a list, items must be sf.model.ModelParams&#39;</span>
                <span class="p">)</span>
            <span class="n">hp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;HP</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">hp</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsError</span><span class="p">(</span>
                    <span class="s1">&#39;If params is a dict, keys must be of type str&#39;</span>
                <span class="p">)</span>
            <span class="n">all_hp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">ModelParams</span><span class="p">)</span> <span class="k">for</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">all_hp</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModelParamsError</span><span class="p">(</span>
                    <span class="s1">&#39;If params is a dict, values must be sf.ModelParams&#39;</span>
                <span class="p">)</span>
            <span class="n">hp_dict</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to interprest params value </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get default validation settings from kwargs</span>
        <span class="n">val_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">training_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;val_&#39;</span>
        <span class="p">}</span>
        <span class="n">training_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">training_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;val_&#39;</span>
        <span class="p">}</span>
        <span class="n">val_settings</span> <span class="o">=</span> <span class="n">get_validation_settings</span><span class="p">(</span><span class="o">**</span><span class="n">val_kwargs</span><span class="p">)</span>
        <span class="n">_invalid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;k-fold-manual&#39;</span><span class="p">,</span>
            <span class="s1">&#39;k-fold-preserved-site&#39;</span><span class="p">,</span>
            <span class="s1">&#39;k-fold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bootstrap&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span> <span class="ow">in</span> <span class="n">_invalid</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val_settings</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="n">_m</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val_settings</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s1"> invalid with val_source != None&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_m</span><span class="p">)</span>

        <span class="c1"># Next, prepare the multiprocessing manager (needed to free VRAM after</span>
        <span class="c1"># training and keep track of results)</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
        <span class="n">results_dict</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>  <span class="c1"># type: Dict</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>

        <span class="c1"># === Train with a set of hyperparameters =============================</span>
        <span class="k">for</span> <span class="n">hp_name</span><span class="p">,</span> <span class="n">hp</span> <span class="ow">in</span> <span class="n">hp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">exp_label</span><span class="p">:</span>
                <span class="n">hp_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exp_label</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">hp_name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_hp</span><span class="p">(</span>
                <span class="n">hp_name</span><span class="o">=</span><span class="n">hp_name</span><span class="p">,</span>
                <span class="n">hp</span><span class="o">=</span><span class="n">hp</span><span class="p">,</span>
                <span class="n">outcomes</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
                <span class="n">val_settings</span><span class="o">=</span><span class="n">val_settings</span><span class="p">,</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">,</span>
                <span class="n">input_header</span><span class="o">=</span><span class="n">input_header</span><span class="p">,</span>
                <span class="n">min_tiles</span><span class="o">=</span><span class="n">min_tiles</span><span class="p">,</span>
                <span class="n">max_tiles</span><span class="o">=</span><span class="n">max_tiles</span><span class="p">,</span>
                <span class="n">mixed_precision</span><span class="o">=</span><span class="n">mixed_precision</span><span class="p">,</span>
                <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
                <span class="n">balance_headers</span><span class="o">=</span><span class="n">balance_headers</span><span class="p">,</span>
                <span class="n">training_kwargs</span><span class="o">=</span><span class="n">training_kwargs</span><span class="p">,</span>
                <span class="n">results_dict</span><span class="o">=</span><span class="n">results_dict</span>
            <span class="p">)</span>
        <span class="c1"># Print summary of all models</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training complete; validation accuracies:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;epochs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">ep_res</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
            <span class="n">epochs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ep_res</span> <span class="k">if</span> <span class="s1">&#39;epoch&#39;</span> <span class="ow">in</span> <span class="n">ep_res</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">])</span>
                <span class="n">final_train_metrics</span> <span class="o">=</span> <span class="n">ep_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">last</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;train_metrics&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[green]</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">[/] training metrics:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">final_train_metrics</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">final_train_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;val_metrics&#39;</span> <span class="ow">in</span> <span class="n">ep_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">last</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]:</span>
                    <span class="n">final_val_metrics</span> <span class="o">=</span> <span class="n">ep_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;epoch</span><span class="si">{</span><span class="n">last</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="s1">&#39;val_metrics&#39;</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[green]</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">[/] validation metrics:&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">final_val_metrics</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">final_val_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.train_clam"><a class="viewcode-back" href="../../project.html#slideflow.Project.train_clam">[docs]</a>    <span class="k">def</span> <span class="nf">train_clam</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pt_files</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">outcomes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">train_slides</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">val_slides</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">splits</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;splits.json&#39;</span><span class="p">,</span>
        <span class="n">clam_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">attention_heatmaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Train a CLAM model from layer activations exported with</span>
<span class="sd">        :meth:`slideflow.project.generate_features_for_clam`.</span>

<span class="sd">        Args:</span>
<span class="sd">            exp_name (str): Name of experiment. Makes clam/{exp_name} folder.</span>
<span class="sd">            pt_files (str): Path to pt_files containing tile-level features.</span>
<span class="sd">            outcomes (str): Annotation column which specifies the outcome.</span>
<span class="sd">            dataset (:class:`slideflow.dataset.Dataset`): Dataset object from</span>
<span class="sd">                which to generate activations.</span>
<span class="sd">            train_slides (str, optional): List of slide names for training.</span>
<span class="sd">                If &#39;auto&#39; (default), will auto-generate training/val split.</span>
<span class="sd">            validation_slides (str, optional): List of slides for validation.</span>
<span class="sd">                If &#39;auto&#39; (default), will auto-generate training/val split.</span>
<span class="sd">            splits (str, optional): Filename of JSON file in which to log</span>
<span class="sd">                training/val splits. Looks for filename in project root</span>
<span class="sd">                directory. Defaults to &quot;splits.json&quot;.</span>
<span class="sd">            clam_args (optional): Namespace with clam arguments, as provided</span>
<span class="sd">                by :func:`slideflow.clam.get_args`.</span>
<span class="sd">            attention_heatmaps (bool, optional): Save attention heatmaps of</span>
<span class="sd">                validation dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Examples</span>
<span class="sd">            Train with basic settings:</span>

<span class="sd">                &gt;&gt;&gt; dataset = P.dataset(tile_px=299, tile_um=302)</span>
<span class="sd">                &gt;&gt;&gt; P.generate_features_for_clam(&#39;/model&#39;, outdir=&#39;/pt_files&#39;)</span>
<span class="sd">                &gt;&gt;&gt; P.train_clam(&#39;NAME&#39;, &#39;/pt_files&#39;, &#39;category1&#39;, dataset)</span>

<span class="sd">            Specify a specific layer from which to generate activations:</span>

<span class="sd">                &gt;&gt;&gt; P.generate_features_for_clam(..., layers=[&#39;postconv&#39;])</span>

<span class="sd">            Manually configure CLAM, with 5-fold validation and SVM bag loss:</span>

<span class="sd">                &gt;&gt;&gt; import slideflow.clam as clam</span>
<span class="sd">                &gt;&gt;&gt; clam_args = clam.get_args(k=5, bag_loss=&#39;svm&#39;)</span>
<span class="sd">                &gt;&gt;&gt; P.generate_features_for_clam(...)</span>
<span class="sd">                &gt;&gt;&gt; P.train_clam(..., clam_args=clam_args)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">slideflow.clam</span> <span class="k">as</span> <span class="nn">clam</span>
        <span class="kn">from</span> <span class="nn">slideflow.clam.create_attention</span> <span class="kn">import</span> <span class="n">export_attention</span>
        <span class="kn">from</span> <span class="nn">slideflow.clam.datasets.dataset_generic</span> <span class="kn">import</span> <span class="n">Generic_MIL_Dataset</span>

        <span class="c1"># Set up CLAM experiment data directory</span>
        <span class="n">clam_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;clam&#39;</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">)</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">clam_dir</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">)</span>
        <span class="n">splits_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">splits</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">results_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_dir</span><span class="p">)</span>

        <span class="c1"># Get base CLAM args/settings if not provided.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clam_args</span><span class="p">:</span>
            <span class="n">clam_args</span> <span class="o">=</span> <span class="n">clam</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clam_args</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span>

        <span class="c1"># Detect number of features automatically from saved pt_files</span>
        <span class="n">pt_file_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">join</span><span class="p">(</span><span class="n">pt_files</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pt_files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">pt_files</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;pt&#39;</span>
        <span class="p">]</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="n">clam</span><span class="o">.</span><span class="n">detect_num_features</span><span class="p">(</span><span class="n">pt_file_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Note: CLAM only supports categorical outcomes</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">train_slides</span> <span class="o">==</span> <span class="n">val_slides</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">k_train_slides</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict</span>
            <span class="n">k_val_slides</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clam_args</span><span class="o">.</span><span class="n">k</span><span class="p">):</span>
                <span class="n">train_dts</span><span class="p">,</span> <span class="n">val_dts</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_val_split</span><span class="p">(</span>
                    <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                    <span class="n">labels</span><span class="p">,</span>
                    <span class="n">val_strategy</span><span class="o">=</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span>
                    <span class="n">splits</span><span class="o">=</span><span class="n">splits_file</span><span class="p">,</span>
                    <span class="n">val_k_fold</span><span class="o">=</span><span class="n">clam_args</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                    <span class="n">k_fold_iter</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">path_to_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">train_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">path_to_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">val_dts</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_train_slides</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">train_slides</span><span class="p">}</span>
            <span class="n">k_val_slides</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">val_slides</span><span class="p">}</span>

        <span class="c1"># Remove slides without associated .pt files</span>
        <span class="n">num_skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_train_slides</span><span class="p">:</span>
            <span class="n">n_supplied</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">pt_files</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="s1">&#39;.pt&#39;</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">pt_files</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="s1">&#39;.pt&#39;</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">n_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">n_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">num_skipped</span> <span class="o">+=</span> <span class="n">n_supplied</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_train</span> <span class="o">+</span> <span class="n">n_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_skipped</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping </span><span class="si">{</span><span class="n">num_skipped</span><span class="si">}</span><span class="s1"> slides missing .pt files.&#39;</span><span class="p">)</span>

        <span class="c1"># Set up training/validation splits (mirror base model)</span>
        <span class="n">split_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">clam_dir</span><span class="p">,</span> <span class="s1">&#39;splits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">split_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">split_dir</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clam_args</span><span class="o">.</span><span class="n">k</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">split_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;splits_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="c1"># Currently, the below sets the val &amp; test sets to be the same</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>
                                   <span class="nb">len</span><span class="p">(</span><span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]))):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># type: List</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k_train_slides</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># Assign CLAM settings based on this project</span>
        <span class="n">clam_args</span><span class="o">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_features</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
        <span class="n">clam_args</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">=</span> <span class="n">results_dir</span>
        <span class="n">clam_args</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span>
        <span class="n">clam_args</span><span class="o">.</span><span class="n">split_dir</span> <span class="o">=</span> <span class="n">split_dir</span>
        <span class="n">clam_args</span><span class="o">.</span><span class="n">data_root_dir</span> <span class="o">=</span> <span class="n">pt_files</span>

        <span class="c1"># Save clam settings</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">clam_args</span><span class="p">),</span> <span class="n">join</span><span class="p">(</span><span class="n">clam_dir</span><span class="p">,</span> <span class="s1">&#39;experiment.json&#39;</span><span class="p">))</span>

        <span class="c1"># Create CLAM dataset</span>
        <span class="n">clam_dataset</span> <span class="o">=</span> <span class="n">Generic_MIL_Dataset</span><span class="p">(</span>
            <span class="n">csv_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="n">pt_files</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">clam_args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">print_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="n">outcomes</span><span class="p">,</span>
            <span class="n">label_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))),</span>
            <span class="n">patient_strat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ignore</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="c1"># Run CLAM</span>
        <span class="n">clam</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">clam_args</span><span class="p">,</span> <span class="n">clam_dataset</span><span class="p">)</span>

        <span class="c1"># Get attention from trained model on validation set(s)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_val_slides</span><span class="p">:</span>
            <span class="n">tfr</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecords</span><span class="p">()</span>
            <span class="n">attention_tfrecords</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tfr</span> <span class="k">if</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">attention_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">clam_dir</span><span class="p">,</span> <span class="s1">&#39;attention&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">attention_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">attention_dir</span><span class="p">)</span>
            <span class="n">rev_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)),</span> <span class="n">unique_labels</span><span class="p">))</span>
            <span class="n">export_attention</span><span class="p">(</span>
                <span class="nb">vars</span><span class="p">(</span><span class="n">clam_args</span><span class="p">),</span>
                <span class="n">ckpt_path</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;s_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_checkpoint.pt&#39;</span><span class="p">),</span>
                <span class="n">outdir</span><span class="o">=</span><span class="n">attention_dir</span><span class="p">,</span>
                <span class="n">pt_files</span><span class="o">=</span><span class="n">pt_files</span><span class="p">,</span>
                <span class="n">slides</span><span class="o">=</span><span class="n">k_val_slides</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="n">reverse_labels</span><span class="o">=</span><span class="n">rev_labels</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">attention_heatmaps</span><span class="p">:</span>
                <span class="n">heatmaps_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">clam_dir</span><span class="p">,</span> <span class="s1">&#39;attention_heatmaps&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">heatmaps_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">heatmaps_dir</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">att_tfr</span> <span class="ow">in</span> <span class="n">attention_tfrecords</span><span class="p">:</span>
                    <span class="n">attention_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">slide</span> <span class="o">=</span> <span class="n">path_to_name</span><span class="p">(</span><span class="n">att_tfr</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">attention_dir</span><span class="p">,</span> <span class="n">slide</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                                <span class="n">attention_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="p">})</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attention scores for slide </span><span class="si">{</span><span class="n">slide</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">tfrecord_heatmap</span><span class="p">(</span>
                        <span class="n">att_tfr</span><span class="p">,</span>
                        <span class="n">tile_dict</span><span class="o">=</span><span class="n">attention_dict</span><span class="p">,</span>
                        <span class="n">outdir</span><span class="o">=</span><span class="n">heatmaps_dir</span>
                    <span class="p">)</span></div></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, James M Dolezal.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
         <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
         <script src="../../_static/jquery.js"></script>
         <script src="../../_static/underscore.js"></script>
         <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://slideflow.dev">Docs</a>
          </li>

          <li>
            <a href="https://slideflow.dev/tutorial1.html">Tutorials</a>
          </li>

          <li>
            <a href="https://github.com/jamesdolezal/slideflow">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script script type="text/javascript">
    var collapsedSections = [];
  </script>

  <script type="text/javascript" src="../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>