Layer activations
=================

Once a model has been fully trained and evaluated, you may use the model to generate layer activations to gain better insight into the kinds of image features the model has learned.

Mosaic maps
***********

The easiest way to get started with layer activations is to calculate and display layer activations as a mosaic map. Mosaic maps are generated by calculating layer activations for a set of tiles (via :class:`slideflow.activations.ActivationsVisualizer`), performing dimensionality reduction (UMAP) on the activations (via :class:`slideflow.statistics.SlideMap`), and overlaying tile images onto the UMAP (via :class:`slideflow.mosaic.Mosaic`). By default, the post-convolutional ('postconv') layer is used when calculating activations, but any combination of other layers can be also be used. The ``SlideflowProject`` class has a function which can supervise these steps automatically and save the final figure to the project directory:

.. code-block:: python

	SFP.generate_mosaic(
			model="/path/to/saved/model.h5",
			mosaic_filename="/path/to/destination/mosaic.png",
		  	filters={"dataset": ["evaluation"]})

.. autofunction:: slideflow.SlideflowProject.generate_mosaic
   :noindex:

.. image:: mosaic_example2.jpg

If you provide a filename to the ``umap_filename`` argument, a plot of the constituent tiles will also be saved. If you additionally provide an outcome header (as saved in the annotations file) to the argument ``outcome_label_headers``, these tiles will be colored according to the slide-level annotation in the provided outcome header column of the annotations file:

.. image:: umap_example.png

Instead of mapping all tiles within a slide, you can choose instead to map only centroid tiles by passing ``map_slide='centroid'``:

.. image:: umap_example_centroid.png

There are many additional arguments that can be provided to the ``generate_mosaic()`` function to customize the mosaic and UMAP plots. However, you may choose to further customize these plots by working with the ``Mosaic`` and ``SlideMap`` objects directly, which are returned from the ``generate_mosaic()`` function.

For example, it may be interesting to view a UMAP of tiles with an added third dimension, such as the activation value of a particular penultimate layer node. With this kind of plot, one can visualize how the activation of a particular node varies across the UMAP. To make such a plot, use the ``save_3d_node_plot`` function of the ``SlideMap``:

.. code-block:: python

	AV, mosaic, umap = SFP.generate_mosaic(
		model="/path/to/saved/model.h5",
		mosaic_filename="/path/to/destination/mosaic.png",
		filters={"dataset": ["evaluation"]})
	umap.save_3d_node_plot(node=497)

.. image:: 3d_umap.png

Working with activations
************************

To work more directly with layer activations, use the :class:`slideflow.activations.ActivationsVisualizer` class. Instancing the class supervises the calculation and caching of layer activations, which can then be exported, viewed (as a mosaic map), or analyzed with various statistical methods. ``SlideflowProject.generate_activations()`` automatically creates and returns an instance of this class.

.. code-block:: python

	AV = SFP.generate_activations(
		model='/path/to/trained_model_epoch1',
		outcome_label_headers="HPV")

The ``get_predictions()`` function will return a dictionary mapping slide names to outcome categories and list tile-level predictions. Predictions are ordered according to their position in their corresponding TFRecord. Corresponding tile images can be pulled from the TFRecords with :meth:`slideflow.io.tfrecords.get_tfrecord_by_index`.

.. code-block:: python

	AV.get_predictions()

Similarly, the ``get_activations()`` function will return a dictionary mapping slide names to layer nodes, listing tile-level activations for each node.

.. code-block:: python

	AV.get_activations()

To compare activations of layer nodes across outcome categories and find nodes which differ significantly across categories, use the ``generate_box_plots()`` function:

.. code-block:: python

	AV.generate_box_plots()

.. image:: boxplot_example.png

To get a list of the layer nodes which differ most significantly across outcome categories (by ANOVA), use ``get_top_nodes_by_slide()``:

.. code-block:: python

	AV.get_top_nodes_by_slide()

Many other functions are available, as described in the documentation, :class:`slideflow.activations.ActivationsVisualizer`.